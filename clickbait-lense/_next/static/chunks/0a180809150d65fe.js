(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,34582,(e,t,r)=>{"use strict";r.byteLength=function(e){var t=c(e),r=t[0],n=t[1];return(r+n)*3/4-n},r.toByteArray=function(e){var t,r,n=c(e),a=n[0],o=n[1],l=new i((a+o)*3/4-o),u=0,h=o>0?a-4:a;for(r=0;r<h;r+=4)t=s[e.charCodeAt(r)]<<18|s[e.charCodeAt(r+1)]<<12|s[e.charCodeAt(r+2)]<<6|s[e.charCodeAt(r+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===o&&(t=s[e.charCodeAt(r)]<<2|s[e.charCodeAt(r+1)]>>4,l[u++]=255&t),1===o&&(t=s[e.charCodeAt(r)]<<10|s[e.charCodeAt(r+1)]<<4|s[e.charCodeAt(r+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},r.fromByteArray=function(e){for(var t,r=e.length,s=r%3,i=[],a=0,o=r-s;a<o;a+=16383)i.push(function(e,t,r){for(var s,i=[],a=t;a<r;a+=3)s=(e[a]<<16&0xff0000)+(e[a+1]<<8&65280)+(255&e[a+2]),i.push(n[s>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return i.join("")}(e,a,a+16383>o?o:a+16383));return 1===s?i.push(n[(t=e[r-1])>>2]+n[t<<4&63]+"=="):2===s&&i.push(n[(t=(e[r-2]<<8)+e[r-1])>>10]+n[t>>4&63]+n[t<<2&63]+"="),i.join("")};for(var n=[],s=[],i="u">typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,l=a.length;o<l;++o)n[o]=a[o],s[a.charCodeAt(o)]=o;function c(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var n=r===t?0:4-r%4;return[r,n]}s[45]=62,s[95]=63},79304,(e,t,r)=>{"use strict";r.Headers=self.Headers,r.Request=self.Request,r.Response=self.Response,r.fetch=self.fetch},67034,(e,t,r)=>{var n={675:function(e,t){"use strict";t.byteLength=function(e){var t=l(e),r=t[0],n=t[1];return(r+n)*3/4-n},t.toByteArray=function(e){var t,r,i=l(e),a=i[0],o=i[1],c=new s((a+o)*3/4-o),u=0,h=o>0?a-4:a;for(r=0;r<h;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],c[u++]=t>>16&255,c[u++]=t>>8&255,c[u++]=255&t;return 2===o&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,c[u++]=255&t),1===o&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,c[u++]=t>>8&255,c[u++]=255&t),c},t.fromByteArray=function(e){for(var t,n=e.length,s=n%3,i=[],a=0,o=n-s;a<o;a+=16383)i.push(function(e,t,n){for(var s,i=[],a=t;a<n;a+=3)s=(e[a]<<16&0xff0000)+(e[a+1]<<8&65280)+(255&e[a+2]),i.push(r[s>>18&63]+r[s>>12&63]+r[s>>6&63]+r[63&s]);return i.join("")}(e,a,a+16383>o?o:a+16383));return 1===s?i.push(r[(t=e[n-1])>>2]+r[t<<4&63]+"=="):2===s&&i.push(r[(t=(e[n-2]<<8)+e[n-1])>>10]+r[t>>4&63]+r[t<<2&63]+"="),i.join("")};for(var r=[],n=[],s="u">typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,o=i.length;a<o;++a)r[a]=i[a],n[i.charCodeAt(a)]=a;function l(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var n=r===t?0:4-r%4;return[r,n]}n[45]=62,n[95]=63},72:function(e,t,r){"use strict";var n=r(675),s=r(783),i="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;function a(e){if(e>0x7fffffff)throw RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return Object.setPrototypeOf(t,o.prototype),t}function o(e,t,r){if("number"==typeof e){if("string"==typeof t)throw TypeError('The "string" argument must be of type string. Received type number');return u(e)}return l(e,t,r)}function l(e,t,r){if("string"==typeof e){var n=e,s=t;if(("string"!=typeof s||""===s)&&(s="utf8"),!o.isEncoding(s))throw TypeError("Unknown encoding: "+s);var i=0|p(n,s),l=a(i),c=l.write(n,s);return c!==i&&(l=l.slice(0,c)),l}if(ArrayBuffer.isView(e))return h(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(C(e,ArrayBuffer)||e&&C(e.buffer,ArrayBuffer)||"u">typeof SharedArrayBuffer&&(C(e,SharedArrayBuffer)||e&&C(e.buffer,SharedArrayBuffer)))return function(e,t,r){var n;if(t<0||e.byteLength<t)throw RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw RangeError('"length" is outside of buffer bounds');return Object.setPrototypeOf(n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),o.prototype),n}(e,t,r);if("number"==typeof e)throw TypeError('The "value" argument must not be of type number. Received type number');var u=e.valueOf&&e.valueOf();if(null!=u&&u!==e)return o.from(u,t,r);var f=function(e){if(o.isBuffer(e)){var t=0|d(e.length),r=a(t);return 0===r.length||e.copy(r,0,0,t),r}return void 0!==e.length?"number"!=typeof e.length||function(e){return e!=e}(e.length)?a(0):h(e):"Buffer"===e.type&&Array.isArray(e.data)?h(e.data):void 0}(e);if(f)return f;if("u">typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return o.from(e[Symbol.toPrimitive]("string"),t,r);throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw TypeError('"size" argument must be of type number');if(e<0)throw RangeError('The value "'+e+'" is invalid for option "size"')}function u(e){return c(e),a(e<0?0:0|d(e))}function h(e){for(var t=e.length<0?0:0|d(e.length),r=a(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}t.Buffer=o,t.SlowBuffer=function(e){return+e!=e&&(e=0),o.alloc(+e)},t.INSPECT_MAX_BYTES=50,t.kMaxLength=0x7fffffff,o.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),!o.TYPED_ARRAY_SUPPORT&&"u">typeof console&&"function"==typeof console.error&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}}),o.poolSize=8192,o.from=function(e,t,r){return l(e,t,r)},Object.setPrototypeOf(o.prototype,Uint8Array.prototype),Object.setPrototypeOf(o,Uint8Array),o.alloc=function(e,t,r){return(c(e),e<=0)?a(e):void 0!==t?"string"==typeof r?a(e).fill(t,r):a(e).fill(t):a(e)},o.allocUnsafe=function(e){return u(e)},o.allocUnsafeSlow=function(e){return u(e)};function d(e){if(e>=0x7fffffff)throw RangeError("Attempt to allocate Buffer larger than maximum size: 0x7fffffff bytes");return 0|e}function p(e,t){if(o.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||C(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return P(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return S(e).length;default:if(s)return n?-1:P(e).length;t=(""+t).toLowerCase(),s=!0}}function f(e,t,r){var s,i,a,o=!1;if((void 0===t||t<0)&&(t=0),t>this.length||((void 0===r||r>this.length)&&(r=this.length),r<=0||(r>>>=0)<=(t>>>=0)))return"";for(e||(e="utf8");;)switch(e){case"hex":return function(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var s="",i=t;i<r;++i)s+=j[e[i]];return s}(this,t,r);case"utf8":case"utf-8":return y(this,t,r);case"ascii":return function(e,t,r){var n="";r=Math.min(e.length,r);for(var s=t;s<r;++s)n+=String.fromCharCode(127&e[s]);return n}(this,t,r);case"latin1":case"binary":return function(e,t,r){var n="";r=Math.min(e.length,r);for(var s=t;s<r;++s)n+=String.fromCharCode(e[s]);return n}(this,t,r);case"base64":return s=this,i=t,a=r,0===i&&a===s.length?n.fromByteArray(s):n.fromByteArray(s.slice(i,a));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(e,t,r){for(var n=e.slice(t,r),s="",i=0;i<n.length;i+=2)s+=String.fromCharCode(n[i]+256*n[i+1]);return s}(this,t,r);default:if(o)throw TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function m(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function g(e,t,r,n,s){var i;if(0===e.length)return -1;if("string"==typeof r?(n=r,r=0):r>0x7fffffff?r=0x7fffffff:r<-0x80000000&&(r=-0x80000000),(i=r*=1)!=i&&(r=s?0:e.length-1),r<0&&(r=e.length+r),r>=e.length)if(s)return -1;else r=e.length-1;else if(r<0)if(!s)return -1;else r=0;if("string"==typeof t&&(t=o.from(t,n)),o.isBuffer(t))return 0===t.length?-1:b(e,t,r,n,s);if("number"==typeof t){if(t&=255,"function"==typeof Uint8Array.prototype.indexOf)if(s)return Uint8Array.prototype.indexOf.call(e,t,r);else return Uint8Array.prototype.lastIndexOf.call(e,t,r);return b(e,[t],r,n,s)}throw TypeError("val must be string, number or Buffer")}function b(e,t,r,n,s){var i,a=1,o=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return -1;a=2,o/=2,l/=2,r/=2}function c(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(s){var u=-1;for(i=r;i<o;i++)if(c(e,i)===c(t,-1===u?0:i-u)){if(-1===u&&(u=i),i-u+1===l)return u*a}else -1!==u&&(i-=i-u),u=-1}else for(r+l>o&&(r=o-l),i=r;i>=0;i--){for(var h=!0,d=0;d<l;d++)if(c(e,i+d)!==c(t,d)){h=!1;break}if(h)return i}return -1}o.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==o.prototype},o.compare=function(e,t){if(C(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),C(t,Uint8Array)&&(t=o.from(t,t.offset,t.byteLength)),!o.isBuffer(e)||!o.isBuffer(t))throw TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var r=e.length,n=t.length,s=0,i=Math.min(r,n);s<i;++s)if(e[s]!==t[s]){r=e[s],n=t[s];break}return r<n?-1:+(n<r)},o.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(e,t){if(!Array.isArray(e))throw TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return o.alloc(0);if(void 0===t)for(r=0,t=0;r<e.length;++r)t+=e[r].length;var r,n=o.allocUnsafe(t),s=0;for(r=0;r<e.length;++r){var i=e[r];if(C(i,Uint8Array)&&(i=o.from(i)),!o.isBuffer(i))throw TypeError('"list" argument must be an Array of Buffers');i.copy(n,s),s+=i.length}return n},o.byteLength=p,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)m(this,t,t+1);return this},o.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)m(this,t,t+3),m(this,t+1,t+2);return this},o.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)m(this,t,t+7),m(this,t+1,t+6),m(this,t+2,t+5),m(this,t+3,t+4);return this},o.prototype.toString=function(){var e=this.length;return 0===e?"":0==arguments.length?y(this,0,e):f.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(e){if(!o.isBuffer(e))throw TypeError("Argument must be a Buffer");return this===e||0===o.compare(this,e)},o.prototype.inspect=function(){var e="",r=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},i&&(o.prototype[i]=o.prototype.inspect),o.prototype.compare=function(e,t,r,n,s){if(C(e,Uint8Array)&&(e=o.from(e,e.offset,e.byteLength)),!o.isBuffer(e))throw TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===s&&(s=this.length),t<0||r>e.length||n<0||s>this.length)throw RangeError("out of range index");if(n>=s&&t>=r)return 0;if(n>=s)return -1;if(t>=r)return 1;if(t>>>=0,r>>>=0,n>>>=0,s>>>=0,this===e)return 0;for(var i=s-n,a=r-t,l=Math.min(i,a),c=this.slice(n,s),u=e.slice(t,r),h=0;h<l;++h)if(c[h]!==u[h]){i=c[h],a=u[h];break}return i<a?-1:+(a<i)},o.prototype.includes=function(e,t,r){return -1!==this.indexOf(e,t,r)},o.prototype.indexOf=function(e,t,r){return g(this,e,t,r,!0)},o.prototype.lastIndexOf=function(e,t,r){return g(this,e,t,r,!1)};function y(e,t,r){r=Math.min(e.length,r);for(var n=[],s=t;s<r;){var i,a,o,l,c=e[s],u=null,h=c>239?4:c>223?3:c>191?2:1;if(s+h<=r)switch(h){case 1:c<128&&(u=c);break;case 2:(192&(i=e[s+1]))==128&&(l=(31&c)<<6|63&i)>127&&(u=l);break;case 3:i=e[s+1],a=e[s+2],(192&i)==128&&(192&a)==128&&(l=(15&c)<<12|(63&i)<<6|63&a)>2047&&(l<55296||l>57343)&&(u=l);break;case 4:i=e[s+1],a=e[s+2],o=e[s+3],(192&i)==128&&(192&a)==128&&(192&o)==128&&(l=(15&c)<<18|(63&i)<<12|(63&a)<<6|63&o)>65535&&l<1114112&&(u=l)}null===u?(u=65533,h=1):u>65535&&(u-=65536,n.push(u>>>10&1023|55296),u=56320|1023&u),n.push(u),s+=h}var d=n,p=d.length;if(p<=4096)return String.fromCharCode.apply(String,d);for(var f="",m=0;m<p;)f+=String.fromCharCode.apply(String,d.slice(m,m+=4096));return f}function v(e,t,r){if(e%1!=0||e<0)throw RangeError("offset is not uint");if(e+t>r)throw RangeError("Trying to access beyond buffer length")}function w(e,t,r,n,s,i){if(!o.isBuffer(e))throw TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<i)throw RangeError('"value" argument is out of bounds');if(r+n>e.length)throw RangeError("Index out of range")}function _(e,t,r,n,s,i){if(r+n>e.length||r<0)throw RangeError("Index out of range")}function x(e,t,r,n,i){return t*=1,r>>>=0,i||_(e,t,r,4,34028234663852886e22,-34028234663852886e22),s.write(e,t,r,n,23,4),r+4}function O(e,t,r,n,i){return t*=1,r>>>=0,i||_(e,t,r,8,17976931348623157e292,-17976931348623157e292),s.write(e,t,r,n,52,8),r+8}o.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else if(isFinite(t))t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0);else throw Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var s,i,a,o,l,c,u,h,d=this.length-t;if((void 0===r||r>d)&&(r=d),e.length>0&&(r<0||t<0)||t>this.length)throw RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var p=!1;;)switch(n){case"hex":return function(e,t,r,n){r=Number(r)||0;var s=e.length-r;n?(n=Number(n))>s&&(n=s):n=s;var i=t.length;n>i/2&&(n=i/2);for(var a=0;a<n;++a){var o,l=parseInt(t.substr(2*a,2),16);if((o=l)!=o)break;e[r+a]=l}return a}(this,e,t,r);case"utf8":case"utf-8":return s=t,i=r,A(P(e,this.length-s),this,s,i);case"ascii":return a=t,o=r,A(E(e),this,a,o);case"latin1":case"binary":return function(e,t,r,n){return A(E(t),e,r,n)}(this,e,t,r);case"base64":return l=t,c=r,A(S(e),this,l,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return u=t,h=r,A(function(e,t){for(var r,n,s=[],i=0;i<e.length&&!((t-=2)<0);++i)n=(r=e.charCodeAt(i))>>8,s.push(r%256),s.push(n);return s}(e,this.length-u),this,u,h);default:if(p)throw TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),p=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},o.prototype.slice=function(e,t){var r=this.length;e=~~e,t=void 0===t?r:~~t,e<0?(e+=r)<0&&(e=0):e>r&&(e=r),t<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);var n=this.subarray(e,t);return Object.setPrototypeOf(n,o.prototype),n},o.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||v(e,t,this.length);for(var n=this[e],s=1,i=0;++i<t&&(s*=256);)n+=this[e+i]*s;return n},o.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||v(e,t,this.length);for(var n=this[e+--t],s=1;t>0&&(s*=256);)n+=this[e+--t]*s;return n},o.prototype.readUInt8=function(e,t){return e>>>=0,t||v(e,1,this.length),this[e]},o.prototype.readUInt16LE=function(e,t){return e>>>=0,t||v(e,2,this.length),this[e]|this[e+1]<<8},o.prototype.readUInt16BE=function(e,t){return e>>>=0,t||v(e,2,this.length),this[e]<<8|this[e+1]},o.prototype.readUInt32LE=function(e,t){return e>>>=0,t||v(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+0x1000000*this[e+3]},o.prototype.readUInt32BE=function(e,t){return e>>>=0,t||v(e,4,this.length),0x1000000*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},o.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||v(e,t,this.length);for(var n=this[e],s=1,i=0;++i<t&&(s*=256);)n+=this[e+i]*s;return n>=(s*=128)&&(n-=Math.pow(2,8*t)),n},o.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||v(e,t,this.length);for(var n=t,s=1,i=this[e+--n];n>0&&(s*=256);)i+=this[e+--n]*s;return i>=(s*=128)&&(i-=Math.pow(2,8*t)),i},o.prototype.readInt8=function(e,t){return(e>>>=0,t||v(e,1,this.length),128&this[e])?-((255-this[e]+1)*1):this[e]},o.prototype.readInt16LE=function(e,t){e>>>=0,t||v(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?0xffff0000|r:r},o.prototype.readInt16BE=function(e,t){e>>>=0,t||v(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?0xffff0000|r:r},o.prototype.readInt32LE=function(e,t){return e>>>=0,t||v(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},o.prototype.readInt32BE=function(e,t){return e>>>=0,t||v(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},o.prototype.readFloatLE=function(e,t){return e>>>=0,t||v(e,4,this.length),s.read(this,e,!0,23,4)},o.prototype.readFloatBE=function(e,t){return e>>>=0,t||v(e,4,this.length),s.read(this,e,!1,23,4)},o.prototype.readDoubleLE=function(e,t){return e>>>=0,t||v(e,8,this.length),s.read(this,e,!0,52,8)},o.prototype.readDoubleBE=function(e,t){return e>>>=0,t||v(e,8,this.length),s.read(this,e,!1,52,8)},o.prototype.writeUIntLE=function(e,t,r,n){if(e*=1,t>>>=0,r>>>=0,!n){var s=Math.pow(2,8*r)-1;w(this,e,t,r,s,0)}var i=1,a=0;for(this[t]=255&e;++a<r&&(i*=256);)this[t+a]=e/i&255;return t+r},o.prototype.writeUIntBE=function(e,t,r,n){if(e*=1,t>>>=0,r>>>=0,!n){var s=Math.pow(2,8*r)-1;w(this,e,t,r,s,0)}var i=r-1,a=1;for(this[t+i]=255&e;--i>=0&&(a*=256);)this[t+i]=e/a&255;return t+r},o.prototype.writeUInt8=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,1,255,0),this[t]=255&e,t+1},o.prototype.writeUInt16LE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeUInt16BE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeUInt32LE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,4,0xffffffff,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},o.prototype.writeUInt32BE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,4,0xffffffff,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeIntLE=function(e,t,r,n){if(e*=1,t>>>=0,!n){var s=Math.pow(2,8*r-1);w(this,e,t,r,s-1,-s)}var i=0,a=1,o=0;for(this[t]=255&e;++i<r&&(a*=256);)e<0&&0===o&&0!==this[t+i-1]&&(o=1),this[t+i]=(e/a|0)-o&255;return t+r},o.prototype.writeIntBE=function(e,t,r,n){if(e*=1,t>>>=0,!n){var s=Math.pow(2,8*r-1);w(this,e,t,r,s-1,-s)}var i=r-1,a=1,o=0;for(this[t+i]=255&e;--i>=0&&(a*=256);)e<0&&0===o&&0!==this[t+i+1]&&(o=1),this[t+i]=(e/a|0)-o&255;return t+r},o.prototype.writeInt8=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},o.prototype.writeInt16LE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},o.prototype.writeInt16BE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},o.prototype.writeInt32LE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,4,0x7fffffff,-0x80000000),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},o.prototype.writeInt32BE=function(e,t,r){return e*=1,t>>>=0,r||w(this,e,t,4,0x7fffffff,-0x80000000),e<0&&(e=0xffffffff+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},o.prototype.writeFloatLE=function(e,t,r){return x(this,e,t,!0,r)},o.prototype.writeFloatBE=function(e,t,r){return x(this,e,t,!1,r)},o.prototype.writeDoubleLE=function(e,t,r){return O(this,e,t,!0,r)},o.prototype.writeDoubleBE=function(e,t,r){return O(this,e,t,!1,r)},o.prototype.copy=function(e,t,r,n){if(!o.isBuffer(e))throw TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r||0===e.length||0===this.length)return 0;if(t<0)throw RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw RangeError("Index out of range");if(n<0)throw RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var s=n-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,n);else if(this===e&&r<t&&t<n)for(var i=s-1;i>=0;--i)e[i+t]=this[i+r];else Uint8Array.prototype.set.call(e,this.subarray(r,n),t);return s},o.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw TypeError("encoding must be a string");if("string"==typeof n&&!o.isEncoding(n))throw TypeError("Unknown encoding: "+n);if(1===e.length){var s,i=e.charCodeAt(0);("utf8"===n&&i<128||"latin1"===n)&&(e=i)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw RangeError("Out of range index");if(r<=t)return this;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(s=t;s<r;++s)this[s]=e;else{var a=o.isBuffer(e)?e:o.from(e,n),l=a.length;if(0===l)throw TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<r-t;++s)this[s+t]=a[s%l]}return this};var k=/[^+/0-9A-Za-z-_]/g;function P(e,t){t=t||1/0;for(var r,n=e.length,s=null,i=[],a=0;a<n;++a){if((r=e.charCodeAt(a))>55295&&r<57344){if(!s){if(r>56319||a+1===n){(t-=3)>-1&&i.push(239,191,189);continue}s=r;continue}if(r<56320){(t-=3)>-1&&i.push(239,191,189),s=r;continue}r=(s-55296<<10|r-56320)+65536}else s&&(t-=3)>-1&&i.push(239,191,189);if(s=null,r<128){if((t-=1)<0)break;i.push(r)}else if(r<2048){if((t-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else if(r<1114112){if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}else throw Error("Invalid code point")}return i}function E(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}function S(e){return n.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(k,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function A(e,t,r,n){for(var s=0;s<n&&!(s+r>=t.length)&&!(s>=e.length);++s)t[s+r]=e[s];return s}function C(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}var j=function(){for(var e="0123456789abcdef",t=Array(256),r=0;r<16;++r)for(var n=16*r,s=0;s<16;++s)t[n+s]=e[r]+e[s];return t}()},783:function(e,t){t.read=function(e,t,r,n,s){var i,a,o=8*s-n-1,l=(1<<o)-1,c=l>>1,u=-7,h=r?s-1:0,d=r?-1:1,p=e[t+h];for(h+=d,i=p&(1<<-u)-1,p>>=-u,u+=o;u>0;i=256*i+e[t+h],h+=d,u-=8);for(a=i&(1<<-u)-1,i>>=-u,u+=n;u>0;a=256*a+e[t+h],h+=d,u-=8);if(0===i)i=1-c;else{if(i===l)return a?NaN:1/0*(p?-1:1);a+=Math.pow(2,n),i-=c}return(p?-1:1)*a*Math.pow(2,i-n)},t.write=function(e,t,r,n,s,i){var a,o,l,c=8*i-s-1,u=(1<<c)-1,h=u>>1,d=5960464477539062e-23*(23===s),p=n?0:i-1,f=n?1:-1,m=+(t<0||0===t&&1/t<0);for(isNaN(t=Math.abs(t))||t===1/0?(o=+!!isNaN(t),a=u):(a=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-a))<1&&(a--,l*=2),a+h>=1?t+=d/l:t+=d*Math.pow(2,1-h),t*l>=2&&(a++,l/=2),a+h>=u?(o=0,a=u):a+h>=1?(o=(t*l-1)*Math.pow(2,s),a+=h):(o=t*Math.pow(2,h-1)*Math.pow(2,s),a=0));s>=8;e[r+p]=255&o,p+=f,o/=256,s-=8);for(a=a<<s|o,c+=s;c>0;e[r+p]=255&a,p+=f,a/=256,c-=8);e[r+p-f]|=128*m}}},s={};function i(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}},a=!0;try{n[e](r,r.exports,i),a=!1}finally{a&&delete s[e]}return r.exports}i.ab="/ROOT/node_modules/next/dist/compiled/buffer/",t.exports=i(72)},31713,e=>{"use strict";let t,r,n,s,i,a,o,l,c,u,h,d;var p,f,m,g,b,y,v,w,_,x,O,k,P,E,S,A,C,j,T,N,I,R,M,$,L,D,B,F,U,K,z,V,q,W,G,J,H,Z,Y,X,Q,ee,et,er,en,es,ei,ea,eo,el,ec,eu,eh,ed,ep,ef,em,eg,eb,ey,ev,ew,e_,ex,eO,ek,eP,eE,eS,eA,eC,ej,eT,eN,eI,eR,eM,e$,eL,eD,eB,eF,eU,eK,ez,eV,eq,eW,eG,eJ,eH,eZ,eY,eX=e.i(43476),eQ=e.i(71645);function e0({children:e,onClose:t}){return(0,eX.jsx)("div",{className:"fixed inset-0 z-40 flex items-center justify-center bg-black/70 p-6",onClick:t,children:(0,eX.jsx)("div",{className:"w-full max-w-3xl rounded-3xl border border-[#1f1f26] bg-[#0f0f14] p-8 text-[#d6d6de]",onClick:e=>e.stopPropagation(),children:e})})}let e1=`You are a helpful AI agent, tasked with reading a news article and extracting important points from it.

All the news article contain useless redundant information to engage reader and increase retention, you need to help the user with this problem.
The user will provide you with the content of the page your task is to go through it understand the content and extract the key points from it.
No min/max limit on the number of points.
It should be the important information only.
The data user is providing is the scrapped site so it might contain extra information.
Use the metadata to understand the context using the title and description and then focus on that topic only.
Do not add points from your own only use the information provided in the article.

After you are done a reviewer will review your work if he finds any feedback it will be shared with you in the format 'Feedback': <feedback>,
if any feedback is present then use it to refine the points already extracted.
If no feedback then this is the first occurrence just extract the important points.`,e2=`You are a review agent. The user has seen a lot of news articles with useless redundant information so he created a important points extractor.
Your task is to review the result and come up with any feedback if required.

Provide any feedback that would remove not useful information or points. Ensure the points are precise and to the point no story telling. Ensure the agent has covered all the keys points.
Ensure the points are only relevant to the title of the article extra information is not required. Mostly I want the points that answer the question or topic raised in the title directly nothing in direct only the direct answer or fact for the point mentioned in the article

Get the points removed that do not answer the main title

Give only constructive feedback and only if necessary do not give a feedback if its not required.

To review the work you also have the fact checking tool available to you. Ensure to fact check all of the claims made by the first AI agent,
you can call this tool with the claim and it will reply yes or no based on the article and then use this to frame your feedback accordingly.
Ensure to send the entire point to the tool checker don't rephrase that part the fact check needs to verify every individual detail.

Since this is a cycle you might have already reviewed the points generated, so you might existing review comments if you do, ensure that they were followed in the next draft.

If all looks good and no feedback is required reply with only "LGTM". On the other hand if feedback is required reply with the feedback in the format 'Feedback': <feedback>.
Strictly follow the above formats i.e. either LGTM or Feedback: <Feedback>.`;function e5({onClose:e}){return(0,eX.jsxs)(e0,{onClose:e,children:[(0,eX.jsxs)("div",{className:"flex items-center justify-between",children:[(0,eX.jsx)("h2",{className:"font-[var(--font-display)] text-2xl text-white",children:"Architecture overview"}),(0,eX.jsx)("button",{onClick:e,className:"rounded-full border border-[#2a2a33] px-3 py-1 text-xs uppercase tracking-[0.2em]",children:"Close"})]}),(0,eX.jsx)("p",{className:"mt-4 text-sm text-[#b5b5bf]",children:"Clickbait Lense runs an agentic LangGraph pipeline on the client. It scrapes or ingests article content, builds a focused prompt, and iterates with a reviewer. Optional fact checking runs via a local Ollama model."}),(0,eX.jsxs)("div",{className:"mt-6 grid gap-4 md:grid-cols-2",children:[(0,eX.jsxs)("div",{className:"rounded-2xl border border-[#24242c] bg-[#101017] p-4",children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Extractor prompt"}),(0,eX.jsxs)("p",{className:"mt-2 text-xs text-[#c9c9d3]",children:[e1.slice(0,240),"..."]})]}),(0,eX.jsxs)("div",{className:"rounded-2xl border border-[#24242c] bg-[#101017] p-4",children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Reviewer prompt"}),(0,eX.jsxs)("p",{className:"mt-2 text-xs text-[#c9c9d3]",children:[e2.slice(0,240),"..."]})]})]})]})}function e3({onAbout:e,onSettings:t}){return(0,eX.jsxs)("header",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[(0,eX.jsxs)("div",{children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Clickbait Lense"}),(0,eX.jsx)("h1",{className:"mt-3 font-[var(--font-display)] text-3xl text-white sm:text-4xl",children:"Extract what matters, leave the fluff."})]}),(0,eX.jsxs)("div",{className:"flex flex-wrap items-center gap-3 text-xs",children:[(0,eX.jsx)("button",{onClick:e,className:"w-full rounded-full border border-[#2a2a33] px-4 py-2 text-[#d1d1d6] sm:w-auto",children:"About the system"}),(0,eX.jsx)("button",{onClick:t,className:"w-full rounded-full border border-[#2a2a33] px-4 py-2 text-[#d1d1d6] sm:w-auto",children:"Models + keys"}),(0,eX.jsx)("button",{className:"w-full rounded-full border border-[#2a2a33] px-4 py-2 text-[#d1d1d6] sm:w-auto",children:"View samples"})]})]})}function e4(e){switch(e){case"direct":default:return"Direct fetch";case"jina":return"Jina reader";case"proxy":return"Local proxy";case"paste":return"Paste content"}}let e8="node -e \"process.env.NODE_TLS_REJECT_UNAUTHORIZED='0';import('http').then(http=>import('https').then(https=>import('url').then(({URL})=>{http.createServer((req,res)=>{const target=req.url.slice(1);if(!target||!target.startsWith('http')){res.writeHead(400);return res.end('Provide full URL like /https://example.com');}const url=new URL(target);const client=url.protocol==='https:'?https: http;client.get(url,(proxyRes)=>{res.writeHead(proxyRes.statusCode,{...proxyRes.headers,'access-control-allow-origin':'*'});proxyRes.pipe(res);}).on('error',(err)=>{res.writeHead(500);res.end(err.toString());});}).listen(3000,()=>console.log('Proxy running at http://localhost:3000/'));})));\"";function e6({onCopy:e}){return(0,eX.jsxs)("div",{className:"mt-4 w-full max-w-full overflow-hidden rounded-2xl border border-[#23232b] bg-[#0f0f14] p-4 text-xs text-[#b4b4be]",children:[(0,eX.jsx)("p",{className:"text-[#e0b87b]",children:"Local proxy"}),(0,eX.jsxs)("p",{className:"mt-2",children:["Run this once, then prefix URLs with",(0,eX.jsx)("span",{className:"text-white",children:" http://localhost:3000/"})]}),(0,eX.jsxs)("div",{className:"mt-3 flex min-w-0 items-center gap-2 rounded-xl border border-[#22222a] bg-[#0b0b0f] px-3 py-2",children:[(0,eX.jsx)("div",{className:"min-w-0 flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-[11px] text-[#c7c7d1]",children:e8}),(0,eX.jsx)("button",{onClick:e,className:"rounded-full border border-[#2a2a33] px-3 py-1 text-[10px] uppercase tracking-[0.2em] text-[#d1d1d6]",children:"Copy"})]})]})}function e7({url:e,content:t,sourceMode:r,lastUrlMode:n,showProxy:s,onUrlChange:i,onContentChange:a,onRun:o,onModeChange:l,onToggleProxy:c,onCopyProxy:u,isRunning:h}){return(0,eX.jsxs)("div",{className:"min-w-0 rounded-3xl border border-[#1f1f26] bg-[#111115]/90 p-5 shadow-[0_20px_60px_rgba(0,0,0,0.35)] sm:p-7",children:[(0,eX.jsx)("div",{className:"flex items-center justify-between",children:(0,eX.jsxs)("div",{children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Input"}),(0,eX.jsx)("h2",{className:"mt-2 font-[var(--font-display)] text-xl text-white sm:text-2xl",children:"Article source"})]})}),(0,eX.jsxs)("div",{className:"mt-6",children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.25em] text-[#a1a1aa]",children:"Input path"}),(0,eX.jsxs)("div",{className:"mt-3 grid gap-3 sm:grid-cols-2",children:[(0,eX.jsxs)("button",{onClick:()=>l(n),className:`rounded-2xl border p-4 text-left transition ${"paste"!==r?"border-[#e0b87b] bg-[#15131a]":"border-[#23232b] bg-[#0f0f14] hover:border-[#3a3a46]"}`,children:[(0,eX.jsx)("p",{className:"text-sm font-semibold text-white",children:"Use URL"}),(0,eX.jsx)("p",{className:"mt-1 text-xs text-[#8f8f9b]",children:"Fetch from a link"})]}),(0,eX.jsxs)("button",{onClick:()=>l("paste"),className:`rounded-2xl border p-4 text-left transition ${"paste"===r?"border-[#e0b87b] bg-[#15131a]":"border-[#23232b] bg-[#0f0f14] hover:border-[#3a3a46]"}`,children:[(0,eX.jsx)("p",{className:"text-sm font-semibold text-white",children:"Paste content"}),(0,eX.jsx)("p",{className:"mt-1 text-xs text-[#8f8f9b]",children:"Skip the scrapper"})]})]}),(0,eX.jsxs)("p",{className:"mt-2 text-xs text-[#7c7c86]",children:["Active: ","paste"===r?"Paste content":"URL"]})]}),"paste"!==r?(0,eX.jsxs)(eX.Fragment,{children:[(0,eX.jsxs)("div",{className:"mt-6",children:[(0,eX.jsx)("label",{className:"text-xs uppercase tracking-[0.25em] text-[#a1a1aa]",children:"URL"}),(0,eX.jsxs)("div",{className:"mt-2 flex flex-wrap items-center gap-3 rounded-2xl border border-[#23232b] bg-[#0d0d11] p-3",children:[(0,eX.jsx)("input",{value:e,onChange:e=>i(e.target.value),placeholder:"https://example.com/news/article",className:"flex-1 bg-transparent text-sm text-white outline-none placeholder:text-[#5c5c66]"}),(0,eX.jsx)("button",{onClick:o,className:"w-full rounded-full bg-[#e0b87b] px-4 py-2 text-xs uppercase tracking-[0.2em] text-[#1c1408] sm:w-auto",children:h?"Running":"Run lens"})]})]}),(0,eX.jsxs)("div",{className:"mt-6",children:[(0,eX.jsx)("div",{className:"flex items-center justify-between",children:(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.25em] text-[#a1a1aa]",children:"Source mode"})}),(0,eX.jsx)("div",{className:"mt-3 grid gap-3 sm:grid-cols-3",children:[{label:"Direct",desc:"Fetch the URL from the browser",mode:"direct"},{label:"Jina",desc:"Reader API fallback",mode:"jina"},{label:"Proxy",desc:"Local CORS bridge",mode:"proxy"}].map(e=>(0,eX.jsxs)("button",{onClick:()=>l(e.mode),className:`rounded-2xl border p-4 text-left transition ${r===e.mode?"border-[#e0b87b] bg-[#15131a]":"border-[#23232b] bg-[#0f0f14] hover:border-[#3a3a46]"}`,children:[(0,eX.jsx)("p",{className:"text-sm font-semibold text-white",children:e.label}),(0,eX.jsx)("p",{className:"mt-1 text-xs text-[#8f8f9b]",children:e.desc})]},e.label))}),"proxy"===r?(0,eX.jsx)("div",{className:"mt-3",children:(0,eX.jsx)("button",{onClick:c,className:"text-xs text-[#aab8d1]",children:"Proxy instructions"})}):null,s?(0,eX.jsx)(e6,{onCopy:u}):null]})]}):(0,eX.jsxs)("div",{className:"mt-6 rounded-2xl border border-[#23232b] bg-[#0d0d11] p-4",children:[(0,eX.jsxs)("div",{className:"flex items-center justify-between",children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.25em] text-[#a1a1aa]",children:"Paste content"}),(0,eX.jsx)("button",{onClick:()=>l("paste"),className:`rounded-full border px-3 py-1 text-[11px] uppercase tracking-[0.2em] ${"paste"===r?"border-[#e0b87b] text-[#e0b87b]":"border-[#2a2a33] text-[#a1a1aa]"}`,children:"paste"===r?"Active":"Skip scrapper"})]}),(0,eX.jsx)("textarea",{value:t,onChange:e=>a(e.target.value),className:"mt-3 min-h-[120px] w-full resize-none bg-transparent text-sm text-white outline-none placeholder:text-[#5b5b66]",placeholder:"Paste article content here when URLs are blocked."}),"paste"===r?(0,eX.jsx)("button",{onClick:o,className:"mt-3 w-full rounded-full bg-[#e0b87b] px-4 py-2 text-xs uppercase tracking-[0.2em] text-[#1c1408]",children:h?"Running":"Run lens"}):null,(0,eX.jsxs)("p",{className:"mt-2 text-xs text-[#7c7c86]",children:["Mode: ",e4(r)]})]})]})}function e9({isRunning:e,keyPoints:t,onDownload:r}){let n=t.length>0;return(0,eX.jsxs)("div",{className:"min-w-0 rounded-[32px] border border-[#1f1f26] bg-[#101015] p-6 shadow-[0_24px_70px_rgba(0,0,0,0.45)] sm:p-9",children:[(0,eX.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[(0,eX.jsxs)("div",{children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Output"}),(0,eX.jsx)("h3",{className:"mt-2 font-[var(--font-display)] text-2xl text-white sm:text-3xl",children:"Key points"}),(0,eX.jsx)("p",{className:"mt-2 text-sm text-[#9d9da7]",children:e?"Running the agent graph now.":"This is the primary result. It expands once the run is complete."})]}),(0,eX.jsxs)("div",{className:"flex flex-wrap items-center gap-3",children:[(0,eX.jsx)("span",{className:"rounded-full border border-[#2a2a33] px-3 py-1 text-xs uppercase tracking-[0.2em] text-[#a1a1aa]",children:e?"Running":n?"Complete":"Awaiting output"}),(0,eX.jsx)("button",{onClick:r,className:"w-full rounded-full border border-[#2a2a33] px-4 py-2 text-xs uppercase tracking-[0.2em] text-[#e0b87b] sm:w-auto",children:"Save sample"})]})]}),(0,eX.jsxs)("div",{className:"mt-6 grid gap-4",children:[n?null:(0,eX.jsxs)("div",{className:"rounded-3xl border border-[#26262f] bg-gradient-to-br from-[#14141c] via-[#101017] to-[#0e0e14] p-6",children:[(0,eX.jsx)("p",{className:"text-sm uppercase tracking-[0.3em] text-[#7b7b86]",children:"Headline focus"}),(0,eX.jsx)("p",{className:"mt-3 text-lg text-[#e6e6ef]",children:"Structured bullet points appear here once the graph finishes or completes a review loop."})]}),(0,eX.jsx)("div",{className:"grid gap-4 md:grid-cols-2",children:(n?t:["Key point one will appear as a focused, evidence-backed bullet.","Key point two highlights the essential facts and removes filler.","Key point three captures the timeline or outcome.","Key point four preserves only what the article supports."]).map(e=>(0,eX.jsx)("div",{className:"rounded-2xl border border-[#22222a] bg-[#0f0f14] p-4 text-sm text-[#d2d2d8]",children:e},e))})]})]})}let te=[{label:"gpt-5-mini",provider:"openai"},{label:"gpt-4o",provider:"openai"},{label:"llama3.1:8b",provider:"ollama"},{label:"bespoke-minicheck",provider:"ollama"}];function tt({settings:e,onChange:t,onClose:r}){return(0,eX.jsxs)(e0,{onClose:r,children:[(0,eX.jsxs)("div",{className:"flex items-center justify-between",children:[(0,eX.jsx)("h2",{className:"font-[var(--font-display)] text-2xl text-white",children:"Models and API keys"}),(0,eX.jsx)("button",{onClick:r,className:"rounded-full border border-[#2a2a33] px-3 py-1 text-xs uppercase tracking-[0.2em]",children:"Close"})]}),(0,eX.jsx)("p",{className:"mt-3 text-sm text-[#9d9da7]",children:"Keys are stored locally in your browser. Choose the provider and model per run."}),(0,eX.jsxs)("div",{className:"mt-6 grid gap-6 md:grid-cols-2",children:[(0,eX.jsxs)("div",{children:[(0,eX.jsx)("label",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Provider"}),(0,eX.jsxs)("div",{className:"relative mt-2",children:[(0,eX.jsxs)("select",{value:e.provider,onChange:r=>t({...e,provider:r.target.value}),className:"w-full appearance-none rounded-2xl border border-[#2a2a33] bg-[#0b0b0f] px-4 py-3 pr-10 text-sm text-white",children:[(0,eX.jsx)("option",{value:"openai",children:"OpenAI"}),(0,eX.jsx)("option",{value:"ollama",children:"Ollama"}),(0,eX.jsx)("option",{value:"google",children:"Google"}),(0,eX.jsx)("option",{value:"other",children:"Other"})]}),(0,eX.jsx)("span",{className:"pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-xs text-[#8f8f9b]",children:"â–¼"})]})]}),(0,eX.jsxs)("div",{children:[(0,eX.jsx)("label",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Model"}),(0,eX.jsx)("input",{value:e.model,onChange:r=>t({...e,model:r.target.value}),className:"mt-2 w-full rounded-2xl border border-[#2a2a33] bg-[#0b0b0f] px-4 py-3 text-sm text-white",placeholder:"gpt-5-mini"}),(0,eX.jsx)("div",{className:"mt-3 flex flex-wrap gap-2",children:te.map(r=>(0,eX.jsx)("button",{onClick:()=>t({...e,model:r.label,provider:r.provider}),className:"rounded-full border border-[#2a2a33] px-3 py-1 text-[11px] uppercase tracking-[0.2em] text-[#d1d1d6]",children:r.label},r.label))})]}),(0,eX.jsxs)("div",{className:"md:col-span-2",children:[(0,eX.jsx)("label",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"API key"}),(0,eX.jsx)("input",{value:e.apiKey,onChange:r=>t({...e,apiKey:r.target.value}),className:"mt-2 w-full rounded-2xl border border-[#2a2a33] bg-[#0b0b0f] px-4 py-3 text-sm text-white",placeholder:"Stored locally only"})]}),(0,eX.jsxs)("div",{className:"md:col-span-2",children:[(0,eX.jsx)("label",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Jina API key (optional)"}),(0,eX.jsx)("input",{value:e.jinaKey,onChange:r=>t({...e,jinaKey:r.target.value}),className:"mt-2 w-full rounded-2xl border border-[#2a2a33] bg-[#0b0b0f] px-4 py-3 text-sm text-white",placeholder:"Bearer token"})]}),(0,eX.jsxs)("div",{className:"md:col-span-2",children:[(0,eX.jsxs)("label",{className:"flex items-center justify-between rounded-2xl border border-[#2a2a33] bg-[#0b0b0f] px-4 py-3 text-sm text-white",children:[(0,eX.jsx)("span",{children:"Enable fact checking (Ollama)"}),(0,eX.jsx)("input",{type:"checkbox",checked:e.factCheckEnabled,onChange:r=>t({...e,factCheckEnabled:r.target.checked}),className:"h-4 w-4"})]}),(0,eX.jsx)("p",{className:"mt-2 text-xs text-[#8b8b95]",children:"Fact checking uses the local `bespoke-minicheck` model."})]})]})]})}function tr({settings:e,sourceMode:t,onAbout:r}){return(0,eX.jsxs)("div",{className:"min-w-0 rounded-3xl border border-[#1f1f26] bg-[#0f0f14] p-6 sm:p-7",children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"System health"}),(0,eX.jsxs)("div",{className:"mt-4 space-y-3 text-sm text-[#c4c4cc]",children:[(0,eX.jsxs)("div",{className:"flex items-center justify-between",children:[(0,eX.jsx)("span",{children:"Main model"}),(0,eX.jsx)("span",{className:"text-[#e0b87b]",children:e.model})]}),(0,eX.jsxs)("div",{className:"flex items-center justify-between",children:[(0,eX.jsx)("span",{children:"Fact checking"}),(0,eX.jsx)("span",{className:"text-[#7dd3fc]",children:e.factCheckEnabled?"Enabled (Ollama)":"Disabled"})]}),(0,eX.jsxs)("div",{className:"flex items-center justify-between",children:[(0,eX.jsx)("span",{children:"Source mode"}),(0,eX.jsx)("span",{className:"text-[#a1a1aa]",children:e4(t)})]})]}),(0,eX.jsx)("button",{onClick:r,className:"mt-6 w-full rounded-2xl border border-[#2a2a33] px-4 py-3 text-xs uppercase tracking-[0.3em] text-[#d1d1d6]",children:"View architecture"})]})}function tn({timeline:e}){return(0,eX.jsxs)("div",{className:"min-w-0 rounded-3xl border border-[#1f1f26] bg-[#101015] p-6 sm:p-7",children:[(0,eX.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-[#a1a1aa]",children:"Execution"}),(0,eX.jsx)("h3",{className:"mt-2 font-[var(--font-display)] text-xl text-white sm:text-2xl",children:"Graph timeline"}),(0,eX.jsx)("p",{className:"mt-3 text-sm text-[#9d9da7]",children:"Each node can repeat. Tool calls nest under the node that triggered them."}),(0,eX.jsx)("div",{className:"mt-6 space-y-3",children:e.map((e,t)=>(0,eX.jsxs)("details",{className:"group rounded-2xl border border-[#24242c] bg-[#0f0f14] p-4",children:[(0,eX.jsxs)("summary",{className:"flex cursor-pointer list-none items-center justify-between text-sm text-white",children:[(0,eX.jsx)("span",{className:"font-mono text-xs text-[#7b7b86]",children:String(t+1).padStart(2,"0")}),(0,eX.jsx)("span",{className:"flex-1 px-3",children:e.title}),(0,eX.jsx)("span",{className:"text-xs text-[#a1a1aa]",children:e.summary})]}),(0,eX.jsx)("p",{className:"mt-3 text-xs text-[#9a9aac]",children:e.detail}),e.toolCalls.length>0?(0,eX.jsx)("div",{className:"mt-4 space-y-2",children:e.toolCalls.map(e=>(0,eX.jsx)("div",{className:"rounded-xl border border-[#2a2a33] bg-[#121219] px-3 py-2 text-[11px] text-[#c7c7d1]",children:e},e))}):null]},`${e.title}-${t}`))})]})}function ts({toasts:e}){return(0,eX.jsx)("div",{className:"fixed right-6 top-6 z-50 space-y-2",children:e.map(e=>(0,eX.jsx)("div",{className:`rounded-2xl border px-4 py-3 text-xs uppercase tracking-[0.2em] ${"error"===e.type?"border-[#3b1b1b] bg-[#1a0c0c] text-[#ff9c9c]":"success"===e.type?"border-[#1f3a28] bg-[#0f1a12] text-[#7be3a0]":"border-[#2a2a33] bg-[#0f0f14] text-[#d1d1d6]"}`,children:e.message},e.id))})}e.i(33953);var ti=e.i(65161),ta=e.i(65898),to=e.i(41290),tl=e.i(44649),tc=e.i(80666),tu=e.i(1828),th=e.i(57933),td=e.i(79059),tp=e.i(95529),tf=e.i(50579),tm=e.i(99855);e.s(["AIMessage",()=>to.AIMessage,"AIMessageChunk",()=>to.AIMessageChunk,"BaseMessage",()=>tl.BaseMessage,"BaseMessageChunk",()=>tl.BaseMessageChunk,"ChatMessage",()=>tc.ChatMessage,"ChatMessageChunk",()=>tc.ChatMessageChunk,"FunctionMessage",()=>tu.FunctionMessage,"FunctionMessageChunk",()=>tu.FunctionMessageChunk,"HumanMessage",()=>ti.HumanMessage,"HumanMessageChunk",()=>ti.HumanMessageChunk,"RemoveMessage",()=>tp.RemoveMessage,"SystemMessage",()=>ta.SystemMessage,"SystemMessageChunk",()=>ta.SystemMessageChunk,"ToolMessage",()=>tm.ToolMessage,"ToolMessageChunk",()=>tm.ToolMessageChunk,"_isMessageFieldWithRole",()=>tl._isMessageFieldWithRole,"_mergeDicts",()=>tl._mergeDicts,"_mergeLists",()=>tl._mergeLists,"_mergeObj",()=>tl._mergeObj,"_mergeStatus",()=>tl._mergeStatus,"coerceMessageLikeToMessage",()=>th.coerceMessageLikeToMessage,"convertToChunk",()=>th.convertToChunk,"convertToOpenAIImageBlock",()=>tf.convertToOpenAIImageBlock,"convertToProviderContentBlock",()=>tf.convertToProviderContentBlock,"defaultTextSplitter",()=>td.defaultTextSplitter,"filterMessages",()=>td.filterMessages,"getBufferString",()=>th.getBufferString,"isAIMessage",()=>to.isAIMessage,"isAIMessageChunk",()=>to.isAIMessageChunk,"isBase64ContentBlock",()=>tf.isBase64ContentBlock,"isBaseMessage",()=>tl.isBaseMessage,"isBaseMessageChunk",()=>tl.isBaseMessageChunk,"isChatMessage",()=>tc.isChatMessage,"isChatMessageChunk",()=>tc.isChatMessageChunk,"isDataContentBlock",()=>tf.isDataContentBlock,"isFunctionMessage",()=>tu.isFunctionMessage,"isFunctionMessageChunk",()=>tu.isFunctionMessageChunk,"isHumanMessage",()=>ti.isHumanMessage,"isHumanMessageChunk",()=>ti.isHumanMessageChunk,"isIDContentBlock",()=>tf.isIDContentBlock,"isOpenAIToolCallArray",()=>tl.isOpenAIToolCallArray,"isPlainTextContentBlock",()=>tf.isPlainTextContentBlock,"isSystemMessage",()=>ta.isSystemMessage,"isSystemMessageChunk",()=>ta.isSystemMessageChunk,"isToolMessage",()=>tm.isToolMessage,"isToolMessageChunk",()=>tm.isToolMessageChunk,"isURLContentBlock",()=>tf.isURLContentBlock,"mapChatMessagesToStoredMessages",()=>th.mapChatMessagesToStoredMessages,"mapStoredMessageToChatMessage",()=>th.mapStoredMessageToChatMessage,"mapStoredMessagesToChatMessages",()=>th.mapStoredMessagesToChatMessages,"mergeContent",()=>tl.mergeContent,"mergeMessageRuns",()=>td.mergeMessageRuns,"parseBase64DataUrl",()=>tf.parseBase64DataUrl,"parseMimeType",()=>tf.parseMimeType,"trimMessages",()=>td.trimMessages],92863);var tm=tm,tg=e.i(50270);e.i(53723);var tb=e.i(27768),ty=e.i(54809),tv="object"==typeof window?window:{},tw="0123456789abcdef".split(""),t_=[-0x80000000,8388608,32768,128],tx=[24,16,8,0],tO=[];function tk(e){e?(tO[0]=tO[16]=tO[1]=tO[2]=tO[3]=tO[4]=tO[5]=tO[6]=tO[7]=tO[8]=tO[9]=tO[10]=tO[11]=tO[12]=tO[13]=tO[14]=tO[15]=0,this.blocks=tO):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=0x67452301,this.h1=0xefcdab89,this.h2=0x98badcfe,this.h3=0x10325476,this.h4=0xc3d2e1f0,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}tk.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===tv.ArrayBuffer&&(e=new Uint8Array(e));for(var r,n,s=0,i=e.length||0,a=this.blocks;s<i;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),t)for(n=this.start;s<i&&n<64;++s)a[n>>2]|=e[s]<<tx[3&n++];else for(n=this.start;s<i&&n<64;++s)(r=e.charCodeAt(s))<128?a[n>>2]|=r<<tx[3&n++]:(r<2048?a[n>>2]|=(192|r>>6)<<tx[3&n++]:(r<55296||r>=57344?a[n>>2]|=(224|r>>12)<<tx[3&n++]:(r=65536+((1023&r)<<10|1023&e.charCodeAt(++s)),a[n>>2]|=(240|r>>18)<<tx[3&n++],a[n>>2]|=(128|r>>12&63)<<tx[3&n++]),a[n>>2]|=(128|r>>6&63)<<tx[3&n++]),a[n>>2]|=(128|63&r)<<tx[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=a[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},tk.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=t_[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},tk.prototype.hash=function(){var e,t,r,n=this.h0,s=this.h1,i=this.h2,a=this.h3,o=this.h4,l=this.blocks;for(t=16;t<80;++t)r=l[t-3]^l[t-8]^l[t-14]^l[t-16],l[t]=r<<1|r>>>31;for(t=0;t<20;t+=5)e=s&i|~s&a,o=(r=n<<5|n>>>27)+e+o+0x5a827999+l[t]|0,e=n&(s=s<<30|s>>>2)|~n&i,a=(r=o<<5|o>>>27)+e+a+0x5a827999+l[t+1]|0,e=o&(n=n<<30|n>>>2)|~o&s,i=(r=a<<5|a>>>27)+e+i+0x5a827999+l[t+2]|0,e=a&(o=o<<30|o>>>2)|~a&n,s=(r=i<<5|i>>>27)+e+s+0x5a827999+l[t+3]|0,e=i&(a=a<<30|a>>>2)|~i&o,n=(r=s<<5|s>>>27)+e+n+0x5a827999+l[t+4]|0,i=i<<30|i>>>2;for(;t<40;t+=5)e=s^i^a,o=(r=n<<5|n>>>27)+e+o+0x6ed9eba1+l[t]|0,e=n^(s=s<<30|s>>>2)^i,a=(r=o<<5|o>>>27)+e+a+0x6ed9eba1+l[t+1]|0,e=o^(n=n<<30|n>>>2)^s,i=(r=a<<5|a>>>27)+e+i+0x6ed9eba1+l[t+2]|0,e=a^(o=o<<30|o>>>2)^n,s=(r=i<<5|i>>>27)+e+s+0x6ed9eba1+l[t+3]|0,e=i^(a=a<<30|a>>>2)^o,n=(r=s<<5|s>>>27)+e+n+0x6ed9eba1+l[t+4]|0,i=i<<30|i>>>2;for(;t<60;t+=5)e=s&i|s&a|i&a,o=(r=n<<5|n>>>27)+e+o-0x70e44324+l[t]|0,e=n&(s=s<<30|s>>>2)|n&i|s&i,a=(r=o<<5|o>>>27)+e+a-0x70e44324+l[t+1]|0,e=o&(n=n<<30|n>>>2)|o&s|n&s,i=(r=a<<5|a>>>27)+e+i-0x70e44324+l[t+2]|0,e=a&(o=o<<30|o>>>2)|a&n|o&n,s=(r=i<<5|i>>>27)+e+s-0x70e44324+l[t+3]|0,e=i&(a=a<<30|a>>>2)|i&o|a&o,n=(r=s<<5|s>>>27)+e+n-0x70e44324+l[t+4]|0,i=i<<30|i>>>2;for(;t<80;t+=5)e=s^i^a,o=(r=n<<5|n>>>27)+e+o-0x359d3e2a+l[t]|0,e=n^(s=s<<30|s>>>2)^i,a=(r=o<<5|o>>>27)+e+a-0x359d3e2a+l[t+1]|0,e=o^(n=n<<30|n>>>2)^s,i=(r=a<<5|a>>>27)+e+i-0x359d3e2a+l[t+2]|0,e=a^(o=o<<30|o>>>2)^n,s=(r=i<<5|i>>>27)+e+s-0x359d3e2a+l[t+3]|0,e=i^(a=a<<30|a>>>2)^o,n=(r=s<<5|s>>>27)+e+n-0x359d3e2a+l[t+4]|0,i=i<<30|i>>>2;this.h0=this.h0+n|0,this.h1=this.h1+s|0,this.h2=this.h2+i|0,this.h3=this.h3+a|0,this.h4=this.h4+o|0},tk.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,s=this.h4;return tw[e>>28&15]+tw[e>>24&15]+tw[e>>20&15]+tw[e>>16&15]+tw[e>>12&15]+tw[e>>8&15]+tw[e>>4&15]+tw[15&e]+tw[t>>28&15]+tw[t>>24&15]+tw[t>>20&15]+tw[t>>16&15]+tw[t>>12&15]+tw[t>>8&15]+tw[t>>4&15]+tw[15&t]+tw[r>>28&15]+tw[r>>24&15]+tw[r>>20&15]+tw[r>>16&15]+tw[r>>12&15]+tw[r>>8&15]+tw[r>>4&15]+tw[15&r]+tw[n>>28&15]+tw[n>>24&15]+tw[n>>20&15]+tw[n>>16&15]+tw[n>>12&15]+tw[n>>8&15]+tw[n>>4&15]+tw[15&n]+tw[s>>28&15]+tw[s>>24&15]+tw[s>>20&15]+tw[s>>16&15]+tw[s>>12&15]+tw[s>>8&15]+tw[s>>4&15]+tw[15&s]},tk.prototype.toString=tk.prototype.hex,tk.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,s>>24&255,s>>16&255,s>>8&255,255&s]},tk.prototype.array=tk.prototype.digest,tk.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};let tP=!1,tE=e=>(tP||(console.warn(`The default method for hashing keys is insecure and will be replaced in a future version,
but hasn't been replaced yet as to not break existing caches. It's recommended that you use
a more secure hashing algorithm to avoid cache poisoning.

See this page for more information:
|
â””> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm`),tP=!0),new tk(!0).update(e).hex());var tS="0123456789abcdef".split(""),tA=[-0x80000000,8388608,32768,128],tC=[24,16,8,0],tj=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2],tT=[];function tN(e,t){t?(tT[0]=tT[16]=tT[1]=tT[2]=tT[3]=tT[4]=tT[5]=tT[6]=tT[7]=tT[8]=tT[9]=tT[10]=tT[11]=tT[12]=tT[13]=tT[14]=tT[15]=0,this.blocks=tT):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=0xc1059ed8,this.h1=0x367cd507,this.h2=0x3070dd17,this.h3=0xf70e5939,this.h4=0xffc00b31,this.h5=0x68581511,this.h6=0x64f98fa7,this.h7=0xbefa4fa4):(this.h0=0x6a09e667,this.h1=0xbb67ae85,this.h2=0x3c6ef372,this.h3=0xa54ff53a,this.h4=0x510e527f,this.h5=0x9b05688c,this.h6=0x1f83d9ab,this.h7=0x5be0cd19),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}tN.prototype.update=function(e){if(!this.finalized){var t,r=typeof e;if("string"!==r){if("object"===r){if(null===e)throw Error(ERROR);else if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(e)))throw Error(ERROR)}else throw Error(ERROR);t=!0}for(var n,s,i=0,a=e.length,o=this.blocks;i<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(s=this.start;i<a&&s<64;++i)o[s>>>2]|=e[i]<<tC[3&s++];else for(s=this.start;i<a&&s<64;++i)(n=e.charCodeAt(i))<128?o[s>>>2]|=n<<tC[3&s++]:(n<2048?o[s>>>2]|=(192|n>>>6)<<tC[3&s++]:(n<55296||n>=57344?o[s>>>2]|=(224|n>>>12)<<tC[3&s++]:(n=65536+((1023&n)<<10|1023&e.charCodeAt(++i)),o[s>>>2]|=(240|n>>>18)<<tC[3&s++],o[s>>>2]|=(128|n>>>12&63)<<tC[3&s++]),o[s>>>2]|=(128|n>>>6&63)<<tC[3&s++]),o[s>>>2]|=(128|63&n)<<tC[3&s++]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=o[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},tN.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=tA[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},tN.prototype.hash=function(){var e,t,r,n,s,i,a,o,l,c,u=this.h0,h=this.h1,d=this.h2,p=this.h3,f=this.h4,m=this.h5,g=this.h6,b=this.h7,y=this.blocks;for(e=16;e<64;++e)t=((s=y[e-15])>>>7|s<<25)^(s>>>18|s<<14)^s>>>3,r=((s=y[e-2])>>>17|s<<15)^(s>>>19|s<<13)^s>>>10,y[e]=y[e-16]+t+y[e-7]+r|0;for(e=0,c=h&d;e<64;e+=4)this.first?(this.is224?(a=300032,b=(s=y[0]-0x543c9a5b)-0x8f1a6c7|0,p=s+0x170e9b5|0):(a=0x2a01a605,b=(s=y[0]-0xc881298)-0x5ab00ac6|0,p=s+0x8909ae5|0),this.first=!1):(t=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),r=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),n=(a=u&h)^u&d^c,s=b+r+(f&m^~f&g)+tj[e]+y[e],i=t+n,b=p+s|0,p=s+i|0),t=(p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10),r=(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7),n=(o=p&u)^p&h^a,s=m+r+(g&b^~g&f)+tj[e+1]+y[e+1],i=t+n,g=d+s|0,t=((d=s+i|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7),n=(l=d&p)^d&u^o,s=f+r+(m&g^~m&b)+tj[e+2]+y[e+2],i=t+n,m=h+s|0,t=((h=s+i|0)>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7),n=(c=h&d)^h&p^l,s=f+r+(m&g^~m&b)+tj[e+3]+y[e+3],i=t+n,f=u+s|0,u=s+i|0,this.chromeBugWorkAround=!0;this.h0=this.h0+u|0,this.h1=this.h1+h|0,this.h2=this.h2+d|0,this.h3=this.h3+p|0,this.h4=this.h4+f|0,this.h5=this.h5+m|0,this.h6=this.h6+g|0,this.h7=this.h7+b|0},tN.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,l=tS[e>>>28&15]+tS[e>>>24&15]+tS[e>>>20&15]+tS[e>>>16&15]+tS[e>>>12&15]+tS[e>>>8&15]+tS[e>>>4&15]+tS[15&e]+tS[t>>>28&15]+tS[t>>>24&15]+tS[t>>>20&15]+tS[t>>>16&15]+tS[t>>>12&15]+tS[t>>>8&15]+tS[t>>>4&15]+tS[15&t]+tS[r>>>28&15]+tS[r>>>24&15]+tS[r>>>20&15]+tS[r>>>16&15]+tS[r>>>12&15]+tS[r>>>8&15]+tS[r>>>4&15]+tS[15&r]+tS[n>>>28&15]+tS[n>>>24&15]+tS[n>>>20&15]+tS[n>>>16&15]+tS[n>>>12&15]+tS[n>>>8&15]+tS[n>>>4&15]+tS[15&n]+tS[s>>>28&15]+tS[s>>>24&15]+tS[s>>>20&15]+tS[s>>>16&15]+tS[s>>>12&15]+tS[s>>>8&15]+tS[s>>>4&15]+tS[15&s]+tS[i>>>28&15]+tS[i>>>24&15]+tS[i>>>20&15]+tS[i>>>16&15]+tS[i>>>12&15]+tS[i>>>8&15]+tS[i>>>4&15]+tS[15&i]+tS[a>>>28&15]+tS[a>>>24&15]+tS[a>>>20&15]+tS[a>>>16&15]+tS[a>>>12&15]+tS[a>>>8&15]+tS[a>>>4&15]+tS[15&a];return this.is224||(l+=tS[o>>>28&15]+tS[o>>>24&15]+tS[o>>>20&15]+tS[o>>>16&15]+tS[o>>>12&15]+tS[o>>>8&15]+tS[o>>>4&15]+tS[15&o]),l},tN.prototype.toString=tN.prototype.hex,tN.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,r>>>24&255,r>>>16&255,r>>>8&255,255&r,n>>>24&255,n>>>16&255,n>>>8&255,255&n,s>>>24&255,s>>>16&255,s>>>8&255,255&s,i>>>24&255,i>>>16&255,i>>>8&255,255&i,a>>>24&255,a>>>16&255,a>>>8&255,255&a];return this.is224||l.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),l},tN.prototype.array=tN.prototype.digest,tN.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},e.s([],52541);let tI=(...e)=>tE(e.join("_"));function tR(e){return void 0!==e.message?{text:e.text,message:(0,th.mapStoredMessageToChatMessage)(e.message)}:{text:e.text}}function tM(e){let t={text:e.text};return void 0!==e.message&&(t.message=e.message.toDict()),t}class t${constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:tI})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}let tL=new Map;class tD extends t${constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,r){this.cache.set(this.keyEncoder(e,t),r)}static global(){return new tD(tL)}}e.s(["BaseCache",()=>t$,"InMemoryCache",()=>tD,"deserializeStoredGeneration",()=>tR,"getCacheKey",0,tI,"serializeGeneration",()=>tM],38394);var tB=e.i(96170),tF=e.i(88155),tU=e.i(34582),tK=Object.defineProperty,tz=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){for(const[t,r]of(this.patStr=e.pat_str,Object.entries(e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{let[r,n,...s]=t.split(" "),i=Number.parseInt(n,10);return s.forEach((t,r)=>e[t]=i+r),e},{})))){const e=tU.default.toByteArray(t);this.rankMap.set(e.join(","),r),this.textMap.set(r,e)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){let n=RegExp(this.patStr,"ug"),s=tz.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!a.has(e)):r);if(o.size>0){let t=tz.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;s.lastIndex=r,!(null==(t=s.exec(e))||a.has(t[0]));)r=t.index+1;let o=t?.index??e.length;for(let t of e.substring(l,o).matchAll(n)){let e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));if(null!=r){i.push(r);continue}i.push(...function(e,t){return 1===e.length?[t.get(e.join(","))]:(function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let n=null;for(let s=0;s<r.length-1;s++){let i=e.slice(r[s].start,r[s+1].end),a=t.get(i.join(","));null!=a&&(null==n||a<n[0])&&(n=[a,s])}if(null!=n){let e=n[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}else break}return r})(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}(e,this.rankMap))}if(null==t)break;let c=this.specialTokens[t[0]];i.push(c),l=t.index+t[0].length}return i}decode(e){let t=[],r=0;for(let n=0;n<e.length;++n){let s=e[n],i=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=i&&(t.push(i),r+=i.length)}let n=new Uint8Array(r),s=0;for(let e of t)n.set(e,s),s+=e.length;return this.textDecoder.decode(n)}};p="specialTokenRegex",f=e=>RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"),(n="symbol"!=typeof p?p+"":p)in tz?tK(tz,n,{enumerable:!0,configurable:!0,writable:!0,value:f}):tz[n]=f;let tV={},tq=new tF.AsyncCaller({});async function tW(e){return e in tV||(tV[e]=tq.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new tz(e)).catch(t=>{throw delete tV[e],t})),await tV[e]}async function tG(e){return tW(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw Error("Unknown model")}}(e))}e.s(["encodingForModel",()=>tG,"getEncoding",()=>tW],43195);var tJ=e.i(69966);let tH=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e,tZ=e=>{switch(tH(e)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":default:return 4097;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":return 8e3}};function tY(e){return"object"==typeof e&&!!e&&("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&!!e.function&&"name"in e.function&&"parameters"in e.function||!1)}let tX=async({prompt:e,modelName:t})=>{let r;try{r=(await tG(tH(t))).encode(e).length}catch(t){console.warn("Failed to calculate number of tokens, falling back to approximate count"),r=Math.ceil(e.length/4)}return tZ(t)-r};class tQ extends tJ.Runnable{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class t0 extends tQ{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:n,...s}=r;super({callbacks:e??t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof n?this.cache=n:n?this.cache=tD.global():this.cache=void 0,this.caller=new tF.AsyncCaller(r??{})}async getNumTokens(e){let t,r=Math.ceil((t="string"==typeof e?e:e.map(e=>"string"==typeof e?e:"text"===e.type&&"text"in e?e.text:"").join("")).length/4);if(!this._encoding)try{this._encoding=await tG("modelName"in this?tH(this.modelName):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{r=this._encoding.encode(t).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return r}static _convertInputToPromptValue(e){return"string"==typeof e?new tB.StringPromptValue(e):Array.isArray(e)?new tB.ChatPromptValue(e.map(th.coerceMessageLikeToMessage)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){return Object.entries({...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()}).filter(([e,t])=>void 0!==t).map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw Error("Use .toJSON() instead")}}e.s(["BaseLangChain",()=>tQ,"BaseLanguageModel",()=>t0,"calculateMaxTokens",0,tX,"getEmbeddingContextSize",0,e=>"text-embedding-ada-002"===e?8191:2046,"getModelContextSize",0,tZ,"getModelNameForTiktoken",0,tH,"isOpenAITool",()=>tY],15614);var t1=e.i(60418),t2=tm;e.i(6349);var t5=e.i(47943),t3=e.i(34099),t4=e.i(29280),t8=e.i(89023);function t6(e){return void 0!==e&&Array.isArray(e.lc_namespace)}function t7(e){return void 0!==e&&tJ.Runnable.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}function t9(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&((0,t4.isInteropZodSchema)(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))}function re(e){return t9(e)||t7(e)||t6(e)}class rt extends tQ{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let r,n=(0,t1.ensureConfig)((0,t1.mergeConfigs)(this.defaultConfig,t));return(0,t3._isToolCall)(e)?(r=e.args,n={...n,toolCall:e}):r=e,this.call(r,n)}async call(e,t,r){let n,s,i,a,o,l=(0,t3._isToolCall)(e)?e.args:e;if((0,t4.isInteropZodSchema)(this.schema))try{n=await (0,t4.interopParseAsync)(this.schema,l)}catch(r){let t="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(t=`${t}
Details: ${r.message}`),new t3.ToolInputParsingException(t,JSON.stringify(e))}else{let t=(0,tb.validate)(l,this.schema);if(!t.valid){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}
Details: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new t3.ToolInputParsingException(r,JSON.stringify(e))}n=l}let c=(0,ty.parseCallbackConfigArg)(t),u=ty.CallbackManager.configure(c.callbacks,this.callbacks,c.tags||r,this.tags,c.metadata,this.metadata,{verbose:this.verbose}),h=await u?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),c.runId,void 0,void 0,void 0,c.runName);delete c.runId;try{s=await this._call(n,h,c)}catch(e){throw await h?.handleToolError(e),e}if("content_and_artifact"===this.responseFormat)if(Array.isArray(s)&&2===s.length)[i,a]=s;else throw Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(s)}`);else i=s;(0,t3._isToolCall)(e)&&(o=e.id),!o&&(0,t3._configHasToolCallId)(c)&&(o=c.toolCall.id);let d=function(e){let{content:t,artifact:r,toolCallId:n,metadata:s}=e;return!n||(0,t2.isDirectToolOutput)(t)?t:new t2.ToolMessage("string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?{status:"success",content:t,artifact:r,tool_call_id:n,name:e.name,metadata:s}:{status:"success",content:function(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}(t),artifact:r,tool_call_id:n,name:e.name,metadata:s})}({content:i,artifact:a,toolCallId:o,name:this.name,metadata:this.metadata});return await h?.handleToolEnd(d),d}}class rr extends rt{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:tg.z.object({input:tg.z.string().optional()}).transform(e=>e.input)})}call(e,t){return super.call("string"==typeof e||null==e?{input:e}:e,t)}}class rn extends rr{static lc_name(){return"DynamicTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}async call(e,t){let r=(0,ty.parseCallbackConfigArg)(t);return void 0===r.runName&&(r.runName=this.name),super.call(e,r)}async _call(e,t,r){return this.func(e,t,r)}}class rs extends rt{static lc_name(){return"DynamicStructuredTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}async call(e,t,r){let n=(0,ty.parseCallbackConfigArg)(t);return void 0===n.runName&&(n.runName=this.name),super.call(e,n,r)}_call(e,t,r){return this.func(e,t,r)}}class ri{getTools(){return this.tools}}function ra(e,t){let r=(0,t4.isSimpleStringZodSchema)(t.schema),n=(0,t8.validatesOnlyStrings)(t.schema);if(!t.schema||r||n)return new rn({...t,description:t.description??(t.schema&&(0,t4.getSchemaDescription)(t.schema))??`${t.name} tool`,func:async(t,r,n)=>new Promise((s,i)=>{let a=(0,t1.patchConfig)(n,{callbacks:r?.getChild()});t5.AsyncLocalStorageProviderSingleton.runWithConfig((0,t1.pickRunnableConfigKeys)(a),async()=>{try{s(e(t,a))}catch(e){i(e)}})})});let s=t.schema,i=t.description??t.schema.description??`${t.name} tool`;return new rs({...t,description:i,schema:s,func:async(t,r,n)=>new Promise((s,i)=>{let a=(0,t1.patchConfig)(n,{callbacks:r?.getChild()});t5.AsyncLocalStorageProviderSingleton.runWithConfig((0,t1.pickRunnableConfigKeys)(a),async()=>{try{s(e(t,a))}catch(e){i(e)}})})})}e.s(["BaseToolkit",()=>ri,"DynamicStructuredTool",()=>rs,"DynamicTool",()=>rn,"StructuredTool",()=>rt,"Tool",()=>rr,"tool",()=>ra],22617),e.i(22617),e.s(["BaseToolkit",()=>ri,"DynamicStructuredTool",()=>rs,"DynamicTool",()=>rn,"StructuredTool",()=>rt,"Tool",()=>rr,"ToolInputParsingException",()=>t3.ToolInputParsingException,"isLangChainTool",()=>re,"isRunnableToolLike",()=>t7,"isStructuredTool",()=>t6,"isStructuredToolParams",()=>t9,"tool",()=>ra],5995),(m=S||(S={})).STRING="string",m.NUMBER="number",m.INTEGER="integer",m.BOOLEAN="boolean",m.ARRAY="array",m.OBJECT="object",(g=A||(A={})).LANGUAGE_UNSPECIFIED="language_unspecified",g.PYTHON="python",(b=C||(C={})).OUTCOME_UNSPECIFIED="outcome_unspecified",b.OUTCOME_OK="outcome_ok",b.OUTCOME_FAILED="outcome_failed",b.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded";let ro=["user","model","function","system"];(y=j||(j={})).HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",y.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",y.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",y.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",y.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",y.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",(v=T||(T={})).HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",v.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",v.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",v.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",v.BLOCK_NONE="BLOCK_NONE",(w=N||(N={})).HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",w.NEGLIGIBLE="NEGLIGIBLE",w.LOW="LOW",w.MEDIUM="MEDIUM",w.HIGH="HIGH",(_=I||(I={})).BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",_.SAFETY="SAFETY",_.OTHER="OTHER",(x=R||(R={})).FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",x.STOP="STOP",x.MAX_TOKENS="MAX_TOKENS",x.SAFETY="SAFETY",x.RECITATION="RECITATION",x.LANGUAGE="LANGUAGE",x.BLOCKLIST="BLOCKLIST",x.PROHIBITED_CONTENT="PROHIBITED_CONTENT",x.SPII="SPII",x.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",x.OTHER="OTHER",(O=M||(M={})).TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",O.RETRIEVAL_QUERY="RETRIEVAL_QUERY",O.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",O.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",O.CLASSIFICATION="CLASSIFICATION",O.CLUSTERING="CLUSTERING",(k=$||($={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",k.AUTO="AUTO",k.ANY="ANY",k.NONE="NONE",(P=L||(L={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",P.MODE_DYNAMIC="MODE_DYNAMIC";class rl extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class rc extends rl{constructor(e,t){super(e),this.response=t}}class ru extends rl{constructor(e,t,r,n){super(e),this.status=t,this.statusText=r,this.errorDetails=n}}class rh extends rl{}class rd extends rl{}(E=D||(D={})).GENERATE_CONTENT="generateContent",E.STREAM_GENERATE_CONTENT="streamGenerateContent",E.COUNT_TOKENS="countTokens",E.EMBED_CONTENT="embedContent",E.BATCH_EMBED_CONTENTS="batchEmbedContents";class rp{constructor(e,t,r,n,s){this.model=e,this.task=t,this.apiKey=r,this.stream=n,this.requestOptions=s}toString(){var e,t;let r=(null==(e=this.requestOptions)?void 0:e.apiVersion)||"v1beta",n=(null==(t=this.requestOptions)?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com",s=`${n}/${r}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}}async function rf(e){var t,r;let n,s=new Headers;s.append("Content-Type","application/json"),s.append("x-goog-api-client",(r=e.requestOptions,n=[],(null==r?void 0:r.apiClient)&&n.push(r.apiClient),n.push("genai-js/0.24.1"),n.join(" "))),s.append("x-goog-api-key",e.apiKey);let i=null==(t=e.requestOptions)?void 0:t.customHeaders;if(i){if(!(i instanceof Headers))try{i=new Headers(i)}catch(e){throw new rh(`unable to convert customHeaders value ${JSON.stringify(i)} to Headers: ${e.message}`)}for(let[e,t]of i.entries()){if("x-goog-api-key"===e)throw new rh(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new rh(`Header name ${e} can only be set using the apiClient field`);s.append(e,t)}}return s}async function rm(e,t,r,n,s,i){let a=new rp(e,t,r,n,i);return{url:a.toString(),fetchOptions:Object.assign(Object.assign({},function(e){let t={};if((null==e?void 0:e.signal)!==void 0||(null==e?void 0:e.timeout)>=0){let r=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>r.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{r.abort()}),t.signal=r.signal}return t}(i)),{method:"POST",headers:await rf(a),body:s})}}async function rg(e,t,r,n,s,i={},a=fetch){let{url:o,fetchOptions:l}=await rm(e,t,r,n,s,i);return rb(o,l,a)}async function rb(e,t,r=fetch){let n;try{n=await r(e,t)}catch(r){var s=r,i=e;let t=s;throw"AbortError"===t.name?(t=new rd(`Request aborted when fetching ${i.toString()}: ${s.message}`)).stack=s.stack:s instanceof ru||s instanceof rh||((t=new rl(`Error fetching from ${i.toString()}: ${s.message}`)).stack=s.stack),t}return n.ok||await ry(n,e),n}async function ry(e,t){let r,n="";try{let t=await e.json();n=t.error.message,t.error.details&&(n+=` ${JSON.stringify(t.error.details)}`,r=t.error.details)}catch(e){}throw new ru(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${n}`,e.status,e.statusText,r)}function rv(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),rx(e.candidates[0]))throw new rc(`${rO(e)}`,e);return function(e){var t,r,n,s;let i=[];if(null==(r=null==(t=e.candidates)?void 0:t[0].content)?void 0:r.parts)for(let t of null==(s=null==(n=e.candidates)?void 0:n[0].content)?void 0:s.parts)t.text&&i.push(t.text),t.executableCode&&i.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&i.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return i.length>0?i.join(""):""}(e)}if(e.promptFeedback)throw new rc(`Text not available. ${rO(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),rx(e.candidates[0]))throw new rc(`${rO(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),rw(e)[0]}if(e.promptFeedback)throw new rc(`Function call not available. ${rO(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),rx(e.candidates[0]))throw new rc(`${rO(e)}`,e);return rw(e)}if(e.promptFeedback)throw new rc(`Function call not available. ${rO(e)}`,e)},e}function rw(e){var t,r,n,s;let i=[];if(null==(r=null==(t=e.candidates)?void 0:t[0].content)?void 0:r.parts)for(let t of null==(s=null==(n=e.candidates)?void 0:n[0].content)?void 0:s.parts)t.functionCall&&i.push(t.functionCall);return i.length>0?i:void 0}let r_=[R.RECITATION,R.SAFETY,R.LANGUAGE];function rx(e){return!!e.finishReason&&r_.includes(e.finishReason)}function rO(e){var t,r,n;let s="";if((!e.candidates||0===e.candidates.length)&&e.promptFeedback)s+="Response was blocked",(null==(t=e.promptFeedback)?void 0:t.blockReason)&&(s+=` due to ${e.promptFeedback.blockReason}`),(null==(r=e.promptFeedback)?void 0:r.blockReasonMessage)&&(s+=`: ${e.promptFeedback.blockReasonMessage}`);else if(null==(n=e.candidates)?void 0:n[0]){let t=e.candidates[0];rx(t)&&(s+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(s+=`: ${t.finishMessage}`))}return s}function rk(e){return this instanceof rk?(this.v=e,this):new rk(e)}"function"==typeof SuppressedError&&SuppressedError;let rP=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function rE(e){let t=[],r=e.getReader();for(;;){let{done:e,value:n}=await r.read();if(e)return rv(function(e){let t=e[e.length-1],r={promptFeedback:null==t?void 0:t.promptFeedback};for(let t of e){if(t.candidates){let e=0;for(let n of t.candidates)if(r.candidates||(r.candidates=[]),r.candidates[e]||(r.candidates[e]={index:e}),r.candidates[e].citationMetadata=n.citationMetadata,r.candidates[e].groundingMetadata=n.groundingMetadata,r.candidates[e].finishReason=n.finishReason,r.candidates[e].finishMessage=n.finishMessage,r.candidates[e].safetyRatings=n.safetyRatings,n.content&&n.content.parts){r.candidates[e].content||(r.candidates[e].content={role:n.content.role||"user",parts:[]});let t={};for(let s of n.content.parts)s.text&&(t.text=s.text),s.functionCall&&(t.functionCall=s.functionCall),s.executableCode&&(t.executableCode=s.executableCode),s.codeExecutionResult&&(t.codeExecutionResult=s.codeExecutionResult),0===Object.keys(t).length&&(t.text=""),r.candidates[e].content.parts.push(t)}e++}t.usageMetadata&&(r.usageMetadata=t.usageMetadata)}return r}(t));t.push(n)}}async function rS(e,t,r,n){return function(e){let t,[r,n]=(t=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})).getReader(),new ReadableStream({start(e){let r="";return function n(){return t.read().then(({value:t,done:s})=>{let i;if(s)return r.trim()?void e.error(new rl("Failed to parse stream")):void e.close();let a=(r+=t).match(rP);for(;a;){try{i=JSON.parse(a[1])}catch(t){e.error(new rl(`Error parsing JSON response: "${a[1]}"`));return}e.enqueue(i),a=(r=r.substring(a[0].length)).match(rP)}return n()}).catch(e=>{let t=e;throw t.stack=e.stack,t="AbortError"===t.name?new rd("Request aborted when reading from the stream"):new rl("Error reading from the stream")})}()}})).tee();return{stream:function(e){return function(e,t,r){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var n,s=r.apply(e,t||[]),i=[];return n={},a("next"),a("throw"),a("return"),n[Symbol.asyncIterator]=function(){return this},n;function a(e){s[e]&&(n[e]=function(t){return new Promise(function(r,n){i.push([e,t,r,n])>1||o(e,t)})})}function o(e,t){try{var r;(r=s[e](t)).value instanceof rk?Promise.resolve(r.value.v).then(l,c):u(i[0][2],r)}catch(e){u(i[0][3],e)}}function l(e){o("next",e)}function c(e){o("throw",e)}function u(e,t){e(t),i.shift(),i.length&&o(i[0][0],i[0][1])}}(this,arguments,function*(){let t=e.getReader();for(;;){let{value:e,done:r}=yield rk(t.read());if(r)break;yield yield rk(rv(e))}})}(r),response:rE(n)}}(await rg(t,D.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(r),n))}async function rA(e,t,r,n){let s=await rg(t,D.GENERATE_CONTENT,e,!1,JSON.stringify(r),n);return{response:rv(await s.json())}}function rC(e){if(null!=e){if("string"==typeof e)return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)if(!e.role)return{role:"system",parts:e.parts};else return e}}function rj(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(let r of e)"string"==typeof r?t.push({text:r}):t.push(r);var r=t;let n={role:"user",parts:[]},s={role:"function",parts:[]},i=!1,a=!1;for(let e of r)"functionResponse"in e?(s.parts.push(e),a=!0):(n.parts.push(e),i=!0);if(i&&a)throw new rl("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!i&&!a)throw new rl("No content is provided for sending chat message.");return i?n:s}function rT(e){let t;return t=e.contents?e:{contents:[rj(e)]},e.systemInstruction&&(t.systemInstruction=rC(e.systemInstruction)),t}let rN=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],rI={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function rR(e){var t;if(void 0===e.candidates||0===e.candidates.length)return!1;let r=null==(t=e.candidates[0])?void 0:t.content;if(void 0===r||void 0===r.parts||0===r.parts.length)return!1;for(let e of r.parts)if(void 0===e||0===Object.keys(e).length||void 0!==e.text&&""===e.text)return!1;return!0}let rM="SILENT_ERROR";class r${constructor(e,t,r,n={}){this.model=t,this.params=r,this._requestOptions=n,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==r?void 0:r.history)&&(!function(e){let t=!1;for(let r of e){let{role:e,parts:n}=r;if(!t&&"user"!==e)throw new rl(`First content should be with role 'user', got ${e}`);if(!ro.includes(e))throw new rl(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(ro)}`);if(!Array.isArray(n))throw new rl("Content should have 'parts' property with an array of Parts");if(0===n.length)throw new rl("Each Content should have at least one part");let s={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let e of n)for(let t of rN)t in e&&(s[t]+=1);let i=rI[e];for(let t of rN)if(!i.includes(t)&&s[t]>0)throw new rl(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var r,n,s,i,a,o;let l;await this._sendPromise;let c=rj(e),u={safetySettings:null==(r=this.params)?void 0:r.safetySettings,generationConfig:null==(n=this.params)?void 0:n.generationConfig,tools:null==(s=this.params)?void 0:s.tools,toolConfig:null==(i=this.params)?void 0:i.toolConfig,systemInstruction:null==(a=this.params)?void 0:a.systemInstruction,cachedContent:null==(o=this.params)?void 0:o.cachedContent,contents:[...this._history,c]},h=Object.assign(Object.assign({},this._requestOptions),t);return this._sendPromise=this._sendPromise.then(()=>rA(this._apiKey,this.model,u,h)).then(e=>{var t;if(rR(e.response)){this._history.push(c);let r=Object.assign({parts:[],role:"model"},null==(t=e.response.candidates)?void 0:t[0].content);this._history.push(r)}else{let t=rO(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e}).catch(e=>{throw this._sendPromise=Promise.resolve(),e}),await this._sendPromise,l}async sendMessageStream(e,t={}){var r,n,s,i,a,o;await this._sendPromise;let l=rj(e),c={safetySettings:null==(r=this.params)?void 0:r.safetySettings,generationConfig:null==(n=this.params)?void 0:n.generationConfig,tools:null==(s=this.params)?void 0:s.tools,toolConfig:null==(i=this.params)?void 0:i.toolConfig,systemInstruction:null==(a=this.params)?void 0:a.systemInstruction,cachedContent:null==(o=this.params)?void 0:o.cachedContent,contents:[...this._history,l]},u=Object.assign(Object.assign({},this._requestOptions),t),h=rS(this._apiKey,this.model,c,u);return this._sendPromise=this._sendPromise.then(()=>h).catch(e=>{throw Error(rM)}).then(e=>e.response).then(e=>{if(rR(e)){this._history.push(l);let t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{let t=rO(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}}).catch(e=>{e.message!==rM&&console.error(e)}),h}}async function rL(e,t,r,n){return(await rg(t,D.COUNT_TOKENS,e,!1,JSON.stringify(r),n)).json()}async function rD(e,t,r,n){return(await rg(t,D.EMBED_CONTENT,e,!1,JSON.stringify(r),n)).json()}async function rB(e,t,r,n){let s=r.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await rg(t,D.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:s}),n)).json()}class rF{constructor(e,t,r={}){this.apiKey=e,this._requestOptions=r,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=rC(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var r;let n=rT(e),s=Object.assign(Object.assign({},this._requestOptions),t);return rA(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(r=this.cachedContent)?void 0:r.name},n),s)}async generateContentStream(e,t={}){var r;let n=rT(e),s=Object.assign(Object.assign({},this._requestOptions),t);return rS(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(r=this.cachedContent)?void 0:r.name},n),s)}startChat(e){var t;return new r$(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(t=this.cachedContent)?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let r=function(e,t){var r;let n={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null==(r=null==t?void 0:t.cachedContent)?void 0:r.name,contents:[]},s=null!=e.generateContentRequest;if(e.contents){if(s)throw new rh("CountTokensRequest must have one of contents or generateContentRequest, not both.");n.contents=e.contents}else if(s)n=Object.assign(Object.assign({},n),e.generateContentRequest);else{let t=rj(e);n.contents=[t]}return{generateContentRequest:n}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),n=Object.assign(Object.assign({},this._requestOptions),t);return rL(this.apiKey,this.model,r,n)}async embedContent(e,t={}){let r="string"==typeof e||Array.isArray(e)?{content:rj(e)}:e,n=Object.assign(Object.assign({},this._requestOptions),t);return rD(this.apiKey,this.model,r,n)}async batchEmbedContents(e,t={}){let r=Object.assign(Object.assign({},this._requestOptions),t);return rB(this.apiKey,this.model,e,r)}}class rU{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new rl("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new rF(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,r){if(!e.name)throw new rh("Cached content must contain a `name` field.");if(!e.model)throw new rh("Cached content must contain a `model` field.");for(let r of["model","systemInstruction"])if((null==t?void 0:t[r])&&e[r]&&(null==t?void 0:t[r])!==e[r]){if("model"===r&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new rh(`Different value for "${r}" specified in modelParams (${t[r]}) and cachedContent (${e[r]})`)}let n=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new rF(this.apiKey,n,r)}}var rK=e.i(87179),rz=e.i(83493),rV=e.i(87900),rq=tJ;class rW extends rq.Runnable{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=(0,t1.ensureConfig)(t);return this.func&&await this.func(e,r),this._callWithConfig(e=>Promise.resolve(e),e,r)}async *transform(e,t){let r,n=(0,t1.ensureConfig)(t),s=!0;for await(let t of this._transformStreamWithConfig(e,e=>e,n))if(yield t,s)if(void 0===r)r=t;else try{r=(0,rV.concat)(r,t)}catch{r=void 0,s=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new rq.RunnableAssign(new rq.RunnableMap({steps:e}))}}var rG=e.i(74550);function rJ(){let e=new TextEncoder;return new TransformStream({transform(t,r){r.enqueue(e.encode("string"==typeof t.content?t.content:JSON.stringify(t.content)))}})}function rH(e){let t=[];for(let r of e){let e=r;if(Array.isArray(r.content))for(let t=0;t<r.content.length;t++){let n=r.content[t];((0,tf.isURLContentBlock)(n)||(0,tf.isBase64ContentBlock)(n))&&e===r&&(e=new r.constructor({...e,content:[...r.content.slice(0,t),(0,tf.convertToOpenAIImageBlock)(n),...r.content.slice(t+1)]}))}t.push(e)}return t}class rZ extends t0{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){let r=rZ._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async *_streamResponseChunks(e,t,r){throw Error("Not implemented.")}async *_streamIterator(e,t){if(this._streamResponseChunks===rZ.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{let r,n,s=rZ._convertInputToPromptValue(e).toChatMessages(),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...i.metadata,...this.getLsParams(a)},l=await ty.CallbackManager.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this?.invocationParams(a),batch_size:1},u=await l?.handleChatModelStart(this.toJSON(),[rH(s)],i.runId,void 0,c,void 0,void 0,i.runName);try{for await(let e of this._streamResponseChunks(s,a,u?.[0])){if(null==e.message.id){let t=u?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,r=r?r.concat(e):e,(0,to.isAIMessageChunk)(e.message)&&void 0!==e.message.usage_metadata&&(n={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((u??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((u??[]).map(e=>e?.handleLLMEnd({generations:[[r]],llmOutput:n})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,n){let s,i=e.map(e=>e.map(th.coerceMessageLikeToMessage));if(void 0!==n&&n.length===i.length)s=n;else{let e={...r.metadata,...this.getLsParams(t)},n=await ty.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,e,this.metadata,{verbose:this.verbose}),a={options:t,invocation_params:this?.invocationParams(t),batch_size:1};s=await n?.handleChatModelStart(this.toJSON(),i.map(rH),r.runId,void 0,a,void 0,void 0,r.runName)}let a=[],o=[];if(s?.[0].handlers.find(rG.callbackHandlerPrefersStreaming)&&!this.disableStreaming&&1===i.length&&this._streamResponseChunks!==rZ.prototype._streamResponseChunks)try{let e,r;for await(let n of(await this._streamResponseChunks(i[0],t,s?.[0]))){if(null==n.message.id){let e=s?.at(0)?.runId;null!=e&&n.message._updateId(`run-${e}`)}e=void 0===e?n:(0,rV.concat)(e,n),(0,to.isAIMessageChunk)(n.message)&&void 0!==n.message.usage_metadata&&(r={tokenUsage:{promptTokens:n.message.usage_metadata.input_tokens,completionTokens:n.message.usage_metadata.output_tokens,totalTokens:n.message.usage_metadata.total_tokens}})}if(void 0===e)throw Error("Received empty response from chat model call.");a.push([e]),await s?.[0].handleLLMEnd({generations:a,llmOutput:r})}catch(e){throw await s?.[0].handleLLMError(e),e}else{let e=await Promise.allSettled(i.map((e,r)=>this._generate(e,{...t,promptIndex:r},s?.[r])));await Promise.all(e.map(async(e,t)=>{if("fulfilled"!==e.status)return await s?.[t]?.handleLLMError(e.reason),Promise.reject(e.reason);{let r=e.value;for(let e of r.generations){if(null==e.message.id){let t=s?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===r.generations.length&&(r.generations[0].message.response_metadata={...r.llmOutput,...r.generations[0].message.response_metadata}),a[t]=r.generations,o[t]=r.llmOutput,s?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}}))}let l={generations:a,llmOutput:o.length?this._combineLLMOutput?.(...o):void 0};return Object.defineProperty(l,rz.RUN_KEY,{value:s?{runIds:s?.map(e=>e.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:n,handledOptions:s}){let i=e.map(e=>e.map(th.coerceMessageLikeToMessage)),a={...s.metadata,...this.getLsParams(n)},o=await ty.CallbackManager.configure(s.callbacks,this.callbacks,s.tags,this.tags,a,this.metadata,{verbose:this.verbose}),l={options:n,invocation_params:this?.invocationParams(n),batch_size:1},c=await o?.handleChatModelStart(this.toJSON(),i.map(rH),s.runId,void 0,l,void 0,void 0,s.runName),u=[],h=(await Promise.allSettled(i.map(async(e,n)=>{let s=rZ._convertInputToPromptValue(e).toString(),i=await t.lookup(s,r);return null==i&&u.push(n),i}))).map((e,t)=>({result:e,runManager:c?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),d=[];await Promise.all(h.map(async({result:e,runManager:t},r)=>{if("fulfilled"!==e.status)return await t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(e.reason);{let n=e.value;return d[r]=n.map(e=>("message"in e&&(0,tl.isBaseMessage)(e.message)&&(0,to.isAIMessage)(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),n.length&&await t?.handleLLMNewToken(n[0].text),t?.handleLLMEnd({generations:[n]},void 0,void 0,void 0,{cached:!0})}}));let p={generations:d,missingPromptIndices:u,startedRunManagers:c};return Object.defineProperty(p,rz.RUN_KEY,{value:c?{runIds:c?.map(e=>e.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let n;n=Array.isArray(t)?{stop:t}:t;let s=e.map(e=>e.map(th.coerceMessageLikeToMessage)),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(n);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(s,a,i);let{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(a),{generations:c,missingPromptIndices:u,startedRunManagers:h}=await this._generateCached({messages:s,cache:o,llmStringKey:l,parsedOptions:a,handledOptions:i}),d={};if(u.length>0){let e=await this._generateUncached(u.map(e=>s[e]),a,i,void 0!==h?u.map(e=>h?.[e]):void 0);await Promise.all(e.generations.map(async(e,t)=>{let r=u[t];c[r]=e;let n=rZ._convertInputToPromptValue(s[r]).toString();return o.update(n,l,e)})),d=e.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let n=e.map(e=>e.toChatMessages());return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e.map(th.coerceMessageLikeToMessage)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let n=e.toChatMessages();return this.call(n,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let n=new ti.HumanMessage(e),s=await this.call([n],t,r);if("string"!=typeof s.content)throw Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){let r;if("function"!=typeof this.bindTools)throw Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw Error('"strict" mode is not supported for this model by default.');let n=t?.name,s=(0,t4.getSchemaDescription)(e)??"A function available to call.",i=t?.method,a=t?.includeRaw;if("jsonMode"===i)throw Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o=n??"extract";(0,t4.isInteropZodSchema)(e)?r=[{type:"function",function:{name:o,description:s,parameters:(0,t8.toJsonSchema)(e)}}]:("name"in e&&(o=e.name),r=[{type:"function",function:{name:o,description:s,parameters:e}}]);let l=this.bindTools(r),c=tJ.RunnableLambda.from(e=>{if(!e.tool_calls||0===e.tool_calls.length)throw Error("No tool calls found in the response.");let t=e.tool_calls.find(e=>e.name===o);if(!t)throw Error(`No tool call found with name ${o}.`);return t.args});if(!a)return l.pipe(c).withConfig({runName:"StructuredOutput"});let u=rW.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),h=rW.assign({parsed:()=>null}),d=u.withFallbacks({fallbacks:[h]});return tJ.RunnableSequence.from([{raw:l},d]).withConfig({runName:"StructuredOutputRunnable"})}}class rY extends rZ{async _generate(e,t,r){let n=await this._call(e,t,r),s=new to.AIMessage(n);if("string"!=typeof s.content)throw Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}}e.s(["BaseChatModel",()=>rZ,"SimpleChatModel",()=>rY,"createChatMessageChunkEncoderStream",()=>rJ],72674);var rX=tJ;class rQ extends rX.Runnable{static lc_name(){return"RouterRunnable"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnables=e.runnables}async invoke(e,t){let{key:r,input:n}=e,s=this.runnables[r];if(void 0===s)throw Error(`No runnable associated with key "${r}".`);return s.invoke(n,(0,t1.ensureConfig)(t))}async batch(e,t,r){let n=e.map(e=>e.key),s=e.map(e=>e.input);if(void 0!==n.find(e=>void 0===this.runnables[e]))throw Error("One or more keys do not have a corresponding runnable.");let i=n.map(e=>this.runnables[e]),a=this._getOptionsList(t??{},e.length),o=a[0]?.maxConcurrency??r?.maxConcurrency,l=o&&o>0?o:e.length,c=[];for(let e=0;e<s.length;e+=l){let t=s.slice(e,e+l).map((e,t)=>i[t].invoke(e,a[t])),r=await Promise.all(t);c.push(r)}return c.flat()}async stream(e,t){let{key:r,input:n}=e,s=this.runnables[r];if(void 0===s)throw Error(`No runnable associated with key "${r}".`);return s.stream(n,t)}}var r0=tJ;class r1 extends r0.Runnable{static lc_name(){return"RunnableBranch"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"default",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.branches=e.branches,this.default=e.default}static from(e){if(e.length<1)throw Error("RunnableBranch requires at least one branch");return new this({branches:e.slice(0,-1).map(([e,t])=>[(0,r0._coerceToRunnable)(e),(0,r0._coerceToRunnable)(t)]),default:(0,r0._coerceToRunnable)(e[e.length-1])})}async _invoke(e,t,r){let n;for(let s=0;s<this.branches.length;s+=1){let[i,a]=this.branches[s];if(await i.invoke(e,(0,t1.patchConfig)(t,{callbacks:r?.getChild(`condition:${s+1}`)}))){n=await a.invoke(e,(0,t1.patchConfig)(t,{callbacks:r?.getChild(`branch:${s+1}`)}));break}}return n||(n=await this.default.invoke(e,(0,t1.patchConfig)(t,{callbacks:r?.getChild("branch:default")}))),n}async invoke(e,t={}){return this._callWithConfig(this._invoke,e,t)}async *_streamIterator(e,t){let r,n,s=await (0,t1.getCallbackManagerForConfig)(t),i=await s?.handleChainStart(this.toJSON(),(0,r0._coerceToDict)(e,"input"),t?.runId,void 0,void 0,void 0,t?.runName),a=!0;try{for(let s=0;s<this.branches.length;s+=1){let[o,l]=this.branches[s];if(await o.invoke(e,(0,t1.patchConfig)(t,{callbacks:i?.getChild(`condition:${s+1}`)}))){for await(let o of n=await l.stream(e,(0,t1.patchConfig)(t,{callbacks:i?.getChild(`branch:${s+1}`)})))if(yield o,a)if(void 0===r)r=o;else try{r=(0,rV.concat)(r,o)}catch(e){r=void 0,a=!1}break}}if(void 0===n){for await(let s of n=await this.default.stream(e,(0,t1.patchConfig)(t,{callbacks:i?.getChild("branch:default")})))if(yield s,a)if(void 0===r)r=s;else try{r=(0,rV.concat)(r,s)}catch(e){r=void 0,a=!1}}}catch(e){throw await i?.handleChainError(e),e}await i?.handleChainEnd(r??{})}}var r2=tJ;class r5 extends r2.RunnableBinding{constructor(e){let t=r2.RunnableLambda.from((e,t)=>this._enterHistory(e,t??{})).withConfig({runName:"loadHistory"});const r=e.historyMessagesKey??e.inputMessagesKey;r&&(t=rW.assign({[r]:t}).withConfig({runName:"insertHistory"}));const n=t.pipe(e.runnable.withListeners({onEnd:(e,t)=>this._exitHistory(e,t??{})})).withConfig({runName:"RunnableWithMessageHistory"}),s=e.config??{};super({...e,config:s,bound:n}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if("object"!=typeof e||Array.isArray(e)||(0,tl.isBaseMessage)(e))t=e;else{let r;r=this.inputMessagesKey?this.inputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"input",t=Array.isArray(e[r])&&Array.isArray(e[r][0])?e[r][0]:e[r]}if("string"==typeof t)return[new ti.HumanMessage(t)];if(Array.isArray(t))return t;if((0,tl.isBaseMessage)(t))return[t];throw Error(`Expected a string, BaseMessage, or array of BaseMessages.
Got ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(Array.isArray(e)||(0,tl.isBaseMessage)(e)||"string"==typeof e)t=e;else{let r;r=void 0!==this.outputMessagesKey?this.outputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"output",t=void 0!==e.generations?e.generations[0][0].message:e[r]}if("string"==typeof t)return[new to.AIMessage(t)];if(Array.isArray(t))return t;if((0,tl.isBaseMessage)(t))return[t];throw Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){let r=t?.configurable?.messageHistory,n=await r.getMessages();return void 0===this.historyMessagesKey?n.concat(this._getInputMessages(e)):n}async _exitHistory(e,t){let r,n=t.configurable?.messageHistory;r=Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?e.inputs[0]:e.inputs;let s=this._getInputMessages(r);if(void 0===this.historyMessagesKey){let e=await n.getMessages();s=s.slice(e.length)}let i=e.outputs;if(!i)throw Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);let a=this._getOutputMessages(i);await n.addMessages([...s,...a])}async _mergeConfig(...e){let t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){let e={[this.inputMessagesKey??"input"]:"foo"};throw Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()
eg. chain.invoke(${JSON.stringify(e)}, ${JSON.stringify({configurable:{sessionId:"123"}})})`)}let{sessionId:r}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(r),t}}e.s([],89352),e.i(89352);var r3=tJ,r4=t1;e.s(["RouterRunnable",()=>rQ,"Runnable",()=>r3.Runnable,"RunnableAssign",()=>r3.RunnableAssign,"RunnableBinding",()=>r3.RunnableBinding,"RunnableBranch",()=>r1,"RunnableEach",()=>r3.RunnableEach,"RunnableLambda",()=>r3.RunnableLambda,"RunnableMap",()=>r3.RunnableMap,"RunnableParallel",()=>r3.RunnableParallel,"RunnablePassthrough",()=>rW,"RunnablePick",()=>r3.RunnablePick,"RunnableRetry",()=>r3.RunnableRetry,"RunnableSequence",()=>r3.RunnableSequence,"RunnableToolLike",()=>r3.RunnableToolLike,"RunnableWithFallbacks",()=>r3.RunnableWithFallbacks,"RunnableWithMessageHistory",()=>r5,"_coerceToRunnable",()=>r3._coerceToRunnable,"ensureConfig",()=>r4.ensureConfig,"getCallbackManagerForConfig",()=>r4.getCallbackManagerForConfig,"mergeConfigs",()=>r4.mergeConfigs,"patchConfig",()=>r4.patchConfig,"pickRunnableConfigKeys",()=>r4.pickRunnableConfigKeys],50823);var r3=tJ;e.s([],53394),e.i(14904);var r8=e.i(39154);function r6(e){if("object"==typeof e&&null!==e){let t={...e};for(let e in"additionalProperties"in t&&delete t.additionalProperties,"$schema"in t&&delete t.$schema,t)e in t&&(Array.isArray(t[e])?t[e]=t[e].map(r6):"object"==typeof t[e]&&null!==t[e]&&(t[e]=r6(t[e])));return t}return e}function r7(e){let{$schema:t,...r}=r6((0,r8.zodToJsonSchema)(e));return r}function r9(e,t){let r="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:(0,t8.toJsonSchema)(e.schema),...r?.strict!==void 0?{strict:r.strict}:{}}}function ne(e,t){let r,n="number"==typeof t?void 0:t;return r=re(e)?{type:"function",function:r9(e)}:e,n?.strict!==void 0&&(r.function.strict=n.strict),r}function nt(e,t,r=!1){return e.reduce((e,n,s)=>{let i;if(!(0,tl.isBaseMessage)(n))throw Error("Unsupported message input");let a=(i=n._getType(),tc.ChatMessage.isInstance(n)?n.role:"tool"===i?i:n.name??i);if("system"===a&&0!==s)throw Error("System message should be the first one");let o=function(e){switch(e){case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw Error(`Unknown / unsupported author: ${e}`)}}(a),l=e.content[e.content.length];if(!e.mergeWithPreviousContent&&l&&l.role===o)throw Error("Google Generative AI requires alternate messages between authors");let c=function(e,t){if("string"==typeof e.content&&""!==e.content)return[{text:e.content}];let r=[],n=[],s=[];return"tool_calls"in e&&Array.isArray(e.tool_calls)&&e.tool_calls.length>0?r=e.tool_calls.map(e=>({functionCall:{name:e.name,args:e.args}})):"tool"===e.getType()&&e.name&&e.content?n=[{functionResponse:{name:e.name,response:e.content}}]:Array.isArray(e.content)&&(s=e.content.map(e=>{if("text"===e.type)return{text:e.text};if("executableCode"===e.type)return{executableCode:e.executableCode};if("codeExecutionResult"===e.type)return{codeExecutionResult:e.codeExecutionResult};if("image_url"===e.type){let r;if(!t)throw Error("This model does not support images");if("string"==typeof e.image_url)r=e.image_url;else if("object"==typeof e.image_url&&"url"in e.image_url)r=e.image_url.url;else throw Error("Please provide image as base64 encoded data URL");let[n,s]=r.split(",");if(!n.startsWith("data:"))throw Error("Please provide image as base64 encoded data URL");let[i,a]=n.replace(/^data:/,"").split(";");if("base64"!==a)throw Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:i}}}if("media"===e.type){if("mimeType"in e&&"data"in e)return{inlineData:{mimeType:e.mimeType,data:e.data}};if("mimeType"in e&&"fileUri"in e)return{fileData:{mimeType:e.mimeType,fileUri:e.fileUri}};throw Error("Invalid media content")}if("tool_use"===e.type)return{functionCall:{name:e.name,args:e.input}};if(e.type?.includes("/")&&2===e.type.split("/").length&&"data"in e&&"string"==typeof e.data)return{inlineData:{mimeType:e.type,data:e.data}};throw Error(`Unknown content type ${e.type}`)})),[...s,...r,...n]}(n,t);if(e.mergeWithPreviousContent){let t=e.content[e.content.length-1];if(!t)throw Error("There was a problem parsing your system message. Please try a prompt without one.");return t.parts.push(...c),{mergeWithPreviousContent:!1,content:e.content}}let u=o;"function"!==u&&("system"!==u||r)||(u="user");let h={role:u,parts:c};return{mergeWithPreviousContent:"system"===a&&!r,content:[...e.content,h]}},{content:[],mergeWithPreviousContent:!1}).content}e.s(["convertToOpenAIFunction",()=>r9,"convertToOpenAITool",()=>ne],70666),e.i(70666),e.s(["convertToOpenAIFunction",()=>r9,"convertToOpenAITool",()=>ne,"isLangChainTool",()=>re,"isRunnableToolLike",()=>t7,"isStructuredTool",()=>t6,"isStructuredToolParams",()=>t9],90506);var nr=tJ,nn=e.i(56437);class ns extends nr.Runnable{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class ni extends ns{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw Error("_type not implemented")}}class na extends Error{constructor(e,t,r,n=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=n,n&&(void 0===r||void 0===t))throw Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");(0,nn.addLangChainErrorFields)(this,"OUTPUT_PARSING_FAILURE")}}e.s(["BaseLLMOutputParser",()=>ns,"BaseOutputParser",()=>ni,"OutputParserException",()=>na],19917);var no=e.i(50975);class nl extends ni{async *_transform(e){for await(let t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async *transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class nc extends nl{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async *_transform(e){let t,r;for await(let n of e){let e;if("string"!=typeof n&&"string"!=typeof n.content)throw Error("Cannot handle non-string output.");if((0,tl.isBaseMessageChunk)(n)){if("string"!=typeof n.content)throw Error("Cannot handle non-string message output.");e=new rz.ChatGenerationChunk({message:n,text:n.content})}else if((0,tl.isBaseMessage)(n)){if("string"!=typeof n.content)throw Error("Cannot handle non-string message output.");e=new rz.ChatGenerationChunk({message:(0,th.convertToChunk)(n),text:n.content})}else e=new rz.GenerationChunk({text:n});r=void 0===r?e:r.concat(e);let s=await this.parsePartialResult([r]);null==s||(0,no.deepCompareStrict)(s,t)||(this.diff?yield this._diff(t,s):yield s,t=s)}}getFormatInstructions(){return""}}e.s(["BaseCumulativeTransformOutputParser",()=>nc,"BaseTransformOutputParser",()=>nl],67649);class nu extends nl{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","bytes"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"textEncoder",{enumerable:!0,configurable:!0,writable:!0,value:new TextEncoder})}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}}e.s(["BytesOutputParser",()=>nu],23814);class nh extends nl{constructor(){super(...arguments),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}async *_transform(e){let t="";for await(let r of e)if("string"==typeof r?t+=r:t+=r.content,this.re){let e=[...t.matchAll(this.re)];if(e.length>1){let r=0;for(let t of e.slice(0,-1))yield[t[1]],r+=(t.index??0)+t[0].length;t=t.slice(r)}}else{let e=await this.parse(t);if(e.length>1){for(let t of e.slice(0,-1))yield[t];t=e[e.length-1]}}for(let e of(await this.parse(t)))yield[e]}}class nd extends nh{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(e=>e.trim())}catch(t){throw new na(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}}class np extends nh{constructor({length:e,separator:t}){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{let t=e.trim().split(this.separator).map(e=>e.trim());if(void 0!==this.length&&t.length!==this.length)throw new na(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){if(Object.getPrototypeOf(t)===na.prototype)throw t;throw new na(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${void 0===this.length?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}}class nf extends nh{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/\d+\.\s([^\n]+)/g})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(e=>e[1])}}class nm extends nh{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/^\s*[-*]\s([^\n]+)$/gm})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(e=>e[1])}}e.s(["CommaSeparatedListOutputParser",()=>nd,"CustomListOutputParser",()=>np,"ListOutputParser",()=>nh,"MarkdownListOutputParser",()=>nm,"NumberedListOutputParser",()=>nf],26656);class ng extends nl{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw Error(`Cannot coerce "${e.type}" message part into a string.`)}throw Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((e,t)=>e+this._messageContentComplexToString(t),"")}}e.s(["StringOutputParser",()=>ng],20278);class nb extends ni{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(tg.z.object(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,tg.z.string().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify((0,t8.toJsonSchema)(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.trim(),r=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>{let r=t.replace(/\n/g,"\\n");return`"${r}"`}).replace(/\n/g,"");return await (0,t4.interopParseAsync)(this.schema,JSON.parse(r))}catch(t){throw new na(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class ny extends nb{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction((0,t8.toJsonSchema)(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){if("type"in e){let r,n=!1;if(Array.isArray(e.type)){let t=e.type.findIndex(e=>"null"===e);-1!==t&&(n=!0,e.type.splice(t,1)),r=e.type.join(" | ")}else r=e.type;if("object"===e.type&&e.properties){let r=e.description?` // ${e.description}`:"",n=Object.entries(e.properties).map(([r,n])=>{let s=e.required?.includes(r)?"":" (optional)";return`${" ".repeat(t)}"${r}": ${this._schemaToInstruction(n,t+2)}${s}`}).join("\n");return`{
${n}
${" ".repeat(t-2)}}${r}`}if("array"===e.type&&e.items){let r=e.description?` // ${e.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(e.items,t+2)}
${" ".repeat(t-2)}] ${r}`}let s=n?" (nullable)":"",i=e.description?` // ${e.description}`:"";return`${r}${i}${s}`}if("anyOf"in e)return e.anyOf.map(e=>this._schemaToInstruction(e,t)).join(`
${" ".repeat(t-2)}`);throw Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(tg.z.object(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,tg.z.string().describe(t)]))))}}class nv extends ni{constructor({inputSchema:e}){super(...arguments),Object.defineProperty(this,"structuredInputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.structuredInputParser=new ny(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(t){throw new na(`Failed to parse. Text: "${e}". Error: ${t}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}}e.s(["AsymmetricStructuredOutputParser",()=>nv,"JsonMarkdownStructuredOutputParser",()=>ny,"StructuredOutputParser",()=>nb],35174),e.i(52496),e.s([],73977);var nw=e.i(13786),n_=e.i(3304);class nx extends nc{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?(0,nw.compare)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,n_.parseJsonMarkdown)(e[0].text)}async parse(e){return(0,n_.parseJsonMarkdown)(e,JSON.parse)}getFormatInstructions(){return""}}e.s(["JsonOutputParser",()=>nx],38325);let nO=function(){let e={};e.parser=function(e,t){return new r(e,t)},e.SAXParser=r,e.SAXStream=l,e.createStream=function(e,t){return new l(e,t)},e.MAX_BUFFER_LENGTH=65536;let t=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];function r(n,s){if(!(this instanceof r))return new r(n,s);(function(e){for(var r=0,n=t.length;r<n;r++)e[t[r]]=""})(this),this.q=this.c="",this.bufferCheckPosition=e.MAX_BUFFER_LENGTH,this.opt=s||{},this.opt.lowercase=this.opt.lowercase||this.opt.lowercasetags,this.looseCase=this.opt.lowercase?"toLowerCase":"toUpperCase",this.tags=[],this.closed=this.closedRoot=this.sawRoot=!1,this.tag=this.error=null,this.strict=!!n,this.noscript=!!(n||this.opt.noscript),this.state=v.BEGIN,this.strictEntities=this.opt.strictEntities,this.ENTITIES=this.strictEntities?Object.create(e.XML_ENTITIES):Object.create(e.ENTITIES),this.attribList=[],this.opt.xmlns&&(this.ns=Object.create(h)),this.trackPosition=!1!==this.opt.position,this.trackPosition&&(this.position=this.line=this.column=0),_(this,"onready")}e.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(e){function t(){}return t.prototype=e,new t}),Object.keys||(Object.keys=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t}),r.prototype={end:function(){E(this)},write:function(r){if(this.error)throw this.error;if(this.closed)return P(this,"Cannot write after close. Assign an onready handler.");if(null===r)return E(this);"object"==typeof r&&(r=r.toString());for(var n=0,s="";s=R(r,n++),this.c=s,s;)switch(this.trackPosition&&(this.position++,"\n"===s?(this.line++,this.column=0):this.column++),this.state){case v.BEGIN:if(this.state=v.BEGIN_WHITESPACE,"\uFEFF"===s)continue;I(this,s);continue;case v.BEGIN_WHITESPACE:I(this,s);continue;case v.TEXT:if(this.sawRoot&&!this.closedRoot){for(var i=n-1;s&&"<"!==s&&"&"!==s;)(s=R(r,n++))&&this.trackPosition&&(this.position++,"\n"===s?(this.line++,this.column=0):this.column++);this.textNode+=r.substring(i,n-1)}"<"!==s||this.sawRoot&&this.closedRoot&&!this.strict?(g(s)||this.sawRoot&&!this.closedRoot||S(this,"Text data outside of root node."),"&"===s?this.state=v.TEXT_ENTITY:this.textNode+=s):(this.state=v.OPEN_WAKA,this.startTagPosition=this.position);continue;case v.SCRIPT:"<"===s?this.state=v.SCRIPT_ENDING:this.script+=s;continue;case v.SCRIPT_ENDING:"/"===s?this.state=v.CLOSE_TAG:(this.script+="<"+s,this.state=v.SCRIPT);continue;case v.OPEN_WAKA:"!"===s?(this.state=v.SGML_DECL,this.sgmlDecl=""):g(s)||(y(d,s)?(this.state=v.OPEN_TAG,this.tagName=s):"/"===s?(this.state=v.CLOSE_TAG,this.tagName=""):"?"===s?(this.state=v.PROC_INST,this.procInstName=this.procInstBody=""):(S(this,"Unencoded <"),this.startTagPosition+1<this.position&&(s=Array(this.position-this.startTagPosition).join(" ")+s),this.textNode+="<"+s,this.state=v.TEXT));continue;case v.SGML_DECL:"[CDATA["===(this.sgmlDecl+s).toUpperCase()?(x(this,"onopencdata"),this.state=v.CDATA,this.sgmlDecl="",this.cdata=""):this.sgmlDecl+s==="--"?(this.state=v.COMMENT,this.comment="",this.sgmlDecl=""):"DOCTYPE"===(this.sgmlDecl+s).toUpperCase()?(this.state=v.DOCTYPE,(this.doctype||this.sawRoot)&&S(this,"Inappropriately located doctype declaration"),this.doctype="",this.sgmlDecl=""):">"===s?(x(this,"onsgmldeclaration",this.sgmlDecl),this.sgmlDecl="",this.state=v.TEXT):(b(s)&&(this.state=v.SGML_DECL_QUOTED),this.sgmlDecl+=s);continue;case v.SGML_DECL_QUOTED:s===this.q&&(this.state=v.SGML_DECL,this.q=""),this.sgmlDecl+=s;continue;case v.DOCTYPE:">"===s?(this.state=v.TEXT,x(this,"ondoctype",this.doctype),this.doctype=!0):(this.doctype+=s,"["===s?this.state=v.DOCTYPE_DTD:b(s)&&(this.state=v.DOCTYPE_QUOTED,this.q=s));continue;case v.DOCTYPE_QUOTED:this.doctype+=s,s===this.q&&(this.q="",this.state=v.DOCTYPE);continue;case v.DOCTYPE_DTD:this.doctype+=s,"]"===s?this.state=v.DOCTYPE:b(s)&&(this.state=v.DOCTYPE_DTD_QUOTED,this.q=s);continue;case v.DOCTYPE_DTD_QUOTED:this.doctype+=s,s===this.q&&(this.state=v.DOCTYPE_DTD,this.q="");continue;case v.COMMENT:"-"===s?this.state=v.COMMENT_ENDING:this.comment+=s;continue;case v.COMMENT_ENDING:"-"===s?(this.state=v.COMMENT_ENDED,this.comment=k(this.opt,this.comment),this.comment&&x(this,"oncomment",this.comment),this.comment=""):(this.comment+="-"+s,this.state=v.COMMENT);continue;case v.COMMENT_ENDED:">"!==s?(S(this,"Malformed comment"),this.comment+="--"+s,this.state=v.COMMENT):this.state=v.TEXT;continue;case v.CDATA:"]"===s?this.state=v.CDATA_ENDING:this.cdata+=s;continue;case v.CDATA_ENDING:"]"===s?this.state=v.CDATA_ENDING_2:(this.cdata+="]"+s,this.state=v.CDATA);continue;case v.CDATA_ENDING_2:">"===s?(this.cdata&&x(this,"oncdata",this.cdata),x(this,"onclosecdata"),this.cdata="",this.state=v.TEXT):"]"===s?this.cdata+="]":(this.cdata+="]]"+s,this.state=v.CDATA);continue;case v.PROC_INST:"?"===s?this.state=v.PROC_INST_ENDING:g(s)?this.state=v.PROC_INST_BODY:this.procInstName+=s;continue;case v.PROC_INST_BODY:!this.procInstBody&&g(s)||("?"===s?this.state=v.PROC_INST_ENDING:this.procInstBody+=s);continue;case v.PROC_INST_ENDING:">"===s?(x(this,"onprocessinginstruction",{name:this.procInstName,body:this.procInstBody}),this.procInstName=this.procInstBody="",this.state=v.TEXT):(this.procInstBody+="?"+s,this.state=v.PROC_INST_BODY);continue;case v.OPEN_TAG:y(p,s)?this.tagName+=s:(!function(e){e.strict||(e.tagName=e.tagName[e.looseCase]());var t=e.tags[e.tags.length-1]||e,r=e.tag={name:e.tagName,attributes:{}};e.opt.xmlns&&(r.ns=t.ns),e.attribList.length=0,x(e,"onopentagstart",r)}(this),">"===s?j(this):"/"===s?this.state=v.OPEN_TAG_SLASH:(g(s)||S(this,"Invalid character in tag name"),this.state=v.ATTRIB));continue;case v.OPEN_TAG_SLASH:">"===s?(j(this,!0),T(this)):(S(this,"Forward-slash in opening tag not followed by >"),this.state=v.ATTRIB);continue;case v.ATTRIB:g(s)||(">"===s?j(this):"/"===s?this.state=v.OPEN_TAG_SLASH:y(d,s)?(this.attribName=s,this.attribValue="",this.state=v.ATTRIB_NAME):S(this,"Invalid attribute name"));continue;case v.ATTRIB_NAME:"="===s?this.state=v.ATTRIB_VALUE:">"===s?(S(this,"Attribute without value"),this.attribValue=this.attribName,C(this),j(this)):g(s)?this.state=v.ATTRIB_NAME_SAW_WHITE:y(p,s)?this.attribName+=s:S(this,"Invalid attribute name");continue;case v.ATTRIB_NAME_SAW_WHITE:if("="===s)this.state=v.ATTRIB_VALUE;else{if(g(s))continue;S(this,"Attribute without value"),this.tag.attributes[this.attribName]="",this.attribValue="",x(this,"onattribute",{name:this.attribName,value:""}),this.attribName="",">"===s?j(this):y(d,s)?(this.attribName=s,this.state=v.ATTRIB_NAME):(S(this,"Invalid attribute name"),this.state=v.ATTRIB)}continue;case v.ATTRIB_VALUE:g(s)||(b(s)?(this.q=s,this.state=v.ATTRIB_VALUE_QUOTED):(S(this,"Unquoted attribute value"),this.state=v.ATTRIB_VALUE_UNQUOTED,this.attribValue=s));continue;case v.ATTRIB_VALUE_QUOTED:if(s!==this.q){"&"===s?this.state=v.ATTRIB_VALUE_ENTITY_Q:this.attribValue+=s;continue}C(this),this.q="",this.state=v.ATTRIB_VALUE_CLOSED;continue;case v.ATTRIB_VALUE_CLOSED:g(s)?this.state=v.ATTRIB:">"===s?j(this):"/"===s?this.state=v.OPEN_TAG_SLASH:y(d,s)?(S(this,"No whitespace between attributes"),this.attribName=s,this.attribValue="",this.state=v.ATTRIB_NAME):S(this,"Invalid attribute name");continue;case v.ATTRIB_VALUE_UNQUOTED:if(!(">"===(a=s)||g(a))){"&"===s?this.state=v.ATTRIB_VALUE_ENTITY_U:this.attribValue+=s;continue}C(this),">"===s?j(this):this.state=v.ATTRIB;continue;case v.CLOSE_TAG:this.tagName?">"===s?T(this):y(p,s)?this.tagName+=s:this.script?(this.script+="</"+this.tagName,this.tagName="",this.state=v.SCRIPT):(g(s)||S(this,"Invalid tagname in closing tag"),this.state=v.CLOSE_TAG_SAW_WHITE):g(s)||(y(d,s)?this.tagName=s:this.script?(this.script+="</"+s,this.state=v.SCRIPT):S(this,"Invalid tagname in closing tag."));continue;case v.CLOSE_TAG_SAW_WHITE:if(g(s))continue;">"===s?T(this):S(this,"Invalid characters in closing tag");continue;case v.TEXT_ENTITY:case v.ATTRIB_VALUE_ENTITY_Q:case v.ATTRIB_VALUE_ENTITY_U:switch(this.state){case v.TEXT_ENTITY:o=v.TEXT,l="textNode";break;case v.ATTRIB_VALUE_ENTITY_Q:o=v.ATTRIB_VALUE_QUOTED,l="attribValue";break;case v.ATTRIB_VALUE_ENTITY_U:o=v.ATTRIB_VALUE_UNQUOTED,l="attribValue"}if(";"===s)if(this.opt.unparsedEntities){var a,o,l,c=N(this);this.entity="",this.state=o,this.write(c)}else this[l]+=N(this),this.entity="",this.state=o;else y(this.entity.length?m:f,s)?this.entity+=s:(S(this,"Invalid character in entity name"),this[l]+="&"+this.entity+s,this.entity="",this.state=o);continue;default:throw Error(this,"Unknown state: "+this.state)}return this.position>=this.bufferCheckPosition&&function(r){for(var n=Math.max(e.MAX_BUFFER_LENGTH,10),s=0,i=0,a=t.length;i<a;i++){var o=r[t[i]].length;if(o>n)switch(t[i]){case"textNode":O(r);break;case"cdata":x(r,"oncdata",r.cdata),r.cdata="";break;case"script":x(r,"onscript",r.script),r.script="";break;default:P(r,"Max buffer length exceeded: "+t[i])}s=Math.max(s,o)}r.bufferCheckPosition=e.MAX_BUFFER_LENGTH-s+r.position}(this),this},resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){O(this),""!==this.cdata&&(x(this,"oncdata",this.cdata),this.cdata=""),""!==this.script&&(x(this,"onscript",this.script),this.script="")}};var n,s,i,a=ReadableStream;a||(a=function(){});var o=e.EVENTS.filter(function(e){return"error"!==e&&"end"!==e});function l(e,t){if(!(this instanceof l))return new l(e,t);a.apply(this),this._parser=new r(e,t),this.writable=!0,this.readable=!0;var n=this;this._parser.onend=function(){n.emit("end")},this._parser.onerror=function(e){n.emit("error",e),n._parser.error=null},this._decoder=null,o.forEach(function(e){Object.defineProperty(n,"on"+e,{get:function(){return n._parser["on"+e]},set:function(t){if(!t)return n.removeAllListeners(e),n._parser["on"+e]=t,t;n.on(e,t)},enumerable:!0,configurable:!1})})}l.prototype=Object.create(a.prototype,{constructor:{value:l}}),l.prototype.write=function(e){return this._parser.write(e.toString()),this.emit("data",e),!0},l.prototype.end=function(e){return e&&e.length&&this.write(e),this._parser.end(),!0},l.prototype.on=function(e,t){var r=this;return r._parser["on"+e]||-1===o.indexOf(e)||(r._parser["on"+e]=function(){var t=1==arguments.length?[arguments[0]]:Array.apply(null,arguments);t.splice(0,0,e),r.emit.apply(r,t)}),a.prototype.on.call(r,e,t)};var c="http://www.w3.org/XML/1998/namespace",u="http://www.w3.org/2000/xmlns/",h={xml:c,xmlns:u},d=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,p=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,f=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,m=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function g(e){return" "===e||"\n"===e||"\r"===e||"	"===e}function b(e){return'"'===e||"'"===e}function y(e,t){return e.test(t)}var v=0;for(var w in e.STATE={BEGIN:v++,BEGIN_WHITESPACE:v++,TEXT:v++,TEXT_ENTITY:v++,OPEN_WAKA:v++,SGML_DECL:v++,SGML_DECL_QUOTED:v++,DOCTYPE:v++,DOCTYPE_QUOTED:v++,DOCTYPE_DTD:v++,DOCTYPE_DTD_QUOTED:v++,COMMENT_STARTING:v++,COMMENT:v++,COMMENT_ENDING:v++,COMMENT_ENDED:v++,CDATA:v++,CDATA_ENDING:v++,CDATA_ENDING_2:v++,PROC_INST:v++,PROC_INST_BODY:v++,PROC_INST_ENDING:v++,OPEN_TAG:v++,OPEN_TAG_SLASH:v++,ATTRIB:v++,ATTRIB_NAME:v++,ATTRIB_NAME_SAW_WHITE:v++,ATTRIB_VALUE:v++,ATTRIB_VALUE_QUOTED:v++,ATTRIB_VALUE_CLOSED:v++,ATTRIB_VALUE_UNQUOTED:v++,ATTRIB_VALUE_ENTITY_Q:v++,ATTRIB_VALUE_ENTITY_U:v++,CLOSE_TAG:v++,CLOSE_TAG_SAW_WHITE:v++,SCRIPT:v++,SCRIPT_ENDING:v++},e.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},e.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(e.ENTITIES).forEach(function(t){var r=e.ENTITIES[t],n="number"==typeof r?String.fromCharCode(r):r;e.ENTITIES[t]=n}),e.STATE)e.STATE[e.STATE[w]]=w;function _(e,t,r){e[t]&&e[t](r)}function x(e,t,r){e.textNode&&O(e),_(e,t,r)}function O(e){e.textNode=k(e.opt,e.textNode),e.textNode&&_(e,"ontext",e.textNode),e.textNode=""}function k(e,t){return e.trim&&(t=t.trim()),e.normalize&&(t=t.replace(/\s+/g," ")),t}function P(e,t){return O(e),e.trackPosition&&(t+="\nLine: "+e.line+"\nColumn: "+e.column+"\nChar: "+e.c),e.error=t=Error(t),_(e,"onerror",t),e}function E(e){return e.sawRoot&&!e.closedRoot&&S(e,"Unclosed root tag"),e.state!==v.BEGIN&&e.state!==v.BEGIN_WHITESPACE&&e.state!==v.TEXT&&P(e,"Unexpected end"),O(e),e.c="",e.closed=!0,_(e,"onend"),r.call(e,e.strict,e.opt),e}function S(e,t){if("object"!=typeof e||!(e instanceof r))throw Error("bad call to strictFail");e.strict&&P(e,t)}function A(e,t){var r=0>e.indexOf(":")?["",e]:e.split(":"),n=r[0],s=r[1];return t&&"xmlns"===e&&(n="xmlns",s=""),{prefix:n,local:s}}function C(e){if(e.strict||(e.attribName=e.attribName[e.looseCase]()),-1!==e.attribList.indexOf(e.attribName)||e.tag.attributes.hasOwnProperty(e.attribName)){e.attribName=e.attribValue="";return}if(e.opt.xmlns){var t=A(e.attribName,!0),r=t.prefix,n=t.local;if("xmlns"===r)if("xml"===n&&e.attribValue!==c)S(e,"xml: prefix must be bound to "+c+"\nActual: "+e.attribValue);else if("xmlns"===n&&e.attribValue!==u)S(e,"xmlns: prefix must be bound to "+u+"\nActual: "+e.attribValue);else{var s=e.tag,i=e.tags[e.tags.length-1]||e;s.ns===i.ns&&(s.ns=Object.create(i.ns)),s.ns[n]=e.attribValue}e.attribList.push([e.attribName,e.attribValue])}else e.tag.attributes[e.attribName]=e.attribValue,x(e,"onattribute",{name:e.attribName,value:e.attribValue});e.attribName=e.attribValue=""}function j(e,t){if(e.opt.xmlns){var r=e.tag,n=A(e.tagName);r.prefix=n.prefix,r.local=n.local,r.uri=r.ns[n.prefix]||"",r.prefix&&!r.uri&&(S(e,"Unbound namespace prefix: "+JSON.stringify(e.tagName)),r.uri=n.prefix);var s=e.tags[e.tags.length-1]||e;r.ns&&s.ns!==r.ns&&Object.keys(r.ns).forEach(function(t){x(e,"onopennamespace",{prefix:t,uri:r.ns[t]})});for(var i=0,a=e.attribList.length;i<a;i++){var o=e.attribList[i],l=o[0],c=o[1],u=A(l,!0),h=u.prefix,d=u.local,p=""===h?"":r.ns[h]||"",f={name:l,value:c,prefix:h,local:d,uri:p};h&&"xmlns"!==h&&!p&&(S(e,"Unbound namespace prefix: "+JSON.stringify(h)),f.uri=h),e.tag.attributes[l]=f,x(e,"onattribute",f)}e.attribList.length=0}e.tag.isSelfClosing=!!t,e.sawRoot=!0,e.tags.push(e.tag),x(e,"onopentag",e.tag),t||(e.noscript||"script"!==e.tagName.toLowerCase()?e.state=v.TEXT:e.state=v.SCRIPT,e.tag=null,e.tagName=""),e.attribName=e.attribValue="",e.attribList.length=0}function T(e){if(!e.tagName){S(e,"Weird empty close tag."),e.textNode+="</>",e.state=v.TEXT;return}if(e.script){if("script"!==e.tagName){e.script+="</"+e.tagName+">",e.tagName="",e.state=v.SCRIPT;return}x(e,"onscript",e.script),e.script=""}var t=e.tags.length,r=e.tagName;e.strict||(r=r[e.looseCase]());for(var n=r;t--;)if(e.tags[t].name!==n)S(e,"Unexpected close tag");else break;if(t<0){S(e,"Unmatched closing tag: "+e.tagName),e.textNode+="</"+e.tagName+">",e.state=v.TEXT;return}e.tagName=r;for(var s=e.tags.length;s-- >t;){var i=e.tag=e.tags.pop();e.tagName=e.tag.name,x(e,"onclosetag",e.tagName);var a={};for(var o in i.ns)a[o]=i.ns[o];var l=e.tags[e.tags.length-1]||e;e.opt.xmlns&&i.ns!==l.ns&&Object.keys(i.ns).forEach(function(t){var r=i.ns[t];x(e,"onclosenamespace",{prefix:t,uri:r})})}0===t&&(e.closedRoot=!0),e.tagName=e.attribValue=e.attribName="",e.attribList.length=0,e.state=v.TEXT}function N(e){var t,r=e.entity,n=r.toLowerCase(),s="";return e.ENTITIES[r]?e.ENTITIES[r]:e.ENTITIES[n]?e.ENTITIES[n]:("#"===(r=n).charAt(0)&&(s="x"===r.charAt(1)?(t=parseInt(r=r.slice(2),16)).toString(16):(t=parseInt(r=r.slice(1),10)).toString(10)),r=r.replace(/^0+/,""),isNaN(t)||s.toLowerCase()!==r)?(S(e,"Invalid character entity"),"&"+e.entity+";"):String.fromCodePoint(t)}function I(e,t){"<"===t?(e.state=v.OPEN_WAKA,e.startTagPosition=e.position):g(t)||(S(e,"Non-whitespace before first tag."),e.textNode=t,e.state=v.TEXT)}function R(e,t){var r="";return t<e.length&&(r=e.charAt(t)),r}return v=e.STATE,String.fromCodePoint||(n=String.fromCharCode,s=Math.floor,i=function(){var e,t,r=[],i=-1,a=arguments.length;if(!a)return"";for(var o="";++i<a;){var l=Number(arguments[i]);if(!isFinite(l)||l<0||l>1114111||s(l)!==l)throw RangeError("Invalid code point: "+l);l<=65535?r.push(l):(l-=65536,e=(l>>10)+55296,t=l%1024+56320,r.push(e,t)),(i+1===a||r.length>16384)&&(o+=n.apply(null,r),r.length=0)}return o},Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:i,configurable:!0,writable:!0}):String.fromCodePoint=i),e}(),nk=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``;class nP extends nc{constructor(e){super(e),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.tags=e?.tags}static lc_name(){return"XMLOutputParser"}_diff(e,t){if(t)return e?(0,nw.compare)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return nS(e[0].text)}async parse(e){return nS(e)}getFormatInstructions(){return this.tags&&this.tags.length>0?nk.replace("{tags}",this.tags?.join(", ")??""):nk}}let nE=e=>{if(0===Object.keys(e).length)return{};let t={};return e.children.length>0?t[e.name]=e.children.map(nE):t[e.name]=e.text??void 0,t};function nS(e){let t=e.split("\n").map(e=>e.replace(/^\s+/,"")).join("\n").trim(),r=nO.parser(!0),n={},s=[];r.onopentag=e=>{let t={name:e.name,attributes:e.attributes,children:[],text:"",isSelfClosing:e.isSelfClosing};s.length>0?s[s.length-1].children.push(t):n=t,e.isSelfClosing||s.push(t)},r.onclosetag=()=>{if(s.length>0){let e=s.pop();0===s.length&&e&&(n=e)}},r.ontext=e=>{if(s.length>0){let t=s[s.length-1];t.text+=e}},r.onattribute=e=>{s.length>0&&(s[s.length-1].attributes[e.name]=e.value)};let i=/```(xml)?(.*)```/s.exec(t),a=i?i[2]:t;return r.write(a).close(),n&&"?xml"===n.name&&(n=n.children[0]),nE(n)}e.s(["XMLOutputParser",()=>nP,"XML_FORMAT_INSTRUCTIONS",0,nk,"parseXMLMarkdown",()=>nS],77974),e.s([],40502);class nA extends ns{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new na(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let t=e.flatMap(e=>{let{message:t}=e;return"tool_calls"in t&&Array.isArray(t.tool_calls)?t.tool_calls:[]});if(void 0===t[0])throw Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");let[r]=t;return await this._validateResult(r.args)}}function nC(e,t){let r,n,s=(r=[],n=[],(e.forEach(e=>{var t,s;if(re(e)){let[n]=(t=[e]).every(e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations))?t:[{functionDeclarations:t.map(e=>{if(re(e)){let t=r7(e.schema);return{name:e.name,description:e.description,parameters:t}}return tY(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:function(e){let{$schema:t,...r}=r6(e);return r}(e.function.parameters)}:e})}];n.functionDeclarations&&r.push(...n.functionDeclarations)}else if(tY(e)){let{functionDeclarations:t}={functionDeclarations:[{name:(s=e).function.name,description:s.function.description,parameters:r6(s.function.parameters)}]};if(t)r.push(...t);else throw Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else n.push(e)}),n.find(e=>"functionDeclarations"in e))?n.map(e=>{if(r?.length>0&&"functionDeclarations"in e){let t={functionDeclarations:[...e.functionDeclarations||[],...r]};return r=[],t}return e}):[...n,...r.length>0?[{functionDeclarations:r}]:[]]),i=function(e,t){if(!e.length||!t)return;let{toolChoice:r,allowedFunctionNames:n}=t,s={any:$.ANY,auto:$.AUTO,none:$.NONE};return r&&["any","auto","none"].includes(r)?{functionCallingConfig:{mode:s[r]??"MODE_UNSPECIFIED",allowedFunctionNames:n}}:"string"==typeof r||n?{functionCallingConfig:{mode:$.ANY,allowedFunctionNames:[...n??[],...r&&"string"==typeof r?[r]:[]]}}:void 0}(s,t);return{tools:s,toolConfig:i}}class nj extends rZ{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=e?.model?.replace(/^models\//,"")??e?.modelName?.replace(/^models\//,"")??this.model,this.model=this.modelName,this.maxOutputTokens=e?.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e?.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=e?.topP??this.topP,this.topP&&this.topP<0)throw Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw Error("`topP` must be below 1.");if(this.topK=e?.topK??this.topK,this.topK&&this.topK<0)throw Error("`topK` must be a positive integer");if(this.stopSequences=e?.stopSequences??this.stopSequences,this.apiKey=e?.apiKey??(0,rK.getEnvironmentVariable)("GOOGLE_API_KEY"),!this.apiKey)throw Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e?.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(e=>e.category)).size!==this.safetySettings.length)throw Error("The categories in `safetySettings` array must be unique");this.streaming=e?.streaming??this.streaming,this.client=new rU(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...e?.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e?.apiVersion,baseUrl:e?.baseUrl}),this.streamUsage=e?.streamUsage??this.streamUsage}useCachedContent(e,t,r){this.apiKey&&(this.client=new rU(this.apiKey).getGenerativeModelFromCachedContent(e,t,r))}get useSystemInstruction(){return"boolean"==typeof this.convertSystemMessageToHumanContent?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return!("gemini-1.0-pro-001"===this.modelName||this.modelName.startsWith("gemini-pro-vision"))&&!this.modelName.startsWith("gemini-1.0-pro-vision")&&"gemini-pro"!==this.modelName&&!0}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.bind({tools:nC(e)?.tools,...t})}invocationParams(e){let t=e?.tools?.length?nC(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return{...t?.tools?{tools:t.tools}:{},...t?.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,r){let n,s=nt(e,this._isMultimodalModel,this.useSystemInstruction),i=s;if("system"===s[0].role){let[e]=s;this.client.systemInstruction=e,i=s.slice(1)}let a=this.invocationParams(t);if(this.streaming){let n=this._streamResponseChunks(e,t,r),s={};for await(let e of n){let t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}return{generations:Object.entries(s).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),llmOutput:{estimatedTokenUsage:{}}}}let o=await this.completionWithRetry({...a,contents:i});if("usageMetadata"in o.response){let e=o.response.usageMetadata;n={input_tokens:e.promptTokenCount??0,output_tokens:e.candidatesTokenCount??0,total_tokens:e.totalTokenCount??0}}let l=function(e,t){let r;if(!e.candidates||0===e.candidates.length||!e.candidates[0])return{generations:[],llmOutput:{filters:e.promptFeedback}};let n=e.functionCalls(),[s]=e.candidates,{content:i,...a}=s;r=i?.parts.length===1&&i.parts[0].text?i.parts[0].text:i.parts.map(e=>"text"in e?{type:"text",text:e.text}:"executableCode"in e?{type:"executableCode",executableCode:e.executableCode}:"codeExecutionResult"in e?{type:"codeExecutionResult",codeExecutionResult:e.codeExecutionResult}:e);let o="";return"string"==typeof r?o=r:"text"in r[0]&&(o=r[0].text),{generations:[{text:o,message:new to.AIMessage({content:r,tool_calls:n?.map(e=>({...e,type:"tool_call"})),additional_kwargs:{...a},usage_metadata:t?.usageMetadata}),generationInfo:a}],llmOutput:{tokenUsage:{promptTokens:t?.usageMetadata?.input_tokens,completionTokens:t?.usageMetadata?.output_tokens,totalTokens:t?.usageMetadata?.total_tokens}}}}(o.response,{usageMetadata:n});return await r?.handleLLMNewToken(l.generations[0].text??""),l}async *_streamResponseChunks(e,t,r){let n,s=nt(e,this._isMultimodalModel,this.useSystemInstruction),i=s;if("system"===s[0].role){let[e]=s;this.client.systemInstruction=e,i=s.slice(1)}let a={...this.invocationParams(t),contents:i},o=await this.caller.callWithOptions({signal:t?.signal},async()=>{let{stream:e}=await this.client.generateContentStream(a);return e}),l=0;for await(let e of o){if("usageMetadata"in e&&!1!==this.streamUsage&&!1!==t.streamUsage){let t=e.usageMetadata;if(n){let e=(t.candidatesTokenCount??0)-n.output_tokens;n={input_tokens:0,output_tokens:e,total_tokens:e}}else n={input_tokens:t.promptTokenCount??0,output_tokens:t.candidatesTokenCount??0,total_tokens:t.totalTokenCount??0}}let s=function(e,t){let r;if(!e.candidates||0===e.candidates.length)return null;let n=e.functionCalls(),[s]=e.candidates,{content:i,...a}=s;i?.parts&&i.parts.every(e=>"text"in e)?r=i.parts.map(e=>e.text).join(""):i.parts&&(r=i.parts.map(e=>"text"in e?{type:"text",text:e.text}:"executableCode"in e?{type:"executableCode",executableCode:e.executableCode}:"codeExecutionResult"in e?{type:"codeExecutionResult",codeExecutionResult:e.codeExecutionResult}:e));let o="";r&&"string"==typeof r?o=r:r&&"object"==typeof r&&"text"in r[0]&&(o=r[0].text);let l=[];return n&&l.push(...n.map(e=>({...e,args:JSON.stringify(e.args),index:t.index,type:"tool_call_chunk"}))),new rz.ChatGenerationChunk({text:o,message:new to.AIMessageChunk({content:r||"",name:i?i.role:void 0,tool_call_chunks:l,additional_kwargs:{},usage_metadata:t.usageMetadata}),generationInfo:a})}(e,{usageMetadata:n,index:l});l+=1,s&&(yield s,await r?.handleLLMNewToken(s.text??""))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t?.signal},async()=>{try{return await this.client.generateContent(e)}catch(e){throw e.message?.includes("400 Bad Request")&&(e.status=400),e}})}withStructuredOutput(e,t){let r,n,s=t?.name,i=t?.method,a=t?.includeRaw;if("jsonMode"===i)throw Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let o=s??"extract";if((0,t4.isZodSchema)(e)){let t=r7(e);n=[{functionDeclarations:[{name:o,description:t.description??"A function available to call.",parameters:t}]}],r=new nA({returnSingle:!0,keyName:o,zodSchema:e})}else{let t;"string"==typeof e.name&&"object"==typeof e.parameters&&null!=e.parameters?(t=e,o=e.name):t={name:o,description:e.description??"",parameters:e},n=[{functionDeclarations:[t]}],r=new nA({returnSingle:!0,keyName:o})}let l=this.bind({tools:n,tool_choice:o});if(!a)return l.pipe(r).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});let c=rW.assign({parsed:(e,t)=>r.invoke(e.raw,t)}),u=rW.assign({parsed:()=>null}),h=c.withFallbacks({fallbacks:[u]});return r3.RunnableSequence.from([{raw:l},h]).withConfig({runName:"StructuredOutputRunnable"})}}class nT{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new tF.AsyncCaller(e??{})}}e.s(["Embeddings",()=>nT],96236),e.s(["chunkArray",0,(e,t)=>e.reduce((e,r,n)=>{let s=Math.floor(n/t),i=e[s]||[];return e[s]=i.concat([r]),e},[])],67324);class nN extends Error{constructor(e,t){let r=e??"";t?.lc_error_code&&(r=`${r}

Troubleshooting URL: https://langchain-ai.github.io/langgraphjs/troubleshooting/errors/${t.lc_error_code}/
`),super(r),Object.defineProperty(this,"lc_error_code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_error_code=t?.lc_error_code}}class nI extends nN{get is_bubble_up(){return!0}}class nR extends nN{constructor(e,t){super(e,t),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}}class nM extends nN{constructor(e,t){super(e,t),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}}class n$ extends nI{constructor(e,t){super(JSON.stringify(e,null,2),t),Object.defineProperty(this,"interrupts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}}class nL extends n${constructor(e,t){super([{value:e,when:"during"}],t),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}}class nD extends nI{constructor(e){super(),Object.defineProperty(this,"command",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}}function nB(e){return void 0!==e&&e.name===nD.unminifiable_name}function nF(e){return void 0!==e&&!0===e.is_bubble_up}function nU(e){return void 0!==e&&[n$.unminifiable_name,nL.unminifiable_name].includes(e.name)}class nK extends nN{constructor(e,t){super(e,t),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}}class nz extends nN{constructor(e,t){super(e,t),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}}class nV extends nN{constructor(e,t){super(e,t),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}}class nq extends nN{constructor(e,t){super(e,t),this.name="MultipleSubgraphError"}static get unminifiable_name(){return"MultipleSubgraphError"}}class nW extends nN{constructor(e,t){super(e,t),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}}class nG extends nN{constructor(e,t){super(e,t),this.name="RemoteException"}static get unminifiable_name(){return"RemoteException"}}e.s(["BaseLangGraphError",()=>nN,"EmptyChannelError",()=>nz,"EmptyInputError",()=>nK,"GraphBubbleUp",()=>nI,"GraphInterrupt",()=>n$,"GraphRecursionError",()=>nR,"GraphValueError",()=>nM,"InvalidUpdateError",()=>nV,"MultipleSubgraphsError",()=>nq,"NodeInterrupt",()=>nL,"ParentCommand",()=>nD,"RemoteException",()=>nG,"UnreachableNodeError",()=>nW,"getSubgraphsSeenSet",0,()=>(void 0===globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]&&(globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]=new Set),globalThis[Symbol.for("LG_CHECKPOINT_SEEN_NS_SET")]),"isGraphBubbleUp",()=>nF,"isGraphInterrupt",()=>nU,"isParentCommand",()=>nB],90588);var nJ=e.i(2082),nH=e.i(65704),nZ=e.i(65274),nY=0,nX=0;let nQ=function(e,t,r){var n=t&&r||0,s=t||Array(16),i=(e=e||{}).node,a=e.clockseq;if(e._v6||(i||(i=B),null==a&&(a=F)),null==i||null==a){var o=e.random||(e.rng||nZ.default)();null==i&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],B||e._v6||(i[0]|=1,B=i)),null==a&&(a=(o[6]<<8|o[7])&16383,void 0!==F||e._v6||(F=a))}var l=void 0!==e.msecs?e.msecs:Date.now(),c=void 0!==e.nsecs?e.nsecs:nX+1,u=l-nY+(c-nX)/1e4;if(u<0&&void 0===e.clockseq&&(a=a+1&16383),(u<0||l>nY)&&void 0===e.nsecs&&(c=0),c>=1e4)throw Error("uuid.v1(): Can't create more than 10M uuids/sec");nY=l,nX=c,F=a;var h=((0xfffffff&(l+=122192928e5))*1e4+c)%0x100000000;s[n++]=h>>>24&255,s[n++]=h>>>16&255,s[n++]=h>>>8&255,s[n++]=255&h;var d=l/0x100000000*1e4&0xfffffff;s[n++]=d>>>8&255,s[n++]=255&d,s[n++]=d>>>24&15|16,s[n++]=d>>>16&255,s[n++]=a>>>8|128,s[n++]=255&a;for(var p=0;p<6;++p)s[n+p]=i[p];return t||(0,nH.unsafeStringify)(s)};var n0=e.i(38685);function n1(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function n2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n1(Object(r),!0).forEach(function(t){var n,s,i;n=e,s=t,i=r[t],(s=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(s))in n?Object.defineProperty(n,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[s]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n1(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function n5(e){return function(e={},t,r=0){var n,s,i=nQ(n2(n2({},e),{},{_v6:!0}),new Uint8Array(16));return s=function(e,t=!1){return Uint8Array.of((15&e[6])<<4|e[7]>>4&15,(15&e[7])<<4|(240&e[4])>>4,(15&e[4])<<4|(240&e[5])>>4,(15&e[5])<<4|(240&e[0])>>4,(15&e[0])<<4|(240&e[1])>>4,(15&e[1])<<4|(240&e[2])>>4,96|15&e[2],e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}("string"==typeof(n=i)?(0,n0.default)(n):n),i="string"==typeof n?(0,nH.unsafeStringify)(s):s,(0,nH.unsafeStringify)(i)}({clockseq:e})}function n3(e,t){let r=t.replace(/-/g,"").match(/.{2}/g).map(e=>parseInt(e,16));return(0,nJ.v5)(e,new Uint8Array(r))}e.s(["uuid5",()=>n3,"uuid6",()=>n5],24060);let n4="__error__",n8="__scheduled__",n6="__interrupt__",n7="__resume__";e.s(["ERROR",0,n4,"INTERRUPT",0,n6,"RESUME",0,n7,"SCHEDULED",0,n8,"TASKS",0,"__pregel_tasks"],81800);var n9=e.i(87863);let se=[];e.s([],55352),e.i(5354);var st=n9;class sr extends st.Serializable{async addMessages(e){for(let t of e)await this.addMessage(t)}}class sn extends st.Serializable{addUserMessage(e){return this.addMessage(new ti.HumanMessage(e))}addAIChatMessage(e){return this.addMessage(new to.AIMessage(e))}addAIMessage(e){return this.addMessage(new to.AIMessage(e))}async addMessages(e){for(let t of e)await this.addMessage(t)}clear(){throw Error("Not implemented.")}}class ss extends sn{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}}e.s(["BaseChatMessageHistory",()=>sr,"BaseListChatMessageHistory",()=>sn,"InMemoryChatMessageHistory",()=>ss],47111);class si{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=void 0!==e.pageContent?e.pageContent.toString():"",this.metadata=e.metadata??{},this.id=e.id}}e.s(["Document",()=>si],83292);var sa=tJ;class so extends sa.Runnable{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","documents","transformers"]})}invoke(e,t){return this.transformDocuments(e)}}class sl extends so{async transformDocuments(e){let t=[];for(let r of e){let e=await this._transformDocument(r);t.push(e)}return t}}e.s(["BaseDocumentTransformer",()=>so,"MappingDocumentTransformer",()=>sl],17733),e.s([],14786);var sc=n9;class su extends sc.Serializable{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","example_selectors","base"]})}}e.s(["BaseExampleSelector",()=>su],16448);class sh{async getPromptAsync(e,t){return this.getPrompt(e).partial(t?.partialVariables??{})}}class sd extends sh{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(let[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}function sp(e){return"base_llm"===e._modelType()}function sf(e){return"base_chat_model"===e._modelType()}function sm(e){return e.split(/\n| /).length}e.s(["BasePromptSelector",()=>sh,"ConditionalPromptSelector",()=>sd,"isChatModel",()=>sf,"isLLM",()=>sp],56767);class sg extends su{constructor(e){super(e),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getTextLength",{enumerable:!0,configurable:!0,writable:!0,value:sm}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"exampleTextLengths",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.examplePrompt=e.examplePrompt,this.maxLength=e.maxLength??2048,this.getTextLength=e.getTextLength??sm}async addExample(e){this.examples.push(e);let t=await this.examplePrompt.format(e);this.exampleTextLengths.push(this.getTextLength(t))}async calculateExampleTextLengths(e,t){if(e.length>0)return e;let{examples:r,examplePrompt:n}=t;return(await Promise.all(r.map(e=>n.format(e)))).map(e=>this.getTextLength(e))}async selectExamples(e){let t=Object.values(e).join(" "),r=this.maxLength-this.getTextLength(t),n=0,s=[];for(;r>0&&n<this.examples.length;){let e=r-this.exampleTextLengths[n];if(e<0)break;s.push(this.examples[n]),r=e,n+=1}return s}static async fromExamples(e,t){let r=new sg(t);return await Promise.all(e.map(e=>r.addExample(e))),r}}function sb(e){return Object.keys(e).sort().map(t=>e[t])}e.s(["LengthBasedExampleSelector",()=>sg],70800);class sy extends su{constructor(e){if(super(e),Object.defineProperty(this,"vectorStoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exampleKeys=e.exampleKeys,this.inputKeys=e.inputKeys,void 0!==e.vectorStore)this.vectorStoreRetriever=e.vectorStore.asRetriever({k:e.k??4,filter:e.filter});else if(e.vectorStoreRetriever)this.vectorStoreRetriever=e.vectorStoreRetriever;else throw Error('You must specify one of "vectorStore" and "vectorStoreRetriever".')}async addExample(e){let t=sb((this.inputKeys??Object.keys(e)).reduce((t,r)=>({...t,[r]:e[r]}),{})).join(" ");await this.vectorStoreRetriever.addDocuments([new si({pageContent:t,metadata:e})])}async selectExamples(e){let t=sb((this.inputKeys??Object.keys(e)).reduce((t,r)=>({...t,[r]:e[r]}),{})).join(" "),r=(await this.vectorStoreRetriever.invoke(t)).map(e=>e.metadata);return this.exampleKeys?r.map(e=>this.exampleKeys.reduce((t,r)=>({...t,[r]:e[r]}),{})):r}static async fromExamples(e,t,r,n={}){let s=n.inputKeys??null,i=e.map(e=>sb(s?s.reduce((t,r)=>({...t,[r]:e[r]}),{}):e).join(" "));return new sy({vectorStore:await r.fromTexts(i,e,t,n),k:n.k??4,exampleKeys:n.exampleKeys,inputKeys:n.inputKeys})}}e.s(["SemanticSimilarityExampleSelector",()=>sy],41700),e.s([],4648);class sv extends t0{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){let r=sv._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].text}async *_streamResponseChunks(e,t,r){throw Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async *_streamIterator(e,t){if(this._streamResponseChunks===sv.prototype._streamResponseChunks)yield this.invoke(e,t);else{let r=sv._convertInputToPromptValue(e),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(t),i=await ty.CallbackManager.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),a={options:s,invocation_params:this?.invocationParams(s),batch_size:1},o=await i?.handleLLMStart(this.toJSON(),[r.toString()],n.runId,void 0,a,void 0,void 0,n.runName),l=new rz.GenerationChunk({text:""});try{for await(let e of this._streamResponseChunks(r.toString(),s,o?.[0]))l=l?l.concat(e):e,"string"==typeof e.text&&(yield e.text)}catch(e){throw await Promise.all((o??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((o??[]).map(e=>e?.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(e,t,r){let n=e.map(e=>e.toString());return this.generate(n,t,r)}invocationParams(e){return{}}_flattenLLMResult(e){let t=[];for(let r=0;r<e.generations.length;r+=1){let n=e.generations[r];if(0===r)t.push({generations:[n],llmOutput:e.llmOutput});else{let r=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[n],llmOutput:r})}}return t}async _generateUncached(e,t,r,n){let s,i;if(void 0!==n&&n.length===e.length)s=n;else{let n=await ty.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length};s=await n?.handleLLMStart(this.toJSON(),e,r.runId,void 0,i,void 0,void 0,r?.runName)}if(s?.[0].handlers.find(rG.callbackHandlerPrefersStreaming)&&1===e.length&&this._streamResponseChunks!==sv.prototype._streamResponseChunks)try{let r;for await(let n of(await this._streamResponseChunks(e[0],t,s?.[0])))r=void 0===r?n:(0,rV.concat)(r,n);if(void 0===r)throw Error("Received empty response from chat model call.");i={generations:[[r]],llmOutput:{}},await s?.[0].handleLLMEnd(i)}catch(e){throw await s?.[0].handleLLMError(e),e}else{try{i=await this._generate(e,t,s?.[0])}catch(e){throw await Promise.all((s??[]).map(t=>t?.handleLLMError(e))),e}let r=this._flattenLLMResult(i);await Promise.all((s??[]).map((e,t)=>e?.handleLLMEnd(r[t])))}let a=s?.map(e=>e.runId)||void 0;return Object.defineProperty(i,rz.RUN_KEY,{value:a?{runIds:a}:void 0,configurable:!0}),i}async _generateCached({prompts:e,cache:t,llmStringKey:r,parsedOptions:n,handledOptions:s,runId:i}){let a=await ty.CallbackManager.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o={options:n,invocation_params:this?.invocationParams(n),batch_size:e.length},l=await a?.handleLLMStart(this.toJSON(),e,i,void 0,o,void 0,void 0,s?.runName),c=[],u=(await Promise.allSettled(e.map(async(e,n)=>{let s=await t.lookup(e,r);return null==s&&c.push(n),s}))).map((e,t)=>({result:e,runManager:l?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=[];await Promise.all(u.map(async({result:e,runManager:t},r)=>{if("fulfilled"!==e.status)return await t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(e.reason);{let n=e.value;return h[r]=n.map(e=>(e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),n.length&&await t?.handleLLMNewToken(n[0].text),t?.handleLLMEnd({generations:[n]},void 0,void 0,void 0,{cached:!0})}}));let d={generations:h,missingPromptIndices:c,startedRunManagers:l};return Object.defineProperty(d,rz.RUN_KEY,{value:l?{runIds:l?.map(e=>e.runId)}:void 0,configurable:!0}),d}async generate(e,t,r){let n;if(!Array.isArray(e))throw Error("Argument 'prompts' is expected to be a string[]");n=Array.isArray(t)?{stop:t}:t;let[s,i]=this._separateRunnableConfigFromCallOptionsCompat(n);if(s.callbacks=s.callbacks??r,!this.cache)return this._generateUncached(e,i,s);let{cache:a}=this,o=this._getSerializedCacheKeyParametersForCall(i),{generations:l,missingPromptIndices:c,startedRunManagers:u}=await this._generateCached({prompts:e,cache:a,llmStringKey:o,parsedOptions:i,handledOptions:s,runId:s.runId}),h={};if(c.length>0){let t=await this._generateUncached(c.map(t=>e[t]),i,s,void 0!==u?c.map(e=>u?.[e]):void 0);await Promise.all(t.generations.map(async(t,r)=>{let n=c[r];return l[n]=t,a.update(e[n],o,t)})),h=t.llmOutput??{}}return{generations:l,llmOutput:h}}async call(e,t,r){let{generations:n}=await this.generate([e],t,r);return n[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){let n=(0,th.getBufferString)(e),s=await this.call(n,t,r);return new to.AIMessage(s)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class sw extends sv{async _generate(e,t,r){return{generations:await Promise.all(e.map((e,n)=>this._call(e,{...t,promptIndex:n},r).then(e=>[{text:e}])))}}}e.s(["BaseLLM",()=>sv,"LLM",()=>sw],21532);class s_{}let sx=(e,t)=>{if(void 0!==t)return e[t];let r=Object.keys(e);if(1===r.length)return e[r[0]]};function sO(e,t){let r=Object.keys(e).filter(e=>!t.includes(e)&&"stop"!==e);if(1!==r.length)throw Error(`One input key expected, but got ${r.length}`);return r[0]}e.s(["BaseMemory",()=>s_,"getInputValue",0,(e,t)=>{let r=sx(e,t);if(!r){let t=Object.keys(e);throw Error(`input values have ${t.length} keys, you must specify an input key or pass only 1 key as input`)}return r},"getOutputValue",0,(e,t)=>{let r=sx(e,t);if(!r&&""!==r){let t=Object.keys(e);throw Error(`output values have ${t.length} keys, you must specify an output key or pass only 1 key as output`)}return r},"getPromptInputKey",()=>sO],9747);var sk=e.i(98470),sP=e.i(86039),sE=e.i(28147),sS=sk;class sA extends sS.BasePromptTemplate{static lc_name(){return"PipelinePromptTemplate"}constructor(e){super({...e,inputVariables:[]}),Object.defineProperty(this,"pipelinePrompts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"finalPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pipelinePrompts=e.pipelinePrompts,this.finalPrompt=e.finalPrompt,this.inputVariables=this.computeInputValues()}computeInputValues(){let e=this.pipelinePrompts.map(e=>e.name);return[...new Set(this.pipelinePrompts.map(t=>t.prompt.inputVariables.filter(t=>!e.includes(t))).flat())]}static extractRequiredInputValues(e,t){return t.reduce((t,r)=>(t[r]=e[r],t),{})}async formatPipelinePrompts(e){let t=await this.mergePartialAndUserVariables(e);for(let{name:e,prompt:r}of this.pipelinePrompts){let n=sA.extractRequiredInputValues(t,r.inputVariables);r instanceof sP.ChatPromptTemplate?t[e]=await r.formatMessages(n):t[e]=await r.format(n)}return sA.extractRequiredInputValues(t,this.finalPrompt.inputVariables)}async formatPromptValue(e){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(e))}async format(e){return this.finalPrompt.format(await this.formatPipelinePrompts(e))}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(t=>!(t in e)),t.partialVariables={...this.partialVariables??{},...e},new sA(t)}serialize(){throw Error("Not implemented.")}_getPromptType(){return"pipeline"}}e.s(["PipelinePromptTemplate",()=>sA],84028);var sC=e.i(31601);e.s([],60307);var sj=e.i(88037),sT=e.i(29157),sN=e.i(35316),sI=sP;function sR(e){return"object"==typeof e&&null!=e&&"withStructuredOutput"in e&&"function"==typeof e.withStructuredOutput}class sM extends sI.ChatPromptTemplate{get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"method",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","structured"]}),this.schema=e.schema,this.method=e.method}pipe(e){if(sR(e))return super.pipe(e.withStructuredOutput(this.schema));if("object"==typeof e&&null!=e&&"lc_id"in e&&Array.isArray(e.lc_id)&&"langchain_core/runnables/RunnableBinding"===e.lc_id.join("/")&&sR(e.bound))return super.pipe(new tJ.RunnableBinding({bound:e.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:e.kwargs??{},config:e.config,configFactories:e.configFactories}));throw Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(e,t,r){return sM.fromMessages(e,{schema:t,method:r})}}e.s(["StructuredPrompt",()=>sM],70658);var s$=e.i(21282);e.s([],38538);var sL=tJ;class sD extends sL.Runnable{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e?.callbacks,this.tags=e?.tags??[],this.metadata=e?.metadata??{},this.verbose=e?.verbose??!1}_getRelevantDocuments(e,t){throw Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,(0,t1.ensureConfig)(t))}async getRelevantDocuments(e,t){let r=(0,t1.ensureConfig)((0,ty.parseCallbackConfigArg)(t)),n=await ty.CallbackManager.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s=await n?.handleRetrieverStart(this.toJSON(),e,r.runId,void 0,void 0,void 0,r.runName);try{let t=await this._getRelevantDocuments(e,s);return await s?.handleRetrieverEnd(t),t}catch(e){throw await s?.handleRetrieverError(e),e}}}e.s(["BaseRetriever",()=>sD],3632);var sB=n9;class sF extends sB.Serializable{}class sU extends sF{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","storage"]}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:{}})}async mget(e){return e.map(e=>this.store[e])}async mset(e){for(let[t,r]of e)this.store[t]=r}async mdelete(e){for(let t of e)delete this.store[t]}async *yieldKeys(e){for(let t of Object.keys(this.store))(void 0===e||t.startsWith(e))&&(yield t)}}e.s(["BaseStore",()=>sF,"InMemoryStore",()=>sU],61594);var sK=e.i(42796),sz=e.i(76166),sV=e.i(44235),sq=sK;class sW extends sq.BaseTracer{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(0,rK.getEnvironmentVariable)("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const e=(0,rK.getEnvironmentVariable)("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t,r=this.session??await this.loadDefaultSession(),n=e.serialized;if("llm"===e.run_type){let s=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(e=>(0,th.getBufferString)(e));t={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:n,type:e.run_type,session_id:r.id,prompts:s,response:e.outputs}}else if("chain"===e.run_type){let s=await Promise.all(e.child_runs.map(e=>this.convertV2RunToRun(e)));t={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:n,type:e.run_type,session_id:r.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:s.filter(e=>"llm"===e.type),child_chain_runs:s.filter(e=>"chain"===e.type),child_tool_runs:s.filter(e=>"tool"===e.type)}}else if("tool"===e.run_type){let s=await Promise.all(e.child_runs.map(e=>this.convertV2RunToRun(e)));t={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:n,type:e.run_type,session_id:r.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(n),child_llm_runs:s.filter(e=>"llm"===e.type),child_chain_runs:s.filter(e=>"chain"===e.type),child_tool_runs:s.filter(e=>"tool"===e.type)}}else throw Error(`Unknown run type: ${e.run_type}`);return t}async persistRun(e){let t,r;t="llm"===(r=void 0!==e.run_type?await this.convertV2RunToRun(e):e).type?`${this.endpoint}/llm-runs`:"chain"===r.type?`${this.endpoint}/chain-runs`:`${this.endpoint}/tool-runs`;let n=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});n.ok||console.error(`Failed to persist run: ${n.status} ${n.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t,r=await fetch(e,{method:"GET",headers:this.headers});if(!r.ok)return console.error(`Failed to load session: ${r.status} ${r.statusText}`),t={id:1,start_time:Date.now()},this.session=t,t;let n=await r.json();return 0===n.length?t={id:1,start_time:Date.now()}:[t]=n,this.session=t,t}}async function sG(e){let t=new sW;return e?await t.loadSession(e):await t.loadDefaultSession(),t}async function sJ(){return new sV.LangChainTracer}e.s(["LangChainTracerV1",()=>sW],44556),e.s(["getTracingCallbackHandler",()=>sG,"getTracingV2CallbackHandler",()=>sJ],39577);var sH=e.i(9514),sZ=sK;class sY extends sZ.BaseTracer{constructor({exampleId:e}={}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"run_collector"}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracedRuns",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.exampleId=e,this.tracedRuns=[]}async persistRun(e){let t={...e};t.reference_example_id=this.exampleId,this.tracedRuns.push(t)}}function sX(e,t){let r=0,n=0,s=0;for(let i=0;i<e.length;i++)r+=e[i]*t[i],n+=e[i]*e[i],s+=t[i]*t[i];return r/(Math.sqrt(n)*Math.sqrt(s))}function sQ(e,t){let r=0;for(let n=0;n<e.length;n++)r+=e[n]*t[n];return r}function s0(e,t){return Math.sqrt(function(e,t){let r=0;for(let n=0;n<e.length;n++)r+=(e[n]-t[n])*(e[n]-t[n]);return r}(e,t))}function s1(e,t,r){if(0===e.length||0===e[0].length||0===t.length||0===t[0].length)return[[]];if(e[0].length!==t[0].length)throw Error(`Number of columns in X and Y must be the same. X has shape ${[e.length,e[0].length]} and Y has shape ${[t.length,t[0].length]}.`);return e.map(e=>t.map(t=>r(e,t)).map(e=>Number.isNaN(e)?0:e))}function s2(e,t=!1){let r=e.reduce((e,t)=>Math.max(e,s6(t).maxValue),0);return e.map(e=>e.map(e=>t?1-e/r:e/r))}function s5(e,t){return s1(e,t,sX)}function s3(e,t){return s1(e,t,sQ)}function s4(e,t){return s1(e,t,s0)}function s8(e,t,r=.5,n=4){if(0>=Math.min(n,t.length))return[];let s=s5(Array.isArray(e[0])?e:[e],t)[0],i=s6(s).maxIndex,a=[t[i]],o=[i];for(;o.length<Math.min(n,t.length);){let e=-1/0,n=-1,i=s5(t,a);s.forEach((t,s)=>{if(o.includes(s))return;let a=r*t-(1-r)*Math.max(...i[s]);a>e&&(e=a,n=s)}),a.push(t[n]),o.push(n)}return o}function s6(e){if(0===e.length)return{maxIndex:-1,maxValue:NaN};let t=e[0],r=0;for(let n=1;n<e.length;n+=1)e[n]>t&&(r=n,t=e[n]);return{maxIndex:r,maxValue:t}}e.s(["RunCollectorCallbackHandler",()=>sY],18063),e.s(["cosineSimilarity",()=>s5,"euclideanDistance",()=>s4,"innerProduct",()=>s3,"matrixFunc",()=>s1,"maximalMarginalRelevance",()=>s8,"normalize",()=>s2],75802);var s7=tJ,s9=sK,ie=n9;class it extends sD{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,"mmr"===e.searchType&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if("mmr"===this.searchType){if("function"!=typeof this.vectorStore.maxMarginalRelevanceSearch)throw Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t?.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t?.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class ir extends ie.Serializable{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw Error("Not implemented.")}async similaritySearch(e,t=4,r,n){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map(e=>e[0])}async similaritySearchWithScore(e,t=4,r,n){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,n){throw Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,n,s,i){if("number"==typeof e)return new it({vectorStore:this,k:e,filter:t,tags:[...n??[],this._vectorstoreType()],metadata:s,verbose:i,callbacks:r});{let t={vectorStore:this,k:e?.k,filter:e?.filter,tags:[...e?.tags??[],this._vectorstoreType()],metadata:e?.metadata,verbose:e?.verbose,callbacks:e?.callbacks,searchType:e?.searchType};return new it(e?.searchType==="mmr"?{...t,searchKwargs:e.searchKwargs}:{...t})}}}class is extends ir{static load(e,t){throw Error("Not implemented")}}e.s(["SaveableVectorStore",()=>is,"VectorStore",()=>ir,"VectorStoreRetriever",()=>it],99684);class ii extends ni{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["tests","fake"]})}getFormatInstructions(){return""}async parse(e){return e.split(",").map(e=>e.trim())}}class ia extends s7.Runnable{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["tests","fake"]}),Object.defineProperty(this,"returnOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.returnOptions=e.returnOptions}async invoke(e,t){return this.returnOptions?t??{}:{input:e}}}class io extends sw{constructor(e){super(e),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.response=e.response,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);let n=this.response??e;return await r?.handleLLMNewToken(n),n}}class il extends sw{constructor(e){super(e),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.sleep=e.sleep??this.sleep,this.responses=e.responses,this.thrownErrorString=e.thrownErrorString}_llmType(){return"fake"}async _call(e){if(this.thrownErrorString)throw Error(this.thrownErrorString);let t=this.responses?.[0];return this.responses=this.responses?.slice(1),t??e}async *_streamResponseChunks(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);let n=this.responses?.[0];for(let t of(this.responses=this.responses?.slice(1),n??e))await new Promise(e=>setTimeout(e,this.sleep)),yield{text:t,generationInfo:{}},await r?.handleLLMNewToken(t)}}class ic extends rZ{_combineLLMOutput(){return[]}_llmType(){return"fake"}async _generate(e,t,r){if(t?.stop?.length)return{generations:[{message:new to.AIMessage(t.stop[0]),text:t.stop[0]}]};let n=e.map(e=>"string"==typeof e.content?e.content:JSON.stringify(e.content,null,2)).join("\n");return await r?.handleLLMNewToken(n),{generations:[{message:new to.AIMessage(n),text:n}],llmOutput:{}}}}class iu extends rZ{constructor({sleep:e=50,responses:t=[],chunks:r=[],toolStyle:n="openai",thrownErrorString:s,...i}){super(i),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"toolStyle",{enumerable:!0,configurable:!0,writable:!0,value:"openai"}),Object.defineProperty(this,"thrownErrorString",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tools",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.sleep=e,this.responses=t,this.chunks=r,this.toolStyle=n,this.thrownErrorString=s}_llmType(){return"fake"}bindTools(e){let t=[...this.tools,...e],r=t.map(e=>{switch(this.toolStyle){case"openai":return{type:"function",function:{name:e.name,description:e.description,parameters:(0,t8.toJsonSchema)(e.schema)}};case"anthropic":return{name:e.name,description:e.description,input_schema:(0,t8.toJsonSchema)(e.schema)};case"bedrock":return{toolSpec:{name:e.name,description:e.description,inputSchema:(0,t8.toJsonSchema)(e.schema)}};case"google":return{name:e.name,description:e.description,parameters:(0,t8.toJsonSchema)(e.schema)};default:throw Error(`Unsupported tool style: ${this.toolStyle}`)}}),n="google"===this.toolStyle?[{functionDeclarations:r}]:r,s=new iu({sleep:this.sleep,responses:this.responses,chunks:this.chunks,toolStyle:this.toolStyle,thrownErrorString:this.thrownErrorString});return s.tools=t,s.withConfig({tools:n})}async _generate(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);let n=this.responses?.[0]?.content??e[0].content??"";return{generations:[{text:"",message:new to.AIMessage({content:n,tool_calls:this.chunks?.[0]?.tool_calls})}]}}async *_streamResponseChunks(e,t,r){if(this.thrownErrorString)throw Error(this.thrownErrorString);if(this.chunks?.length){for(let e of this.chunks){let t=new rz.ChatGenerationChunk({message:new to.AIMessageChunk({content:e.content,tool_calls:e.tool_calls,additional_kwargs:e.additional_kwargs??{}}),text:e.content?.toString()??""});yield t,await r?.handleLLMNewToken(e.content,void 0,void 0,void 0,void 0,{chunk:t})}return}let n=this.responses?.[0]??new to.AIMessage("string"==typeof e[0].content?e[0].content:"");for(let e of"string"==typeof n.content?n.content:""){await new Promise(e=>setTimeout(e,this.sleep));let t=new rz.ChatGenerationChunk({message:new to.AIMessageChunk({content:e}),text:e});yield t,await r?.handleLLMNewToken(e,void 0,void 0,void 0,void 0,{chunk:t})}}}class ih extends sD{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["test","fake"]}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:[new si({pageContent:"foo"}),new si({pageContent:"bar"})]}),this.output=e?.output??this.output}async _getRelevantDocuments(e){return this.output}}class id extends rZ{static lc_name(){return"FakeListChatModel"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"responses",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"i",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sleep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"emitCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1});const{responses:t,sleep:r,emitCustomEvent:n}=e;this.responses=t,this.sleep=r,this.emitCustomEvent=n??this.emitCustomEvent}_combineLLMOutput(){return[]}_llmType(){return"fake-list"}async _generate(e,t,r){if(await this._sleepIfRequested(),t?.thrownErrorString)throw Error(t.thrownErrorString);if(this.emitCustomEvent&&await r?.handleCustomEvent("some_test_event",{someval:!0}),t?.stop?.length)return{generations:[this._formatGeneration(t.stop[0])]};{let e=this._currentResponse();return this._incrementResponse(),{generations:[this._formatGeneration(e)],llmOutput:{}}}}_formatGeneration(e){return{message:new to.AIMessage(e),text:e}}async *_streamResponseChunks(e,t,r){let n=this._currentResponse();for await(let e of(this._incrementResponse(),this.emitCustomEvent&&await r?.handleCustomEvent("some_test_event",{someval:!0}),n)){if(await this._sleepIfRequested(),t?.thrownErrorString)throw Error(t.thrownErrorString);let n=this._createResponseChunk(e);yield n,r?.handleLLMNewToken(e)}}async _sleepIfRequested(){void 0!==this.sleep&&await this._sleep()}async _sleep(){return new Promise(e=>{setTimeout(()=>e(),this.sleep)})}_createResponseChunk(e){return new rz.ChatGenerationChunk({message:new to.AIMessageChunk({content:e}),text:e})}_currentResponse(){return this.responses[this.i]}_incrementResponse(){this.i<this.responses.length-1?this.i+=1:this.i=0}withStructuredOutput(e,t){return s7.RunnableLambda.from(async e=>{let t=await this.invoke(e);if(t.tool_calls?.[0]?.args)return t.tool_calls[0].args;if("string"==typeof t.content)return JSON.parse(t.content);throw Error("No structured output found")})}}class ip extends sr{constructor(){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","message","fake"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]})}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async addUserMessage(e){this.messages.push(new ti.HumanMessage(e))}async addAIChatMessage(e){this.messages.push(new to.AIMessage(e))}async clear(){this.messages=[]}}class im extends sn{constructor(){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","message","fake"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]})}async addMessage(e){this.messages.push(e)}async getMessages(){return this.messages}}class ig extends s9.BaseTracer{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"fake_tracer"}),Object.defineProperty(this,"runs",{enumerable:!0,configurable:!0,writable:!0,value:[]})}persistRun(e){return this.runs.push(e),Promise.resolve()}}class ib extends rt{constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}async _call(e,t){return JSON.stringify(e)}}class iy extends nT{constructor(e){super(e??{})}embedDocuments(e){return Promise.resolve(e.map(()=>[.1,.2,.3,.4]))}embedQuery(e){return Promise.resolve([.1,.2,.3,.4])}}class iv extends nT{constructor(e){super(e??{}),Object.defineProperty(this,"vectorSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorSize=e?.vectorSize??4}async embedDocuments(e){return Promise.all(e.map(e=>this.embedQuery(e)))}async embedQuery(e){let t=e,r=(t=t.toLowerCase().replaceAll(/[^a-z ]/g,"")).length%this.vectorSize,n=0===r?0:this.vectorSize-r,s=t.length+n,i=(t=t.padEnd(s," ")).length/this.vectorSize,a=[];for(let e=0;e<t.length;e+=i)a.push(t.slice(e,e+i));return a.map(e=>{let t=0;for(let r=0;r<e.length;r+=1)t+=" "===e?0:e.charCodeAt(r);return t%26/26})}}class iw extends s9.BaseTracer{constructor(){super(),Object.defineProperty(this,"runPromiseResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"single_run_extractor"}),this.runPromise=new Promise(e=>{this.runPromiseResolver=e})}async persistRun(e){this.runPromiseResolver(e)}async extract(){return this.runPromise}}class i_ extends ir{_vectorstoreType(){return"memory"}constructor(e,{similarity:t,...r}={}){super(e,r),Object.defineProperty(this,"memoryVectors",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"similarity",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.similarity=t??sX}async addDocuments(e){let t=e.map(({pageContent:e})=>e);return this.addVectors(await this.embeddings.embedDocuments(t),e)}async addVectors(e,t){let r=e.map((e,r)=>({content:t[r].pageContent,embedding:e,metadata:t[r].metadata}));this.memoryVectors=this.memoryVectors.concat(r)}async similaritySearchVectorWithScore(e,t,r){let n=this.memoryVectors.filter(e=>!r||r(new si({metadata:e.metadata,pageContent:e.content})));return n.map((t,r)=>({similarity:this.similarity(e,t.embedding),index:r})).sort((e,t)=>e.similarity>t.similarity?-1:0).slice(0,t).map(e=>[new si({metadata:n[e.index].metadata,pageContent:n[e.index].content}),e.similarity])}static async fromTexts(e,t,r,n){let s=[];for(let r=0;r<e.length;r+=1){let n=Array.isArray(t)?t[r]:t,i=new si({pageContent:e[r],metadata:n});s.push(i)}return i_.fromDocuments(s,r,n)}static async fromDocuments(e,t,r){let n=new this(t,r);return await n.addDocuments(e),n}static async fromExistingIndex(e,t){return new this(e,t)}}e.s(["FakeChatMessageHistory",()=>ip,"FakeChatModel",()=>ic,"FakeEmbeddings",()=>iy,"FakeLLM",()=>io,"FakeListChatMessageHistory",()=>im,"FakeListChatModel",()=>id,"FakeRetriever",()=>ih,"FakeRunnable",()=>ia,"FakeSplitIntoListParser",()=>ii,"FakeStreamingChatModel",()=>iu,"FakeStreamingLLM",()=>il,"FakeTool",()=>ib,"FakeTracer",()=>ig,"FakeVectorStore",()=>i_,"SingleRunExtractor",()=>iw,"SyntheticEmbeddings",()=>iv],68733),e.s([],44877),e.i(44877);var ix=e.i(55352),iO=e.i(38394),ik=e.i(20261);e.s(["awaitAllCallbacks",()=>ik.awaitAllCallbacks,"consumeCallback",()=>ik.consumeCallback],41246);var iP=e.i(41246),iE=e.i(47111);e.i(14786),e.i(83292),e.i(17733),e.s(["BaseDocumentTransformer",()=>so,"Document",()=>si,"MappingDocumentTransformer",()=>sl],77692);var iS=e.i(77692),iA=e.i(96236);e.i(4648),e.i(16448),e.i(56767),e.i(70800),e.i(41700),e.s(["BaseExampleSelector",()=>su,"BasePromptSelector",()=>sh,"ConditionalPromptSelector",()=>sd,"LengthBasedExampleSelector",()=>sg,"SemanticSimilarityExampleSelector",()=>sy,"isChatModel",()=>sf,"isLLM",()=>sp],33882);var iC=e.i(33882),ij=e.i(15614),iT=e.i(72674),iN=e.i(21532),iI=e.i(9747),iR=e.i(92863);e.i(40502),e.i(19917),e.i(23814),e.i(26656),e.i(20278),e.i(35174),e.i(67649),e.i(38325),e.s(["JsonOutputParser",()=>nx,"parseJsonMarkdown",()=>n_.parseJsonMarkdown,"parsePartialJson",()=>n_.parsePartialJson],11102),e.i(11102),e.i(77974),e.s(["AsymmetricStructuredOutputParser",()=>nv,"BaseCumulativeTransformOutputParser",()=>nc,"BaseLLMOutputParser",()=>ns,"BaseOutputParser",()=>ni,"BaseTransformOutputParser",()=>nl,"BytesOutputParser",()=>nu,"CommaSeparatedListOutputParser",()=>nd,"CustomListOutputParser",()=>np,"JsonMarkdownStructuredOutputParser",()=>ny,"JsonOutputParser",()=>nx,"ListOutputParser",()=>nh,"MarkdownListOutputParser",()=>nm,"NumberedListOutputParser",()=>nf,"OutputParserException",()=>na,"StringOutputParser",()=>ng,"StructuredOutputParser",()=>nb,"XMLOutputParser",()=>nP,"XML_FORMAT_INSTRUCTIONS",0,nk,"parseJsonMarkdown",()=>n_.parseJsonMarkdown,"parsePartialJson",()=>n_.parsePartialJson,"parseXMLMarkdown",()=>nS],87381);var iM=e.i(87381);e.i(38538),e.i(84028),e.i(60307),e.i(70658),e.s(["AIMessagePromptTemplate",()=>sP.AIMessagePromptTemplate,"BaseChatPromptTemplate",()=>sP.BaseChatPromptTemplate,"BaseMessagePromptTemplate",()=>sP.BaseMessagePromptTemplate,"BaseMessageStringPromptTemplate",()=>sP.BaseMessageStringPromptTemplate,"BasePromptTemplate",()=>sk.BasePromptTemplate,"BaseStringPromptTemplate",()=>sj.BaseStringPromptTemplate,"ChatMessagePromptTemplate",()=>sP.ChatMessagePromptTemplate,"ChatPromptTemplate",()=>sP.ChatPromptTemplate,"DEFAULT_FORMATTER_MAPPING",()=>sT.DEFAULT_FORMATTER_MAPPING,"DEFAULT_PARSER_MAPPING",()=>sT.DEFAULT_PARSER_MAPPING,"DictPromptTemplate",()=>s$.DictPromptTemplate,"FewShotChatMessagePromptTemplate",()=>sE.FewShotChatMessagePromptTemplate,"FewShotPromptTemplate",()=>sE.FewShotPromptTemplate,"HumanMessagePromptTemplate",()=>sP.HumanMessagePromptTemplate,"ImagePromptTemplate",()=>sN.ImagePromptTemplate,"MessagesPlaceholder",()=>sP.MessagesPlaceholder,"PipelinePromptTemplate",()=>sA,"PromptTemplate",()=>sC.PromptTemplate,"StructuredPrompt",()=>sM,"SystemMessagePromptTemplate",()=>sP.SystemMessagePromptTemplate,"checkValidTemplate",()=>sT.checkValidTemplate,"interpolateFString",()=>sT.interpolateFString,"interpolateMustache",()=>sT.interpolateMustache,"parseFString",()=>sT.parseFString,"parseMustache",()=>sT.parseMustache,"parseTemplate",()=>sT.parseTemplate,"renderTemplate",()=>sT.renderTemplate],30654);var i$=e.i(30654),iL=e.i(50823),iD=e.i(3632),iB=e.i(61594),iF=e.i(5995),iU=e.i(39577),iK=e.i(18063),iz=e.i(44556),iV=e.i(67324),iq=e.i(90506);e.i(52541),e.s(["insecureHash",0,tE,"sha256",0,(...e)=>new tN(!1,!0).update(e.join("")).hex()],79422);var iW=e.i(79422);e.i(73977);var iG=e.i(26321);e.s(["applyPatch",()=>iG.applyPatch,"compare",()=>nw.compare],18688);var iJ=e.i(18688),iH=t8,iZ=e.i(37088);e.s(["Validator",()=>iZ.Validator,"deepCompareStrict",()=>no.deepCompareStrict,"toJsonSchema",()=>iH.toJsonSchema,"validatesOnlyStrings",()=>iH.validatesOnlyStrings],61315);var iY=e.i(61315),iX=e.i(75802),iQ=e.i(68733),i0=e.i(43195);e.i(53394),e.s(["extendInteropZodObject",()=>t4.extendInteropZodObject,"getInteropZodDefaultGetter",()=>t4.getInteropZodDefaultGetter,"getInteropZodObjectShape",()=>t4.getInteropZodObjectShape,"getSchemaDescription",()=>t4.getSchemaDescription,"interopParse",()=>t4.interopParse,"interopParseAsync",()=>t4.interopParseAsync,"interopSafeParse",()=>t4.interopSafeParse,"interopSafeParseAsync",()=>t4.interopSafeParseAsync,"interopZodObjectPartial",()=>t4.interopZodObjectPartial,"interopZodObjectPassthrough",()=>t4.interopZodObjectPassthrough,"interopZodObjectStrict",()=>t4.interopZodObjectStrict,"interopZodTransformInputSchema",()=>t4.interopZodTransformInputSchema,"isInteropZodObject",()=>t4.isInteropZodObject,"isInteropZodSchema",()=>t4.isInteropZodSchema,"isShapelessZodSchema",()=>t4.isShapelessZodSchema,"isSimpleStringZodSchema",()=>t4.isSimpleStringZodSchema,"isZodArrayV4",()=>t4.isZodArrayV4,"isZodObjectV3",()=>t4.isZodObjectV3,"isZodObjectV4",()=>t4.isZodObjectV4,"isZodSchema",()=>t4.isZodSchema,"isZodSchemaV3",()=>t4.isZodSchemaV3,"isZodSchemaV4",()=>t4.isZodSchemaV4],15464);var i1=e.i(15464),i2=e.i(99684);e.s(["agents",0,ix,"caches",0,iO,"callbacks__base",0,rG,"callbacks__manager",0,ty,"callbacks__promises",0,iP,"chat_history",0,iE,"documents",0,iS,"embeddings",0,iA,"example_selectors",0,iC,"language_models__base",0,ij,"language_models__chat_models",0,iT,"language_models__llms",0,iN,"load__serializable",0,n9,"memory",0,iI,"messages",0,iR,"output_parsers",0,iM,"outputs",0,rz,"prompt_values",0,tB,"prompts",0,i$,"retrievers",0,iD,"runnables",0,iL,"stores",0,iB,"tools",0,iF,"tracers__base",0,sK,"tracers__console",0,sz,"tracers__initialize",0,iU,"tracers__log_stream",0,sH,"tracers__run_collector",0,iK,"tracers__tracer_langchain",0,sV,"tracers__tracer_langchain_v1",0,iz,"utils__async_caller",0,tF,"utils__chunk_array",0,iV,"utils__env",0,rK,"utils__function_calling",0,iq,"utils__hash",0,iW,"utils__json_patch",0,iJ,"utils__json_schema",0,iY,"utils__math",0,iX,"utils__stream",0,rV,"utils__testing",0,iQ,"utils__tiktoken",0,i0,"utils__types",0,i1,"vectorstores",0,i2],28063);var i5=e.i(28063),i3=e.i(57077),i4=e.i(5410);async function i8(e){let{optionalImportsMap:t,optionalImportEntrypoints:r,importMap:n,secretsMap:s,secretsFromEnv:i,path:a,depth:o,maxDepth:l}=this,c=a.join(".");if(o>l)throw Error(`Maximum recursion depth (${l}) exceeded during deserialization. This may indicate a malicious payload or you may need to increase maxDepth.`);if("object"!=typeof e||null==e)return e;if(Array.isArray(e))return Promise.all(e.map((e,t)=>i8.call({...this,path:[...a,`${t}`],depth:o+1},e)));if((0,i4.isEscapedObject)(e))return(0,i4.unescapeValue)(e);if("lc"in e&&"type"in e&&"id"in e&&1===e.lc&&"secret"===e.type){let[t]=e.id;if(t in s)return s[t];if(i){let e=(0,rK.getEnvironmentVariable)(t);if(e)return e}throw Error(`Missing secret "${t}" at ${c}`)}if("lc"in e&&"type"in e&&"id"in e&&1===e.lc&&"not_implemented"===e.type){let t=JSON.stringify(e);throw Error(`Trying to load an object that doesn't implement serialization: ${c} -> ${t}`)}if("lc"in e&&"type"in e&&"id"in e&&"kwargs"in e&&1===e.lc&&"constructor"===e.type){let s=JSON.stringify(e),[i,...l]=e.id.slice().reverse(),u=l.reverse(),h=null,d=[u.join("/")];"langchain_community"===u[0]&&d.push(["langchain",...u.slice(1)].join("/"));let p=d.find(e=>e in t);if(se.concat(r).includes(u.join("/"))||p)if(void 0!==p)h=await t[p];else throw Error(`Missing key "${u.join("/")}" for ${c} in load(optionalImportsMap={})`);else{let e,t;if("langchain"===u[0]||"langchain_core"===u[0])e=({langchain_core:i5,langchain:n})[u[0]],u.shift();else throw Error(`Invalid namespace: ${c} -> ${s}`);if(0===u.length)throw Error(`Invalid namespace: ${c} -> ${s}`);do{if((t=u.join("__"))in e)break;u.pop()}while(u.length>0)t in e&&(h=e[t])}if("object"!=typeof h||null===h)throw Error(`Invalid namespace: ${c} -> ${s}`);let f=h[i]??Object.values(h).find(e=>"function"==typeof e&&(0,n9.get_lc_unique_name)(e)===i);if("function"!=typeof f)throw Error(`Invalid identifer: ${c} -> ${s}`);let m=await i8.call({...this,path:[...a,"kwargs"],depth:o+1},e.kwargs),g=new f((0,i3.mapKeys)(m,i3.keyFromJson,function(e){let t={};for(let r=e;r&&r.prototype;r=Object.getPrototypeOf(r))Object.assign(t,Reflect.get(r.prototype,"lc_aliases"));return Object.entries(t).reduce((e,[t,r])=>(e[r]=t,e),{})}(f)));return Object.defineProperty(g.constructor,"name",{value:i}),g}let u={};for(let[t,r]of Object.entries(e))u[t]=await i8.call({...this,path:[...a,t],depth:o+1},r);return u}async function i6(e,t){let r=JSON.parse(e),n={optionalImportsMap:t?.optionalImportsMap??{},optionalImportEntrypoints:t?.optionalImportEntrypoints??[],secretsMap:t?.secretsMap??{},secretsFromEnv:t?.secretsFromEnv??!1,importMap:t?.importMap??{},path:["$"],depth:0,maxDepth:t?.maxDepth??50};return i8.call(n,r)}var i7=[],i9=[];function ae(e,t,r,n){var s=Object.getOwnPropertyDescriptor(n,r);void 0!==s.get?s.configurable?(Object.defineProperty(n,r,{value:e}),i7.push([n,r,t,s])):i9.push([t,r,e]):(n[r]=e,i7.push([n,r,t]))}async function at(e){if(e&&"object"==typeof e)if(Array.isArray(e))return await Promise.all(e.map(e=>at(e)));else{let t={};for(let[r,n]of Object.entries(e))t[r]=await at(n);if(2===t.lc&&"undefined"===t.type)return;if(2===t.lc&&"constructor"===t.type&&Array.isArray(t.id))try{let e;switch(t.id[t.id.length-1]){case"Set":e=Set;break;case"Map":e=Map;break;case"RegExp":e=RegExp;break;case"Error":e=Error;break;default:return t}if(t.method)return e[t.method](...t.args||[]);return new e(...t.args||[])}catch(e){}else if(null!==t&&1===t.lc&&"constructor"===t.type&&Array.isArray(t.id))return i6(JSON.stringify(t));return t}return e}function ar(e,t,r,n){return{lc:2,type:"constructor",id:[e.name],method:t??null,args:r??[],kwargs:n??{}}}class an{_dumps(e){return new TextEncoder().encode(function(e,t,r,n){void 0===n&&(n={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),function e(t,r,n,s,i,a,o){if(a+=1,"object"==typeof t&&null!==t){for(l=0;l<s.length;l++)if(s[l]===t)return void ae("[Circular]",t,r,i);if(void 0!==o.depthLimit&&a>o.depthLimit||void 0!==o.edgesLimit&&n+1>o.edgesLimit)return void ae("[...]",t,r,i);if(s.push(t),Array.isArray(t))for(l=0;l<t.length;l++)e(t[l],l,l,s,t,a,o);else{var l,c=Object.keys(t);for(l=0;l<c.length;l++){var u=c[l];e(t[u],u,l,s,t,a,o)}}s.pop()}}(e,"",0,[],void 0,0,n);try{var s;i=0===i9.length?JSON.stringify(e,t,void 0):JSON.stringify(e,(s=t,s=void 0!==s?s:function(e,t){return t},function(e,t){if(i9.length>0)for(var r=0;r<i9.length;r++){var n=i9[r];if(n[1]===e&&n[0]===t){t=n[2],i9.splice(r,1);break}}return s.call(this,e,t)}),void 0)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==i7.length;){var i,a=i7.pop();4===a.length?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return i}(e,(e,t)=>(function(e){if(void 0===e)return{lc:2,type:"undefined"};if(e instanceof Set||e instanceof Map)return ar(e.constructor,void 0,[Array.from(e)]);if(e instanceof RegExp)return ar(RegExp,void 0,[e.source,e.flags]);if(e instanceof Error)return ar(e.constructor,void 0,[e.message]);if(e?.lg_name==="Send")return{node:e.node,args:e.args};else return e})(t)))}dumpsTyped(e){return e instanceof Uint8Array?["bytes",e]:["json",this._dumps(e)]}async _loads(e){return at(JSON.parse(e))}async loadsTyped(e,t){if("bytes"===e)return"string"==typeof t?new TextEncoder().encode(t):t;if("json"===e)return this._loads("string"==typeof t?t:new TextDecoder().decode(t));throw Error(`Unknown serialization type: ${e}`)}}function as(e){if("object"!=typeof e||null===e)return e;let t=Array.isArray(e)?[]:{};for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=as(e[r]));return t}function ai(){return{v:1,id:n5(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{},pending_sends:[]}}function aa(e){return{v:e.v,id:e.id,ts:e.ts,channel_values:{...e.channel_values},channel_versions:{...e.channel_versions},versions_seen:as(e.versions_seen),pending_sends:[...e.pending_sends]}}class ao{constructor(e){Object.defineProperty(this,"serde",{enumerable:!0,configurable:!0,writable:!0,value:new an}),this.serde=e||this.serde}async get(e){let t=await this.getTuple(e);return t?t.checkpoint:void 0}getNextVersion(e,t){if("string"==typeof e)throw Error("Please override this method to use string versions.");return void 0!==e&&"number"==typeof e?e+1:1}}function al(e,t){return"number"==typeof e&&"number"==typeof t?Math.sign(e-t):String(e).localeCompare(String(t))}function ac(...e){return e.reduce((e,t,r)=>0===r?t:al(e,t)>=0?e:t)}let au={[n4]:-1,[n8]:-2,[n6]:-3,[n7]:-4};function ah(e){return e.configurable?.checkpoint_id||e.configurable?.thread_ts||""}e.s(["BaseCheckpointSaver",()=>ao,"WRITES_IDX_MAP",0,au,"compareChannelVersions",()=>al,"copyCheckpoint",()=>aa,"deepCopy",()=>as,"emptyCheckpoint",()=>ai,"getCheckpointId",()=>ah,"maxChannelVersion",()=>ac],10591),e.s([],5778),e.s([],11108);class ad extends Error{constructor(e){super(e),this.name="InvalidNamespaceError"}}function ap(e,t){let r=t.split("."),n=e;for(let e of r){if(e.includes("[")){let[t,r]=e.split("["),s=r.replace("]","");if(!n[t])return[];if("*"===s){let e=[];for(let r of n[t])"string"==typeof r&&e.push(r);return e}let i=parseInt(s,10);if(Number.isNaN(i))return[];n=n[t][i]}else n=n[e];if(void 0===n)return[]}return"string"==typeof n?[n]:[]}function af(e){return e.split(".")}class am{async get(e,t){return(await this.batch([{namespace:e,key:t}]))[0]}async search(e,t={}){let{filter:r,limit:n=10,offset:s=0,query:i}=t;return(await this.batch([{namespacePrefix:e,filter:r,limit:n,offset:s,query:i}]))[0]}async put(e,t,r,n){if(0===e.length)throw new ad("Namespace cannot be empty.");for(let t of e){if("string"!=typeof t)throw new ad(`Invalid namespace label '${t}' found in ${e}. Namespace labels must be strings, but got ${typeof t}.`);if(t.includes("."))throw new ad(`Invalid namespace label '${t}' found in ${e}. Namespace labels cannot contain periods ('.').`);if(""===t)throw new ad(`Namespace labels cannot be empty strings. Got ${t} in ${e}`)}if("langgraph"===e[0])throw new ad(`Root label for namespace cannot be "langgraph". Got: ${e}`);await this.batch([{namespace:e,key:t,value:r,index:n}])}async delete(e,t){await this.batch([{namespace:e,key:t,value:null}])}async listNamespaces(e={}){let{prefix:t,suffix:r,maxDepth:n,limit:s=100,offset:i=0}=e,a=[];return t&&a.push({matchType:"prefix",path:t}),r&&a.push({matchType:"suffix",path:r}),(await this.batch([{matchConditions:a.length?a:void 0,maxDepth:n,limit:s,offset:i}]))[0]}start(){}stop(){}}e.s(["BaseStore",()=>am,"InvalidNamespaceError",()=>ad,"getTextAtPath",()=>ap,"tokenizePath",()=>af],4835);class ag extends am{constructor(e){super(),Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"AsyncBatchedStore"}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"processingTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.store=(e=>"lg_name"in e&&"AsyncBatchedStore"===e.lg_name?e.store:e)(e)}get isRunning(){return this.running}async batch(e){throw Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,t){return this.enqueueOperation({namespace:e,key:t})}async search(e,t){let{filter:r,limit:n=10,offset:s=0,query:i}=t||{};return this.enqueueOperation({namespacePrefix:e,filter:r,limit:n,offset:s,query:i})}async put(e,t,r){return this.enqueueOperation({namespace:e,key:t,value:r})}async delete(e,t){return this.enqueueOperation({namespace:e,key:t,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((t,r)=>{let n=this.nextKey;this.nextKey+=1,this.queue.set(n,{operation:e,resolve:t,reject:r})})}async processBatchQueue(){for(;this.running;){if(await new Promise(e=>{setTimeout(e,0)}),0===this.queue.size)continue;let e=new Map(this.queue);this.queue.clear();try{let t=Array.from(e.values()).map(({operation:e})=>e),r=await this.store.batch(t);e.forEach(({resolve:t},n)=>{let s=Array.from(e.keys()).indexOf(n);t(r[s])})}catch(t){e.forEach(({reject:e})=>{e(t)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}}function ab(e){if(!e)return[];let t=[],r=[],n=0;for(;n<e.length;){let s=e[n];if("["===s){r.length&&(t.push(r.join("")),r=[]);let s=1,i=["["];for(n+=1;n<e.length&&s>0;)"["===e[n]?s+=1:"]"===e[n]&&(s-=1),i.push(e[n]),n+=1;t.push(i.join(""));continue}if("{"===s){r.length&&(t.push(r.join("")),r=[]);let s=1,i=["{"];for(n+=1;n<e.length&&s>0;)"{"===e[n]?s+=1:"}"===e[n]&&(s-=1),i.push(e[n]),n+=1;t.push(i.join(""));continue}"."===s?r.length&&(t.push(r.join("")),r=[]):r.push(s);n+=1}return r.length&&t.push(r.join("")),t}e.s(["AsyncBatchedStore",()=>ag],30065);class ay extends am{constructor(e){super(),Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"vectors",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_indexConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e?.index&&(this._indexConfig={...e.index,__tokenizedFields:(e.index.fields??["$"]).map(e=>[e,"$"===e?[e]:ab(e)])})}async batch(e){let t=[],r=new Map,n=new Map;for(let s=0;s<e.length;s+=1){let i=e[s];if("key"in i&&"namespace"in i&&!("value"in i))t.push(this.getOperation(i));else if("namespacePrefix"in i){let e=this.filterItems(i);n.set(s,[i,e]),t.push(null)}else if("value"in i){let e=`${i.namespace.join(":")}:${i.key}`;r.set(e,i),t.push(null)}else"matchConditions"in i&&t.push(this.listNamespacesOperation(i))}if(n.size>0)if(this._indexConfig?.embeddings){let e=new Set;for(let[t]of n.values())t.query&&e.add(t.query);let r=e.size>0?await Promise.all(Array.from(e).map(e=>this._indexConfig.embeddings.embedQuery(e))):[],s=Object.fromEntries(Array.from(e).map((e,t)=>[e,r[t]]));for(let[e,[r,i]]of n.entries())if(r.query&&s[r.query]){let n=s[r.query],a=this.scoreResults(i,n,r.offset??0,r.limit??10);t[e]=a}else t[e]=this.paginateResults(i.map(e=>({...e,score:void 0})),r.offset??0,r.limit??10)}else for(let[e,[r,s]]of n.entries())t[e]=this.paginateResults(s.map(e=>({...e,score:void 0})),r.offset??0,r.limit??10);if(r.size>0&&this._indexConfig?.embeddings){let e=this.extractTexts(Array.from(r.values()));if(Object.keys(e).length>0){let t=await this._indexConfig.embeddings.embedDocuments(Object.keys(e));this.insertVectors(e,t)}}for(let e of r.values())this.putOperation(e);return t}getOperation(e){let t=e.namespace.join(":");return this.data.get(t)?.get(e.key)??null}putOperation(e){let t=e.namespace.join(":");this.data.has(t)||this.data.set(t,new Map);let r=this.data.get(t);if(null===e.value)r.delete(e.key);else{let t=new Date;if(r.has(e.key)){let n=r.get(e.key);n.value=e.value,n.updatedAt=t}else r.set(e.key,{value:e.value,key:e.key,namespace:e.namespace,createdAt:t,updatedAt:t})}}listNamespacesOperation(e){let t=Array.from(this.data.keys()).map(e=>e.split(":"));return e.matchConditions&&e.matchConditions.length>0&&(t=t.filter(t=>e.matchConditions.every(e=>this.doesMatch(e,t)))),void 0!==e.maxDepth&&(t=Array.from(new Set(t.map(t=>t.slice(0,e.maxDepth).join(":")))).map(e=>e.split(":"))),t.sort((e,t)=>e.join(":").localeCompare(t.join(":"))),t.slice(e.offset??0,(e.offset??0)+(e.limit??t.length))}doesMatch(e,t){let{matchType:r,path:n}=e;if("prefix"===r)return!(n.length>t.length)&&n.every((e,r)=>{let n=t[r];return"*"===e||n===e});if("suffix"===r)return!(n.length>t.length)&&n.every((e,r)=>{let s=t[t.length-n.length+r];return"*"===e||s===e});throw Error(`Unsupported match type: ${r}`)}filterItems(e){let t=[];for(let[r,n]of this.data.entries())r.startsWith(e.namespacePrefix.join(":"))&&t.push(...n.values());let r=t;return e.filter&&(r=t.filter(t=>Object.entries(e.filter).every(([e,r])=>{var n;return n=t.value[e],"object"==typeof r&&null!==r&&Object.keys(r).every(e=>"$eq"===e||"$ne"===e||"$gt"===e||"$gte"===e||"$lt"===e||"$lte"===e||"$in"===e||"$nin"===e)?Object.keys(r).filter(e=>e.startsWith("$")).every(e=>{let t=r[e];switch(e){case"$eq":return n===t;case"$ne":return n!==t;case"$gt":return Number(n)>Number(t);case"$gte":return Number(n)>=Number(t);case"$lt":return Number(n)<Number(t);case"$lte":return Number(n)<=Number(t);case"$in":return!!Array.isArray(t)&&t.includes(n);case"$nin":return!Array.isArray(t)||!t.includes(n);default:return!1}}):n===r}))),r}scoreResults(e,t,r=0,n=10){let s=[],i=[],a=[];for(let t of e){let e=this.getVectors(t);if(e.length)for(let r of e)s.push(t),i.push(r);else a.push(t)}let o=this.cosineSimilarity(t,i).map((e,t)=>[e,s[t]]).sort((e,t)=>t[0]-e[0]),l=new Set,c=[];for(let[e,t]of o){let s=`${t.namespace.join(":")}:${t.key}`;if(l.has(s))continue;let i=l.size;if(i>=r+n)break;if(i<r){l.add(s);continue}l.add(s),c.push([e,t])}if(a.length&&c.length<n)for(let e of a.slice(0,n-c.length)){let t=`${e.namespace.join(":")}:${e.key}`;l.has(t)||(l.add(t),c.push([void 0,e]))}return c.map(([e,t])=>({...t,score:e}))}paginateResults(e,t,r){return e.slice(t,t+r)}extractTexts(e){if(!e.length||!this._indexConfig)return{};let t={};for(let s of e)if(null!==s.value&&!1!==s.index)for(let[e,i]of null===s.index||void 0===s.index?this._indexConfig.__tokenizedFields??[]:s.index.map(e=>[e,ab(e)])){var r,n;let a=(r=s.value,(n=i)&&"$"!==n?function e(t,r,n){if(n>=r.length)return"string"==typeof t||"number"==typeof t||"boolean"==typeof t?[String(t)]:null==t?[]:Array.isArray(t)||"object"==typeof t?[JSON.stringify(t,null,2)]:[];let s=r[n],i=[];if(0===n&&"$"===s&&i.push(JSON.stringify(t,null,2)),s.startsWith("[")&&s.endsWith("]")){if(!Array.isArray(t))return[];let a=s.slice(1,-1);if("*"===a)for(let s of t)i.push(...e(s,r,n+1));else try{let s=parseInt(a,10);s<0&&(s=t.length+s),s>=0&&s<t.length&&i.push(...e(t[s],r,n+1))}catch{return[]}}else if(s.startsWith("{")&&s.endsWith("}")){if("object"!=typeof t||null===t)return[];for(let e of s.slice(1,-1).split(",").map(e=>e.trim())){let r=ab(e);if(r.length){let e=t;for(let t of r)if(e&&"object"==typeof e&&t in e)e=e[t];else{e=void 0;break}void 0!==e&&("string"==typeof e||"number"==typeof e||"boolean"==typeof e?i.push(String(e)):(Array.isArray(e)||"object"==typeof e)&&i.push(JSON.stringify(e,null,2)))}}}else if("*"===s){if(Array.isArray(t))for(let s of t)i.push(...e(s,r,n+1));else if("object"==typeof t&&null!==t)for(let s of Object.values(t))i.push(...e(s,r,n+1))}else"object"==typeof t&&null!==t&&s in t&&i.push(...e(t[s],r,n+1));return i}(r,Array.isArray(n)?n:ab(n),0):[JSON.stringify(r,null,2)]);a.length&&(a.length>1?a.forEach((r,n)=>{t[r]||(t[r]=[]),t[r].push([s.namespace,s.key,`${e}.${n}`])}):(t[a[0]]||(t[a[0]]=[]),t[a[0]].push([s.namespace,s.key,e])))}return t}insertVectors(e,t){for(let[r,n]of Object.entries(e)){let e=t.shift();if(!e)throw Error(`No embedding found for text: ${r}`);for(let[t,r,s]of n){let n=t.join(":");this.vectors.has(n)||this.vectors.set(n,new Map);let i=this.vectors.get(n);i.has(r)||i.set(r,new Map),i.get(r).set(s,e)}}}getVectors(e){let t=e.namespace.join(":"),r=e.key;if(!this.vectors.has(t))return[];let n=this.vectors.get(t);if(!n.has(r))return[];let s=Array.from(n.get(r).values());return s.length?s:[]}cosineSimilarity(e,t){if(!t.length)return[];let r=t.map(t=>t.reduce((t,r,n)=>t+r*e[n],0)),n=Math.sqrt(e.reduce((e,t)=>e+t*t,0)),s=t.map(e=>Math.sqrt(e.reduce((e,t)=>e+t*t,0)));return r.map((e,t)=>{let r=s[t];return n&&r?e/(n*r):0})}get indexConfig(){return this._indexConfig}}class av extends ay{}e.s(["InMemoryStore",()=>ay,"MemoryStore",()=>av],60342),e.s([],1164);class aw{constructor(e){Object.defineProperty(this,"serde",{enumerable:!0,configurable:!0,writable:!0,value:new an}),this.serde=e||this.serde}}e.s(["BaseCache",()=>aw],44643);class a_ extends aw{constructor(){super(...arguments),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:{}})}async get(e){if(!e.length)return[];let t=Date.now();return(await Promise.all(e.map(async e=>{let[r,n]=e,s=r.join(",");if(s in this.cache&&n in this.cache[s]){let r=this.cache[s][n];if(null==r.exp||t<r.exp)return[{key:e,value:await this.serde.loadsTyped(r.enc,r.val)}];delete this.cache[s][n]}return[]}))).flat()}async set(e){let t=Date.now();for(let{key:r,value:n,ttl:s}of e){let[e,i]=r,a=e.join(","),[o,l]=await this.serde.dumpsTyped(n),c=null!=s?1e3*s+t:null;this.cache[a]??={},this.cache[a][i]={enc:o,val:l,exp:c}}}async clear(e){if(!e.length){this.cache={};return}for(let t of e){let e=t.join(",");e in this.cache&&delete this.cache[e]}}}function ax(e){return null!=e&&!0===e.lg_is_channel}e.s(["InMemoryCache",()=>a_],68939),e.s([],65378),e.s([],48505);class aO{constructor(){Object.defineProperty(this,"ValueType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"UpdateType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lg_is_channel",{enumerable:!0,configurable:!0,writable:!0,value:!0})}consume(){return!1}}function ak(e,t){let r=Object.fromEntries(Object.entries(e).filter(([,e])=>ax(e))),n={};for(let e in r)if(Object.prototype.hasOwnProperty.call(r,e)){let s=t.channel_values[e];n[e]=r[e].fromCheckpoint(s)}return n}function aP(e,t,r){let n;if(void 0===t)n=e.channel_values;else for(let e of(n={},Object.keys(t)))try{n[e]=t[e].checkpoint()}catch(e){if(e.name===nz.unminifiable_name);else throw e}return{v:1,id:n5(r),ts:new Date().toISOString(),channel_values:n,channel_versions:{...e.channel_versions},versions_seen:as(e.versions_seen),pending_sends:e.pending_sends??[]}}class aE extends aO{constructor(e,t){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"BinaryOperatorAggregate"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"operator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initialValueFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.operator=e,this.initialValueFactory=t,this.value=t?.()}fromCheckpoint(e){let t=new aE(this.operator,this.initialValueFactory);return void 0!==e&&(t.value=e),t}update(e){let t=e;if(!t.length)return!1;for(let e of(void 0===this.value&&([this.value]=t,t=t.slice(1)),t))void 0!==this.value&&(this.value=this.operator(this.value,e));return!0}get(){if(void 0===this.value)throw new nz;return this.value}checkpoint(){if(void 0===this.value)throw new nz;return this.value}}class aS extends aO{constructor(){super(...arguments),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"LastValue"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]})}fromCheckpoint(e){let t=new aS;return void 0!==e&&(t.value=[e]),t}update(e){if(0===e.length)return!1;if(1!==e.length)throw new nV("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[e[e.length-1]],!0}get(){if(0===this.value.length)throw new nz;return this.value[0]}checkpoint(){if(0===this.value.length)throw new nz;return this.value[0]}}let aA="__start__",aC="__end__",aj="__input__",aT="__error__",aN="__pregel_send",aI="__pregel_call",aR="__pregel_read",aM="__pregel_checkpointer",a$="__pregel_resuming",aL="__pregel_task_id",aD="__pregel_stream",aB="__pregel_scratchpad",aF="__pregel_previous",aU="checkpoint_ns",aK="checkpoint_map",az="__pregel_abort_signals",aV="__interrupt__",aq="__resume__",aW="__no_writes__",aG="__return__",aJ="__previous__",aH="__pregel_runtime_placeholder__",aZ="langsmith:hidden",aY="__self__",aX="__pregel_tasks",aQ="__pregel_push",a0="__pregel_pull",a1="00000000-0000-0000-0000-000000000000",a2=[aZ,aj,aV,aq,aT,aW,aX,aN,aR,aM,aD,a$,aL,aI,"__pregel_resume_value",aB,aF,aK,aU,"checkpoint_id"];function a5(e){return null!=e&&"string"==typeof e.node&&void 0!==e.args}class a3{constructor(e,t){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Send"}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"args",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.node=e,this.args=a7(t)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}}function a4(e){return e instanceof a3}class a8{constructor(e){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Command"}),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"graph",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"update",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resume",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"goto",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.resume=e.resume,this.graph=e.graph,this.update=e.update,e.goto&&(this.goto=Array.isArray(e.goto)?a7(e.goto):[a7(e.goto)])}_updateAsTuples(){return this.update&&"object"==typeof this.update&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(e=>Array.isArray(e)&&2===e.length&&"string"==typeof e[0])?this.update:[["__root__",this.update]]}toJSON(){let e;return e="string"==typeof this.goto?this.goto:a4(this.goto)?this.goto.toJSON():this.goto?.map(e=>"string"==typeof e?e:e.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:e}}}function a6(e){return"object"==typeof e&&null!=e&&"lg_name"in e&&"Command"===e.lg_name}function a7(e,t=new Map){if(null!=e&&"object"==typeof e){let r;if(t.has(e))return t.get(e);if(Array.isArray(e))r=[],t.set(e,r),e.forEach((e,n)=>{r[n]=a7(e,t)});else if(!a6(e)||e instanceof a8)if(!a5(e)||e instanceof a3)if(a6(e)||a4(e))r=e,t.set(e,r);else if("lc_serializable"in e&&e.lc_serializable)r=e,t.set(e,r);else for(let[n,s]of(r={},t.set(e,r),Object.entries(e)))r[n]=a7(s,t);else r=new a3(e.node,e.args),t.set(e,r);else r=new a8(e),t.set(e,r);return r}return e}Object.defineProperty(a8,"PARENT",{enumerable:!0,configurable:!0,writable:!0,value:"__parent__"});class a9{constructor(e,t){Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"lg_is_managed_value",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.config=e}static async initialize(e,t){throw Error("Not implemented")}async promises(){return Promise.all(this._promises)}addPromise(e){this._promises.push(e)}}class oe extends a9{}let ot="__channel_key_placeholder__";class or extends Map{constructor(e){super(e?Array.from(e):void 0)}replaceRuntimeValues(e,t){if(0!==this.size&&t&&!Array.from(this.values()).every(e=>!e.runtime))if("object"!=typeof t||Array.isArray(t)){if("object"==typeof t&&"constructor"in t)for(let r of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let n=t[r];for(let[s,i]of this.entries())i.runtime&&i.call(e)===n&&(t[r]={[aH]:s})}catch(e){if(e.name!==TypeError.name)throw e}}else for(let[r,n]of Object.entries(t))for(let[s,i]of this.entries())i.runtime&&i.call(e)===n&&(t[r]={[aH]:s})}replaceRuntimePlaceholders(e,t){if(0!==this.size&&t&&!Array.from(this.values()).every(e=>!e.runtime)){if("object"!=typeof t||Array.isArray(t)){if("object"==typeof t&&"constructor"in t)for(let r of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let n=t[r];if("object"==typeof n&&null!==n&&aH in n){let s=this.get(n[aH]);s&&(t[r]=s.call(e))}}catch(e){if(e.name!==TypeError.name)throw e}}else for(let[r,n]of Object.entries(t))if("object"==typeof n&&null!==n&&aH in n){let s=n[aH];"string"==typeof s&&(t[r]=this.get(s)?.call(e))}}}}function on(e){return"object"==typeof e&&!!e&&"lg_is_managed_value"in e}function os(e){return"object"==typeof e&&!!e&&"cls"in e&&"params"in e}class oi extends a9{call(){}static async initialize(e,t){return Promise.resolve(new oi(e))}}e.s(["ChannelKeyPlaceholder",0,ot,"ManagedValue",()=>a9,"ManagedValueMapping",()=>or,"NoopManagedValue",()=>oi,"WritableManagedValue",()=>oe,"isConfiguredManagedValue",()=>os,"isManagedValue",()=>on],56576);class oa{constructor(e){Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"AnnotationRoot"}),Object.defineProperty(this,"spec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.spec=e}}let oo=function(e){return os(e)?e:e?ol(e):new aS};function ol(e){return"object"==typeof e&&e&&"reducer"in e&&e.reducer?new aE(e.reducer,e.default):"object"==typeof e&&e&&"value"in e&&e.value?new aE(e.value,e.default):new aS}oo.Root=e=>new oa(e);var r3=tJ,oc=e.i(4635),ou=e.i(51342),r3=tJ,r4=t1,oh=t5;e.i(99771);var oh=t5;let od=["tags","metadata","callbacks","configurable"],op=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interruptBefore","interruptAfter","signal"];function of(...e){let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,configurable:{}},r=oh.AsyncLocalStorageProviderSingleton.getRunnableConfig();if(void 0!==r){for(let[e,n]of Object.entries(r))if(void 0!==n)if(od.includes(e)){let r;r=Array.isArray(n)?[...n]:"object"==typeof n?"callbacks"===e&&"copy"in n&&"function"==typeof n.copy?n.copy():{...n}:n,t[e]=r}else t[e]=n}for(let r of e)if(void 0!==r)for(let[e,n]of Object.entries(r))void 0!==n&&op.includes(e)&&(t[e]=n);for(let[e,r]of Object.entries(t.configurable))t.metadata=t.metadata??{},e.startsWith("__")||"string"!=typeof r&&"number"!=typeof r&&"boolean"!=typeof r||e in t.metadata||(t.metadata[e]=r);return t}function om(e){return e.split("|").filter(e=>!e.match(/^\d+$/)).map(e=>e.split(":")[0]).join("|")}class og extends r3.Runnable{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"recurse",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,t,r){return new Promise((n,s)=>{let i=(0,r4.patchConfig)(t,{callbacks:r?.getChild()});oh.AsyncLocalStorageProviderSingleton.runWithConfig(i,async()=>{try{let t=await this.func(e,i);n(t)}catch(e){s(e)}})})}async invoke(e,t){let r,n=of(t),s=(0,r4.mergeConfigs)(this.config,n);return(r=this.trace?await this._callWithConfig(this._tracedInvoke,e,s):await oh.AsyncLocalStorageProviderSingleton.runWithConfig(s,async()=>this.func(e,s)),r3.Runnable.isRunnable(r)&&this.recurse)?await oh.AsyncLocalStorageProviderSingleton.runWithConfig(s,async()=>r.invoke(e,s)):r}}function*ob(e,t){if(void 0===t)yield*e;else for(let r of e)yield[t,r]}async function oy(e){let t=[];for await(let r of(await e))t.push(r);return t}function ov(e){let t=[];for(let r of e)t.push(r);return t}function ow(e,t){return e?"configurable"in e?{...e,configurable:{...e.configurable,...t}}:{...e,configurable:t}:{configurable:t}}Symbol.for("LG_SKIP_WRITE");let o_={[Symbol.for("LG_PASSTHROUGH")]:!0};function ox(e){return"object"==typeof e&&e?.[Symbol.for("LG_PASSTHROUGH")]!==void 0}let oO=Symbol("IS_WRITER");class ok extends og{constructor(e,t){const r=`ChannelWrite<${e.map(e=>a4(e)?e.node:"channel"in e?e.channel:"...").join(",")}>`;super({writes:e,name:r,tags:t,func:async(e,t)=>this._write(e,t??{})}),Object.defineProperty(this,"writes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.writes=e}async _write(e,t){let r=this.writes.map(t=>oE(t)&&ox(t.value)?{mapper:t.mapper,value:e}:oP(t)&&ox(t.value)?{channel:t.channel,value:e,skipNone:t.skipNone,mapper:t.mapper}:t);return await ok.doWrite(t,r),e}static async doWrite(e,t){for(let e of t){if(oP(e)){if(e.channel===aX)throw new nV("Cannot write to the reserved channel TASKS");if(ox(e.value))throw new nV("PASSTHROUGH value must be replaced")}if(oE(e)&&ox(e.value))throw new nV("PASSTHROUGH value must be replaced")}let r=[];for(let n of t)if(a4(n))r.push([aX,n]);else if(oE(n)){let t=await n.mapper.invoke(n.value,e);null!=t&&t.length>0&&r.push(...t)}else if(oP(n)){let t=void 0!==n.mapper?await n.mapper.invoke(n.value,e):n.value;if("object"==typeof t&&t?.[Symbol.for("LG_SKIP_WRITE")]!==void 0||n.skipNone&&void 0===t)continue;r.push([n.channel,t])}else throw Error(`Invalid write entry: ${JSON.stringify(n)}`);(e.configurable?.[aN])(r)}static isWriter(e){return e instanceof ok||oO in e&&!!e[oO]}static registerWriter(e){return Object.defineProperty(e,oO,{value:!0})}}function oP(e){return void 0!==e&&"string"==typeof e.channel}function oE(e){return void 0!==e&&!oP(e)&&r3.Runnable.isRunnable(e.mapper)}class oS extends og{constructor(e,t,r=!1){super({func:(e,t)=>oS.doRead(t,this.channel,this.fresh,this.mapper)}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"ChannelRead"}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fresh",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fresh=r,this.mapper=t,this.channel=e,this.name=Array.isArray(e)?`ChannelRead<${e.join(",")}>`:`ChannelRead<${e}>`}static doRead(e,t,r,n){let s=e.configurable?.[aR];if(!s)throw Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return n?n(s(t,r)):s(t,r)}}let oA=new rW;class oC extends r3.RunnableBinding{constructor(e){const{channels:t,triggers:r,mapper:n,writers:s,bound:i,kwargs:a,metadata:o,retryPolicy:l,tags:c,subgraphs:u,ends:h}=e,d=[...e.config?.tags?e.config.tags:[],...c??[]];super({...e,bound:e.bound??oA,config:{...e.config?e.config:{},tags:d}}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"PregelNode"}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:oA}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subgraphs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channels=t,this.triggers=r,this.mapper=n,this.writers=s??this.writers,this.bound=i??this.bound,this.kwargs=a??this.kwargs,this.metadata=o??this.metadata,this.tags=d,this.retryPolicy=l,this.subgraphs=u,this.ends=h}getWriters(){let e=[...this.writers];for(;e.length>1&&e[e.length-1]instanceof ok&&e[e.length-2]instanceof ok;){let t=e.slice(-2),r=t[0].writes.concat(t[1].writes);e[e.length-2]=new ok(r,t[0].config?.tags),e.pop()}return e}getNode(){let e=this.getWriters();if(this.bound!==oA||0!==e.length)return this.bound===oA&&1===e.length?e[0]:this.bound===oA?new r3.RunnableSequence({first:e[0],middle:e.slice(1,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):e.length>0?new r3.RunnableSequence({first:this.bound,middle:e.slice(0,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):this.bound}join(e){if(!Array.isArray(e))throw Error("channels must be a list");if("object"!=typeof this.channels)throw Error("all channels must be named when using .join()");return new oC({channels:{...this.channels,...Object.fromEntries(e.map(e=>[e,e]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy})}pipe(e){return new oC(ok.isWriter(e)?{channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,e],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}:this.bound===oA?{channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:(0,r3._coerceToRunnable)(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}:{channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy})}}var r3=tJ;class oj extends Error{constructor(e){super(e),this.name="GraphValidationError"}}function oT(e,t){if(Array.isArray(e)){for(let r of e)if(!(r in t))throw Error(`Key ${String(r)} not found in channels`)}else if(!(e in t))throw Error(`Key ${String(e)} not found in channels`)}function oN(e,t,r=!0,n=!1){try{return e[t].get()}catch(e){if(e.name===nz.unminifiable_name){if(n)return e;else if(r)return null}throw e}}function oI(e,t,r=!0){if(!Array.isArray(t))return oN(e,t);{let n={};for(let s of t)try{n[s]=oN(e,s,!r)}catch(e){if(e.name===nz.unminifiable_name)continue}return n}}function*oR(e,t){if(null!=t)if(Array.isArray(e)&&"object"==typeof t&&!Array.isArray(t))for(let r in t)e.includes(r)&&(yield[r,t[r]]);else if(Array.isArray(e))throw Error('Input chunk must be an object when "inputChannels" is an array');else yield[e,t]}function*oM(e,t,r){Array.isArray(e)?(!0===t||t.find(([t,r])=>e.includes(t)))&&(yield oI(r,e)):(!0===t||t.some(([t,r])=>t===e))&&(yield oN(r,e))}function*o$(e,t,r){let n,s=t.filter(([e,t])=>(void 0===e.config||!e.config.tags?.includes(aZ))&&t[0][0]!==aT&&t[0][0]!==aV);if(!s.length)return;n=s.some(([e])=>e.writes.some(([e,t])=>e===aG))?s.flatMap(([e])=>e.writes.filter(([e,t])=>e===aG).map(([t,r])=>[e.name,r])):Array.isArray(e)?s.flatMap(([t])=>{let{writes:r}=t,n={};for(let[t]of r)e.includes(t)&&(n[t]=(n[t]||0)+1);return Object.values(n).some(e=>e>1)?r.filter(([t])=>e.includes(t)).map(([e,r])=>[t.name,{[e]:r}]):[[t.name,Object.fromEntries(r.filter(([t])=>e.includes(t)))]]}):s.flatMap(([t])=>t.writes.filter(([t,r])=>t===e).map(([e,r])=>[t.name,r]));let i={};for(let[e,t]of n)e in i||(i[e]=[]),i[e].push(t);let a={};for(let e in i)if(1===i[e].length){let[t]=i[e];a[e]=t}else a[e]=i[e];r&&(a.__metadata__={cached:r}),yield a}function oL(e){return"lg_is_pregel"in e&&!0===e.lg_is_pregel}function oD(e){let t=[e];for(let e of t)if(oL(e))return e;else"steps"in e&&Array.isArray(e.steps)&&t.push(...e.steps)}let oB={start:"\x1b[34m",end:"\x1b[0m"},oF={start:"\x1b[32m",end:"\x1b[0m"},oU={start:"\x1b[33;1m",end:"\x1b[0m"},oK=(e,t)=>`${e.start}${t}${e.end}`;function*oz(e,t){let r=new Date().toISOString();for(let{id:n,name:s,input:i,config:a,triggers:o,writes:l}of t){if(a?.tags?.includes(aZ))continue;let t=l.filter(([e,t])=>e===n&&t===aV).map(([,e])=>e);yield{type:"task",timestamp:r,step:e,payload:{id:n,name:s,input:i,triggers:o,interrupts:t}}}}function oV(e,t,r){return e.map(e=>{let n=t.find(([t,r])=>t===e.id&&r===aT)?.[2],s=t.filter(([t,r])=>t===e.id&&r===aV).map(([,,e])=>e);if(n)return{id:e.id,name:e.name,path:e.path,error:n,interrupts:s};let i=r?.[e.id];return{id:e.id,name:e.name,path:e.path,interrupts:s,...void 0!==i?{state:i}:{}}})}function oq(e,t){let r=t.length;console.log([`${oK(oB,`[${e}:tasks]`)}`,`\x1b[1m Starting step ${e} with ${r} task${1===r?"":"s"}:\x1b[0m
`,t.map(e=>`- ${oK(oF,String(e.name))} -> ${JSON.stringify(e.input,null,2)}`).join("\n")].join(""))}var r4=t1;class oW{constructor({func:e,name:t,input:r,retry:n,callbacks:s}){Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__lg_type",{enumerable:!0,configurable:!0,writable:!0,value:"call"}),this.func=e,this.name=t,this.input=r,this.retry=n,this.callbacks=s}}function oG(e){let t,r=Object.values(e),n=r.length>0?typeof r[0]:void 0;return"number"===n?t=0:"string"===n&&(t=""),t}function oJ(e,t){if(!(Object.keys(e).length>0))return t;{let r=oG(t);return Object.fromEntries(Object.entries(t).filter(([t,n])=>n>(e[t]??r)))}}function oH(e,t){return null===e?{configurable:t}:e?.configurable===void 0?{...e,configurable:t}:{...e,configurable:{...e.configurable,...t}}}function oZ(e,t){let r=t?.parents??{};return Object.keys(r).length>0?oH(e,{[aK]:{...r,[e.configurable?.checkpoint_ns??""]:e.configurable?.checkpoint_id}}):e}function oY(...e){if(1===e.length)return e[0];let t=new AbortController,r=()=>{t.abort(),e.forEach(e=>e.removeEventListener("abort",r))};return e.forEach(e=>e.addEventListener("abort",r)),e.some(e=>e.aborted)&&t.abort(),t.signal}var r3=tJ,oh=t5;let oX=e=>void 0!==e?e+1:1;function oQ(e,t,r){let n,s=Object.values(e.channel_versions),i=s.length>0?typeof s[0]:void 0;"number"===i?n=0:"string"===i&&(n="");let a=e.versions_seen[aV]??{},o=Object.entries(e.channel_versions).some(([e,t])=>t>(a[e]??n)),l=r.some(e=>"*"===t?!e.config?.tags?.includes(aZ):t.includes(e.name));return o&&l}function o0(e,t,r,n,s,i,a=!1){let o,l=[],c=new Set;if(Array.isArray(i))l=i.filter(e=>n.get(e)),c=new Set((i=i.filter(e=>!n.get(e))).filter(e=>s.writes.some(([t,r])=>t===e)));else{for(let[e]of s.writes)if(e===i){c=new Set([e]);break}c=c||new Set}if(a&&c.size>0){let e=Object.fromEntries(Object.entries(r).filter(([e,t])=>c.has(e))),n=aP(t,e,-1),a=ak(e,n);o5(aa(n),a,[s]),o=oI({...r,...a},i)}else o=oI(r,i);if(l.length>0)for(let t of l){let r=n.get(t);if(r){let n=r.call(e);o[t]=n}}return o}function o1(e,t,r,n,s){for(let[t,i]of s)if([aQ,aX].includes(t)&&null!=i){if(!a4(i))throw new nV(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(i)}`);if(!(i.node in r))throw new nV(`Invalid node name "${i.node}" in Send packet`);n.replaceRuntimeValues(e,i.args)}t(s)}let o2=new Set([aW,aQ,aq,aV,aG,aT]);function o5(e,t,r,n){let s;r.sort((e,t)=>{let r=e.path?.slice(0,3)||[],n=t.path?.slice(0,3)||[];for(let e=0;e<Math.min(r.length,n.length);e+=1){if(r[e]<n[e])return -1;if(r[e]>n[e])return 1}return r.length-n.length});let i=r.some(e=>e.triggers.length>0),a=Object.fromEntries(Object.entries(t).filter(([e,t])=>ax(t)));for(let t of r)for(let r of(void 0===e.versions_seen[t.name]&&(e.versions_seen[t.name]={}),t.triggers))r in e.channel_versions&&(e.versions_seen[t.name][r]=e.channel_versions[r]);for(let t of(Object.keys(e.channel_versions).length>0&&(s=ac(...Object.values(e.channel_versions))),new Set(r.flatMap(e=>e.triggers).filter(e=>!a2.includes(e)))))t in a&&a[t].consume()&&void 0!==n&&(e.channel_versions[t]=n(s,a[t]));e.pending_sends?.length&&i&&(e.pending_sends=[]);let o={},l={};for(let t of r)for(let[r,n]of t.writes)o2.has(r)||(r===aX?e.pending_sends.push({node:n.node,args:n.args}):r in a?r in o?o[r].push(n):o[r]=[n]:r in l?l[r].push(n):l[r]=[n]);s=void 0,Object.keys(e.channel_versions).length>0&&(s=ac(...Object.values(e.channel_versions)));let c=new Set;for(let[t,r]of Object.entries(o))if(t in a){let i;try{i=a[t].update(r)}catch(e){if(e.name===nV.unminifiable_name){let n=new nV(`Invalid update for channel "${t}" with values ${JSON.stringify(r)}: ${e.message}`);throw n.lc_error_code=e.lc_error_code,n}throw e}i&&void 0!==n&&(e.channel_versions[t]=n(s,a[t])),c.add(t)}if(i)for(let t of Object.keys(a))!c.has(t)&&a[t].update([])&&void 0!==n&&(e.channel_versions[t]=n(s,a[t]));return l}function o3(e,t,r,n,s,i,a,o){let l={};for(let c=0;c<e.pending_sends.length;c+=1){let u=o4([aQ,c],e,t,r,n,s,i,a,o);void 0!==u&&(l[u.id]=u)}for(let c of Object.keys(r)){let u=o4([a0,c],e,t,r,n,s,i,a,o);void 0!==u&&(l[u.id]=u)}return l}function o4(e,t,r,n,s,i,a,o,l){var c,u,h;let{step:d,checkpointer:p,manager:f}=l,m=a.configurable??{},g=m.checkpoint_ns??"";if(e[0]===aQ&&"object"==typeof(c=e[e.length-1])&&null!==c&&"__lg_type"in c&&"call"===c.__lg_type){let c,b=e[e.length-1],y=(u=b.name,h=b.func,c=new og({func:e=>h(...e),name:u,trace:!1,recurse:!1}),new r3.RunnableSequence({name:u,first:c,last:new ok([{channel:aG,value:o_}],[aZ])})),v=[aQ],w=""===g?b.name:`${g}|${b.name}`,_=n3(JSON.stringify([w,d.toString(),b.name,aQ,e[1],e[2]]),t.id),x=`${w}:${_}`,O={langgraph_step:d,langgraph_node:b.name,langgraph_triggers:v,langgraph_path:e.slice(0,3),langgraph_checkpoint_ns:x};if(!o)return{id:_,name:b.name,interrupts:[],path:e.slice(0,3)};{let o=[];return{name:b.name,input:b.input,proc:y,writes:o,config:(0,r4.patchConfig)((0,r4.mergeConfigs)(a,{metadata:O,store:l.store??a.store}),{runName:b.name,callbacks:f?.getChild(`graph:step:${d}`),configurable:{[aL]:_,[aN]:e=>o1(d,e=>o.push(...e),n,i,e),[aR]:(r,n=!1)=>o0(d,t,s,i,{name:b.name,writes:o,triggers:v,path:e.slice(0,3)},r,n),[aM]:p??m[aM],[aK]:{...m[aK],[g]:t.id},[aB]:o8({pendingWrites:r??[],taskId:_,currentTaskInput:b.input}),[aF]:t.channel_values[aJ],checkpoint_id:void 0,checkpoint_ns:x}}),triggers:v,retry_policy:b.retry,id:_,path:e.slice(0,3),writers:[]}}}if(e[0]===aQ){let c="number"==typeof e[1]?e[1]:parseInt(e[1],10);if(c>=t.pending_sends.length)return;let u=a5(t.pending_sends[c])&&!a4(t.pending_sends[c])?new a3(t.pending_sends[c].node,t.pending_sends[c].args):t.pending_sends[c];if(!a5(u))return void console.warn(`Ignoring invalid packet ${JSON.stringify(u)} in pending sends.`);if(!(u.node in n))return void console.warn(`Ignoring unknown node name ${u.node} in pending sends.`);let h=[aQ],b=""===g?u.node:`${g}|${u.node}`,y=n3(JSON.stringify([b,d.toString(),u.node,aQ,c.toString()]),t.id),v=`${b}:${y}`,w={langgraph_step:d,langgraph_node:u.node,langgraph_triggers:h,langgraph_path:e.slice(0,3),langgraph_checkpoint_ns:v};if(!o)return{id:y,name:u.node,interrupts:[],path:e};{let o=n[u.node],c=o.getNode();if(void 0!==c){i.replaceRuntimePlaceholders(d,u.args),void 0!==o.metadata&&(w={...w,...o.metadata});let b=[];return{name:u.node,input:u.args,proc:c,subgraphs:o.subgraphs,writes:b,config:(0,r4.patchConfig)((0,r4.mergeConfigs)(a,{metadata:w,tags:o.tags,store:l.store??a.store}),{runName:u.node,callbacks:f?.getChild(`graph:step:${d}`),configurable:{[aL]:y,[aN]:e=>o1(d,e=>b.push(...e),n,i,e),[aR]:(r,n=!1)=>o0(d,t,s,i,{name:u.node,writes:b,triggers:h,path:e},r,n),[aM]:p??m[aM],[aK]:{...m[aK],[g]:t.id},[aB]:o8({pendingWrites:r??[],taskId:y,currentTaskInput:u.args}),[aF]:t.channel_values[aJ],checkpoint_id:void 0,checkpoint_ns:v}}),triggers:h,retry_policy:o.retryPolicy,id:y,path:e,writers:o.getWriters()}}}}else if(e[0]===a0){let c=e[1].toString(),u=n[c];if(void 0===u)return;if(r?.length){let e=n3(JSON.stringify([""===g?c:`${g}|${c}`,d.toString(),c,a0,c]),t.id);if(r.some(t=>t[0]===e&&t[1]!==aT))return}let h=oG(t.channel_versions);if(void 0===h)return;let b=t.versions_seen[c]??{},y=u.triggers.filter(e=>{let r=oN(s,e,!1,!0);return!(r instanceof Error&&r.name===nz.unminifiable_name)&&(t.channel_versions[e]??h)>(b[e]??h)}).sort();if(y.length>0){let h=function(e,t,r,n,s){let i;if("object"!=typeof t.channels||Array.isArray(t.channels))if(Array.isArray(t.channels)){let e=!1;for(let r of t.channels)try{i=oN(n,r,!1),e=!0;break}catch(e){if(e.name===nz.unminifiable_name)continue;throw e}if(!e)return}else throw Error(`Invalid channels type, expected list or dict, got ${t.channels}`);else for(let[s,a]of(i={},Object.entries(t.channels)))if(t.triggers.includes(a))try{i[s]=oN(n,a,!1)}catch(e){if(e.name===nz.unminifiable_name)return;throw e}else if(a in n)try{i[s]=oN(n,a,!1)}catch(e){if(e.name===nz.unminifiable_name)continue;throw e}else i[s]=r.get(s)?.call(e);return s&&void 0!==t.mapper&&(i=t.mapper(i)),i}(d,u,i,s,o);if(void 0===h)return;let b=""===g?c:`${g}|${c}`,v=n3(JSON.stringify([b,d.toString(),c,a0,y]),t.id),w=`${b}:${v}`,_={langgraph_step:d,langgraph_node:c,langgraph_triggers:y,langgraph_path:e,langgraph_checkpoint_ns:w};if(!o)return{id:v,name:c,interrupts:[],path:e};{let o=u.getNode();if(void 0!==o){void 0!==u.metadata&&(_={..._,...u.metadata});let b=[];return{name:c,input:h,proc:o,subgraphs:u.subgraphs,writes:b,config:(0,r4.patchConfig)((0,r4.mergeConfigs)(a,{metadata:_,tags:u.tags,store:l.store??a.store}),{runName:c,callbacks:f?.getChild(`graph:step:${d}`),configurable:{[aL]:v,[aN]:e=>o1(d,e=>{b.push(...e)},n,i,e),[aR]:(r,n=!1)=>o0(d,t,s,i,{name:c,writes:b,triggers:y,path:e},r,n),[aM]:p??m[aM],[aK]:{...m[aK],[g]:t.id},[aB]:o8({pendingWrites:r??[],taskId:v,currentTaskInput:h}),[aF]:t.channel_values[aJ],checkpoint_id:void 0,checkpoint_ns:w}}),triggers:y,retry_policy:u.retryPolicy,id:v,path:e,writers:u.getWriters()}}}}}}function o8({pendingWrites:e,taskId:t,currentTaskInput:r}){let n=e.find(([e,t])=>e===a1&&t===aq)?.[2],s={callCounter:0,interruptCounter:-1,resume:e.filter(([e,r])=>e===t&&r===aq).flatMap(([e,t,r])=>r),nullResume:n,subgraphCounter:0,currentTaskInput:r,consumeNullResume:()=>{if(s.nullResume)return delete s.nullResume,e.splice(e.findIndex(([e,t])=>e===a1&&t===aq),1),n}};return s}var o6=rV;class o7 extends o6.IterableReadableStream{constructor(e,t){const r=e.getReader(),n=t??new AbortController;super({start:e=>(function t(){return r.read().then(({done:r,value:n})=>r?void e.close():(e.enqueue(n),t()))})()}),Object.defineProperty(this,"_abortController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._abortController=n,this._reader=r}async cancel(e){this._abortController.abort(e),this._reader.releaseLock()}get signal(){return this._abortController.signal}}class o9 extends o6.IterableReadableStream{get closed(){return this._closed}constructor(e){let t;const r=new Promise(e=>{t=e});super({start:e=>{t(e)}}),Object.defineProperty(this,"modes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passthroughFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),r.then(e=>{this.controller=e}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}push(e){this.passthroughFn?.(e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch(e){}finally{this._closed=!0}}error(e){this.controller.error(e)}}let le=Symbol.for("INPUT_DONE"),lt=Symbol.for("INPUT_RESUMING");class lr{get isResuming(){let e=0!==Object.keys(this.checkpoint.channel_versions).length,t=this.config.configurable?.[a$]!==void 0&&this.config.configurable?.[a$],r=null===this.input||void 0===this.input,n=a6(this.input)&&null!=this.input.resume,s=this.input===lt;return e&&(t||r||n||s)}constructor(e){Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerGetNextVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"managed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointNamespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointPendingWrites",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"checkpointPreviousVersions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"step",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"skipDoneTasks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"prevCheckpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"pending"}),Object.defineProperty(this,"tasks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerPromises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"isNested",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_checkpointerChainedPromise",{enumerable:!0,configurable:!0,writable:!0,value:Promise.resolve()}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"toInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.input=e.input,this.checkpointer=e.checkpointer,void 0!==this.checkpointer?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=oX,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.managed=e.managed,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.debug=e.debug}static async initialize(e){let{config:t,stream:r}=e;void 0!==r&&t.configurable?.[aD]!==void 0&&(r=function(...e){return new o9({passthroughFn:t=>{for(let r of e)r.modes.has(t[1])&&r.push(t)},modes:new Set(e.flatMap(e=>Array.from(e.modes)))})}(r,t.configurable[aD]));let n=!t.configurable||!("checkpoint_id"in t.configurable),s=t.configurable?.[aB];t.configurable&&s&&(s.subgraphCounter>0&&(t=oH(t,{[aU]:[t.configurable[aU],s.subgraphCounter.toString()].join("|")})),s.subgraphCounter+=1);let i=aR in(t.configurable??{});i||t.configurable?.checkpoint_ns===void 0||t.configurable?.checkpoint_ns===""||(t=oH(t,{checkpoint_ns:"",checkpoint_id:void 0}));let a=t;t.configurable?.[aK]!==void 0&&t.configurable?.[aK]?.[t.configurable?.checkpoint_ns]&&(a=oH(t,{checkpoint_id:t.configurable[aK][t.configurable?.checkpoint_ns]}));let o=t.configurable?.checkpoint_ns?.split("|")??[],l=await e.checkpointer?.getTuple(a)??{config:t,checkpoint:ai(),metadata:{source:"input",step:-2,writes:null,parents:{}},pendingWrites:[]};a={...t,...l.config,configurable:{checkpoint_ns:"",...t.configurable,...l.config.configurable}};let c=l.parentConfig,u=aa(l.checkpoint),h={...l.metadata},d=l.pendingWrites??[],p=ak(e.channelSpecs,u),f=(h.step??0)+1,m=f+(t.recursionLimit??25)+1,g={...u.channel_versions},b=e.store?new ag(e.store):void 0;return b&&b.start(),new lr({input:e.input,config:t,checkpointer:e.checkpointer,checkpoint:u,checkpointMetadata:h,checkpointConfig:a,prevCheckpointConfig:c,checkpointNamespace:o,channels:p,managed:e.managed,isNested:i,manager:e.manager,skipDoneTasks:n,step:f,stop:m,checkpointPreviousVersions:g,checkpointPendingWrites:d,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:r,store:b,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,debug:e.debug})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>this.checkpointer?.put(e.config,e.checkpoint,e.metadata,e.newVersions)),this.checkpointerPromises.push(this._checkpointerChainedPromise)}async updateManagedValues(e,t){let r=this.managed.get(e);r&&"update"in r&&"function"==typeof r.update&&await r.update(t)}putWrites(e,t){let r=t;if(0===r.length)return;for(let[t,n]of(r.every(([e])=>e in au)&&(r=Array.from(new Map(r.map(e=>[e[0],e])).values())),r)){let r=this.checkpointPendingWrites.findIndex(r=>r[0]===e&&r[1]===t);t in au&&-1!==r?this.checkpointPendingWrites[r]=[e,t,n]:this.checkpointPendingWrites.push([e,t,n])}let n=this.checkpointer?.putWrites({...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??"",checkpoint_id:this.checkpoint.id}},r,e);void 0!==n&&this.checkpointerPromises.push(n),this.tasks&&this._outputWrites(e,r)}_outputWrites(e,t,r=!1){let n=this.tasks[e];if(void 0!==n){if(void 0!==n.config&&(n.config.tags??[]).includes(aZ))return;t.length>0&&t[0][0]!==aT&&t[0][0]!==aV&&this._emit(ov(ob(o$(this.outputKeys,[[n,t]],r),"updates"))),r||this._emit(ov(ob(function*(e,t,r){let n=new Date().toISOString();for(let[{id:s,name:i,config:a},o]of t)a?.tags?.includes(aZ)||(yield{type:"task_result",timestamp:n,step:e,payload:{id:s,name:i,result:o.filter(([e])=>Array.isArray(r)?r.includes(e):e===r),interrupts:o.filter(e=>e[0]===aV).map(e=>e[1])}})}(this.step,[[n,t]],this.streamKeys),"debug")))}}async tick(e){this.store&&!this.store.isRunning&&this.store?.start();let{inputKeys:t=[]}=e;if("pending"!==this.status)throw Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if([le,lt].includes(this.input))if(this.toInterrupt.length>0)throw this.status="interrupt_before",new n$;else{if(!Object.values(this.tasks).every(e=>e.writes.length>0))return!1;let e=Object.values(this.tasks).flatMap(e=>e.writes);for(let[e,t]of Object.entries(o5(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion)))await this.updateManagedValues(e,t);let t=await oy(ob(oM(this.outputKeys,e,this.channels),"values"));if(this._emit(t),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop",writes:o$(this.outputKeys,Object.values(this.tasks).map(e=>[e,e.writes])).next().value??null}),oQ(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new n$;this.config.configurable?.[a$]!==void 0&&delete this.config.configurable?.[a$]}else await this._first(t);if(this.step>this.stop)return this.status="out_of_steps",!1;let r=o3(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream});if(this.tasks=r,this.checkpointer&&this._emit(await oy(ob(function*(e,t,r,n,s,i,a,o){function l(e){let t={};return null!=e.callbacks&&(t.callbacks=e.callbacks),null!=e.configurable&&(t.configurable=e.configurable),null!=e.maxConcurrency&&(t.max_concurrency=e.maxConcurrency),null!=e.metadata&&(t.metadata=e.metadata),null!=e.recursionLimit&&(t.recursion_limit=e.recursionLimit),null!=e.runId&&(t.run_id=e.runId),null!=e.runName&&(t.run_name=e.runName),null!=e.tags&&(t.tags=e.tags),t}let c=t.configurable?.checkpoint_ns,u={};for(let e of i){if(!(e.subgraphs?.length?e.subgraphs:[e.proc]).find(oD))continue;let r=`${e.name}:${e.id}`;c&&(r=`${c}|${r}`),u[e.id]={configurable:{thread_id:t.configurable?.thread_id,checkpoint_ns:r}}}let h=new Date().toISOString();yield{type:"checkpoint",timestamp:h,step:e,payload:{config:l(t),values:oI(r,n),metadata:s,next:i.map(e=>e.name),tasks:oV(i,a,u),parentConfig:o?l(o):void 0}}}(this.step-1,this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig),"debug"))),0===Object.values(this.tasks).length)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(let[e,t,r]of this.checkpointPendingWrites){if(t===aT||t===aV||t===aq)continue;let n=Object.values(this.tasks).find(t=>t.id===e);n&&n.writes.push([t,r])}for(let e of Object.values(this.tasks))e.writes.length>0&&this._outputWrites(e.id,e.writes,!0)}if(Object.values(this.tasks).every(e=>e.writes.length>0))return this.tick({inputKeys:t});if(oQ(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new n$;let n=await oy(ob(oz(this.step,Object.values(this.tasks)),"debug"));return this._emit(n),!0}async finishAndHandleError(e){let t=this._suppressInterrupt(e);if((t||void 0===e)&&(this.output=oI(this.channels,this.outputKeys)),t){if(void 0!==this.tasks&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(e=>e.writes.length>0)){for(let[e,t]of Object.entries(o5(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion)))await this.updateManagedValues(e,t);this._emit(ov(ob(oM(this.outputKeys,Object.values(this.tasks).flatMap(e=>e.writes),this.channels),"values")))}this._emit([["updates",{[aV]:e.interrupts}]])}return t}acceptPush(e,t,r){if(this.interruptAfter?.length>0&&oQ(this.checkpoint,this.interruptAfter,[e]))return void this.toInterrupt.push(e);let n=o4([aQ,e.path??[],t,e.id,r],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(n)return this.interruptBefore?.length>0&&oQ(this.checkpoint,this.interruptBefore,[n])?void this.toInterrupt.push(n):(this._emit(ov(ob(oz(this.step,[n]),"debug"))),this.debug&&oq(this.step,[n]),this.tasks[n.id]=n,this.skipDoneTasks&&this._matchWrites({[n.id]:n}),n)}_suppressInterrupt(e){return nU(e)&&!this.isNested}async _first(e){let{configurable:t}=this.config,r=t?.[aB];if(r&&void 0!==r.nullResume&&this.putWrites(a1,[[aq,r.nullResume]]),a6(this.input)){if(null!=this.input.resume&&null==this.checkpointer)throw Error("Cannot use Command(resume=...) without checkpointer");let e={};for(let[t,r,n]of function*(e,t){if(e.graph===a8.PARENT)throw new nV("There is no parent graph.");if(e.goto){for(let t of Array.isArray(e.goto)?e.goto:[e.goto])if(a4(t))yield[a1,aX,t];else if("string"==typeof t)yield[a1,`branch:to:${t}`,"__start__"];else throw Error(`In Command.send, expected Send or string, got ${typeof t}`)}if(e.resume)if("object"==typeof e.resume&&Object.keys(e.resume).length&&Object.keys(e.resume).every(ou.validate))for(let[r,n]of Object.entries(e.resume)){let e=t.filter(e=>e[0]===r&&e[1]===aq).map(e=>e[2]).slice(0,1)??[];e.push(n),yield[r,aq,e]}else yield[a1,aq,e.resume];if(e.update){if("object"!=typeof e.update||!e.update)throw Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(e.update))for(let[t,r]of e.update)yield[a1,t,r];else for(let[t,r]of Object.entries(e.update))yield[a1,t,r]}}(this.input,this.checkpointPendingWrites))void 0===e[t]&&(e[t]=[]),e[t].push([r,n]);if(0===Object.keys(e).length)throw new nK("Received empty Command input");for(let[t,r]of Object.entries(e))this.putWrites(t,r)}let n=(this.checkpointPendingWrites??[]).filter(e=>e[0]===a1).map(e=>e.slice(1));n.length>0&&o5(this.checkpoint,this.channels,[{name:aj,writes:n,triggers:[]}],this.checkpointerGetNextVersion);let s=a6(this.input)&&n.length>0;if(this.isResuming||s){for(let e of Object.keys(this.channels))if(void 0!==this.checkpoint.channel_versions[e]){let t=this.checkpoint.channel_versions[e];this.checkpoint.versions_seen[aV]={...this.checkpoint.versions_seen[aV],[e]:t}}let e=await oy(ob(oM(this.outputKeys,!0,this.channels),"values"));this._emit(e)}if(this.isResuming)this.input=lt;else if(s)await this._putCheckpoint({source:"input",writes:{}}),this.input=le;else{let t=await oy(oR(e,this.input));if(t.length>0){let e=o3(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step});o5(this.checkpoint,this.channels,Object.values(e).concat([{name:aj,writes:t,triggers:[]}]),this.checkpointerGetNextVersion),await this._putCheckpoint({source:"input",writes:Object.fromEntries(t)}),this.input=le}else if(a$ in(this.config.configurable??{}))this.input=le;else throw new nK(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=oH(this.config,{[a$]:this.isResuming}))}_emit(e){for(let t of e)this.stream.modes.has(t[0])&&this.stream.push([this.checkpointNamespace,...t])}async _putCheckpoint(e){let t={...e,step:this.step,parents:this.config.configurable?.[aK]??{}};if(void 0!==this.checkpointer){this.prevCheckpointConfig=this.checkpointConfig?.configurable?.checkpoint_id?this.checkpointConfig:void 0,this.checkpointMetadata=t,this.checkpoint=aP(this.checkpoint,this.channels,this.step),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??""}};let e={...this.checkpoint.channel_versions},r=oJ(this.checkpointPreviousVersions,e);this.checkpointPreviousVersions=e,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:aa(this.checkpoint),metadata:{...this.checkpointMetadata},newVersions:r}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}}this.step+=1}_matchWrites(e){for(let[t,r,n]of this.checkpointPendingWrites){if(r===aT||r===aV||r===aq)continue;let s=Object.values(e).find(e=>e.id===t);s&&s.writes.push([r,n])}for(let t of Object.values(e))t.writes.length>0&&this._outputWrites(t.id,t.writes,!0)}}var ln=rG,tm=tm;class ls extends ln.BaseCallbackHandler{constructor(e){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"StreamMessagesHandler"}),Object.defineProperty(this,"streamFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadatas",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"emittedChatModelRunIds",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stableMessageIdMap",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.streamFn=e}_emit(e,t,r,n=!1){if(n&&void 0!==t.id&&void 0!==this.seen[t.id])return;let s=t.id;null!=r&&((0,tm.isToolMessage)(t)?s??=`run-${r}-tool-${t.tool_call_id}`:((null==s||s===`run-${r}`)&&(s=this.stableMessageIdMap[r]??s??`run-${r}`),this.stableMessageIdMap[r]??=s)),s!==t.id&&(t.id=s,t.lc_kwargs.id=s),null!=t.id&&(this.seen[t.id]=t),this.streamFn([e[0],"messages",[t,e[1]]])}handleChatModelStart(e,t,r,n,s,i,a,o){!a||i&&(i.includes("langsmith:nostream")||i.includes("nostream"))||(this.metadatas[r]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:o,...a}])}handleLLMNewToken(e,t,r,n,s,i){let a=i?.chunk;(this.emittedChatModelRunIds[r]=!0,void 0!==this.metadatas[r])&&((0,tl.isBaseMessage)(a?.message)?this._emit(this.metadatas[r],a.message,r):this._emit(this.metadatas[r],new to.AIMessageChunk({content:e}),r))}handleLLMEnd(e,t){if(!this.emittedChatModelRunIds[t]){let r=e.generations?.[0]?.[0];(0,tl.isBaseMessage)(r?.message)&&this._emit(this.metadatas[t],r?.message,t,!0),delete this.emittedChatModelRunIds[t]}delete this.metadatas[t],delete this.stableMessageIdMap[t]}handleLLMError(e,t){delete this.metadatas[t]}handleChainStart(e,t,r,n,s,i,a,o){if(void 0!==i&&o===i.langgraph_node&&(void 0===s||!s.includes(aZ))&&(this.metadatas[r]=[i.langgraph_checkpoint_ns.split("|"),{tags:s,name:o,...i}],"object"==typeof t)){for(let e of Object.values(t))if(((0,tl.isBaseMessage)(e)||(0,tl.isBaseMessageChunk)(e))&&void 0!==e.id)this.seen[e.id]=e;else if(Array.isArray(e))for(let t of e)((0,tl.isBaseMessage)(t)||(0,tl.isBaseMessageChunk)(t))&&void 0!==t.id&&(this.seen[t.id]=t)}}handleChainEnd(e,t){let r=this.metadatas[t];if(delete this.metadatas[t],void 0!==r){if((0,tl.isBaseMessage)(e))this._emit(r,e,t,!0);else if(Array.isArray(e))for(let n of e)(0,tl.isBaseMessage)(n)&&this._emit(r,n,t,!0);else if(null!=e&&"object"==typeof e){for(let n of Object.values(e))if((0,tl.isBaseMessage)(n))this._emit(r,n,t,!0);else if(Array.isArray(n))for(let e of n)(0,tl.isBaseMessage)(e)&&this._emit(r,e,t,!0)}}}handleChainError(e,t){delete this.metadatas[t]}}let li=[400,401,402,403,404,405,406,407,409],la=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name||e?.code==="ECONNABORTED")return!1;let t=e?.response?.status??e?.status;return!(t&&li.includes(+t))&&e?.error?.code!=="insufficient_quota"};async function lo(e,t,r,n){let s,i,a=e.retry_policy??t,o=void 0!==a?a.initialInterval??500:0,l=0,{config:c}=e;for(r&&(c=oH(c,r)),c={...c,signal:n};!n?.aborted;){e.writes.splice(0,e.writes.length),s=void 0;try{i=await e.proc.invoke(e.input,c);break}catch(n){if((s=n).pregelTaskId=e.id,nB(s)){let t=c?.configurable?.checkpoint_ns,r=s.command;if(r.graph===t){for(let t of e.writers)await t.invoke(r,c);s=void 0;break}if(r.graph===a8.PARENT){let e=function(e){let t=e.split("|");for(;t.length>1&&t[t.length-1].match(/^\d+$/);)t.pop();return t.slice(0,-1).join("|")}(t);s.command=new a8({...s.command,graph:e})}}if(nF(s)||void 0===a||(l+=1)>=(a.maxAttempts??3)||!(a.retryOn??la)(s))break;o=Math.min(a.maxInterval??128e3,o*(a.backoffFactor??2));let t=a.jitter?Math.floor(o+1e3*Math.random()):o;await new Promise(e=>setTimeout(e,t));let r=s.name??s.constructor.unminifiable_name??s.constructor.name;(a?.logWarning??!0)&&console.log(`Retrying task "${String(e.name)}" after ${o.toFixed(2)}ms (attempt ${l}) after ${r}: ${s}`),c=oH(c,{[a$]:!0})}}return{task:e,result:i,error:s,signalAborted:n?.aborted}}let ll=Symbol.for("promiseAdded");class lc{constructor({loop:e,nodeFinished:t}){Object.defineProperty(this,"nodeFinished",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.loop=e,this.nodeFinished=t}async tick(e={}){let t,{timeout:r,retryPolicy:n,onStepWrite:s,maxConcurrency:i}=e,a=new Set,o=new AbortController,l=Object.values(this.loop.tasks).filter(e=>0===e.writes.length),c=this._initializeAbortSignals({exceptionSignalController:o,timeout:r,signal:e.signal});for await(let{task:e,error:r,signalAborted:s}of this._executeTasksWithRetry(l,{signals:c,retryPolicy:n,maxConcurrency:i}))this._commit(e,r),nU(r)||nF(r)&&!nU(t)?t=r:r&&(0===a.size||!s)&&(o.abort(),a.add(r));if(s?.(this.loop.step,Object.values(this.loop.tasks).map(e=>e.writes).flat()),1===a.size)throw Array.from(a)[0];if(a.size>1)throw AggregateError(Array.from(a),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(nU(t)||nF(t)&&this.loop.isNested)throw t}_initializeAbortSignals({exceptionSignalController:e,timeout:t,signal:r}){let n=this.loop.config.configurable?.[az]??{},s=r&&n.composedAbortSignal&&r!==n.composedAbortSignal?oY(n.externalAbortSignal,r):n.externalAbortSignal??r,i=n.errorAbortSignal?oY(n.errorAbortSignal,e.signal):e.signal,a=t?AbortSignal.timeout(t):void 0,o=oY(...s?[s]:[],...a?[a]:[],i),l={externalAbortSignal:s,errorAbortSignal:i,timeoutAbortSignal:a,composedAbortSignal:o};return this.loop.config=oH(this.loop.config,{[az]:l}),l}async *_executeTasksWithRetry(e,t){let r,n,{retryPolicy:s,maxConcurrency:i,signals:a}=t??{},o=((n={next:()=>void 0,wait:Promise.resolve(ll)}).wait=new Promise(function e(t){n.next=()=>{n.wait=new Promise(e),t(ll)}}),n),l={},c={executingTasksMap:l,barrier:o,retryPolicy:s,scheduleTask:async(e,t,r)=>this.loop.acceptPush(e,t,r)};if(a?.composedAbortSignal?.aborted)throw Error("Abort");let u=0,h=a?.externalAbortSignal||a?.timeoutAbortSignal?oY(...a.externalAbortSignal?[a.externalAbortSignal]:[],...a.timeoutAbortSignal?[a.timeoutAbortSignal]:[]):void 0,d=h?new Promise((e,t)=>{r=()=>t(Error("Abort")),h.addEventListener("abort",r,{once:!0})}):void 0;for(;(0===u||Object.keys(l).length>0)&&e.length;){for(;Object.values(l).length<(i??e.length)&&u<e.length;u+=1){let t=e[u];l[t.id]=lo(t,s,{[aI]:lu?.bind(c,this,t)},a?.composedAbortSignal).catch(e=>({task:t,error:e,signalAborted:a?.composedAbortSignal?.aborted}))}let t=await Promise.race([...Object.values(l),...d?[d]:[],o.wait]);t!==ll&&(yield t,delete l[t.task.id])}}_commit(e,t){if(void 0!==t)if(nU(t)){if(t.interrupts.length){let r=t.interrupts.map(e=>[aV,e]),n=e.writes.filter(e=>e[0]===aq);n.length&&r.push(...n),this.loop.putWrites(e.id,r)}}else nF(t)&&e.writes.length?this.loop.putWrites(e.id,e.writes):this.loop.putWrites(e.id,[[aT,{message:t.message,name:t.name}]]);else this.nodeFinished&&(e.config?.tags==null||!e.config.tags.includes(aZ))&&this.nodeFinished(String(e.name)),0===e.writes.length&&e.writes.push([aW,null]),this.loop.putWrites(e.id,e.writes)}}async function lu(e,t,r,n,s,i={}){let a=t.config?.configurable?.[aB];if(!a)throw Error(`BUG: No scratchpad found on task ${t.name}__${t.id}`);let o=a.callCounter;a.callCounter+=1;let l=new oW({func:r,name:n,input:s,retry:i.retry,callbacks:i.callbacks}),c=await this.scheduleTask(t,o,l);if(!c)return;let u=this.executingTasksMap[c.id];if(void 0!==u)return u;if(c.writes.length>0){let e=c.writes.filter(([e])=>e===aG),t=c.writes.filter(([e])=>e===aT);if(e.length>0){if(1===e.length)return Promise.resolve(e[0][1]);throw Error(`BUG: multiple returns found for task ${c.name}__${c.id}`)}if(t.length>0){if(1===t.length){let e=t[0][1];return Promise.reject(e instanceof Error?e:Error(String(e)))}throw Error(`BUG: multiple errors found for task ${c.name}__${c.id}`)}return}{let t=lo(c,i.retry,{[aI]:lu.bind(this,e,c)});return this.executingTasksMap[c.id]=t,this.barrier.next(),t.then(({result:e,error:t})=>t?Promise.reject(t):e)}}class lh{static subscribeTo(e,t){let r,{key:n,tags:s}={key:void 0,tags:void 0,...t??{}};if(Array.isArray(e)&&void 0!==n)throw Error("Can't specify a key when subscribing to multiple channels");return new oC({channels:r="string"==typeof e?n?{[n]:e}:[e]:Object.fromEntries(e.map(e=>[e,e])),triggers:Array.isArray(e)?e:[e],tags:s})}static writeTo(e,t){let r=[];for(let t of e)r.push({channel:t,value:o_,skipNone:!1});for(let[e,n]of Object.entries(t??{}))r3.Runnable.isRunnable(n)||"function"==typeof n?r.push({channel:e,value:o_,skipNone:!0,mapper:(0,r3._coerceToRunnable)(n)}):r.push({channel:e,value:n,skipNone:!1});return new ok(r)}}class ld extends r3.Runnable{static lc_name(){return"LangGraph"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph","pregel"]}),Object.defineProperty(this,"lg_is_pregel",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoValidate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamMode",{enumerable:!0,configurable:!0,writable:!0,value:["values"]}),Object.defineProperty(this,"streamChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{streamMode:t}=e;null==t||Array.isArray(t)||(t=[t]),this.nodes=e.nodes,this.channels=e.channels,this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=t??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.name=e.name,this.autoValidate&&this.validate()}withConfig(e){let t=(0,r4.mergeConfigs)(this.config,e);return new this.constructor({...this,config:t})}validate(){return!function({nodes:e,channels:t,inputChannels:r,outputChannels:n,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!t)throw new oj("Channels not provided");let o=new Set,l=new Set;for(let[t,r]of Object.entries(e)){if(t===aV)throw new oj(`"Node name ${aV} is reserved"`);if(r.constructor===oC)r.triggers.forEach(e=>o.add(e));else throw new oj(`Invalid node type ${typeof r}, expected PregelNode`)}for(let e of o)if(!(e in t))throw new oj(`Subcribed channel '${String(e)}' not in channels`);if(Array.isArray(r)){if(r.every(e=>!o.has(e)))throw new oj(`None of the input channels ${r} are subscribed to by any node`)}else if(!o.has(r))throw new oj(`Input channel ${String(r)} is not subscribed to by any node`);for(let e of(Array.isArray(n)?n.forEach(e=>l.add(e)):l.add(n),s&&!Array.isArray(s)?l.add(s):Array.isArray(s)&&s.forEach(e=>l.add(e)),l))if(!(e in t))throw new oj(`Output channel '${String(e)}' not in channels`);if(i&&"*"!==i){for(let t of i)if(!(t in e))throw new oj(`Node ${String(t)} not in nodes`)}if(a&&"*"!==a){for(let t of a)if(!(t in e))throw new oj(`Node ${String(t)} not in nodes`)}}({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore}),this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,t){for(let[r,n]of Object.entries(this.nodes))if(void 0===e||e.startsWith(r))for(let s of n.subgraphs?.length?n.subgraphs:[n.bound]){let n=oD(s);if(void 0!==n){if(r===e)return void(yield[r,n]);if(void 0===e&&(yield[r,n]),t){let s=e;for(let[i,a]of(void 0!==e&&(s=e.slice(r.length+1)),n.getSubgraphs(s,t)))yield[`${r}|${i}`,a]}}}}async *getSubgraphsAsync(e,t){yield*this.getSubgraphs(e,t)}async _prepareStateSnapshot({config:e,saved:t,subgraphCheckpointer:r,applyPendingWrites:n=!1}){if(void 0===t)return{values:{},next:[],config:e,tasks:[]};let{managed:s}=await this.prepareSpecs(e,{skipManaged:!0}),i=ak(this.channels,t.checkpoint);if(t.pendingWrites?.length){let e=t.pendingWrites.filter(([e,t])=>e===a1).map(([e,t,r])=>[String(t),r]);e.length>0&&o5(t.checkpoint,i,[{name:aj,writes:e,triggers:[]}])}let a=Object.values(o3(t.checkpoint,t.pendingWrites,this.nodes,i,s,t.config,!0,{step:(t.metadata?.step??-1)+1,store:this.store})),o=await oy(this.getSubgraphsAsync()),l=t.config.configurable?.checkpoint_ns??"",c={};for(let e of a){let n=o.find(([t])=>t===e.name);if(!n)continue;let s=`${String(e.name)}:${e.id}`;if(l&&(s=`${l}|${s}`),void 0===r){let r={configurable:{thread_id:t.config.configurable?.thread_id,checkpoint_ns:s}};c[e.id]=r}else{let i={configurable:{[aM]:r,thread_id:t.config.configurable?.thread_id,checkpoint_ns:s}},a=n[1];c[e.id]=await a.getState(i,{subgraphs:!0})}}if(n&&t.pendingWrites?.length){let e=Object.fromEntries(a.map(e=>[e.id,e]));for(let[r,n,s]of t.pendingWrites)![aT,aV,n8].includes(n)&&r in e&&e[r].writes.push([String(n),s]);let r=a.filter(e=>e.writes.length>0);r.length>0&&o5(t.checkpoint,i,r)}let u=t?.metadata;u&&t?.config?.configurable?.thread_id&&(u={...u,thread_id:t.config.configurable.thread_id});let h=a.filter(e=>0===e.writes.length).map(e=>e.name);return{values:oI(i,this.streamChannelsAsIs),next:h,tasks:oV(a,t?.pendingWrites??[],c),metadata:u,config:oZ(t.config,t.metadata),createdAt:t.checkpoint.ts,parentConfig:t.parentConfig}}async getState(e,t){let r=e.configurable?.[aM]??this.checkpointer;if(!r)throw new nM("No checkpointer set");let n=e.configurable?.checkpoint_ns??"";if(""!==n&&e.configurable?.[aM]===void 0){let s=om(n);for await(let[n,i]of this.getSubgraphsAsync(s,!0))if(n===s)return await i.getState(ow(e,{[aM]:r}),{subgraphs:t?.subgraphs});throw Error(`Subgraph with namespace "${s}" not found.`)}let s=(0,r4.mergeConfigs)(this.config,e),i=await r.getTuple(e);return await this._prepareStateSnapshot({config:s,saved:i,subgraphCheckpointer:t?.subgraphs?r:void 0,applyPendingWrites:!e.configurable?.checkpoint_id})}async *getStateHistory(e,t){let r=e.configurable?.[aM]??this.checkpointer;if(!r)throw Error("No checkpointer set");let n=e.configurable?.checkpoint_ns??"";if(""!==n&&e.configurable?.[aM]===void 0){let s=om(n);for await(let[n,i]of this.getSubgraphsAsync(s,!0))if(n===s)return void(yield*i.getStateHistory(ow(e,{[aM]:r}),t));throw Error(`Subgraph with namespace "${s}" not found.`)}let s=(0,r4.mergeConfigs)(this.config,e,{configurable:{checkpoint_ns:n}});for await(let e of r.list(s,t))yield this._prepareStateSnapshot({config:e.config,saved:e})}async bulkUpdateState(e,t){let r=e.configurable?.[aM]??this.checkpointer;if(!r)throw new nM("No checkpointer set");if(0===t.length)throw Error("No supersteps provided");if(t.some(e=>0===e.updates.length))throw Error("No updates provided");let n=e.configurable?.checkpoint_ns??"";if(""!==n&&e.configurable?.[aM]===void 0){let s=om(n);for await(let[,n]of this.getSubgraphsAsync(s,!0))return await n.bulkUpdateState(ow(e,{[aM]:r}),t);throw Error(`Subgraph "${s}" not found`)}let s=async(e,t)=>{let n=this.config?(0,r4.mergeConfigs)(this.config,e):e,s=await r.getTuple(n),i=void 0!==s?aa(s.checkpoint):ai(),a={...s?.checkpoint.channel_versions},o=s?.metadata?.step??-1,l=ow(n,{checkpoint_ns:n.configurable?.checkpoint_ns??""}),c=n.metadata??{};s?.config.configurable&&(l=ow(n,s.config.configurable),c={...s.metadata,...c});let{values:u,asNode:h}=t[0];if(null==u&&void 0===h){if(t.length>1)throw new nV("Cannot create empty checkpoint with multiple updates");return oZ(await r.put(l,aP(i,void 0,o),{source:"update",step:o+1,writes:{},parents:s?.metadata?.parents??{}},{}),s?s.metadata:void 0)}let d=ak(this.channels,i),{managed:p}=await this.prepareSpecs(n,{skipManaged:!0});if(null===u&&h===aC){if(t.length>1)throw new nV("Cannot apply multiple updates when clearing state");if(s){let e=o3(i,s.pendingWrites||[],this.nodes,d,p,s.config,!0,{step:(s.metadata?.step??-1)+1,checkpointer:this.checkpointer||void 0,store:this.store}),t=(s.pendingWrites||[]).filter(e=>e[0]===a1).map(e=>e.slice(1));for(let[r,n,i]of(t.length>0&&o5(s.checkpoint,d,[{name:aj,writes:t,triggers:[]}]),s.pendingWrites||[]))![aT,aV,n8].includes(n)&&r in e&&e[r].writes.push([n,i]);o5(i,d,Object.values(e))}return oZ(await r.put(l,aP(i,void 0,o),{...c,source:"update",step:o+1,writes:{},parents:s?.metadata?.parents??{}},{}),s?s.metadata:void 0)}if(null==u&&"__copy__"===h){if(t.length>1)throw new nV("Cannot copy checkpoint with multiple updates");return oZ(await r.put(s?.parentConfig??l,aP(i,void 0,o),{source:"fork",step:o+1,writes:{},parents:s?.metadata?.parents??{}},{}),s?s.metadata:void 0)}if(h===aj){if(t.length>1)throw new nV("Cannot apply multiple updates when updating as input");let e=await oy(oR(this.inputChannels,u));if(0===e.length)throw new nV(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);o5(i,d,[{name:aj,writes:e,triggers:[]}],r.getNextVersion.bind(this.checkpointer));let n=s?.metadata?.step!=null?s.metadata.step+1:-1,o=await r.put(l,aP(i,d,n),{source:"input",step:n,writes:Object.fromEntries(e),parents:s?.metadata?.parents??{}},oJ(a,i.channel_versions));return await r.putWrites(o,e,n3(aj,i.id)),oZ(o,s?s.metadata:void 0)}if(n.configurable?.checkpoint_id===void 0&&s?.pendingWrites!==void 0&&s.pendingWrites.length>0){let e=o3(i,s.pendingWrites,this.nodes,d,p,s.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(s.metadata?.step??-1)+1}),t=(s.pendingWrites??[]).filter(e=>e[0]===a1).map(e=>e.slice(1));for(let[r,n,i]of(t.length>0&&o5(s.checkpoint,d,[{name:aj,writes:t,triggers:[]}]),s.pendingWrites))[aT,aV,n8].includes(n)||void 0===e[r]||e[r].writes.push([n,i]);let r=Object.values(e).filter(e=>e.writes.length>0);r.length>0&&o5(i,d,r)}let f=Object.values(i.versions_seen).map(e=>Object.values(e)).flat().find(e=>!!e),m=[];if(1===t.length){let{values:e,asNode:r}=t[0];if(void 0===r&&1===Object.keys(this.nodes).length)[r]=Object.keys(this.nodes);else if(void 0===r&&void 0===f)"string"==typeof this.inputChannels&&void 0!==this.nodes[this.inputChannels]&&(r=this.inputChannels);else if(void 0===r){let e=Object.entries(i.versions_seen).map(([e,t])=>Object.values(t).map(t=>[t,e])).flat().sort(([e],[t])=>al(e,t));e&&(1===e.length?r=e[0][1]:e[e.length-1][0]!==e[e.length-2][0]&&(r=e[e.length-1][1]))}if(void 0===r)throw new nV('Ambiguous update, specify "asNode"');m.push({values:e,asNode:r})}else for(let{asNode:e,values:r}of t){if(null==e)throw new nV('"asNode" is required when applying multiple updates');m.push({values:r,asNode:e})}let g=[];for(let{asNode:e,values:t}of m){if(void 0===this.nodes[e])throw new nV(`Node "${e.toString()}" does not exist`);let r=this.nodes[e].getWriters();if(!r.length)throw new nV(`No writers found for node "${e.toString()}"`);g.push({name:e,input:t,proc:r.length>1?r3.RunnableSequence.from(r,{omitSequenceTags:!0}):r[0],writes:[],triggers:[aV],id:n3(aV,i.id),writers:[]})}for(let e of g)await e.proc.invoke(e.input,(0,r4.patchConfig)({...n,store:n?.store??this.store},{runName:n.runName??`${this.getName()}UpdateState`,configurable:{[aN]:t=>e.writes.push(...t),[aR]:(t,r=!1)=>o0(o,i,d,p,e,t,r)}}));for(let e of g){let t=e.writes.filter(e=>e[0]!==aQ);void 0!==s&&t.length>0&&await r.putWrites(l,t,e.id)}o5(i,d,g,r.getNextVersion.bind(this.checkpointer));let b=oJ(a,i.channel_versions),y=await r.put(l,aP(i,d,o+1),{source:"update",step:o+1,writes:Object.fromEntries(m.map(e=>[e.asNode,e.values])),parents:s?.metadata?.parents??{}},b);for(let e of g){let t=e.writes.filter(e=>e[0]===aQ);t.length>0&&await r.putWrites(y,t,e.id)}return oZ(y,s?s.metadata:void 0)},i=e;for(let{updates:e}of t)i=await s(i,e);return i}async updateState(e,t,r){return this.bulkUpdateState(e,[{updates:[{values:t,asNode:r}]}])}_defaults(e){let t,{debug:r,streamMode:n,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...l}=e,c=!0,u=void 0!==r?r:this.debug,h=i;void 0===h?h=this.streamChannelsAsIs:oT(h,this.channels);let d=s;void 0===d?d=this.inputChannels:oT(d,this.channels);let p=o??this.interruptBefore??[],f=a??this.interruptAfter??[];return void 0!==n?(t=Array.isArray(n)?n:[n],c="string"==typeof n):(t=this.streamMode,c=!0),e.configurable?.[aL]!==void 0&&(t=["values"]),[u,t,d,h,l,p,f,!1===this.checkpointer?void 0:void 0!==e&&e.configurable?.[aM]!==void 0?e.configurable[aM]:this.checkpointer,e.store??this.store,c]}async stream(e,t){let r=new AbortController,n={recursionLimit:this.config?.recursionLimit,...t,signal:t?.signal?oY(t.signal,r.signal):r.signal};return new o7(await super.stream(e,n),r)}streamEvents(e,t,r){let n=new AbortController,s={recursionLimit:this.config?.recursionLimit,callbacks:this.config?.callbacks,...t,signal:t?.signal?oY(t.signal,n.signal):n.signal};return new o7(super.streamEvents(e,s,r),n)}async prepareSpecs(e,t){let r={...e,store:this.store},n={},s={};for(let[e,r]of Object.entries(this.channels))ax(r)?n[e]=r:t?.skipManaged?s[e]={cls:oi,params:{config:{}}}:s[e]=r;return{channelSpecs:n,managed:new or(await Object.entries(s).reduce(async(e,[t,n])=>{let s,i=await e;return os(n)?("key"in n.params&&n.params.key===ot&&(n.params.key=t),s=await n.cls.initialize(r,n.params)):s=await n.initialize(r),void 0!==s&&i.push([t,s]),i},Promise.resolve([])))}}async _validateInput(e){return e}async _validateConfigurable(e){return e}async *_streamIterator(e,t){let r,n,s=t?.subgraphs,i=of(this.config,t);if(void 0===i.recursionLimit||i.recursionLimit<1)throw Error('Passed "recursionLimit" must be at least 1.');if(void 0!==this.checkpointer&&!1!==this.checkpointer&&void 0===i.configurable)throw Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');let a=await this._validateInput(e),{runId:o,...l}=i,[c,u,,h,d,p,f,m,g,b]=this._defaults(l);d.configurable=await this._validateConfigurable(d.configurable);let y=new o9({modes:new Set(u)});if(u.includes("messages")){let e=new ls(e=>y.push(e)),{callbacks:t}=d;if(void 0===t)d.callbacks=[e];else if(Array.isArray(t))d.callbacks=t.concat(e);else{let r=t.copy();r.addHandler(e,!0),d.callbacks=r}}u.includes("custom")&&(d.writer=e=>y.push([[],"custom",e]));let v=await (0,r4.getCallbackManagerForConfig)(d),w=await v?.handleChainStart(this.toJSON(),!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{input:e}:e,o,void 0,void 0,void 0,d?.runName??this.getName()),{channelSpecs:_,managed:x}=await this.prepareSpecs(d),O=(async()=>{try{r=await lr.initialize({input:a,config:d,checkpointer:m,nodes:this.nodes,channelSpecs:_,managed:x,outputKeys:h,streamKeys:this.streamChannelsAsIs,store:g,stream:y,interruptAfter:f,interruptBefore:p,manager:w,debug:this.debug});let e=new lc({loop:r,nodeFinished:d.configurable?.__pregel_node_finished});t?.subgraphs&&(r.config.configurable={...r.config.configurable,[aD]:r.stream}),await this._runLoop({loop:r,runner:e,debug:c,config:d})}catch(e){n=e}finally{try{r&&await r.store?.stop(),await Promise.all([...r?.checkpointerPromises??[],...Array.from(x.values()).map(e=>e.promises())])}catch(e){n=n??e}n?y.error(n):y.close()}})();try{for await(let e of y){if(void 0===e)throw Error("Data structure error.");let[t,r,n]=e;u.includes(r)&&(s&&!b?yield[t,r,n]:b?s?yield[t,n]:yield n:yield[r,n])}}catch(e){throw await w?.handleChainError(n),e}finally{await O}await w?.handleChainEnd(r?.output??{},o,void 0,void 0,void 0)}async invoke(e,t){let r=t?.streamMode??"values",n={...t,outputKeys:t?.outputKeys??this.outputChannels,streamMode:r},s=[];for await(let t of(await this.stream(e,n)))s.push(t);return"values"===r?s[s.length-1]:s}async _runLoop(e){let t,{loop:r,runner:n,debug:s,config:i}=e;try{for(;await r.tick({inputKeys:this.inputChannels});){var a,o,l;s&&(a=r.checkpointMetadata.step,o=r.channels,l=this.streamChannelsList,console.log([`${oK(oB,`[${a}:checkpoint]`)}`,`\x1b[1m State at the end of step ${a}:\x1b[0m
`,JSON.stringify(oI(o,l),null,2)].join(""))),s&&oq(r.step,Object.values(r.tasks)),await n.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(e,t)=>{s&&function(e,t,r){let n={};for(let[e,s]of t)r.includes(e)&&(n[e]||(n[e]=[]),n[e].push(s));console.log([`${oK(oB,`[${e}:writes]`)}`,`\x1b[1m Finished step ${e} with writes to ${Object.keys(n).length} channel${1!==Object.keys(n).length?"s":""}:\x1b[0m
`,Object.entries(n).map(([e,t])=>`- ${oK(oU,e)} -> ${t.map(e=>JSON.stringify(e)).join(", ")}`).join("\n")].join(""))}(e,t,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal})}if("out_of_steps"===r.status)throw new nR(`Recursion limit of ${i.recursionLimit} reached without hitting a stop condition. You can increase the limit by setting the "recursionLimit" config key.`,{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(e){if(t=e,!await r.finishAndHandleError(t))throw e}finally{void 0===t&&await r.finishAndHandleError()}}}class lp extends aO{constructor(e=!0){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"EphemeralValue"}),Object.defineProperty(this,"guard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.guard=e}fromCheckpoint(e){let t=new lp(this.guard);return void 0!==e&&(t.value=[e]),t}update(e){if(0===e.length){let e=this.value.length>0;return this.value=[],e}if(1!==e.length&&this.guard)throw new nV("EphemeralValue can only receive one value per step.");return this.value=[e[e.length-1]],!0}get(){if(0===this.value.length)throw new nz;return this.value[0]}checkpoint(){if(0===this.value.length)throw new nz;return this.value[0]}}class lf{constructor(e){Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),r3.Runnable.isRunnable(e.path)?this.path=e.path:this.path=(0,r3._coerceToRunnable)(e.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(e.pathMap)?e.pathMap.reduce((e,t)=>(e[t]=t,e),{}):e.pathMap}run(e,t){return ok.registerWriter(new og({name:"<branch_run>",trace:!1,func:async(r,n)=>{try{return await this._route(r,n,e,t)}catch(e){throw e.name===nL.unminifiable_name&&console.warn("[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.\nNodeInterrupt should only be thrown inside a node, not in edge conditions."),e}}}))}async _route(e,t,r,n){let s,i=await this.path.invoke(n?n(t):e,t);if(Array.isArray(i)||(i=[i]),(s=this.ends?i.map(e=>a4(e)?e:this.ends[e]):i).some(e=>!e))throw Error("Branch condition returned unknown or null destination");if(s.filter(a4).some(e=>e.node===aC))throw new nV("Cannot send a packet to the END node");return await r(s,t)??e}}class lm{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"entryPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"compiled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(e){this.compiled&&console.warn(e)}get allEdges(){return this.edges}addNode(...e){let t=e.length>=1&&"string"!=typeof e[0]?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(0===t.length)throw Error("No nodes provided in `addNode`");for(let[e,r,n]of t){for(let t of["|",":"])if(e.includes(t))throw Error(`"${t}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),e in this.nodes)throw Error(`Node \`${e}\` already present.`);if(e===aC)throw Error(`Node \`${e}\` is reserved.`);let t=(0,r3._coerceToRunnable)(r);this.nodes[e]={runnable:t,metadata:n?.metadata,subgraphs:oL(t)?[t]:n?.subgraphs,ends:n?.ends}}return this}addEdge(e,t){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e===aC)throw Error("END cannot be a start node");if(t===aA)throw Error("START cannot be an end node");if(Array.from(this.edges).some(([t])=>t===e)&&!("channels"in this))throw Error(`Already found path for ${e}. For multiple edges, use StateGraph.`);return this.edges.add([e,t]),this}addConditionalEdges(e,t,r){let n="object"==typeof e?e:{source:e,path:t,pathMap:r};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!r3.Runnable.isRunnable(n.path)){let e=Array.isArray(n.pathMap)?n.pathMap.join(","):Object.keys(n.pathMap??{}).join(",");n.path=(0,r3._coerceToRunnable)(n.path).withConfig({runName:`Branch<${n.source}${""!==e?`,${e}`:""}>`.slice(0,63)})}let s="RunnableLambda"===n.path.getName()?"condition":n.path.getName();if(this.branches[n.source]&&this.branches[n.source][s])throw Error(`Condition \`${s}\` already present for node \`${e}\``);return this.branches[n.source]??={},this.branches[n.source][s]=new lf(n),this}setEntryPoint(e){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(aA,e)}setFinishPoint(e){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(e,aC)}compile({checkpointer:e,interruptBefore:t,interruptAfter:r,name:n}={}){this.validate([...Array.isArray(t)?t:[],...Array.isArray(r)?r:[]]);let s=new lg({builder:this,checkpointer:e,interruptAfter:r,interruptBefore:t,autoValidate:!1,nodes:{},channels:{[aA]:new lp,[aC]:new lp},inputChannels:aA,outputChannels:aC,streamChannels:[],streamMode:"values",name:n});for(let[e,t]of Object.entries(this.nodes))s.attachNode(e,t);for(let[e,t]of this.edges)s.attachEdge(e,t);for(let[e,t]of Object.entries(this.branches))for(let[r,n]of Object.entries(t))s.attachBranch(e,r,n);return s.validate()}validate(e){let t=new Set([...this.allEdges].map(([e,t])=>e));for(let[e]of Object.entries(this.branches))t.add(e);for(let e of t)if(e!==aA&&!(e in this.nodes))throw Error(`Found edge starting at unknown node \`${e}\``);let r=new Set([...this.allEdges].map(([e,t])=>t));for(let[e,t]of Object.entries(this.branches))for(let n of Object.values(t))if(null!=n.ends)for(let e of Object.values(n.ends))r.add(e);else for(let t of(r.add(aC),Object.keys(this.nodes)))t!==e&&r.add(t);for(let e of Object.values(this.nodes))for(let t of e.ends??[])r.add(t);for(let e of Object.keys(this.nodes))if(!r.has(e))throw new nW(`Node \`${e}\` is not reachable.

If you are returning Command objects from your node,
make sure you are passing names of potential destination nodes as an "ends" array
into ".addNode(..., { ends: ["node1", "node2"] })".`,{lc_error_code:"UNREACHABLE_NODE"});for(let e of r)if(e!==aC&&!(e in this.nodes))throw Error(`Found edge ending at unknown node \`${e}\``);if(e){for(let t of e)if(!(t in this.nodes))throw Error(`Interrupt node \`${t}\` is not present`)}this.compiled=!0}}class lg extends ld{constructor({builder:e,...t}){super(t),Object.defineProperty(this,"builder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.builder=e}attachNode(e,t){this.channels[e]=new lp,this.nodes[e]=new oC({channels:[],triggers:[],metadata:t.metadata,subgraphs:t.subgraphs,ends:t.ends}).pipe(t.runnable).pipe(new ok([{channel:e,value:o_}],[aZ])),this.streamChannels.push(e)}attachEdge(e,t){if(t===aC){if(e===aA)throw Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new ok([{channel:aC,value:o_}],[aZ]))}else this.nodes[t].triggers.push(e),this.nodes[t].channels.push(e)}attachBranch(e,t,r){for(let n of(e!==aA||this.nodes[aA]||(this.nodes[aA]=lh.subscribeTo(aA,{tags:[aZ]})),this.nodes[e].pipe(r.run(r=>new ok(r.map(r=>a4(r)?r:{channel:r===aC?aC:`branch:${e}:${t}:${r}`,value:o_}),[aZ]))),r.ends?Object.values(r.ends):Object.keys(this.nodes)))if(n!==aC){let r=`branch:${e}:${t}:${n}`;this.channels[r]=new lp,this.nodes[n].triggers.push(r),this.nodes[n].channels.push(r)}}async getGraphAsync(e){let t=e?.xray,r=new oc.Graph,n={[aA]:r.addNode({schema:tg.z.any()},aA)},s={},i={};function a(e,t,i,o=!1){if(t===aC&&void 0===s[aC]&&(s[aC]=r.addNode({schema:tg.z.any()},aC)),void 0!==n[e]){if(void 0===s[t])throw Error(`End node ${t} not found!`);return r.addEdge(n[e],s[t],i!==t?i:void 0,o)}}for(let[a,l]of(t&&(i=Object.fromEntries((await oy(this.getSubgraphsAsync())).filter(e=>lb(e[1])))),Object.entries(this.builder.nodes))){let c=ly(a),u=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(a)&&this.interruptAfter?.includes(a)?h.__interrupt="before,after":this.interruptBefore?.includes(a)?h.__interrupt="before":this.interruptAfter?.includes(a)&&(h.__interrupt="after"),t){let l="number"==typeof t?t-1:t,d=void 0!==i[a]?await i[a].getGraphAsync({...e,xray:l}):u.getGraph(e);if(d.trimFirstNode(),d.trimLastNode(),Object.keys(d.nodes).length>1){let[e,t]=r.extend(d,c);if(void 0===e)throw Error(`Could not extend subgraph "${a}" due to missing entrypoint.`);function o(e,t){if(void 0!==e&&!(0,ou.validate)(e))return e;if(!t||!t.lc_runnable)return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e}catch(e){return t.getName()}}void 0!==t&&(n[c]={name:o(t.id,t.data),...t}),s[c]={name:o(e.id,e.data),...e}}else{let e=r.addNode(u,c,h);n[c]=e,s[c]=e}}else{let e=r.addNode(u,c,h);n[c]=e,s[c]=e}}for(let[e,t]of[...this.builder.allEdges].sort(([e],[t])=>e<t?-1:+(t>e)))a(ly(e),ly(t));for(let[e,t]of Object.entries(this.builder.branches)){let r={...Object.fromEntries(Object.keys(this.builder.nodes).filter(t=>t!==e).map(e=>[ly(e),ly(e)])),[aC]:aC};for(let n of Object.values(t)){for(let[t,s]of Object.entries(void 0!==n.ends?n.ends:r))a(ly(e),ly(s),t,!0)}}for(let[e,t]of Object.entries(this.builder.nodes))if(void 0!==t.ends)for(let r of t.ends)a(ly(e),ly(r),void 0,!0);return r}getGraph(e){let t=e?.xray,r=new oc.Graph,n={[aA]:r.addNode({schema:tg.z.any()},aA)},s={},i={};function a(e,t,i,o=!1){return t===aC&&void 0===s[aC]&&(s[aC]=r.addNode({schema:tg.z.any()},aC)),r.addEdge(n[e],s[t],i!==t?i:void 0,o)}for(let[a,l]of(t&&(i=Object.fromEntries(ov(this.getSubgraphs()).filter(e=>lb(e[1])))),Object.entries(this.builder.nodes))){let c=ly(a),u=l.runnable,h=l.metadata??{};if(this.interruptBefore?.includes(a)&&this.interruptAfter?.includes(a)?h.__interrupt="before,after":this.interruptBefore?.includes(a)?h.__interrupt="before":this.interruptAfter?.includes(a)&&(h.__interrupt="after"),t){let l="number"==typeof t?t-1:t,d=void 0!==i[a]?i[a].getGraph({...e,xray:l}):u.getGraph(e);if(d.trimFirstNode(),d.trimLastNode(),Object.keys(d.nodes).length>1){let[e,t]=r.extend(d,c);if(void 0===e)throw Error(`Could not extend subgraph "${a}" due to missing entrypoint.`);function o(e,t){if(void 0!==e&&!(0,ou.validate)(e))return e;if(!t||!t.lc_runnable)return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e}catch(e){return t.getName()}}void 0!==t&&(n[c]={name:o(t.id,t.data),...t}),s[c]={name:o(e.id,e.data),...e}}else{let e=r.addNode(u,c,h);n[c]=e,s[c]=e}}else{let e=r.addNode(u,c,h);n[c]=e,s[c]=e}}for(let[e,t]of[...this.builder.allEdges].sort(([e],[t])=>e<t?-1:+(t>e)))a(ly(e),ly(t));for(let[e,t]of Object.entries(this.builder.branches)){let r={...Object.fromEntries(Object.keys(this.builder.nodes).filter(t=>t!==e).map(e=>[ly(e),ly(e)])),[aC]:aC};for(let n of Object.values(t)){for(let[t,s]of Object.entries(void 0!==n.ends?n.ends:r))a(ly(e),ly(s),t,!0)}}return r}}function lb(e){return"function"==typeof e.attachNode&&"function"==typeof e.attachEdge}function ly(e){return"subgraph"===e?`"${e}"`:e}var r3=tJ;let lv=(e,t)=>e.size===t.size&&[...e].every(e=>t.has(e));class lw extends aO{constructor(e){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"NamedBarrierValue"}),Object.defineProperty(this,"names",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.names=e,this.seen=new Set}fromCheckpoint(e){let t=new lw(this.names);return void 0!==e&&(t.seen=new Set(e)),t}update(e){let t=!1;for(let r of e)if(this.names.has(r))this.seen.has(r)||(this.seen.add(r),t=!0);else throw new nV(`Value ${JSON.stringify(r)} not in names ${JSON.stringify(this.names)}`);return t}get(){if(!lv(this.names,this.seen))throw new nz}checkpoint(){return[...this.seen]}consume(){return!!(this.seen&&this.names&&lv(this.seen,this.names))&&(this.seen=new Set,!0)}}let l_=new WeakMap;function lx(e){return"object"==typeof e&&null!=e&&"_parse"in e&&"function"==typeof e._parse}function lO(e){return lx(e)&&"partial"in e&&"function"==typeof e.partial}function lk(e){let t={};for(let n in e.shape)if(Object.prototype.hasOwnProperty.call(e.shape,n)){var r;let s=(r=e.shape[n],l_.get(r));s?.reducer?t[n]=new aE(s.reducer.fn,s.default):t[n]=new aS}return t}let lP="__root__";class lE extends lm{constructor(e,t){if(super(),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"waitingEdges",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"_schemaDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_configSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_configRuntimeSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){return"object"==typeof e&&null!=e&&"state"in e&&!!lO(e.state)&&(!("input"in e)||!!lO(e.input))&&(!("output"in e)||!!lO(e.output))}(e)){const t=lk(e.state),r=null!=e.input?lk(e.input):t,n=null!=e.output?lk(e.output):t;this._schemaDefinition=t,this._schemaRuntimeDefinition=e.state,this._inputDefinition=r,this._inputRuntimeDefinition=e.input??e.state.partial(),this._outputDefinition=n,this._outputRuntimeDefinition=e.output??e.state}else if(lO(e)){const t=lk(e);this._schemaDefinition=t,this._schemaRuntimeDefinition=e,this._inputDefinition=t,this._inputRuntimeDefinition=e.partial(),this._outputDefinition=t,this._outputRuntimeDefinition=e}else if(function(e){return"object"==typeof e&&null!==e&&void 0===e.stateSchema&&void 0!==e.input&&void 0!==e.output}(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(function(e){return"object"==typeof e&&null!==e&&void 0!==e.stateSchema}(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=e.input?.spec??this._schemaDefinition,this._outputDefinition=e.output?.spec??this._schemaDefinition;else if(function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&Object.keys(e).length>0&&Object.values(e).every(e=>"function"==typeof e||ax(e))}(e)||lA(e)){const t=lA(e)?e.spec:e;this._schemaDefinition=t}else if(function(e){return"object"==typeof e&&null!==e&&void 0!==e.channels}(e)){const t=function(e){let t={};for(let[r,n]of Object.entries(e))t[r]=ol(n);return t}(e.channels);this._schemaDefinition=t}else throw Error("Invalid StateGraph input.");this._inputDefinition??=this._schemaDefinition,this._outputDefinition??=this._schemaDefinition,this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition),lO(t)&&(this._configRuntimeSchema=t.passthrough())}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,t])=>e.map(e=>[e,t]))])}_addSchema(e){if(!this._schemaDefinitions.has(e))for(let[t,r]of(this._schemaDefinitions.set(e,e),Object.entries(e))){let e;if(e="function"==typeof r?r():r,void 0!==this.channels[t]){if(this.channels[t]!==e&&!os(e)&&"LastValue"!==e.lc_graph_name)throw Error(`Channel "${t}" already exists with a different type.`)}else this.channels[t]=e}}addNode(...e){let t=e.length>=1&&"string"!=typeof e[0]?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(0===t.length)throw Error("No nodes provided in `addNode`");for(let[e,r,n]of t){let t;if(e in this.channels)throw Error(`${e} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(let t of["|",":"])if(e.includes(t))throw Error(`"${t}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),e in this.nodes)throw Error(`Node \`${e}\` already present.`);if(e===aC||e===aA)throw Error(`Node \`${e}\` is reserved.`);let s=this._schemaDefinition;n?.input!==void 0&&(lO(n.input)?s=lk(n.input):void 0!==n.input.spec&&(s=n.input.spec)),void 0!==s&&this._addSchema(s);let i={runnable:t=r3.Runnable.isRunnable(r)?r:"function"==typeof r?new og({func:r,name:e,trace:!1}):(0,r3._coerceToRunnable)(r),retryPolicy:n?.retryPolicy,metadata:n?.metadata,input:s??this._schemaDefinition,subgraphs:oL(t)?[t]:n?.subgraphs,ends:n?.ends};this.nodes[e]=i}return this}addEdge(e,t){if("string"==typeof e)return super.addEdge(e,t);for(let t of(this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e)){if(t===aC)throw Error("END cannot be a start node");if(!Object.keys(this.nodes).some(e=>e===t))throw Error(`Need to add a node named "${t}" first`)}if(t===aC)throw Error("END cannot be an end node");if(!Object.keys(this.nodes).some(e=>e===t))throw Error(`Need to add a node named "${t}" first`);return this.waitingEdges.add([e,t]),this}addSequence(e){let t,r=Array.isArray(e)?e:Object.entries(e);if(0===r.length)throw Error("Sequence requires at least one node.");for(let[e,n,s]of r){if(e in this.nodes)throw Error(`Node names must be unique: node with the name "${e}" already exists.`);this.addNode(e,n,s),null!=t&&this.addEdge(t,e),t=e}return this}compile({checkpointer:e,store:t,interruptBefore:r,interruptAfter:n,name:s}={}){this.validate([...Array.isArray(r)?r:[],...Array.isArray(n)?n:[]]);let i=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),a=1===i.length&&i[0]===lP?lP:i,o=Object.keys(this.channels),l=1===o.length&&o[0]===lP?lP:o,c=new lS({builder:this,checkpointer:e,interruptAfter:n,interruptBefore:r,autoValidate:!1,nodes:{},channels:{...this.channels,[aA]:new lp},inputChannels:aA,outputChannels:a,streamChannels:l,streamMode:"updates",store:t,name:s});for(let[e,t]of(c.attachNode(aA),Object.entries(this.nodes)))c.attachNode(e,t);for(let[e]of(c.attachBranch(aA,aY,lj(),{withReader:!1}),Object.entries(this.nodes)))c.attachBranch(e,aY,lj(),{withReader:!1});for(let[e,t]of this.edges)c.attachEdge(e,t);for(let[e,t]of this.waitingEdges)c.attachEdge(e,t);for(let[e,t]of Object.entries(this.branches))for(let[r,n]of Object.entries(t))c.attachBranch(e,r,n);return c.validate()}}class lS extends lg{attachNode(e,t){let r,n=[{value:o_,mapper:new og({func:(r=e===aA?Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).filter(([e,t])=>!os(t)).map(([e])=>e):Object.keys(this.builder.channels)).length&&r[0]===lP?function(e){if(a6(e))return e.graph===a8.PARENT?null:e._updateAsTuples();if(Array.isArray(e)&&e.length>0&&e.some(e=>a6(e))){let t=[];for(let r of e)if(a6(r)){if(r.graph===a8.PARENT)continue;t.push(...r._updateAsTuples())}else t.push([lP,r]);return t}return null!=e?[[lP,e]]:null}:function t(n){if(!n)return null;if(a6(n))return n.graph===a8.PARENT?null:n._updateAsTuples().filter(([e])=>r.includes(e));if(Array.isArray(n)&&n.length>0&&n.some(a6)){let e=[];for(let s of n)if(a6(s)){if(s.graph===a8.PARENT)continue;e.push(...s._updateAsTuples().filter(([e])=>r.includes(e)))}else{let r=t(s);r&&e.push(...r??[])}return e}{if("object"==typeof n&&!Array.isArray(n))return Object.entries(n).filter(([e])=>r.includes(e));let t=Array.isArray(n)?"array":typeof n;throw new nV(`Expected node "${e.toString()}" to return an object or an array containing at least one Command object, received ${t}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}},trace:!1,recurse:!1})}];if(e===aA)this.nodes[e]=new oC({tags:[aZ],triggers:[aA],channels:[aA],writers:[new ok(n,[aZ])]});else{let r=t?.input??this.builder._schemaDefinition,s=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(r)).map(e=>[e,e])),i=1===Object.keys(s).length&&lP in s,a=`branch:to:${e}`;this.channels[a]=new lp(!1),this.nodes[e]=new oC({triggers:[a],channels:i?Object.keys(s):s,writers:[new ok(n,[aZ])],mapper:i?void 0:e=>Object.fromEntries(Object.entries(e).filter(([e])=>e in s)),bound:t?.runnable,metadata:t?.metadata,retryPolicy:t?.retryPolicy,subgraphs:t?.subgraphs,ends:t?.ends})}}attachEdge(e,t){if(t!==aC){if("string"==typeof e)this.nodes[e].writers.push(new ok([{channel:`branch:to:${t}`,value:null}],[aZ]));else if(Array.isArray(e)){let r=`join:${e.join("+")}:${t}`;for(let n of(this.channels[r]=new lw(new Set(e)),this.nodes[t].triggers.push(r),e))this.nodes[n].writers.push(new ok([{channel:r,value:n}],[aZ]))}}}attachBranch(e,t,r,n={withReader:!0}){let s=async(t,r)=>{let n=t.filter(e=>e!==aC);if(!n.length)return;let s=n.map(t=>a4(t)?t:{channel:`branch:to:${t}`,value:e});await ok.doWrite({...r,tags:(r.tags??[]).concat([aZ])},s)};this.nodes[e].writers.push(r.run(s,n.withReader?e=>oS.doRead(e,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){let t=this.builder._inputRuntimeDefinition;return a6(e)?(e.update&&lO(t)&&(e.update=t.parse(e.update)),e):lO(t)?t.parse(e):e}async _validateConfigurable(e){let t=this.builder._configRuntimeSchema;return lO(t)&&t.parse(e),e}}function lA(e){return"object"==typeof e&&null!==e&&"lc_graph_name"in e&&"AnnotationRoot"===e.lc_graph_name}function lC(e){if(a4(e))return[e];let t=[];a6(e)?t.push(e):Array.isArray(e)&&t.push(...e.filter(a6));let r=[];for(let e of t){if(e.graph===a8.PARENT)throw new nD(e);a4(e.goto)||"string"==typeof e.goto?r.push(e.goto):Array.isArray(e.goto)&&r.push(...e.goto)}return r}function lj(){return new lf({path:new og({func:lC,tags:[aZ],trace:!1,recurse:!1,name:"<control_branch>"})})}var lT=e.i(22233);function lN(e,t){let r,n=Array.isArray(e)?e:[e],s=Array.isArray(t)?t:[t],i=n.map(th.coerceMessageLikeToMessage),a=s.map(th.coerceMessageLikeToMessage);for(let e of i)(null===e.id||void 0===e.id)&&(e.id=(0,lT.v4)(),e.lc_kwargs.id=e.id);for(let e=0;e<a.length;e+=1){let t=a[e];(null===t.id||void 0===t.id)&&(t.id=(0,lT.v4)(),t.lc_kwargs.id=t.id),"remove"===t.getType()&&"__remove_all__"===t.id&&(r=e)}if(null!=r)return a.slice(r+1);let o=[...i],l=new Map(o.map((e,t)=>[e.id,t])),c=new Set;for(let e of a){let t=l.get(e.id);if(void 0!==t)"remove"===e.getType()?c.add(e.id):(c.delete(e.id),o[t]=e);else{if("remove"===e.getType())throw Error(`Attempting to delete a message with an ID that doesn't exist ('${e.id}')`);l.set(e.id,o.length),o.push(e)}}return o.filter(e=>!c.has(e.id))}class lI extends a9{call(e){return e===(this.config.recursionLimit??25)-1}}e.s(["IsLastStepManager",()=>lI],93477);class lR extends oe{constructor(e,t){if(super(e,t),Object.defineProperty(this,"scope",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ns",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this.scope=t.scope,this.store=e.store||null,this.store)if(e.configurable?.[this.scope]){const r=e.configurable[this.scope],n="string"==typeof r?r:JSON.stringify(r);this.ns=["scoped",this.scope,t.key,n]}else throw Error(`Required scope "${this.scope}" for shared state key was not passed in "config.configurable".`);else this.ns=null}static async initialize(e,t){let r=new this(e,t);return await r.loadStore(),r}static on(e){return{cls:lR,params:{scope:e,key:ot}}}call(e){return{...this.value}}processUpdate(e){let t=[];for(let r of e)for(let[e,n]of Object.entries(r))if(null===n)e in this.value&&(delete this.value[e],this.ns&&t.push({namespace:this.ns,key:e,value:null}));else if("object"!=typeof n||null===n)throw new nV("Received a non-object value");else this.value[e]=n,this.ns&&t.push({namespace:this.ns,key:e,value:n});return t}async update(e){this.store?await this.store.batch(this.processUpdate(e)):this.processUpdate(e)}async loadStore(){if(this.store&&this.ns){let e=await this.store.search(this.ns);this.value=e.reduce((e,t)=>(e[t.key]=t.value,e),{})}return!1}}e.s(["SharedValue",()=>lR],99502),e.s([],18684),oo.Root({messages:oo({reducer:lN,default:()=>[]})}),tg.z.object({messages:function(e,t){if(t.reducer&&!t.default){let r=lx(e)&&"removeDefault"in e&&"function"==typeof e.removeDefault?e._def.defaultValue:void 0;null!=r&&(t.default=r)}return l_.set(e,t),e}(tg.z.custom(),{reducer:{schema:tg.z.custom(),fn:lN},default:()=>[]})}),e.s([],63500),e.i(63500),e.i(90588),e.i(48505),e.i(10591),e.i(24060),e.i(5778),e.i(11108),e.i(81800),e.i(1164),e.i(4835),e.i(30065),e.i(60342),e.s(["AsyncBatchedStore",()=>ag,"BaseStore",()=>am,"InMemoryStore",()=>ay,"InvalidNamespaceError",()=>ad,"MemoryStore",()=>av,"getTextAtPath",()=>ap,"tokenizePath",()=>af],84676),e.i(84676),e.i(65378),e.i(44643),e.i(68939),e.s(["BaseCache",()=>aw,"InMemoryCache",()=>a_],58107),e.i(58107),e.i(18684),e.i(56576),e.i(93477),e.i(99502),e.s(["ChannelKeyPlaceholder",0,ot,"IsLastStepManager",()=>lI,"ManagedValue",()=>a9,"ManagedValueMapping",()=>or,"NoopManagedValue",()=>oi,"SharedValue",()=>lR,"WritableManagedValue",()=>oe,"isConfiguredManagedValue",()=>os,"isManagedValue",()=>on],75894),e.i(75894);var lM=e.i(47167);e.i(79304);let l$="11434",lL=`http://127.0.0.1:${l$}`;var lD=Object.defineProperty,lB=(e,t,r)=>{let n;return(n="symbol"!=typeof t?t+"":t)in e?lD(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,r};class lF extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,lF)}}class lU{constructor(e,t,r){lB(this,"abortController"),lB(this,"itr"),lB(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=r}abort(){this.abortController.abort()}async *[Symbol.asyncIterator](){for await(let e of this.itr){if("error"in e)throw Error(e.error);if(yield e,e.done||"success"===e.status)return void this.doneCallback()}throw Error("Did not receive done or success response in stream.")}}let lK=async e=>{if(e.ok)return;let t=`Error ${e.status}: ${e.statusText}`;if(e.headers.get("content-type")?.includes("application/json"))try{t=(await e.json()).error||t}catch(e){console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response"),t=await e.text()||t}catch(e){console.log("Failed to get text from error response")}throw new lF(t,e.status)},lz=async(e,t,r={})=>{let n={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/0.5.18 (${function(){if("u">typeof window&&window.navigator){let e=navigator;return"userAgentData"in e&&e.userAgentData?.platform?`${e.userAgentData.platform.toLowerCase()} Browser/${navigator.userAgent};`:navigator.platform?`${navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:`unknown Browser/${navigator.userAgent};`}return void 0!==lM.default?`${lM.default.arch} ${lM.default.platform} Node.js/${lM.default.version}`:""}()})`};r.headers=function(e){if(e instanceof Headers){let t={};return e.forEach((e,r)=>{t[r]=e}),t}return Array.isArray(e)?Object.fromEntries(e):e||{}}(r.headers);let s=Object.fromEntries(Object.entries(r.headers).filter(([e])=>!Object.keys(n).some(t=>t.toLowerCase()===e.toLowerCase())));return r.headers={...n,...s},e(t,r)},lV=async(e,t,r)=>{let n=await lz(e,t,{headers:r?.headers});return await lK(n),n},lq=async(e,t,r,n)=>{let s=null===r||"object"!=typeof r||Array.isArray(r)?r:JSON.stringify(r),i=await lz(e,t,{method:"POST",body:s,signal:n?.signal,headers:n?.headers});return await lK(i),i},lW=async(e,t,r,n)=>{let s=await lz(e,t,{method:"DELETE",body:JSON.stringify(r),headers:n?.headers});return await lK(s),s},lG=async function*(e){let t=new TextDecoder("utf-8"),r="",n=e.getReader();for(;;){let{done:e,value:s}=await n.read();if(e)break;let i=(r+=t.decode(s)).split("\n");for(let e of(r=i.pop()??"",i))try{yield JSON.parse(e)}catch(t){console.warn("invalid json: ",e)}}for(let e of r.split("\n").filter(e=>""!==e))try{yield JSON.parse(e)}catch(t){console.warn("invalid json: ",e)}};var lJ=Object.defineProperty,lH=(e,t,r)=>{let n;return(n="symbol"!=typeof t?t+"":t)in e?lJ(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,r};let lZ=class{constructor(e){lH(this,"config"),lH(this,"fetch"),lH(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:e?.headers},e?.proxy||(this.config.host=(e=>{if(!e)return lL;let t=e.includes("://");e.startsWith(":")&&(e=`http://127.0.0.1${e}`,t=!0),t||(e=`http://${e}`);let r=new URL(e),n=r.port;n||(n=t?"https:"===r.protocol?"443":"80":l$);let s="";r.username&&(s=r.username,r.password&&(s+=`:${r.password}`),s+="@");let i=`${r.protocol}//${s}${r.hostname}:${n}${r.pathname}`;return i.endsWith("/")&&(i=i.slice(0,-1)),i})(e?.host??lL)),this.fetch=e?.fetch??fetch}abort(){for(let e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){t.stream=t.stream??!1;let r=`${this.config.host}/api/${e}`;if(t.stream){let e=new AbortController,n=await lq(this.fetch,r,t,{signal:e.signal,headers:this.config.headers});if(!n.body)throw Error("Missing body");let s=new lU(e,lG(n.body),()=>{let e=this.ongoingStreamedRequests.indexOf(s);e>-1&&this.ongoingStreamedRequests.splice(e,1)});return this.ongoingStreamedRequests.push(s),s}let n=await lq(this.fetch,r,t,{headers:this.config.headers});return await n.json()}async encodeImage(e){if("string"!=typeof e){let t=new Uint8Array(e),r="",n=t.byteLength;for(let e=0;e<n;e++)r+=String.fromCharCode(t[e]);return btoa(r)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(let t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{...e})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await lW(this.fetch,`${this.config.host}/api/delete`,{name:e.model},{headers:this.config.headers}),{status:"success"}}async copy(e){return await lq(this.fetch,`${this.config.host}/api/copy`,{...e},{headers:this.config.headers}),{status:"success"}}async list(){let e=await lV(this.fetch,`${this.config.host}/api/tags`,{headers:this.config.headers});return await e.json()}async show(e){let t=await lq(this.fetch,`${this.config.host}/api/show`,{...e},{headers:this.config.headers});return await t.json()}async embed(e){let t=await lq(this.fetch,`${this.config.host}/api/embed`,{...e},{headers:this.config.headers});return await t.json()}async embeddings(e){let t=await lq(this.fetch,`${this.config.host}/api/embeddings`,{...e},{headers:this.config.headers});return await t.json()}async ps(){let e=await lV(this.fetch,`${this.config.host}/api/ps`,{headers:this.config.headers});return await e.json()}};new lZ;var r3=tJ,iH=t8;function lY(e){let t=e.match(/^data:.*?;base64,(.*)$/);return t?t[1]:""}class lX extends rZ{static lc_name(){return"ChatOllama"}constructor(e){super(e??{}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama3"}),Object.defineProperty(this,"numa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16Kv",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMmap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMlock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkOrPullModel",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://127.0.0.1:11434"}),Object.defineProperty(this,"think",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=new lZ({fetch:e?.fetch,host:e?.baseUrl,headers:e?.headers}),this.baseUrl=e?.baseUrl??this.baseUrl,this.model=e?.model??this.model,this.numa=e?.numa,this.numCtx=e?.numCtx,this.numBatch=e?.numBatch,this.numGpu=e?.numGpu,this.mainGpu=e?.mainGpu,this.lowVram=e?.lowVram,this.f16Kv=e?.f16Kv,this.logitsAll=e?.logitsAll,this.vocabOnly=e?.vocabOnly,this.useMmap=e?.useMmap,this.useMlock=e?.useMlock,this.embeddingOnly=e?.embeddingOnly,this.numThread=e?.numThread,this.numKeep=e?.numKeep,this.seed=e?.seed,this.numPredict=e?.numPredict,this.topK=e?.topK,this.topP=e?.topP,this.tfsZ=e?.tfsZ,this.typicalP=e?.typicalP,this.repeatLastN=e?.repeatLastN,this.temperature=e?.temperature,this.repeatPenalty=e?.repeatPenalty,this.presencePenalty=e?.presencePenalty,this.frequencyPenalty=e?.frequencyPenalty,this.mirostat=e?.mirostat,this.mirostatTau=e?.mirostatTau,this.mirostatEta=e?.mirostatEta,this.penalizeNewline=e?.penalizeNewline,this.streaming=e?.streaming,this.format=e?.format,this.keepAlive=e?.keepAlive,this.think=e?.think,this.checkOrPullModel=e?.checkOrPullModel??this.checkOrPullModel}_llmType(){return"ollama"}async pull(e,t){let{stream:r,insecure:n,logProgress:s}={stream:!0,...t};if(r)for await(let t of(await this.client.pull({model:e,insecure:n,stream:r})))s&&console.log(t);else{let t=await this.client.pull({model:e,insecure:n});s&&console.log(t)}}bindTools(e,t){return this.withConfig({tools:e.map(e=>ne(e)),...t})}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.options?.temperature??void 0,ls_max_tokens:t.options?.num_predict??void 0,ls_stop:e.stop}}invocationParams(e){if(e?.tool_choice)throw Error("Tool choice is not supported for ChatOllama.");return{model:this.model,format:e?.format??this.format,keep_alive:this.keepAlive,think:this.think,options:{numa:this.numa,num_ctx:this.numCtx,num_batch:this.numBatch,num_gpu:this.numGpu,main_gpu:this.mainGpu,low_vram:this.lowVram,f16_kv:this.f16Kv,logits_all:this.logitsAll,vocab_only:this.vocabOnly,use_mmap:this.useMmap,use_mlock:this.useMlock,embedding_only:this.embeddingOnly,num_thread:this.numThread,num_keep:this.numKeep,seed:this.seed,num_predict:this.numPredict,top_k:this.topK,top_p:this.topP,tfs_z:this.tfsZ,typical_p:this.typicalP,repeat_last_n:this.repeatLastN,temperature:this.temperature,repeat_penalty:this.repeatPenalty,presence_penalty:this.presencePenalty,frequency_penalty:this.frequencyPenalty,mirostat:this.mirostat,mirostat_tau:this.mirostatTau,mirostat_eta:this.mirostatEta,penalize_newline:this.penalizeNewline,stop:e?.stop},tools:e?.tools?.length?e.tools.map(e=>ne(e)):void 0}}async checkModelExistsOnMachine(e){let{models:t}=await this.client.list();return!!t.find(t=>t.name===e||t.name===`${e}:latest`)}async _generate(e,t,r){let n;for await(let s of(this.checkOrPullModel&&!await this.checkModelExistsOnMachine(this.model)&&await this.pull(this.model,{logProgress:!0}),this._streamResponseChunks(e,t,r)))n=n?(0,rV.concat)(n,s.message):s.message;let s=new to.AIMessage({id:n?.id,content:n?.content??"",tool_calls:n?.tool_calls,response_metadata:n?.response_metadata,usage_metadata:n?.usage_metadata});return{generations:[{text:"string"==typeof s.content?s.content:"",message:s}]}}async *_streamResponseChunks(e,t,r){let n;this.checkOrPullModel&&!await this.checkModelExistsOnMachine(this.model)&&await this.pull(this.model,{logProgress:!0});let s=this.invocationParams(t),i=e.flatMap(e=>{if(["human","generic"].includes(e._getType()))return"string"==typeof e.content?[{role:"user",content:e.content}]:e.content.map(e=>{if("text"===e.type)return{role:"user",content:e.text};if("image_url"===e.type){if("string"==typeof e.image_url)return{role:"user",content:"",images:[lY(e.image_url)]};else if(e.image_url.url&&"string"==typeof e.image_url.url)return{role:"user",content:"",images:[lY(e.image_url.url)]}}throw Error(`Unsupported content type: ${e.type}`)});if("ai"===e._getType()){let t;if("string"==typeof e.content)return[{role:"assistant",content:e.content}];let r=e.content.filter(e=>"text"===e.type&&"string"==typeof e.text).map(e=>({role:"assistant",content:e.text}));if(e.content.find(e=>"tool_use"===e.type)&&e.tool_calls?.length){let r=e.tool_calls?.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:e.args}}));r&&(t={role:"assistant",tool_calls:r,content:""})}else if(e.content.find(e=>"tool_use"===e.type)&&!e.tool_calls?.length)throw Error("'tool_use' content type is not supported without tool calls.");return[...r,...t?[t]:[]]}if("system"===e._getType()){if("string"==typeof e.content)return[{role:"system",content:e.content}];if(e.content.every(e=>"text"===e.type&&"string"==typeof e.text))return e.content.map(e=>({role:"system",content:e.text}));throw Error(`Unsupported content type(s): ${e.content.map(e=>e.type).join(", ")}`)}if("tool"===e._getType()){if("string"!=typeof e.content)throw Error("Non string tool message content is not supported");return[{role:"tool",content:e.content}]}throw Error(`Unsupported message type: ${e._getType()}`)}),a={input_tokens:0,output_tokens:0,total_tokens:0};for await(let e of(await this.client.chat({...s,messages:i,stream:!0}))){t.signal?.aborted&&this.client.abort();let{message:s,...i}=e;a.input_tokens+=i.prompt_eval_count??0,a.output_tokens+=i.eval_count??0,a.total_tokens=a.input_tokens+a.output_tokens,n=i;let o=this.think?s.thinking??s.content??"":s.content??"";yield new rz.ChatGenerationChunk({text:o,message:new to.AIMessageChunk({content:s.thinking??s.content??"",tool_call_chunks:s.tool_calls?.map(e=>({name:e.function.name,args:JSON.stringify(e.function.arguments),type:"tool_call_chunk",index:0,id:(0,lT.v4)()})),response_metadata:void 0,usage_metadata:void 0})}),await r?.handleLLMNewToken(o)}yield new rz.ChatGenerationChunk({text:"",message:new to.AIMessageChunk({content:"",response_metadata:n,usage_metadata:a})})}withStructuredOutput(e,t){if(t?.method!==void 0&&t?.method!=="jsonSchema")return super.withStructuredOutput(e,t);{let r=(0,t4.isInteropZodSchema)(e),n=r?(0,iH.toJsonSchema)(e):e,s=this.bindTools([{type:"function",function:{name:"extract",description:n.description,parameters:n}}]).withConfig({format:"json",ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:(0,iH.toJsonSchema)(e)}}),i=r?nb.fromZodSchema(e):new nx;if(!t?.includeRaw)return s.pipe(i);let a=rW.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),o=rW.assign({parsed:()=>null}),l=a.withFallbacks({fallbacks:[o]});return r3.RunnableSequence.from([{raw:s},l])}}}let lQ="RFC3986",l0={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)};Object.prototype.hasOwnProperty;let l1=Array.isArray,l2=(()=>{let e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();function l5(e,t){if(l1(e)){let r=[];for(let n=0;n<e.length;n+=1)r.push(t(e[n]));return r}return t(e)}let l3=Object.prototype.hasOwnProperty,l4={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},l8=Array.isArray,l6=Array.prototype.push,l7=function(e,t){l6.apply(e,l8(t)?t:[t])},l9=Date.prototype.toISOString,ce={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,r,n,s)=>{if(0===e.length)return e;let i=e;if("symbol"==typeof e?i=Symbol.prototype.toString.call(e):"string"!=typeof e&&(i=String(e)),"iso-8859-1"===r)return escape(i).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let a="";for(let e=0;e<i.length;e+=1024){let t=i.length>=1024?i.slice(e,e+1024):i,r=[];for(let e=0;e<t.length;++e){let n=t.charCodeAt(e);if(45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===s&&(40===n||41===n)){r[r.length]=t.charAt(e);continue}if(n<128){r[r.length]=l2[n];continue}if(n<2048){r[r.length]=l2[192|n>>6]+l2[128|63&n];continue}if(n<55296||n>=57344){r[r.length]=l2[224|n>>12]+l2[128|n>>6&63]+l2[128|63&n];continue}e+=1,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),r[r.length]=l2[240|n>>18]+l2[128|n>>12&63]+l2[128|n>>6&63]+l2[128|63&n]}a+=r.join("")}return a},encodeValuesOnly:!1,format:lQ,formatter:l0[lQ],indices:!1,serializeDate:e=>l9.call(e),skipNulls:!1,strictNullHandling:!1},ct={};var cr=e.i(67034);let cn="4.104.0",cs=!1;class ci{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}let ca=()=>{s||function(e,t={auto:!1}){if(cs)throw Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(s)throw Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${s}'\``);cs=t.auto,s=e.kind,i=e.fetch,e.Request,e.Response,e.Headers,a=e.FormData,e.Blob,o=e.File,l=e.ReadableStream,c=e.getMultipartRequestOptions,u=e.getDefaultAgent,h=e.fileFromPath,d=e.isFsReadStream}(function({manuallyImported:e}={}){let t,r,n,s,i=e?"You may need to use polyfills":`Add one of these imports before your first \`import â€¦ from 'openai'\`:
- \`import 'openai/shims/node'\` (if you're running on Node)
- \`import 'openai/shims/web'\` (otherwise)
`;try{t=fetch,r=Request,n=Response,s=Headers}catch(e){throw Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${i}`)}return{kind:"web",fetch:t,Request:r,Response:n,Headers:s,FormData:"u">typeof FormData?FormData:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${i}`)}},Blob:"u">typeof Blob?Blob:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${i}`)}},File:"u">typeof File?File:class{constructor(){throw Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${i}`)}},ReadableStream:"u">typeof ReadableStream?ReadableStream:class{constructor(){throw Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${i}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new ci(e)}),getDefaultAgent:e=>void 0,fileFromPath:()=>{throw Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0})};ca();class co extends Error{}class cl extends co{constructor(e,t,r,n){super(`${cl.makeMessage(e,t,r)}`),this.status=e,this.headers=n,this.request_id=n?.["x-request-id"],this.error=t,this.code=t?.code,this.param=t?.param,this.type=t?.type}static makeMessage(e,t,r){let n=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,r,n){if(!e||!n)return new cu({message:r,cause:c8(t)});let s=t?.error;return 400===e?new cd(e,s,r,n):401===e?new cp(e,s,r,n):403===e?new cf(e,s,r,n):404===e?new cm(e,s,r,n):409===e?new cg(e,s,r,n):422===e?new cb(e,s,r,n):429===e?new cy(e,s,r,n):e>=500?new cv(e,s,r,n):new cl(e,s,r,n)}}class cc extends cl{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class cu extends cl{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class ch extends cu{constructor({message:e}={}){super({message:e??"Request timed out."})}}class cd extends cl{}class cp extends cl{}class cf extends cl{}class cm extends cl{}class cg extends cl{}class cb extends cl{}class cy extends cl{}class cv extends cl{}class cw extends co{constructor(){super("Could not parse response content as the length limit was reached")}}class c_ extends co{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var cx=function(e,t,r,n,s){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r},cO=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class ck{constructor(){U.set(this,void 0),this.buffer=new Uint8Array,cx(this,U,null,"f")}decode(e){let t;if(null==e)return[];let r=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?new TextEncoder().encode(e):e,n=new Uint8Array(this.buffer.length+r.length);n.set(this.buffer),n.set(r,this.buffer.length),this.buffer=n;let s=[];for(;null!=(t=function(e,t){for(let r=t??0;r<e.length;r++){if(10===e[r])return{preceding:r,index:r+1,carriage:!1};if(13===e[r])return{preceding:r,index:r+1,carriage:!0}}return null}(this.buffer,cO(this,U,"f")));){if(t.carriage&&null==cO(this,U,"f")){cx(this,U,t.index,"f");continue}if(null!=cO(this,U,"f")&&(t.index!==cO(this,U,"f")+1||t.carriage)){s.push(this.decodeText(this.buffer.slice(0,cO(this,U,"f")-1))),this.buffer=this.buffer.slice(cO(this,U,"f")),cx(this,U,null,"f");continue}let e=null!==cO(this,U,"f")?t.preceding-1:t.preceding,r=this.decodeText(this.buffer.slice(0,e));s.push(r),this.buffer=this.buffer.slice(t.index),cx(this,U,null,"f")}return s}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if(void 0!==cr.Buffer){if(e instanceof cr.Buffer)return e.toString();if(e instanceof Uint8Array)return cr.Buffer.from(e).toString();throw new co(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("u">typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new co(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new co("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode("\n"):[]}}function cP(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){let e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}U=new WeakMap,ck.NEWLINE_CHARS=new Set(["\n","\r"]),ck.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class cE{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*n(){if(r)throw Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(let r of cS(e,t))if(!n){if(r.data.startsWith("[DONE]")){n=!0;continue}if(null===r.event||r.event.startsWith("response.")||r.event.startsWith("transcript.")){let t;try{t=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if(t&&t.error)throw new cl(void 0,t.error,void 0,cH(e.headers));yield t}else{let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new cl(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}}n=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{n||t.abort()}}return new cE(n,t)}static fromReadableStream(e,t){let r=!1;async function*n(){let t=new ck;for await(let r of cP(e))for(let e of t.decode(r))yield e;for(let e of t.flush())yield e}return new cE(async function*(){if(r)throw Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let e=!1;try{for await(let t of n())!e&&t&&(yield JSON.parse(t));e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||t.abort()}},t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),n=n=>({next:()=>{if(0===n.length){let n=r.next();e.push(n),t.push(n)}return n.shift()}});return[new cE(()=>n(e),this.controller),new cE(()=>n(t),this.controller)]}toReadableStream(){let e,t=this,r=new TextEncoder;return new l({async start(){e=t[Symbol.asyncIterator]()},async pull(t){try{let{value:n,done:s}=await e.next();if(s)return t.close();let i=r.encode(JSON.stringify(n)+"\n");t.enqueue(i)}catch(e){t.error(e)}},async cancel(){await e.return?.()}})}}async function*cS(e,t){if(!e.body)throw t.abort(),new co("Attempted to iterate over a response with no body");let r=new cC,n=new ck;for await(let t of cA(cP(e.body)))for(let e of n.decode(t)){let t=r.decode(e);t&&(yield t)}for(let e of n.flush()){let t=r.decode(e);t&&(yield t)}}async function*cA(e){let t=new Uint8Array;for await(let r of e){let e;if(null==r)continue;let n=r instanceof ArrayBuffer?new Uint8Array(r):"string"==typeof r?new TextEncoder().encode(r):r,s=new Uint8Array(t.length+n.length);for(s.set(t),s.set(n,t.length),t=s;-1!==(e=function(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1]||13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return -1}(t));)yield t.slice(0,e),t=t.slice(e)}t.length>0&&(yield t)}class cC{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){var t;let r;if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,s,i]=-1!==(r=(t=e).indexOf(":"))?[t.substring(0,r),":",t.substring(r+1)]:[t,"",""];return i.startsWith(" ")&&(i=i.substring(1)),"event"===n?this.event=i:"data"===n&&this.data.push(i),null}}let cj=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,cT=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&cN(e),cN=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function cI(e,t,r){var n;if(cT(e=await e))return e;if(cj(e)){let n=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");let s=cN(n)?[await n.arrayBuffer()]:[n];return new o(s,t,r)}let s=await cR(e);if(t||(t=(cM((n=e).name)||cM(n.filename)||cM(n.path)?.split(/[\\/]/).pop())??"unknown_file"),!r?.type){let e=s[0]?.type;"string"==typeof e&&(r={...r,type:e})}return new o(s,t,r)}async function cR(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(cN(e))t.push(await e.arrayBuffer());else if(c$(e))for await(let r of e)t.push(r);else{let t;throw Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${(t=Object.getOwnPropertyNames(e),`[${t.map(e=>`"${e}"`).join(", ")}]`)}`)}return t}let cM=e=>"string"==typeof e?e:void 0!==cr.Buffer&&e instanceof cr.Buffer?String(e):void 0,c$=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],cL=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],cD=async e=>{let t=await cB(e.body);return c(t,e)},cB=async e=>{let t=new a;return await Promise.all(Object.entries(e||{}).map(([e,r])=>cF(t,e,r))),t},cF=async(e,t,r)=>{if(void 0!==r){if(null==r)throw TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof r||"number"==typeof r||"boolean"==typeof r)e.append(t,String(r));else{let n;if(cT(n=r)||cj(n)||d(n)){let n=await cI(r);e.append(t,n)}else if(Array.isArray(r))await Promise.all(r.map(r=>cF(e,t+"[]",r)));else if("object"==typeof r)await Promise.all(Object.entries(r).map(([r,n])=>cF(e,`${t}[${r}]`,n)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`)}}};var cU=function(e,t,r,n,s){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r},cK=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};async function cz(e){let{response:t}=e;if(e.options.stream)return(ur("response",t.status,t.url,t.headers,t.body),e.options.__streamClass)?e.options.__streamClass.fromSSEResponse(t,e.controller):cE.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;let r=t.headers.get("content-type"),n=r?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){let e=await t.json();return ur("response",t.status,t.url,t.headers,e),cV(e,t)}let s=await t.text();return ur("response",t.status,t.url,t.headers,s),s}function cV(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}ca();class cq extends Promise{constructor(e,t=cz){super(e=>{e(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new cq(this.responsePromise,async t=>cV(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class cW{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:n,fetch:s}){this.baseURL=e,this.maxRetries=c4("maxRetries",t),this.timeout=c4("timeout",r),this.httpAgent=n,this.fetch=s??i}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...c0(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${un()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async r=>{let n=r&&cN(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:n}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if("string"==typeof e){if(void 0!==cr.Buffer)return cr.Buffer.byteLength(e,"utf8").toString();if("u">typeof TextEncoder)return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:n,path:s,query:i,headers:a={}}=r,o=ArrayBuffer.isView(r.body)||r.__binaryRequest&&"string"==typeof r.body?r.body:cL(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,l=this.calculateContentLength(o),c=this.buildURL(s,i);"timeout"in r&&c4("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let h=r.httpAgent??this.httpAgent??u(c),d=r.timeout+1e3;"number"==typeof h?.options?.timeout&&d>(h.options.timeout??0)&&(h.options.timeout=d),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);let p=this.buildHeaders({options:r,headers:a,contentLength:l,retryCount:t});return{req:{method:n,...o&&{body:o},headers:p,...h&&{agent:h},signal:r.signal??null},url:c,timeout:r.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:n}){let i={};r&&(i["content-length"]=r);let a=this.defaultHeaders(e);return ue(i,a),ue(i,t),cL(e.body)&&"node"!==s&&delete i["content-type"],void 0===us(a,"x-stainless-retry-count")&&void 0===us(t,"x-stainless-retry-count")&&(i["x-stainless-retry-count"]=String(n)),void 0===us(a,"x-stainless-timeout")&&void 0===us(t,"x-stainless-timeout")&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(e=>[...e])):{...e}:{}}makeStatusError(e,t,r,n){return cl.generate(e,t,r,n)}request(e,t=null){return new cq(this.makeRequest(e,t))}async makeRequest(e,t){let r=await e,n=r.maxRetries??this.maxRetries;null==t&&(t=n),await this.prepareOptions(r);let{req:s,url:i,timeout:a}=this.buildRequest(r,{retryCount:n-t});if(await this.prepareRequest(s,{url:i,options:r}),ur("request",i,r,s.headers),r.signal?.aborted)throw new cc;let o=new AbortController,l=await this.fetchWithTimeout(i,s,a,o).catch(c8);if(l instanceof Error){if(r.signal?.aborted)throw new cc;if(t)return this.retryRequest(r,t);if("AbortError"===l.name)throw new ch;throw new cu({cause:l})}let c=cH(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){let e=`retrying, ${t} attempts remaining`;return ur(`response (error; ${e})`,l.status,i,c),this.retryRequest(r,t,c)}let e=await l.text().catch(e=>c8(e).message),n=c1(e),s=n?void 0:e,a=t?"(error; no more retries left)":"(error; not retryable)";throw ur(`response (error; ${a})`,l.status,i,c,s),this.makeStatusError(l.status,n,s,c)}return{response:l,options:r,controller:o}}requestAPIList(e,t){return new cJ(this,this.makeRequest(t,null),e)}buildURL(e,t){let r=new URL(c5(e)?e:this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return c7(n)||(t={...n,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new co(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,n){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>n.abort());let a=setTimeout(()=>n.abort(),r),o={signal:n.signal,...i};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(a)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||!!(e.status>=500))}async retryRequest(e,t,r){let n,s=r?.["retry-after-ms"];if(s){let e=parseFloat(s);Number.isNaN(e)||(n=e)}let i=r?.["retry-after"];if(i&&!n){let e=parseFloat(i);n=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(n&&0<=n&&n<6e4)){let r=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,r)}return await c3(n),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){return Math.min(.5*Math.pow(2,t-e),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${cn}`}}class cG{constructor(e,t,r,n){K.set(this,void 0),cU(this,K,e,"f"),this.options=n,this.response=t,this.body=r}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new co("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){for(let[r,n]of[...Object.entries(t.query||{}),...e.url.searchParams.entries()])e.url.searchParams.set(r,n);t.query=void 0,t.path=e.url.toString()}return await cK(this,K,"f").requestAPIList(this.constructor,t)}async *iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async *[(K=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}}class cJ extends cq{constructor(e,t,r){super(t,async t=>new r(e,t.response,await cz(t),t.options))}async *[Symbol.asyncIterator](){for await(let e of(await this))yield e}}let cH=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),cZ={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},cY=e=>"object"==typeof e&&null!==e&&!c7(e)&&Object.keys(e).every(e=>c9(cZ,e)),cX=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",cQ=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown",c0=()=>t??(t=(()=>{if("u">typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":cn,"X-Stainless-OS":cQ(Deno.build.os),"X-Stainless-Arch":cX(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("u">typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":cn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":lM.default.version};if("[object process]"===Object.prototype.toString.call(void 0!==lM.default?lM.default:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":cn,"X-Stainless-OS":cQ(lM.default.platform),"X-Stainless-Arch":cX(lM.default.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":lM.default.version};let e=function(){if("u"<typeof navigator||!navigator)return null;for(let{key:e,pattern:t}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let r=t.exec(navigator.userAgent);if(r){let t=r[1]||0,n=r[2]||0,s=r[3]||0;return{browser:e,version:`${t}.${n}.${s}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":cn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":cn,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),c1=e=>{try{return JSON.parse(e)}catch(e){return}},c2=/^[a-z][a-z0-9+.-]*:/i,c5=e=>c2.test(e),c3=e=>new Promise(t=>setTimeout(t,e)),c4=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new co(`${e} must be an integer`);if(t<0)throw new co(`${e} must be a positive integer`);return t},c8=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return Error(JSON.stringify(e))}catch{}return Error(e)},c6=e=>void 0!==lM.default?lM.default.env?.[e]?.trim()??void 0:"u">typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function c7(e){if(!e)return!0;for(let t in e)return!1;return!0}function c9(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ue(e,t){for(let r in t){if(!c9(t,r))continue;let n=r.toLowerCase();if(!n)continue;let s=t[r];null===s?delete e[n]:void 0!==s&&(e[n]=s)}}let ut=new Set(["authorization","api-key"]);function ur(e,...t){void 0!==lM.default&&lM.default?.env?.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${e}`,...t.map(e=>{if(!e)return e;if(e.headers){let t={...e,headers:{...e.headers}};for(let r in e.headers)ut.has(r.toLowerCase())&&(t.headers[r]="REDACTED");return t}let t=null;for(let r in e)ut.has(r.toLowerCase())&&(t??(t={...e}),t[r]="REDACTED");return t??e}))}let un=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),us=(e,t)=>{let r=t.toLowerCase();if("function"==typeof e?.get){let n=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(e,t,r)=>t+r.toUpperCase());for(let s of[t,r,t.toUpperCase(),n]){let t=e.get(s);if(t)return t}}for(let[n,s]of Object.entries(e))if(n.toLowerCase()===r){if(Array.isArray(s)){if(s.length<=1)return s[0];return console.warn(`Received ${s.length} entries for the ${t} header, using the first entry.`),s[0]}return s}};function ui(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class ua{constructor(e){this._client=e}}class uo extends ua{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class ul extends ua{list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,up,{query:t,...r})}}class uc extends cG{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class uu extends cG{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class uh extends ua{constructor(){super(...arguments),this.messages=new ul(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/chat/completions",ud,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}}class ud extends uu{}class up extends uu{}uh.ChatCompletionsPage=ud,uh.Messages=ul;class uf extends ua{constructor(){super(...arguments),this.completions=new uh(this._client)}}uf.Completions=uh,uf.ChatCompletionsPage=ud;class um extends ua{create(e,t){let r=!!e.encoding_format,n=r?e.encoding_format:"base64";r&&ur("Request","User defined encoding_format:",e.encoding_format);let s=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return r?s:(ur("response","Decoding base64 embeddings to float32 array"),s._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{let t=e.embedding;e.embedding=(e=>{if(void 0!==cr.Buffer){let t=cr.Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{let t=atob(e),r=t.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}})(t)}),e)))}}class ug extends ua{create(e,t){return this._client.post("/files",cD({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/files",ub,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=18e5}={}){let n=new Set(["processed","error","deleted"]),s=Date.now(),i=await this.retrieve(e);for(;!i.status||!n.has(i.status);)if(await c3(t),i=await this.retrieve(e),Date.now()-s>r)throw new ch({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}}class ub extends uu{}ug.FileObjectsPage=ub;class uy extends ua{createVariation(e,t){return this._client.post("/images/variations",cD({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",cD({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class uv extends ua{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class uw extends ua{create(e,t){return this._client.post("/audio/transcriptions",cD({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class u_ extends ua{create(e,t){return this._client.post("/audio/translations",cD({body:e,...t,__metadata:{model:e.model}}))}}class ux extends ua{constructor(){super(...arguments),this.transcriptions=new uw(this._client),this.translations=new u_(this._client),this.speech=new uv(this._client)}}ux.Transcriptions=uw,ux.Translations=u_,ux.Speech=uv;class uO extends ua{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class uk extends ua{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",uP,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class uP extends uc{}uk.ModelsPage=uP;class uE extends ua{}class uS extends ua{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class uA extends ua{constructor(){super(...arguments),this.graders=new uS(this._client)}}uA.Graders=uS;class uC extends ua{create(e,t,r){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,uj,{body:t,method:"post",...r})}retrieve(e,t={},r){return cY(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}del(e,t,r){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,r)}}class uj extends uc{}uC.PermissionCreateResponsesPage=uj;class uT extends ua{constructor(){super(...arguments),this.permissions=new uC(this._client)}}uT.Permissions=uC,uT.PermissionCreateResponsesPage=uj;class uN extends ua{list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,uI,{query:t,...r})}}class uI extends uu{}uN.FineTuningJobCheckpointsPage=uI;class uR extends ua{constructor(){super(...arguments),this.checkpoints=new uN(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",uM,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return cY(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,u$,{query:t,...r})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class uM extends uu{}class u$ extends uu{}uR.FineTuningJobsPage=uM,uR.FineTuningJobEventsPage=u$,uR.Checkpoints=uN,uR.FineTuningJobCheckpointsPage=uI;class uL extends ua{constructor(){super(...arguments),this.methods=new uE(this._client),this.jobs=new uR(this._client),this.checkpoints=new uT(this._client),this.alpha=new uA(this._client)}}uL.Methods=uE,uL.Jobs=uR,uL.FineTuningJobsPage=uM,uL.FineTuningJobEventsPage=u$,uL.Checkpoints=uT,uL.Alpha=uA;class uD extends ua{}class uB extends ua{constructor(){super(...arguments),this.graderModels=new uD(this._client)}}uB.GraderModels=uD;let uF=async e=>{let t=await Promise.allSettled(e),r=t.filter(e=>"rejected"===e.status);if(r.length){for(let e of r)console.error(e.reason);throw Error(`${r.length} promise(s) failed - see the above errors`)}let n=[];for(let e of t)"fulfilled"===e.status&&n.push(e.value);return n};class uU extends ua{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,uK,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let n=await this.create(e,t,r);return await this.poll(e,n.id,r)}async poll(e,t,r){let n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let s=await this.retrieve(e,t,{...r,headers:n}).withResponse(),i=s.data;switch(i.status){case"in_progress":let a=5e3;if(r?.pollIntervalMs)a=r.pollIntervalMs;else{let e=s.response.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(a=t)}}await c3(a);break;case"failed":case"completed":return i}}}async upload(e,t,r){let n=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:n.id},r)}async uploadAndPoll(e,t,r){let n=await this.upload(e,t,r);return await this.poll(e,n.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,uz,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class uK extends uu{}class uz extends uc{}uU.VectorStoreFilesPage=uK,uU.FileContentResponsesPage=uz;class uV extends ua{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let n=await this.create(e,t);return await this.poll(e,n.id,r)}listFiles(e,t,r={},n){return cY(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,uK,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async poll(e,t,r){let n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:n}).withResponse();switch(s.status){case"in_progress":let a=5e3;if(r?.pollIntervalMs)a=r.pollIntervalMs;else{let e=i.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(a=t)}}await c3(a);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},n){if(null==t||0==t.length)throw Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let s=Math.min(n?.maxConcurrency??5,t.length),i=this._client,a=t.values(),o=[...r];async function l(e){for(let t of e){let e=await i.files.create({file:t,purpose:"assistants"},n);o.push(e.id)}}let c=Array(s).fill(a).map(l);return await uF(c),await this.createAndPoll(e,{file_ids:o})}}class uq extends ua{constructor(){super(...arguments),this.files=new uU(this._client),this.fileBatches=new uV(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/vector_stores",uW,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,uG,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class uW extends uu{}class uG extends uc{}uq.VectorStoresPage=uW,uq.VectorStoreSearchResponsesPage=uG,uq.Files=uU,uq.VectorStoreFilesPage=uK,uq.FileContentResponsesPage=uz,uq.FileBatches=uV;class uJ extends ua{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/assistants",uH,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class uH extends uu{}function uZ(e){return"function"==typeof e.parse}uJ.AssistantsPage=uH;let uY=e=>e?.role==="assistant",uX=e=>e?.role==="function",uQ=e=>e?.role==="tool";var u0=function(e,t,r,n,s){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r},u1=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class u2{constructor(){z.add(this),this.controller=new AbortController,V.set(this,void 0),q.set(this,()=>{}),W.set(this,()=>{}),G.set(this,void 0),J.set(this,()=>{}),H.set(this,()=>{}),Z.set(this,{}),Y.set(this,!1),X.set(this,!1),Q.set(this,!1),ee.set(this,!1),u0(this,V,new Promise((e,t)=>{u0(this,q,e,"f"),u0(this,W,t,"f")}),"f"),u0(this,G,new Promise((e,t)=>{u0(this,J,e,"f"),u0(this,H,t,"f")}),"f"),u1(this,V,"f").catch(()=>{}),u1(this,G,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},u1(this,z,"m",et).bind(this))},0)}_connected(){this.ended||(u1(this,q,"f").call(this),this._emit("connect"))}get ended(){return u1(this,Y,"f")}get errored(){return u1(this,X,"f")}get aborted(){return u1(this,Q,"f")}abort(){this.controller.abort()}on(e,t){return(u1(this,Z,"f")[e]||(u1(this,Z,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=u1(this,Z,"f")[e];if(!r)return this;let n=r.findIndex(e=>e.listener===t);return n>=0&&r.splice(n,1),this}once(e,t){return(u1(this,Z,"f")[e]||(u1(this,Z,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{u0(this,ee,!0,"f"),"error"!==e&&this.once("error",r),this.once(e,t)})}async done(){u0(this,ee,!0,"f"),await u1(this,G,"f")}_emit(e,...t){if(u1(this,Y,"f"))return;"end"===e&&(u0(this,Y,!0,"f"),u1(this,J,"f").call(this));let r=u1(this,Z,"f")[e];if(r&&(u1(this,Z,"f")[e]=r.filter(e=>!e.once),r.forEach(({listener:e})=>e(...t))),"abort"===e){let e=t[0];u1(this,ee,"f")||r?.length||Promise.reject(e),u1(this,W,"f").call(this,e),u1(this,H,"f").call(this,e),this._emit("end");return}if("error"===e){let e=t[0];u1(this,ee,"f")||r?.length||Promise.reject(e),u1(this,W,"f").call(this,e),u1(this,H,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function u5(e){return e?.$brand==="auto-parseable-response-format"}function u3(e){return e?.$brand==="auto-parseable-tool"}function u4(e,t){let r=e.choices.map(e=>{var r,n;if("length"===e.finish_reason)throw new cw;if("content_filter"===e.finish_reason)throw new c_;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>{var r,n;let s;return r=t,n=e,s=r.tools?.find(e=>e.function?.name===n.function.name),{...n,function:{...n.function,parsed_arguments:u3(s)?s.$parseRaw(n.function.arguments):s?.function.strict?JSON.parse(n.function.arguments):null}}})??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?(r=t,n=e.message.content,r.response_format?.type!=="json_schema"?null:r.response_format?.type==="json_schema"?"$parseRaw"in r.response_format?r.response_format.$parseRaw(n):JSON.parse(n):null):null}}});return{...e,choices:r}}function u8(e){return!!u5(e.response_format)||(e.tools?.some(e=>u3(e)||"function"===e.type&&!0===e.function.strict)??!1)}V=new WeakMap,q=new WeakMap,W=new WeakMap,G=new WeakMap,J=new WeakMap,H=new WeakMap,Z=new WeakMap,Y=new WeakMap,X=new WeakMap,Q=new WeakMap,ee=new WeakMap,z=new WeakSet,et=function(e){if(u0(this,X,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new cc),e instanceof cc)return u0(this,Q,!0,"f"),this._emit("abort",e);if(e instanceof co)return this._emit("error",e);if(e instanceof Error){let t=new co(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new co(String(e)))};var u6=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class u7 extends u2{constructor(){super(...arguments),er.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(uX(e)||uQ(e))&&e.content)this._emit("functionCallResult",e.content);else if(uY(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(uY(e)&&e.tool_calls)for(let t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new co("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),u6(this,er,"m",en).call(this)}async finalMessage(){return await this.done(),u6(this,er,"m",es).call(this)}async finalFunctionCall(){return await this.done(),u6(this,er,"m",ei).call(this)}async finalFunctionCallResult(){return await this.done(),u6(this,er,"m",ea).call(this)}async totalUsage(){return await this.done(),u6(this,er,"m",eo).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=u6(this,er,"m",es).call(this);t&&this._emit("finalMessage",t);let r=u6(this,er,"m",en).call(this);r&&this._emit("finalContent",r);let n=u6(this,er,"m",ei).call(this);n&&this._emit("finalFunctionCall",n);let s=u6(this,er,"m",ea).call(this);null!=s&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",u6(this,er,"m",eo).call(this))}async _createChatCompletion(e,t,r){let n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),u6(this,er,"m",el).call(this,t);let s=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(u4(s,t))}async _runChatCompletion(e,t,r){for(let e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){let n="function",{function_call:s="auto",stream:i,...a}=t,o="string"!=typeof s&&s?.name,{maxChatCompletions:l=10}=r||{},c={};for(let e of t.functions)c[e.name||e.function.name]=e;let u=t.functions.map(e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description}));for(let e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){let t,i=await this._createChatCompletion(e,{...a,function_call:s,functions:u,messages:[...this.messages]},r),l=i.choices[0]?.message;if(!l)throw new co("missing message in ChatCompletion response");if(!l.function_call)return;let{name:h,arguments:d}=l.function_call,p=c[h];if(p){if(o&&o!==h){let e=`Invalid function_call: ${JSON.stringify(h)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,name:h,content:e});continue}}else{let e=`Invalid function_call: ${JSON.stringify(h)}. Available options are: ${u.map(e=>JSON.stringify(e.name)).join(", ")}. Please try again`;this._addMessage({role:n,name:h,content:e});continue}try{t=uZ(p)?await p.parse(d):d}catch(e){this._addMessage({role:n,name:h,content:e instanceof Error?e.message:String(e)});continue}let f=await p.function(t,this),m=u6(this,er,"m",ec).call(this,f);if(this._addMessage({role:n,name:h,content:m}),o)return}}async _runTools(e,t,r){let n="tool",{tool_choice:s="auto",stream:i,...a}=t,o="string"!=typeof s&&s?.function?.name,{maxChatCompletions:l=10}=r||{},c=t.tools.map(e=>{if(u3(e)){if(!e.$callback)throw new co("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),u={};for(let e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);let h="tools"in t?c.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(let e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){let t=await this._createChatCompletion(e,{...a,tool_choice:s,tools:h,messages:[...this.messages]},r),i=t.choices[0]?.message;if(!i)throw new co("missing message in ChatCompletion response");if(!i.tool_calls?.length)break;for(let e of i.tool_calls){let t;if("function"!==e.type)continue;let r=e.id,{name:s,arguments:i}=e.function,a=u[s];if(a){if(o&&o!==s){let e=`Invalid tool_call: ${JSON.stringify(s)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,tool_call_id:r,content:e});continue}}else{let e=`Invalid tool_call: ${JSON.stringify(s)}. Available options are: ${Object.keys(u).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:r,content:e});continue}try{t=uZ(a)?await a.parse(i):i}catch(t){let e=t instanceof Error?t.message:String(t);this._addMessage({role:n,tool_call_id:r,content:e});continue}let l=await a.function(t,this),c=u6(this,er,"m",ec).call(this,l);if(this._addMessage({role:n,tool_call_id:r,content:c}),o)return}}}}er=new WeakSet,en=function(){return u6(this,er,"m",es).call(this).content??null},es=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(uY(t)){let{function_call:e,...r}=t,n={...r,content:t.content??null,refusal:t.refusal??null};return e&&(n.function_call=e),n}}throw new co("stream ended without producing a ChatCompletionMessage with role=assistant")},ei=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(uY(t)&&t?.function_call)return t.function_call;if(uY(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},ea=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(uX(t)&&null!=t.content||uQ(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},eo=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},el=function(e){if(null!=e.n&&e.n>1)throw new co("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ec=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class u9 extends u7{static runFunctions(e,t,r){let n=new u9,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(e,t,s)),n}static runTools(e,t,r){let n=new u9,s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,s)),n}_addMessage(e,t=!0){super._addMessage(e,t),uY(e)&&e.content&&this._emit("content",e.content)}}let he=511;class ht extends Error{}class hr extends Error{}let hn=e=>(function(e,t=he){var r,n;let s,i,a,o,l,c,u,h,d,p;if("string"!=typeof e)throw TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw Error(`${e} is empty`);return r=e.trim(),n=t,s=r.length,i=0,a=e=>{throw new ht(`${e} at position ${i}`)},o=e=>{throw new hr(`${e} at position ${i}`)},l=()=>(p(),i>=s&&a("Unexpected end of input"),'"'===r[i])?c():"{"===r[i]?u():"["===r[i]?h():"null"===r.substring(i,i+4)||16&n&&s-i<4&&"null".startsWith(r.substring(i))?(i+=4,null):"true"===r.substring(i,i+4)||32&n&&s-i<4&&"true".startsWith(r.substring(i))?(i+=4,!0):"false"===r.substring(i,i+5)||32&n&&s-i<5&&"false".startsWith(r.substring(i))?(i+=5,!1):"Infinity"===r.substring(i,i+8)||128&n&&s-i<8&&"Infinity".startsWith(r.substring(i))?(i+=8,1/0):"-Infinity"===r.substring(i,i+9)||256&n&&1<s-i&&s-i<9&&"-Infinity".startsWith(r.substring(i))?(i+=9,-1/0):"NaN"===r.substring(i,i+3)||64&n&&s-i<3&&"NaN".startsWith(r.substring(i))?(i+=3,NaN):d(),c=()=>{let e=i,t=!1;for(i++;i<s&&('"'!==r[i]||t&&"\\"===r[i-1]);)t="\\"===r[i]&&!t,i++;if('"'==r.charAt(i))try{return JSON.parse(r.substring(e,++i-Number(t)))}catch(e){o(String(e))}else if(1&n)try{return JSON.parse(r.substring(e,i-Number(t))+'"')}catch(t){return JSON.parse(r.substring(e,r.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},u=()=>{i++,p();let e={};try{for(;"}"!==r[i];){if(p(),i>=s&&8&n)return e;let t=c();p(),i++;try{let r=l();Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}catch(t){if(8&n)return e;throw t}p(),","===r[i]&&i++}}catch(t){if(8&n)return e;a("Expected '}' at end of object")}return i++,e},h=()=>{i++;let e=[];try{for(;"]"!==r[i];)e.push(l()),p(),","===r[i]&&i++}catch(t){if(4&n)return e;a("Expected ']' at end of array")}return i++,e},d=()=>{if(0===i){"-"===r&&2&n&&a("Not sure what '-' is");try{return JSON.parse(r)}catch(e){if(2&n)try{if("."===r[r.length-1])return JSON.parse(r.substring(0,r.lastIndexOf(".")));return JSON.parse(r.substring(0,r.lastIndexOf("e")))}catch(e){}o(String(e))}}let e=i;for("-"===r[i]&&i++;r[i]&&!",]}".includes(r[i]);)i++;i!=s||2&n||a("Unterminated number literal");try{return JSON.parse(r.substring(e,i))}catch(t){"-"===r.substring(e,i)&&2&n&&a("Not sure what '-' is");try{return JSON.parse(r.substring(e,r.lastIndexOf("e")))}catch(e){o(String(e))}}},p=()=>{for(;i<s&&" \n\r	".includes(r[i]);)i++},l()})(e,2^he);var hs=function(e,t,r,n,s){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r},hi=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class ha extends u7{constructor(e){super(),eu.add(this),eh.set(this,void 0),ed.set(this,void 0),ep.set(this,void 0),hs(this,eh,e,"f"),hs(this,ed,[],"f")}get currentChatCompletionSnapshot(){return hi(this,ep,"f")}static fromReadableStream(e){let t=new ha(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let n=new ha(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,r){super._createChatCompletion;let n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),hi(this,eu,"m",ef).call(this);let s=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});for await(let e of(this._connected(),s))hi(this,eu,"m",eg).call(this,e);if(s.controller.signal?.aborted)throw new cc;return this._addChatCompletion(hi(this,eu,"m",ev).call(this))}async _fromReadableStream(e,t){let r,n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),hi(this,eu,"m",ef).call(this),this._connected();let s=cE.fromReadableStream(e,this.controller);for await(let e of s)r&&r!==e.id&&this._addChatCompletion(hi(this,eu,"m",ev).call(this)),hi(this,eu,"m",eg).call(this,e),r=e.id;if(s.controller.signal?.aborted)throw new cc;return this._addChatCompletion(hi(this,eu,"m",ev).call(this))}[(eh=new WeakMap,ed=new WeakMap,ep=new WeakMap,eu=new WeakSet,ef=function(){this.ended||hs(this,ep,void 0,"f")},em=function(e){let t=hi(this,ed,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},hi(this,ed,"f")[e.index]=t),t},eg=function(e){if(this.ended)return;let t=hi(this,eu,"m",e_).call(this,e);for(let r of(this._emit("chunk",e,t),e.choices)){let e=t.choices[r.index];null!=r.delta.content&&e.message?.role==="assistant"&&e.message?.content&&(this._emit("content",r.delta.content,e.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=r.delta.refusal&&e.message?.role==="assistant"&&e.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:e.message.refusal}),r.logprobs?.content!=null&&e.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:e.logprobs?.content??[]}),r.logprobs?.refusal!=null&&e.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});let n=hi(this,eu,"m",em).call(this,e);for(let t of(e.finish_reason&&(hi(this,eu,"m",ey).call(this,e),null!=n.current_tool_call_index&&hi(this,eu,"m",eb).call(this,e,n.current_tool_call_index)),r.delta.tool_calls??[]))n.current_tool_call_index!==t.index&&(hi(this,eu,"m",ey).call(this,e),null!=n.current_tool_call_index&&hi(this,eu,"m",eb).call(this,e,n.current_tool_call_index)),n.current_tool_call_index=t.index;for(let t of r.delta.tool_calls??[]){let r=e.message.tool_calls?.[t.index];r?.type&&(r?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:r.function?.name,index:t.index,arguments:r.function.arguments,parsed_arguments:r.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):hc(r?.type))}}},eb=function(e,t){if(hi(this,eu,"m",em).call(this,e).done_tool_calls.has(t))return;let r=e.message.tool_calls?.[t];if(!r)throw Error("no tool call snapshot");if(!r.type)throw Error("tool call snapshot missing `type`");if("function"===r.type){let e=hi(this,eh,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:t,arguments:r.function.arguments,parsed_arguments:u3(e)?e.$parseRaw(r.function.arguments):e?.function.strict?JSON.parse(r.function.arguments):null})}else hc(r.type)},ey=function(e){let t=hi(this,eu,"m",em).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;let r=hi(this,eu,"m",ew).call(this);this._emit("content.done",{content:e.message.content,parsed:r?r.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},ev=function(){if(this.ended)throw new co("stream has ended, this shouldn't happen");let e=hi(this,ep,"f");if(!e)throw new co("request ended without sending any chunks");return hs(this,ep,void 0,"f"),hs(this,ed,[],"f"),function(e,t){var r;let{id:n,choices:s,created:i,model:a,system_fingerprint:o,...l}=e;return r={...l,id:n,choices:s.map(({message:t,finish_reason:r,index:n,logprobs:s,...i})=>{if(!r)throw new co(`missing finish_reason for choice ${n}`);let{content:a=null,function_call:o,tool_calls:l,...c}=t,u=t.role;if(!u)throw new co(`missing role for choice ${n}`);if(o){let{arguments:e,name:l}=o;if(null==e)throw new co(`missing function_call.arguments for choice ${n}`);if(!l)throw new co(`missing function_call.name for choice ${n}`);return{...i,message:{content:a,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:r,index:n,logprobs:s}}return l?{...i,index:n,finish_reason:r,logprobs:s,message:{...c,role:u,content:a,refusal:t.refusal??null,tool_calls:l.map((t,r)=>{let{function:s,type:i,id:a,...o}=t,{arguments:l,name:c,...u}=s||{};if(null==a)throw new co(`missing choices[${n}].tool_calls[${r}].id
${ho(e)}`);if(null==i)throw new co(`missing choices[${n}].tool_calls[${r}].type
${ho(e)}`);if(null==c)throw new co(`missing choices[${n}].tool_calls[${r}].function.name
${ho(e)}`);if(null==l)throw new co(`missing choices[${n}].tool_calls[${r}].function.arguments
${ho(e)}`);return{...o,id:a,type:i,function:{...u,name:c,arguments:l}}})}}:{...i,message:{...c,content:a,role:u,refusal:t.refusal??null},finish_reason:r,index:n,logprobs:s}}),created:i,model:a,object:"chat.completion",...o?{system_fingerprint:o}:{}},t&&u8(t)?u4(r,t):{...r,choices:r.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(e,hi(this,eh,"f"))},ew=function(){let e=hi(this,eh,"f")?.response_format;return u5(e)?e:null},e_=function(e){var t,r,n,s;let i=hi(this,ep,"f"),{choices:a,...o}=e;for(let{delta:a,finish_reason:l,index:c,logprobs:u=null,...h}of(i?Object.assign(i,o):i=hs(this,ep,{...o,choices:[]},"f"),e.choices)){let e=i.choices[c];if(e||(e=i.choices[c]={finish_reason:l,index:c,message:{},logprobs:u,...h}),u)if(e.logprobs){let{content:n,refusal:s,...i}=u;hl(i),Object.assign(e.logprobs,i),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),s&&((r=e.logprobs).refusal??(r.refusal=[]),e.logprobs.refusal.push(...s))}else e.logprobs=Object.assign({},u);if(l&&(e.finish_reason=l,hi(this,eh,"f")&&u8(hi(this,eh,"f")))){if("length"===l)throw new cw;if("content_filter"===l)throw new c_}if(Object.assign(e,h),!a)continue;let{content:o,refusal:d,function_call:p,role:f,tool_calls:m,...g}=a;if(hl(g),Object.assign(e.message,g),d&&(e.message.refusal=(e.message.refusal||"")+d),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),o&&(e.message.content=(e.message.content||"")+o,!e.message.refusal&&hi(this,eu,"m",ew).call(this)&&(e.message.parsed=hn(e.message.content))),m)for(let{index:t,id:r,type:n,function:i,...a}of(e.message.tool_calls||(e.message.tool_calls=[]),m)){let o=(s=e.message.tool_calls)[t]??(s[t]={});Object.assign(o,a),r&&(o.id=r),n&&(o.type=n),i&&(o.function??(o.function={name:i.name??"",arguments:""})),i?.name&&(o.function.name=i.name),i?.arguments&&(o.function.arguments+=i.arguments,function(e,t){if(!e)return!1;let r=e.tools?.find(e=>e.function?.name===t.function.name);return u3(r)||r?.function.strict||!1}(hi(this,eh,"f"),o)&&(o.function.parsed_arguments=hn(o.function.arguments)))}}return i},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",r=>{let n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(r=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(r=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new cE(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function ho(e){return JSON.stringify(e)}function hl(e){}function hc(e){}class hu extends ha{static fromReadableStream(e){let t=new hu(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let n=new hu(null),s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(e,t,s)),n}static runTools(e,t,r){let n=new hu(t),s={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,s)),n}}class hh extends ua{parse(e,t){for(let t of e.tools??[]){if("function"!==t.type)throw new co(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new co(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}return this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(t=>u4(t,e))}runFunctions(e,t){return e.stream?hu.runFunctions(this._client,e,t):u9.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?hu.runTools(this._client,e,t):u9.runTools(this._client,e,t)}stream(e,t){return ha.createChatCompletion(this._client,e,t)}}class hd extends ua{constructor(){super(...arguments),this.completions=new hh(this._client)}}(hd||(hd={})).Completions=hh;class hp extends ua{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class hf extends ua{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class hm extends ua{constructor(){super(...arguments),this.sessions=new hp(this._client),this.transcriptionSessions=new hf(this._client)}}hm.Sessions=hp,hm.TranscriptionSessions=hf;var hg=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},hb=function(e,t,r,n,s){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r};class hy extends u2{constructor(){super(...arguments),ex.add(this),eO.set(this,[]),ek.set(this,{}),eP.set(this,{}),eE.set(this,void 0),eS.set(this,void 0),eA.set(this,void 0),eC.set(this,void 0),ej.set(this,void 0),eT.set(this,void 0),eN.set(this,void 0),eI.set(this,void 0),eR.set(this,void 0)}[(eO=new WeakMap,ek=new WeakMap,eP=new WeakMap,eE=new WeakMap,eS=new WeakMap,eA=new WeakMap,eC=new WeakMap,ej=new WeakMap,eT=new WeakMap,eN=new WeakMap,eI=new WeakMap,eR=new WeakMap,ex=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",r=>{let n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(r=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(r=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new hy;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let n=cE.fromReadableStream(e,this.controller);for await(let e of n)hg(this,ex,"m",eM).call(this,e);if(n.controller.signal?.aborted)throw new cc;return this._addRun(hg(this,ex,"m",e$).call(this))}toReadableStream(){return new cE(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,n,s){let i=new hy;return i._run(()=>i._runToolAssistantStream(e,t,r,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,n,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...n,stream:!0},o=await e.submitToolOutputs(t,r,a,{...s,signal:this.controller.signal});for await(let e of(this._connected(),o))hg(this,ex,"m",eM).call(this,e);if(o.controller.signal?.aborted)throw new cc;return this._addRun(hg(this,ex,"m",e$).call(this))}static createThreadAssistantStream(e,t,r){let n=new hy;return n._run(()=>n._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,r,n){let s=new hy;return s._run(()=>s._runAssistantStream(e,t,r,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return hg(this,eN,"f")}currentRun(){return hg(this,eI,"f")}currentMessageSnapshot(){return hg(this,eE,"f")}currentRunStepSnapshot(){return hg(this,eR,"f")}async finalRunSteps(){return await this.done(),Object.values(hg(this,ek,"f"))}async finalMessages(){return await this.done(),Object.values(hg(this,eP,"f"))}async finalRun(){if(await this.done(),!hg(this,eS,"f"))throw Error("Final run was not received.");return hg(this,eS,"f")}async _createThreadAssistantStream(e,t,r){let n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));let s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});for await(let e of(this._connected(),i))hg(this,ex,"m",eM).call(this,e);if(i.controller.signal?.aborted)throw new cc;return this._addRun(hg(this,ex,"m",e$).call(this))}async _createAssistantStream(e,t,r,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},a=await e.create(t,i,{...n,signal:this.controller.signal});for await(let e of(this._connected(),a))hg(this,ex,"m",eM).call(this,e);if(a.controller.signal?.aborted)throw new cc;return this._addRun(hg(this,ex,"m",e$).call(this))}static accumulateDelta(e,t){for(let[r,n]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=n;continue}let t=e[r];if(null==t||"index"===r||"type"===r){e[r]=n;continue}if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else if(ui(t)&&ui(n))t=this.accumulateDelta(t,n);else if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(let e of n){if(!ui(e))throw Error(`Expected array delta entry to be an object but got: ${e}`);let r=e.index;if(null==r)throw console.error(e),Error("Expected array delta entry to have an `index` property");if("number"!=typeof r)throw Error(`Expected array delta entry \`index\` property to be a number but got ${r}`);let n=t[r];null==n?t.push(e):t[r]=this.accumulateDelta(n,e)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${n}, accValue: ${t}`);e[r]=t}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,n){return await this._createAssistantStream(t,e,r,n)}async _runToolAssistantStream(e,t,r,n,s){return await this._createToolAssistantStream(r,e,t,n,s)}}eM=function(e){if(!this.ended)switch(hb(this,eN,e,"f"),hg(this,ex,"m",eB).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":hg(this,ex,"m",ez).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":hg(this,ex,"m",eD).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":hg(this,ex,"m",eL).call(this,e);break;case"error":throw Error("Encountered an error event in event processing - errors should be processed earlier")}},e$=function(){if(this.ended)throw new co("stream has ended, this shouldn't happen");if(!hg(this,eS,"f"))throw Error("Final run has not been received");return hg(this,eS,"f")},eL=function(e){let[t,r]=hg(this,ex,"m",eU).call(this,e,hg(this,eE,"f"));for(let e of(hb(this,eE,t,"f"),hg(this,eP,"f")[t.id]=t,r)){let r=t.content[e.index];r?.type=="text"&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let r of e.data.delta.content){if("text"==r.type&&r.text){let e=r.text,n=t.content[r.index];if(n&&"text"==n.type)this._emit("textDelta",e,n.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=hg(this,eA,"f")){if(hg(this,eC,"f"))switch(hg(this,eC,"f").type){case"text":this._emit("textDone",hg(this,eC,"f").text,hg(this,eE,"f"));break;case"image_file":this._emit("imageFileDone",hg(this,eC,"f").image_file,hg(this,eE,"f"))}hb(this,eA,r.index,"f")}hb(this,eC,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==hg(this,eA,"f")){let t=e.data.content[hg(this,eA,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,hg(this,eE,"f"));break;case"text":this._emit("textDone",t.text,hg(this,eE,"f"))}}hg(this,eE,"f")&&this._emit("messageDone",e.data),hb(this,eE,void 0,"f")}},eD=function(e){let t=hg(this,ex,"m",eF).call(this,e);switch(hb(this,eR,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&"tool_calls"==r.step_details.type&&r.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(let e of r.step_details.tool_calls)e.index==hg(this,ej,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(hg(this,eT,"f")&&this._emit("toolCallDone",hg(this,eT,"f")),hb(this,ej,e.index,"f"),hb(this,eT,t.step_details.tool_calls[e.index],"f"),hg(this,eT,"f")&&this._emit("toolCallCreated",hg(this,eT,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":hb(this,eR,void 0,"f"),"tool_calls"==e.data.step_details.type&&hg(this,eT,"f")&&(this._emit("toolCallDone",hg(this,eT,"f")),hb(this,eT,void 0,"f")),this._emit("runStepDone",e.data,t)}},eB=function(e){hg(this,eO,"f").push(e),this._emit("event",e)},eF=function(e){switch(e.event){case"thread.run.step.created":return hg(this,ek,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=hg(this,ek,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let n=hy.accumulateDelta(t,r.delta);hg(this,ek,"f")[e.data.id]=n}return hg(this,ek,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":hg(this,ek,"f")[e.data.id]=e.data}if(hg(this,ek,"f")[e.data.id])return hg(this,ek,"f")[e.data.id];throw Error("No snapshot available")},eU=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(let e of n.delta.content)if(e.index in t.content){let r=t.content[e.index];t.content[e.index]=hg(this,ex,"m",eK).call(this,e,r)}else t.content[e.index]=e,r.push(e);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},eK=function(e,t){return hy.accumulateDelta(t,e)},ez=function(e){switch(hb(this,eI,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":hb(this,eS,e.data,"f"),hg(this,eT,"f")&&(this._emit("toolCallDone",hg(this,eT,"f")),hb(this,eT,void 0,"f"))}};class hv extends ua{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,hw,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class hw extends uu{}hv.MessagesPage=hw;class h_ extends ua{retrieve(e,t,r,n={},s){return cY(n)?this.retrieve(e,t,r,{},n):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t,r={},n){return cY(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,hx,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class hx extends uu{}h_.RunStepsPage=hx;class hO extends ua{constructor(){super(...arguments),this.steps=new h_(this._client)}create(e,t,r){let{include:n,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:n},body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,hk,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){let n=await this.create(e,t,r);return await this.poll(e,n.id,r)}createAndStream(e,t,r){return hy.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...n}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let a=5e3;if(r?.pollIntervalMs)a=r.pollIntervalMs;else{let e=i.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(a=t)}}await c3(a);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return hy.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,n){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,n){let s=await this.submitToolOutputs(e,t,r,n);return await this.poll(e,s.id,n)}submitToolOutputsStream(e,t,r,n){return hy.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,n)}}class hk extends uu{}hO.RunsPage=hk,hO.Steps=h_,hO.RunStepsPage=hx;class hP extends ua{constructor(){super(...arguments),this.runs=new hO(this._client),this.messages=new hv(this._client)}create(e={},t){return cY(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return hy.createThreadAssistantStream(e,this._client.beta.threads,t)}}hP.Runs=hO,hP.RunsPage=hk,hP.Messages=hv,hP.MessagesPage=hw;class hE extends ua{constructor(){super(...arguments),this.realtime=new hm(this._client),this.chat=new hd(this._client),this.assistants=new uJ(this._client),this.threads=new hP(this._client)}}hE.Realtime=hm,hE.Assistants=uJ,hE.AssistantsPage=uH,hE.Threads=hP;class hS extends ua{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/batches",hA,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class hA extends uu{}hS.BatchesPage=hA;class hC extends ua{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,cD({body:t,...r}))}}class hj extends ua{constructor(){super(...arguments),this.parts=new hC(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}function hT(e,t){let r=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:function(e,t){var r,n;let s=(r=e.tools??[],n=t.name,r.find(e=>"function"===e.type&&e.name===n));return{...t,...t,parsed_arguments:s?.$brand==="auto-parseable-tool"?s.$parseRaw(t.arguments):s?.strict?JSON.parse(t.arguments):null}}(t,e)};if("message"===e.type){let r=e.content.map(e=>{var r,n;return"output_text"===e.type?{...e,parsed:(r=t,n=e.text,r.text?.format?.type!=="json_schema"?null:"$parseRaw"in r.text?.format?(r.text?.format).$parseRaw(n):JSON.parse(n))}:e});return{...e,content:r}}return e}),n=Object.assign({},e,{output:r});return Object.getOwnPropertyDescriptor(e,"output_text")||hN(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(let e of n.output)if("message"===e.type){for(let t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed}return null}}),n}function hN(e){let t=[];for(let r of e.output)if("message"===r.type)for(let e of r.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}hj.Parts=hC;class hI extends ua{list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,hD,{query:t,...r})}}var hR=function(e,t,r,n,s){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?s.call(e,r):s?s.value=r:t.set(e,r),r},hM=function(e,t,r,n){if("a"===r&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class h$ extends u2{constructor(e){super(),eV.add(this),eq.set(this,void 0),eW.set(this,void 0),eG.set(this,void 0),hR(this,eq,e,"f")}static createResponse(e,t,r){let n=new h$(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,r){let n,s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),hM(this,eV,"m",eJ).call(this);let i=null;for await(let s of("response_id"in t?(n=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):n=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected(),n))hM(this,eV,"m",eH).call(this,s,i);if(n.controller.signal?.aborted)throw new cc;return hM(this,eV,"m",eZ).call(this)}[(eq=new WeakMap,eW=new WeakMap,eG=new WeakMap,eV=new WeakSet,eJ=function(){this.ended||hR(this,eW,void 0,"f")},eH=function(e,t){if(this.ended)return;let r=(e,r)=>{(null==t||r.sequence_number>t)&&this._emit(e,r)},n=hM(this,eV,"m",eY).call(this,e);switch(r("event",e),e.type){case"response.output_text.delta":{let t=n.output[e.output_index];if(!t)throw new co(`missing output at index ${e.output_index}`);if("message"===t.type){let n=t.content[e.content_index];if(!n)throw new co(`missing content at index ${e.content_index}`);if("output_text"!==n.type)throw new co(`expected content to be 'output_text', got ${n.type}`);r("response.output_text.delta",{...e,snapshot:n.text})}break}case"response.function_call_arguments.delta":{let t=n.output[e.output_index];if(!t)throw new co(`missing output at index ${e.output_index}`);"function_call"===t.type&&r("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:r(e.type,e)}},eZ=function(){if(this.ended)throw new co("stream has ended, this shouldn't happen");let e=hM(this,eW,"f");if(!e)throw new co("request ended without sending any events");hR(this,eW,void 0,"f");let t=function(e,t){var r;return t&&(r=t,u5(r.text?.format))?hT(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,hM(this,eq,"f"));return hR(this,eG,t,"f"),t},eY=function(e){let t=hM(this,eW,"f");if(!t){if("response.created"!==e.type)throw new co(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return hR(this,eW,e.response,"f")}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{let r=t.output[e.output_index];if(!r)throw new co(`missing output at index ${e.output_index}`);"message"===r.type&&r.content.push(e.part);break}case"response.output_text.delta":{let r=t.output[e.output_index];if(!r)throw new co(`missing output at index ${e.output_index}`);if("message"===r.type){let t=r.content[e.content_index];if(!t)throw new co(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new co(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{let r=t.output[e.output_index];if(!r)throw new co(`missing output at index ${e.output_index}`);"function_call"===r.type&&(r.arguments+=e.delta);break}case"response.completed":hR(this,eW,e.response,"f")}return t},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",r=>{let n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(r=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(r=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=hM(this,eG,"f");if(!e)throw new co("stream ended without producing a ChatCompletion");return e}}class hL extends ua{constructor(){super(...arguments),this.inputItems=new hI(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&hN(e),e))}retrieve(e,t={},r){return this._client.get(`/responses/${e}`,{query:t,...r,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>hT(t,e))}stream(e,t){return h$.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class hD extends uu{}hL.InputItems=hI;class hB extends ua{retrieve(e,t,r,n){return this._client.get(`/evals/${e}/runs/${t}/output_items/${r}`,n)}list(e,t,r={},n){return cY(r)?this.list(e,t,{},r):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,hF,{query:r,...n})}}class hF extends uu{}hB.OutputItemListResponsesPage=hF;class hU extends ua{constructor(){super(...arguments),this.outputItems=new hB(this._client)}create(e,t,r){return this._client.post(`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){return this._client.get(`/evals/${e}/runs/${t}`,r)}list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,hK,{query:t,...r})}del(e,t,r){return this._client.delete(`/evals/${e}/runs/${t}`,r)}cancel(e,t,r){return this._client.post(`/evals/${e}/runs/${t}`,r)}}class hK extends uu{}hU.RunListResponsesPage=hK,hU.OutputItems=hB,hU.OutputItemListResponsesPage=hF;class hz extends ua{constructor(){super(...arguments),this.runs=new hU(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,r){return this._client.post(`/evals/${e}`,{body:t,...r})}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/evals",hV,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class hV extends uu{}hz.EvalListResponsesPage=hV,hz.Runs=hU,hz.RunListResponsesPage=hK;class hq extends ua{retrieve(e,t,r){return this._client.get(`/containers/${e}/files/${t}/content`,{...r,headers:{Accept:"application/binary",...r?.headers},__binaryResponse:!0})}}class hW extends ua{constructor(){super(...arguments),this.content=new hq(this._client)}create(e,t,r){return this._client.post(`/containers/${e}/files`,cD({body:t,...r}))}retrieve(e,t,r){return this._client.get(`/containers/${e}/files/${t}`,r)}list(e,t={},r){return cY(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,hG,{query:t,...r})}del(e,t,r){return this._client.delete(`/containers/${e}/files/${t}`,{...r,headers:{Accept:"*/*",...r?.headers}})}}class hG extends uu{}hW.FileListResponsesPage=hG,hW.Content=hq;class hJ extends ua{constructor(){super(...arguments),this.files=new hW(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return cY(e)?this.list({},e):this._client.getAPIList("/containers",hH,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class hH extends uu{}hJ.ContainerListResponsesPage=hH,hJ.Files=hW,hJ.FileListResponsesPage=hG;class hZ extends cW{constructor({baseURL:e=c6("OPENAI_BASE_URL"),apiKey:t=c6("OPENAI_API_KEY"),organization:r=c6("OPENAI_ORG_ID")??null,project:n=c6("OPENAI_PROJECT_ID")??null,...s}={}){if(void 0===t)throw new co("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,project:n,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&"u">typeof window&&void 0!==window.document&&"u">typeof navigator)throw new co("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new uo(this),this.chat=new uf(this),this.embeddings=new um(this),this.files=new ug(this),this.images=new uy(this),this.audio=new ux(this),this.moderations=new uO(this),this.models=new uk(this),this.fineTuning=new uL(this),this.graders=new uB(this),this.vectorStores=new uq(this),this.beta=new hE(this),this.batches=new hS(this),this.uploads=new hj(this),this.responses=new hL(this),this.evals=new hz(this),this.containers=new hJ(this),this._options=i,this.apiKey=t,this.organization=r,this.project=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let r,n=e,s=function(e=ce){let t;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw TypeError("Encoder has to be a function.");let r=e.charset||ce.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=lQ;if(void 0!==e.format){if(!l3.call(l0,e.format))throw TypeError("Unknown format option provided.");n=e.format}let s=l0[n],i=ce.filter;if(("function"==typeof e.filter||l8(e.filter))&&(i=e.filter),t=e.arrayFormat&&e.arrayFormat in l4?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":ce.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw TypeError("`commaRoundTrip` must be a boolean, or absent");let a=void 0===e.allowDots?!0==!!e.encodeDotInKeys||ce.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:ce.addQueryPrefix,allowDots:a,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:ce.allowEmptyArrays,arrayFormat:t,charset:r,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:ce.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?ce.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:ce.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:ce.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:ce.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:ce.encodeValuesOnly,filter:i,format:n,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:ce.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:ce.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:ce.strictNullHandling}}(t);"function"==typeof s.filter?n=(0,s.filter)("",n):l8(s.filter)&&(r=s.filter);let i=[];if("object"!=typeof n||null===n)return"";let a=l4[s.arrayFormat],o="comma"===a&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);let l=new WeakMap;for(let e=0;e<r.length;++e){let t=r[e];s.skipNulls&&null===n[t]||l7(i,function e(t,r,n,s,i,a,o,l,c,u,h,d,p,f,m,g,b,y){var v,w;let _,x=t,O=y,k=0,P=!1;for(;void 0!==(O=O.get(ct))&&!P;){let e=O.get(t);if(k+=1,void 0!==e)if(e===k)throw RangeError("Cyclic object value");else P=!0;void 0===O.get(ct)&&(k=0)}if("function"==typeof u?x=u(r,x):x instanceof Date?x=p?.(x):"comma"===n&&l8(x)&&(x=l5(x,function(e){return e instanceof Date?p?.(e):e})),null===x){if(a)return c&&!g?c(r,ce.encoder,b,"key",f):r;x=""}if("string"==typeof(v=x)||"number"==typeof v||"boolean"==typeof v||"symbol"==typeof v||"bigint"==typeof v||(w=x)&&"object"==typeof w&&w.constructor&&w.constructor.isBuffer&&w.constructor.isBuffer(w)){if(c){let e=g?r:c(r,ce.encoder,b,"key",f);return[m?.(e)+"="+m?.(c(x,ce.encoder,b,"value",f))]}return[m?.(r)+"="+m?.(String(x))]}let E=[];if(void 0===x)return E;if("comma"===n&&l8(x))g&&c&&(x=l5(x,c)),_=[{value:x.length>0?x.join(",")||null:void 0}];else if(l8(u))_=u;else{let e=Object.keys(x);_=h?e.sort(h):e}let S=l?String(r).replace(/\./g,"%2E"):String(r),A=s&&l8(x)&&1===x.length?S+"[]":S;if(i&&l8(x)&&0===x.length)return A+"[]";for(let r=0;r<_.length;++r){let v=_[r],w="object"==typeof v&&void 0!==v.value?v.value:x[v];if(o&&null===w)continue;let O=d&&l?v.replace(/\./g,"%2E"):v,P=l8(x)?"function"==typeof n?n(A,O):A:A+(d?"."+O:"["+O+"]");y.set(t,k);let S=new WeakMap;S.set(ct,y),l7(E,e(w,P,n,s,i,a,o,l,"comma"===n&&g&&l8(x)?null:c,u,h,d,p,f,m,g,b,S))}return E}(n[t],t,a,o,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,l))}let c=i.join(s.delimiter),u=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?u+="utf8=%26%2310003%3B&":u+="utf8=%E2%9C%93&"),c.length>0?u+c:""}(e,{arrayFormat:"brackets"})}}hZ.OpenAI=hZ,hZ.DEFAULT_TIMEOUT=6e5,hZ.OpenAIError=co,hZ.APIError=cl,hZ.APIConnectionError=cu,hZ.APIConnectionTimeoutError=ch,hZ.APIUserAbortError=cc,hZ.NotFoundError=cm,hZ.ConflictError=cg,hZ.RateLimitError=cy,hZ.BadRequestError=cd,hZ.AuthenticationError=cp,hZ.InternalServerError=cv,hZ.PermissionDeniedError=cf,hZ.UnprocessableEntityError=cb,hZ.toFile=cI,hZ.fileFromPath=h,hZ.Completions=uo,hZ.Chat=uf,hZ.ChatCompletionsPage=ud,hZ.Embeddings=um,hZ.Files=ug,hZ.FileObjectsPage=ub,hZ.Images=uy,hZ.Audio=ux,hZ.Moderations=uO,hZ.Models=uk,hZ.ModelsPage=uP,hZ.FineTuning=uL,hZ.Graders=uB,hZ.VectorStores=uq,hZ.VectorStoresPage=uW,hZ.VectorStoreSearchResponsesPage=uG,hZ.Beta=hE,hZ.Batches=hS,hZ.BatchesPage=hA,hZ.Uploads=hj,hZ.Responses=hL,hZ.Evals=hz,hZ.EvalListResponsesPage=hV,hZ.Containers=hJ,hZ.ContainerListResponsesPage=hH;var tm=tm,r3=tJ;function hY(e,t){let r;if(void 0===e.function)return;if(t?.partial)try{r=(0,n_.parsePartialJson)(e.function.arguments??"{}")}catch(e){return}else try{r=JSON.parse(e.function.arguments)}catch(t){throw new na([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"\nare not valid JSON.",`Error: ${t.message}`].join("\n"))}let n={name:e.function.name,args:r,type:"tool_call"};return t?.returnId&&(n.id=e.id),n}function hX(e){if(void 0===e.id)throw Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}class hQ extends nc{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw Error("Not supported.")}async parse(){throw Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let r,n=e[0].message;if((0,to.isAIMessage)(n)&&n.tool_calls?.length?r=n.tool_calls.map(e=>{let{id:t,...r}=e;return this.returnId?{id:t,...r}:r}):void 0!==n.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(e=>hY(e,{returnId:this.returnId,partial:t}))),!r)return[];let s=[];for(let e of r)if(void 0!==e){let t={type:e.name,args:e.args,id:e.id};s.push(t)}return s}}class h0 extends hQ{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let t=await (0,t4.interopSafeParseAsync)(this.zodSchema,e);if(t.success)return t.data;throw new na(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName),r=t;if(t.length)return(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?r[0]:r}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName),r=t;return t.length?(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?this._validateResult(r[0]):await Promise.all(r.map(e=>this._validateResult(e))):void 0}}var h1=e.i(65638);function h2(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function h5(e,t,r,n,s){e[t]=r,h2(e,t,n,s)}let h3=/^[cC][^\s-]{8,}$/,h4=/^[0-9a-z]+$/,h8=/^[0-9A-HJKMNP-TV-Z]{26}$/,h6=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,h7=()=>(void 0===r&&(r=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),r),h9=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,de=/^[a-zA-Z0-9_-]{21}$/;function dt(e,t){let r={type:"string"};function n(e){return"escape"===t.patternStrategy?dr(e):e}if(e.checks)for(let s of e.checks)switch(s.kind){case"min":h5(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,s.value):s.value,s.message,t);break;case"max":h5(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,s.value):s.value,s.message,t);break;case"email":switch(t.emailStrategy){case"format:email":dn(r,"email",s.message,t);break;case"format:idn-email":dn(r,"idn-email",s.message,t);break;case"pattern:zod":ds(r,h6,s.message,t)}break;case"url":dn(r,"uri",s.message,t);break;case"uuid":dn(r,"uuid",s.message,t);break;case"regex":ds(r,s.regex,s.message,t);break;case"cuid":ds(r,h3,s.message,t);break;case"cuid2":ds(r,h4,s.message,t);break;case"startsWith":ds(r,RegExp(`^${n(s.value)}`),s.message,t);break;case"endsWith":ds(r,RegExp(`${n(s.value)}$`),s.message,t);break;case"datetime":dn(r,"date-time",s.message,t);break;case"date":dn(r,"date",s.message,t);break;case"time":dn(r,"time",s.message,t);break;case"duration":dn(r,"duration",s.message,t);break;case"length":h5(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,s.value):s.value,s.message,t),h5(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,s.value):s.value,s.message,t);break;case"includes":ds(r,RegExp(n(s.value)),s.message,t);break;case"ip":"v6"!==s.version&&dn(r,"ipv4",s.message,t),"v4"!==s.version&&dn(r,"ipv6",s.message,t);break;case"emoji":ds(r,h7,s.message,t);break;case"ulid":ds(r,h8,s.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":dn(r,"binary",s.message,t);break;case"contentEncoding:base64":h5(r,"contentEncoding","base64",s.message,t);break;case"pattern:zod":ds(r,h9,s.message,t)}break;case"nanoid":ds(r,de,s.message,t)}return r}let dr=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),dn=(e,t,r,n)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):h5(e,"format",t,r,n)},ds=(e,t,r,n)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:di(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):h5(e,"pattern",di(t,n),r,n)},di=(e,t)=>{let r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;let n={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},s=n.i?r.source.toLowerCase():r.source,i="",a=!1,o=!1,l=!1;for(let e=0;e<s.length;e++){if(a){i+=s[e],a=!1;continue}if(n.i){if(o){if(s[e].match(/[a-z]/)){l?(i+=s[e],i+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(i+=s[e],l=!0):i+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){i+=`[${s[e]}${s[e].toUpperCase()}]`;continue}}if(n.m){if("^"===s[e]){i+=`(^|(?<=[\r
]))`;continue}else if("$"===s[e]){i+=`($|(?=[\r
]))`;continue}}if(n.s&&"."===s[e]){i+=o?`${s[e]}\r
`:`[${s[e]}\r
]`;continue}i+=s[e],"\\"===s[e]?a=!0:o&&"]"===s[e]?o=!1:o||"["!==s[e]||(o=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return i};function da(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===h1.ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,n)=>({...r,[n]:dd(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??{}}),{}),additionalProperties:!1};let r={type:"object",additionalProperties:dd(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===h1.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.checks?.length){let n=Object.entries(dt(e.keyType._def,t)).reduce((e,[t,r])=>"type"===t?e:{...e,[t]:r},{});return{...r,propertyNames:n}}return e.keyType?._def.typeName===h1.ZodFirstPartyTypeKind.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}let dl={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},dc=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>dd(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0},du=Symbol("Let zodToJsonSchema decide on which parser to use"),dh={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function dd(e,t,r=!1){let n=t.seen.get(e);if(t.override){let s=t.override?.(e,t,n,r);if(s!==du)return s}if(n&&!r){let e=dp(n,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}let s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);let i=dm(e,e.typeName,t,r);return i&&dg(e,t,i),s.jsonSchema=i,i}let dp=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let r=e.path.slice(t.basePath.length+1).join("_");return r!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[r]=e.def),{$ref:[...t.basePath,t.definitionPath,r].join("/")};case"relative":return{$ref:df(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},df=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},dm=(e,t,r,n)=>{switch(t){case h1.ZodFirstPartyTypeKind.ZodString:return dt(e,r);case h1.ZodFirstPartyTypeKind.ZodNumber:let s={type:"number"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"int":s.type="integer",h2(s,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?h5(s,"minimum",t.value,t.message,r):h5(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),h5(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?h5(s,"maximum",t.value,t.message,r):h5(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),h5(s,"maximum",t.value,t.message,r));break;case"multipleOf":h5(s,"multipleOf",t.value,t.message,r)}return s;case h1.ZodFirstPartyTypeKind.ZodObject:let i;return(i={type:"object",...Object.entries(e.shape()).reduce((e,[t,n])=>{if(void 0===n||void 0===n._def)return e;let s=[...r.currentPath,"properties",t],i=dd(n._def,{...r,currentPath:s,propertyPath:s});return void 0===i?e:(r.openaiStrictMode&&n.isOptional()&&!n.isNullable()&&console.warn(`Zod field at \`${s.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...e.properties,[t]:i},required:n.isOptional()&&!r.openaiStrictMode?e.required:[...e.required,t]})},{properties:{},required:[]}),additionalProperties:"strict"===r.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:dd(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:dd(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0}).required.length||delete i.required,i;case h1.ZodFirstPartyTypeKind.ZodBigInt:let a={type:"integer",format:"int64"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?h5(a,"minimum",t.value,t.message,r):h5(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),h5(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?h5(a,"maximum",t.value,t.message,r):h5(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),h5(a,"maximum",t.value,t.message,r));break;case"multipleOf":h5(a,"multipleOf",t.value,t.message,r)}return a;case h1.ZodFirstPartyTypeKind.ZodBoolean:return{type:"boolean"};case h1.ZodFirstPartyTypeKind.ZodDate:return function e(t,r,n){let s=n??r.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((n,s)=>e(t,r,n))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var i=t,a=r;let o={type:"integer",format:"unix-time"};if("openApi3"===a.target)return o;for(let e of i.checks)switch(e.kind){case"min":h5(o,"minimum",e.value,e.message,a);break;case"max":h5(o,"maximum",e.value,e.message,a)}return o}}(e,r);case h1.ZodFirstPartyTypeKind.ZodUndefined:return{not:{}};case h1.ZodFirstPartyTypeKind.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case h1.ZodFirstPartyTypeKind.ZodArray:let o;return o={type:"array"},e.type?._def?.typeName!==h1.ZodFirstPartyTypeKind.ZodAny&&(o.items=dd(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&h5(o,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&h5(o,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(h5(o,"minItems",e.exactLength.value,e.exactLength.message,r),h5(o,"maxItems",e.exactLength.value,e.exactLength.message,r)),o;case h1.ZodFirstPartyTypeKind.ZodUnion:case h1.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:if("openApi3"===r.target)return dc(e,r);let l=e.options instanceof Map?Array.from(e.options.values()):e.options;if(l.every(e=>e._def.typeName in dl&&(!e._def.checks||!e._def.checks.length))){let e=l.reduce((e,t)=>{let r=dl[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(l.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=l.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===l.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:l.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(l.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:l.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return dc(e,r);case h1.ZodFirstPartyTypeKind.ZodIntersection:let c,u,h;return c=[dd(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),dd(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),u="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,h=[],c.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)h.push(...e.allOf),void 0===e.unevaluatedProperties&&(u=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...n}=e;t=n}else u=void 0;h.push(t)}}),h.length?{allOf:h,...u}:void 0;case h1.ZodFirstPartyTypeKind.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>dd(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:dd(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>dd(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case h1.ZodFirstPartyTypeKind.ZodRecord:return da(e,r);case h1.ZodFirstPartyTypeKind.ZodLiteral:let d;return"bigint"!=(d=typeof e.value)&&"number"!==d&&"boolean"!==d&&"string"!==d?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===d?"integer":d,enum:[e.value]}:{type:"bigint"===d?"integer":d,const:e.value};case h1.ZodFirstPartyTypeKind.ZodEnum:return{type:"string",enum:[...e.values]};case h1.ZodFirstPartyTypeKind.ZodNativeEnum:let p,f,m;return p=e.values,{type:1===(m=Array.from(new Set((f=Object.keys(e.values).filter(e=>"number"!=typeof p[p[e]]).map(e=>p[e])).map(e=>typeof e)))).length?"string"===m[0]?"string":"number":["string","number"],enum:f};case h1.ZodFirstPartyTypeKind.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target||"property"===r.nullableStrategy?{type:dl[e.innerType._def.typeName],nullable:!0}:{type:[dl[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=dd(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=dd(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case h1.ZodFirstPartyTypeKind.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return dd(e.innerType._def,r);let b=dd(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return b?{anyOf:[{not:{}},b]}:{};case h1.ZodFirstPartyTypeKind.ZodMap:if("record"===r.mapStrategy)return da(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[dd(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},dd(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case h1.ZodFirstPartyTypeKind.ZodSet:let y;return y={type:"array",uniqueItems:!0,items:dd(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})},e.minSize&&h5(y,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&h5(y,"maxItems",e.maxSize.value,e.maxSize.message,r),y;case h1.ZodFirstPartyTypeKind.ZodLazy:return dd(e.getter()._def,r);case h1.ZodFirstPartyTypeKind.ZodPromise:return dd(e.type._def,r);case h1.ZodFirstPartyTypeKind.ZodNaN:case h1.ZodFirstPartyTypeKind.ZodNever:return{not:{}};case h1.ZodFirstPartyTypeKind.ZodEffects:return"input"===r.effectStrategy?dd(e.schema._def,r,n):{};case h1.ZodFirstPartyTypeKind.ZodAny:case h1.ZodFirstPartyTypeKind.ZodUnknown:return{};case h1.ZodFirstPartyTypeKind.ZodDefault:return{...dd(e.innerType._def,r),default:e.defaultValue()};case h1.ZodFirstPartyTypeKind.ZodBranded:return dd(e.type._def,r);case h1.ZodFirstPartyTypeKind.ZodReadonly:case h1.ZodFirstPartyTypeKind.ZodCatch:return dd(e.innerType._def,r);case h1.ZodFirstPartyTypeKind.ZodPipeline:if("input"===r.pipeStrategy)return dd(e.in._def,r);if("output"===r.pipeStrategy)return dd(e.out._def,r);let v=dd(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),w=dd(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",v?"1":"0"]});return{allOf:[v,w].filter(e=>void 0!==e)};case h1.ZodFirstPartyTypeKind.ZodFunction:case h1.ZodFirstPartyTypeKind.ZodVoid:case h1.ZodFirstPartyTypeKind.ZodSymbol:default:return}},dg=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),db=e=>"_def"in e?e._def:e;function dy(e,t){return((e,t)=>{let r,n,s=(n=void 0!==(r="string"==typeof t?{...dh,basePath:["#"],definitions:{},name:t}:{...dh,basePath:["#"],definitions:{},...t}).name?[...r.basePath,r.definitionPath,r.name]:r.basePath,{...r,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(r.definitions).map(([e,t])=>[db(t),{def:db(t),path:[...r.basePath,r.definitionPath,e],jsonSchema:void 0}]))}),i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,a=dd(e._def,void 0===i?s:{...s,currentPath:[...s.basePath,s.definitionPath,i]},!1)??{},o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(a.title=o);let l=(()=>{if(function(e){if(!e)return!0;for(let t in e)return!1;return!0}(s.definitions))return;let e={},t=new Set;for(let r=0;r<500;r++){let r=Object.entries(s.definitions).filter(([e])=>!t.has(e));if(0===r.length)break;for(let[n,i]of r)e[n]=dd(db(i),{...s,currentPath:[...s.basePath,s.definitionPath,n]},!0)??{},t.add(n)}return e})(),c=void 0===i?l?{...a,[s.definitionPath]:l}:a:"duplicate-ref"===s.nameStrategy?{...a,...l||s.seenRefs.size?{[s.definitionPath]:{...l,...s.seenRefs.size?{[i]:a}:void 0}}:void 0}:{$ref:[..."relative"===s.$refStrategy?[]:s.basePath,s.definitionPath,i].join("/"),[s.definitionPath]:{...l,[i]:a}};return"jsonSchema7"===s.target?c.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===s.target&&(c.$schema="https://json-schema.org/draft/2019-09/schema#"),c})(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function dv(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function dw(e){let t;return e.constructor.name===ch.name?(t=Error(e.message)).name="TimeoutError":e.constructor.name===cc.name?(t=Error(e.message)).name="AbortError":t=400===e.status&&e.message.includes("tool_calls")?dv(e,"INVALID_TOOL_RESULTS"):401===e.status?dv(e,"MODEL_AUTHENTICATION"):429===e.status?dv(e,"MODEL_RATE_LIMIT"):404===e.status?dv(e,"MODEL_NOT_FOUND"):e,t}function d_(e,t){let r=[];for(let[n,s]of Object.entries(e.properties??{}))s.description&&t<2&&r.push(`// ${s.description}`),e.required?.includes(n)?r.push(`${n}: ${dx(s,t)},`):r.push(`${n}?: ${dx(s,t)},`);return r.map(e=>" ".repeat(t)+e).join("\n")}function dx(e,t){if(void 0!==e.anyOf&&Array.isArray(e.anyOf))return e.anyOf.map(e=>dx(e,t)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",d_(e,t+2),"}"].join("\n");case"array":if(e.items)return`${dx(e.items,t)}[]`;return"any[]";default:return""}}function dO(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!tc.ChatMessage.isInstance(e))throw Error("Invalid generic chat message");return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role;default:throw Error(`Unknown message type: ${t}`)}}function dk(e,t){return e.flatMap(e=>{let r=dO(e);"system"===r&&t?.startsWith("o1")&&(r="developer");let n={role:r,content:e.content};return(null!=e.name&&(n.name=e.name),null!=e.additional_kwargs.function_call&&(n.function_call=e.additional_kwargs.function_call,n.content=null),(0,to.isAIMessage)(e)&&e.tool_calls?.length?(n.tool_calls=e.tool_calls.map(hX),n.content=null):(null!=e.additional_kwargs.tool_calls&&(n.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(n.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio)?[n,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:n})}function dP(e,t){var r;let n;if(tY(e))return t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e;if(re(e)){let s=function(e,{parser:t,callback:r}){let n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:r,enumerable:!1}}),n}({type:"function",function:{name:(r={name:e.name,parameters:e.schema,description:e.description}).name,parameters:dy(r.parameters,{name:r.name}),strict:!0,...r.description?{description:r.description}:void 0}},{callback:r.function,parser:e=>r.parameters.parse(JSON.parse(e))});n=s.function.parameters?{type:s.type,function:{name:s.function.name,description:s.function.description,parameters:s.function.parameters,...t?.strict!==void 0?{strict:t.strict}:{}}}:{type:"function",function:r9(e,t)}}else n=e;return t?.strict!==void 0&&(n.function.strict=t.strict),n}class dE extends rZ{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??(0,rK.getEnvironmentVariable)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,rK.getEnvironmentVariable)("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,rK.getEnvironmentVariable)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??(0,rK.getEnvironmentVariable)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,rK.getEnvironmentVariable)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,rK.getEnvironmentVariable)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,rK.getEnvironmentVariable)("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??(0,rK.getEnvironmentVariable)("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){const e=this.azureOpenAIBasePath.split("/openai/deployments/");if(2===e.length){const[,t]=e;this.azureOpenAIApiDeploymentName=t}}if(!this.azureOpenAIApiDeploymentName)throw Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}"o1"===this.model&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return t?.strict!==void 0?r=t.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(e=>dP(e,{strict:r})),...t})}createResponseFormat(e){if(e&&"json_schema"===e.type&&e.json_schema.schema&&dS(e.json_schema.schema)){var t,r,n,s;let i;return t=e.json_schema.schema,r=e.json_schema.name,n={type:"json_schema",json_schema:{...{description:e.json_schema.description},name:r,strict:!0,schema:dy(t,{name:r})}},s=e=>t.parse(JSON.parse(e)),Object.defineProperties(i={...n},{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:s,enumerable:!1}}),i}return e}invocationParams(e,t){let r;e?.strict!==void 0?r=e.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling);let n={};e?.stream_options!==void 0?n={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(n={stream_options:{include_usage:!0}});let s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>dP(e,{strict:r})):void 0,tool_choice:function(e){if(e){if("any"===e||"required"===e)return"required";if("auto"===e)return"auto";if("none"===e)return"none";else if("string"==typeof e)return{type:"function",function:{name:e}};else return e}}(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...n,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(s.prediction=e.prediction);let i=e?.reasoning_effort??this.reasoningEffort;return void 0!==i&&(s.reasoning_effort=i),s}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,t,r){let n,s,i=dk(e,this.model),a={...this.invocationParams(t,{streaming:!0}),messages:i,stream:!0};for await(let e of(await this.completionWithRetry(a,t))){let i=e?.choices?.[0];if(e.usage&&(s=e.usage),!i)continue;let{delta:a}=i;if(!a)continue;let o=function(e,t,r,n){let s,i=e.role??r,a=e.content??"";s=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},n&&(s.__raw_response=t),e.audio&&(s.audio={...e.audio,index:t.choices[0].index});let o={usage:{...t.usage}};if("user"===i)return new ti.HumanMessageChunk({content:a,response_metadata:o});if("assistant"===i){let r=[];if(Array.isArray(e.tool_calls))for(let t of e.tool_calls)r.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new to.AIMessageChunk({content:a,tool_call_chunks:r,additional_kwargs:s,id:t.id,response_metadata:o})}if("system"===i)return new ta.SystemMessageChunk({content:a,response_metadata:o});if("developer"===i)return new ta.SystemMessageChunk({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}});if("function"===i)return new tu.FunctionMessageChunk({content:a,additional_kwargs:s,name:e.name,response_metadata:o});else if("tool"===i)return new tm.ToolMessageChunk({content:a,additional_kwargs:s,tool_call_id:e.tool_call_id,response_metadata:o});else return new tc.ChatMessageChunk({content:a,role:i,response_metadata:o})}(a,e,n,this.__includeRawResponse);n=a.role??n;let l={prompt:t.promptIndex??0,completion:i.index??0};if("string"!=typeof o.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let c={...l};null!=i.finish_reason&&(c.finish_reason=i.finish_reason,c.system_fingerprint=e.system_fingerprint,c.model_name=e.model),this.logprobs&&(c.logprobs=i.logprobs);let u=new rz.ChatGenerationChunk({message:o,text:o.content,generationInfo:c});yield u,await r?.handleLLMNewToken(u.text??"",l,void 0,void 0,void 0,{chunk:u})}if(s){let e={...s.prompt_tokens_details?.audio_tokens!==null&&{audio:s.prompt_tokens_details?.audio_tokens},...s.prompt_tokens_details?.cached_tokens!==null&&{cache_read:s.prompt_tokens_details?.cached_tokens}},t={...s.completion_tokens_details?.audio_tokens!==null&&{audio:s.completion_tokens_details?.audio_tokens},...s.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:s.completion_tokens_details?.reasoning_tokens}},r=new rz.ChatGenerationChunk({message:new to.AIMessageChunk({content:"",response_metadata:{usage:{...s}},usage_metadata:{input_tokens:s.prompt_tokens,output_tokens:s.completion_tokens,total_tokens:s.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield r}if(t.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n={},s=this.invocationParams(t),i=dk(e,this.model);if(s.stream){let s=this._streamResponseChunks(e,t,r),i={};for await(let e of s){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};let t=e.generationInfo?.completion??0;void 0===i[t]?i[t]=e:i[t]=i[t].concat(e)}let a=Object.entries(i).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:l}=this.invocationParams(t),c=await this.getEstimatedTokenCountFromPrompt(e,o,l),u=await this.getNumTokensFromGenerations(a);return n.input_tokens=c,n.output_tokens=u,n.total_tokens=c+u,{generations:a,llmOutput:{estimatedTokenUsage:{promptTokens:n.input_tokens,completionTokens:n.output_tokens,totalTokens:n.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t?.signal,...t?.options});let{completion_tokens:r,prompt_tokens:a,total_tokens:o,prompt_tokens_details:l,completion_tokens_details:c}=e?.usage??{};r&&(n.output_tokens=(n.output_tokens??0)+r),a&&(n.input_tokens=(n.input_tokens??0)+a),o&&(n.total_tokens=(n.total_tokens??0)+o),(l?.audio_tokens!==null||l?.cached_tokens!==null)&&(n.input_token_details={...l?.audio_tokens!==null&&{audio:l?.audio_tokens},...l?.cached_tokens!==null&&{cache_read:l?.cached_tokens}}),(c?.audio_tokens!==null||c?.reasoning_tokens!==null)&&(n.output_token_details={...c?.audio_tokens!==null&&{audio:c?.audio_tokens},...c?.reasoning_tokens!==null&&{reasoning:c?.reasoning_tokens}});let u=[];for(let t of e?.choices??[]){let r={text:t.message?.content??"",message:function(e,t,r){let n=e.tool_calls;if("assistant"!==e.role)return new tc.ChatMessage(e.content||"",e.role??"unknown");{let i=[],a=[];for(let e of n??[])try{i.push(hY(e,{returnId:!0}))}catch(t){var s;a.push((s=t.message,{name:e.function?.name,args:e.function?.arguments,id:e.id,error:s,type:"invalid_tool_call"}))}let o={function_call:e.function_call,tool_calls:n};void 0!==r&&(o.__raw_response=t);let l={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(o.audio=e.audio),new to.AIMessage({content:e.content||"",tool_calls:i,invalid_tool_calls:a,additional_kwargs:o,response_metadata:l,id:t.id})}}(t.message??{role:"assistant"},e,this.__includeRawResponse)};r.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},(0,to.isAIMessage)(r.message)&&(r.message.usage_metadata=n),r.message=new to.AIMessage(Object.fromEntries(Object.entries(r.message).filter(([e])=>!e.startsWith("lc_")))),u.push(r)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:n.input_tokens,completionTokens:n.output_tokens,totalTokens:n.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let n=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==r){let e=function(e){let t=["namespace functions {",""];for(let r of e)r.description&&t.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(t.push(`type ${r.name} = (_: {`),t.push(d_(r.parameters,0)),t.push("}) => any;")):t.push(`type ${r.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);n+=await this.getNumTokens(e),n+=9}return t&&e.find(e=>"system"===e._getType())&&(n-=4),"none"===r?n+=1:"object"==typeof r&&(n+=await this.getNumTokens(r.name)+4),n}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,r=0,n=0;"gpt-3.5-turbo-0301"===this.model?(r=4,n=-1):(r=3,n=1);let s=await Promise.all(e.map(async e=>{let s=await this.getNumTokens(e.content),i=await this.getNumTokens(dO(e)),a=void 0!==e.name?n+await this.getNumTokens(e.name):0,o=s+r+i+a;if("function"===e._getType()&&(o-=2),e.additional_kwargs?.function_call&&(o+=3),e?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))}catch(t){console.error("Error parsing function arguments",t,JSON.stringify(e.additional_kwargs.function_call)),o+=await this.getNumTokens(e.additional_kwargs.function_call?.arguments)}return t+=o,o}));return{totalCount:t+=3,countPerMessage:s}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw dw(e)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(e){throw dw(e)}})}_getClientOptions(e){if(!this.client){let e=function(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:n,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=e;if((n||a)&&s&&t)return`${s}/${t}`;if((n||a)&&o&&t)return`${o}/openai/deployments/${t}`;if(n||a){if(!r)throw Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return i}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new hZ(t)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var r;let n,s,i,a,o,l;if(void 0!==(r=e)&&"object"==typeof r.schema?(n=e.schema,s=e.name,i=e.method,a=e.includeRaw):(n=e,s=t?.name,i=t?.method,a=t?.includeRaw),t?.strict!==void 0&&"jsonMode"===i)throw Error("Argument `strict` is only supported for `method` = 'function_calling'");if("jsonMode"===i)o=this.bind({response_format:{type:"json_object"}}),l=dS(n)?nb.fromZodSchema(n):new nx;else if("jsonSchema"===i)o=this.bind({response_format:{type:"json_schema",json_schema:{name:s??"extract",description:n.description,schema:n,strict:t?.strict}}}),l=dS(n)?nb.fromZodSchema(n):new nx;else{let e=s??"extract";if(dS(n)){let r=(0,r8.zodToJsonSchema)(n);o=this.bind({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new h0({returnSingle:!0,keyName:e,zodSchema:n})}else{let r;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(r=n,e=n.name):r={name:e=n.title??e,description:n.description??"",parameters:n},o=this.bind({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new h0({returnSingle:!0,keyName:e})}}if(!a)return o.pipe(l);let c=rW.assign({parsed:(e,t)=>l.invoke(e.raw,t)}),u=rW.assign({parsed:()=>null}),h=c.withFallbacks({fallbacks:[u]});return r3.RunnableSequence.from([{raw:o},h])}}function dS(e){return"function"==typeof e?.parse}Object.defineProperty(class extends rr{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??(0,rK.getEnvironmentVariable)("OPENAI_API_KEY"),organization:e?.organization??(0,rK.getEnvironmentVariable)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new hZ(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)):e.flatMap(e=>e.data.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}let r=await this.client.images.generate(t),n="";return"url"===this.dallEResponseFormat?[n]=r.data.map(e=>e.url).filter(e=>"undefined"!==e):[n]=r.data.map(e=>e.b64_json).filter(e=>"undefined"!==e),n}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});let dA=oo.Root({url:oo(),sourceMode:oo(),inputContent:oo(),pageContent:oo(),metaData:oo(),reviewCounter:oo(),keyPointsText:oo(),messages:oo({reducer:lN,default:()=>[]})}),dC=`Extract the key points from this news article.

Metadata:
{metadata}

Content:
{content}`,dj=new ta.SystemMessage('Determine whether the provided claim is consistent with the corresponding document. Consistency in this context implies that all information presented in the claim is substantiated by the document. If not, it should be considered inconsistent. Please assess the claim\'s consistency with the document by responding with either "Yes" or "No".');function dT(e,t=220){let r=e.replace(/\s+/g," ").trim();return r.length<=t?r:`${r.slice(0,t-1)}â€¦`}async function dN({url:e,mode:t,content:r,jinaKey:n}){if("paste"===t)return{content:r,metaData:{}};let s=e,i={};"jina"===t&&(s=`https://r.jina.ai/${e}`,n&&(i.Authorization=`Bearer ${n}`)),"proxy"===t&&(s=`http://localhost:3000/${e}`);let a=await fetch(s,{headers:i});if(!a.ok)throw Error(`Fetch failed (${a.status}).`);let o=await a.text();return/<html|<!doctype/i.test(o.slice(0,500))?function(e){try{let t,r,n=new DOMParser().parseFromString(e,"text/html"),s=(t=n.querySelector("title")?.textContent?.trim()??"",r=n.querySelector('meta[name="description"]')?.getAttribute("content")||n.querySelector('meta[property="og:description"]')?.getAttribute("content")||"",{title:t,description:r,source:n.querySelector('meta[property="og:site_name"]')?.getAttribute("content")||""});return{content:n.body?.innerText?.trim()||e,metaData:s}}catch{return{content:e,metaData:{}}}}(o):{content:o.trim(),metaData:{}}}async function dI({url:e,content:t,sourceMode:r,settings:n,onTimelineUpdate:s}){let i=[],a={},o=()=>{s?.([...i])},l=(e,t)=>{let r=(a[e]??0)+1;a[e]=r;let n=`${e}-${r}-${crypto.randomUUID()}`;return i.push({id:n,title:e,summary:"Running",detail:t,toolCalls:[],status:"running"}),o(),n},c=(e,t)=>{let r=i.findIndex(t=>t.id===e);-1!==r&&(i[r]={...i[r],...t},o())},u="ollama"===n.provider?new lX({model:n.model,temperature:.2}):"google"===n.provider?new nj({model:n.model,apiKey:n.apiKey}):new dE({model:n.model,apiKey:n.apiKey}),h=new ta.SystemMessage(e1),d=new ta.SystemMessage(e2),p="",f=new lX({model:"bespoke-minicheck"}),m=ra(async({claim:e})=>(await f.invoke([dj,new ti.HumanMessage(`Document: ${p}
Claim: ${e}`)])).content??"",{name:"fact_check",description:"Fact check a claim against the article and return Yes or No.",schema:tg.z.object({claim:tg.z.string()})}),g=n.factCheckEnabled?u.bindTools([m]):u,b=async e=>{let t=l("scrapper","paste"===e.sourceMode?"Using pasted content":"Fetching article content");try{let r=await dN({url:e.url,mode:e.sourceMode,content:e.inputContent,jinaKey:n.jinaKey});return p=r.content,c(t,{summary:"Complete",detail:`Captured ${r.content.length.toLocaleString()} characters of content.`,status:"done"}),{pageContent:r.content,metaData:r.metaData}}catch(e){throw c(t,{summary:"Error",detail:e.message,status:"error"}),e}},y=async e=>{let t,r=l("initiator","Preparing extraction prompt"),n=dC.replace("{metadata}",(t=Object.entries(e.metaData).filter(([,e])=>e).map(([e,t])=>`${e}: ${t}`)).length?t.join("\n"):"No metadata available.").replace("{content}",e.pageContent);return c(r,{summary:"Complete",detail:"Prompt built from metadata and content.",status:"done"}),{messages:[new ti.HumanMessage(n)],reviewCounter:0}},v=async e=>{let t=l("kpExtractor","Drafting key points");try{let r=await u.invoke([h,...e.messages]),n=r.content&&"string"==typeof r.content?dT(r.content):"Extraction completed.";return c(t,{summary:"Complete",detail:n,status:"done"}),{messages:[...e.messages,r],keyPointsText:"string"==typeof r.content?r.content:""}}catch(e){throw c(t,{summary:"Error",detail:e.message,status:"error"}),e}},w=async e=>{let t=l("reviewer","Reviewing extracted points");try{let r=await g.invoke([d,...e.messages]),n=(Array.isArray(r.tool_calls)?r.tool_calls:[]).map(e=>{let t="object"==typeof e.args&&e.args?e.args.claim??e.args:e.args??"",r="string"==typeof t?t:JSON.stringify(t);return`${e.name}: ${r}`}),s="string"==typeof r.content&&r.content?dT(r.content):"Review completed.";return c(t,{summary:n.length?"Tool calls":"Complete",detail:s,toolCalls:n,status:"done"}),{messages:[...e.messages,r],reviewCounter:e.reviewCounter+1}}catch(e){throw c(t,{summary:"Error",detail:e.message,status:"error"}),e}},_=async e=>{let t=e.messages[e.messages.length-1],r=Array.isArray(t?.tool_calls)?t.tool_calls:[],n=l("fact_check",r.length?`Checking ${r.length} claims`:"No claims to check");if(!r.length)return c(n,{summary:"Skipped",detail:"No tool calls found.",status:"done"}),{};try{let t=[];for(let e of r){let r="object"==typeof e.args&&e.args?e.args.claim??e.args:e.args??"",n="string"==typeof r?r:JSON.stringify(r),s=await m.invoke({claim:n});t.push(new tm.ToolMessage({tool_call_id:e.id??crypto.randomUUID(),content:"string"==typeof s?s:String(s)}))}return c(n,{summary:"Complete",detail:"Fact checks added to the thread.",status:"done"}),{messages:[...e.messages,...t]}}catch(e){throw c(n,{summary:"Error",detail:e.message,status:"error"}),e}},x=new lE(dA).addNode("scrapper",b).addNode("initiator",y).addNode("kpExtractor",v).addNode("reviewer",w).addNode("fact_check",_).addEdge(aA,"scrapper").addEdge("scrapper","initiator").addEdge("initiator","kpExtractor").addConditionalEdges("kpExtractor",e=>e.reviewCounter>5?aC:"reviewer").addConditionalEdges("reviewer",e=>{let t=e.messages[e.messages.length-1];return(Array.isArray(t?.tool_calls)?t.tool_calls:[]).length?"fact_check":"string"==typeof t?.content&&t.content.includes("LGTM")?aC:"kpExtractor"}).addEdge("fact_check","reviewer").compile();return{timeline:i,keyPoints:function(e){let t=e.split("\n").map(e=>e.replace(/^[-*\d.\s]+/,"").trim()).filter(Boolean);if(t.length)return t;let r=e.trim();return r?[r]:[]}((await x.invoke({url:e,sourceMode:r,inputContent:t,pageContent:"",metaData:{},reviewCounter:0,keyPointsText:"",messages:[]})).keyPointsText)}}let dR={provider:"openai",model:"gpt-5-mini",apiKey:"",factCheckEnabled:!0,jinaKey:""};function dM(){let[e,t]=(0,eQ.useState)("direct"),[r,n]=(0,eQ.useState)("direct"),[s,i]=(0,eQ.useState)(""),[a,o]=(0,eQ.useState)(""),[l,c]=(0,eQ.useState)([]),[u,h]=(0,eQ.useState)([]),[d,p]=(0,eQ.useState)(!1),[f,m]=(0,eQ.useState)(!1),[g,b]=(0,eQ.useState)(!1),[y,v]=(0,eQ.useState)(!1),[w,_]=(0,eQ.useState)([]),[x,O]=(0,eQ.useState)(dR),k=(0,eQ.useRef)(!1);(0,eQ.useEffect)(()=>{let e=localStorage.getItem("clickbait-lense-settings");if(e)try{let t=JSON.parse(e);O({...dR,...t})}catch{O(dR)}k.current=!0},[]),(0,eQ.useEffect)(()=>{k.current&&localStorage.setItem("clickbait-lense-settings",JSON.stringify(x))},[x]);let P=e=>{let t=crypto.randomUUID();_(r=>[...r,{...e,id:t}]),setTimeout(()=>{_(e=>e.filter(e=>e.id!==t))},4200)},E=async()=>{if(!d){if("paste"===e&&a.trim().length<40)return void P({type:"error",message:"Paste more content to run the extractor."});if("paste"!==e&&!function(e){try{return!!new URL(e).protocol.startsWith("http")}catch{return!1}}(s))return void P({type:"error",message:"Enter a valid URL."});if("jina"===e&&!x.jinaKey.trim())return void P({type:"error",message:"Jina mode requires an API key in Settings."});c([]),h([]),p(!0);try{let t=await dI({url:s,content:a,sourceMode:e,settings:x,onTimelineUpdate:c});h(t.keyPoints),c(t.timeline),P({type:"success",message:"Run completed."})}catch(e){P({type:"error",message:e instanceof Error?e.message:"Run failed. Try again."})}finally{p(!1)}}};return(0,eX.jsxs)("main",{className:"relative min-h-screen overflow-hidden bg-[#0b0b0d]",children:[(0,eX.jsx)("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_top_left,_rgba(224,184,123,0.32),_transparent_55%)]"}),(0,eX.jsx)("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_40%_90%,_rgba(89,151,204,0.2),_transparent_60%)]"}),(0,eX.jsx)("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_top_right,_rgba(255,255,255,0.06),_transparent_60%)]"}),(0,eX.jsxs)("div",{className:"relative mx-auto w-full px-4 pb-16 pt-8 sm:px-6 sm:pt-10",children:[(0,eX.jsx)(e3,{onAbout:()=>m(!0),onSettings:()=>b(!0)}),(0,eX.jsxs)("section",{className:"mt-10 grid gap-6 xl:grid-cols-[1.1fr_1.6fr_1fr] sm:mt-12 sm:gap-8",children:[(0,eX.jsx)("div",{className:"min-w-0 space-y-8",children:(0,eX.jsx)(e7,{url:s,content:a,sourceMode:e,lastUrlMode:r,showProxy:y,onUrlChange:i,onContentChange:o,onRun:E,onModeChange:e=>{t(e),"paste"!==e&&n(e),"proxy"!==e&&v(!1)},onToggleProxy:()=>v(e=>!e),onCopyProxy:()=>{navigator.clipboard.writeText(e8),P({type:"success",message:"Proxy command copied."})},isRunning:d})}),(0,eX.jsx)("div",{className:"min-w-0 space-y-8",children:(0,eX.jsx)(e9,{isRunning:d,keyPoints:u,onDownload:()=>{if(!u.length)return void P({type:"error",message:"Run the extractor first."});let t={id:`sample-${Date.now()}`,title:"Clickbait Lense Sample",source:{mode:e,url:s||"",note:"paste"===e?"User pasted content":""},input:{metadata:{title:"",description:"",source:s||""},content:a||""},timeline:l,output:{key_points:u},created_at:new Date().toISOString()},r=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(r),n.download=`${t.id}.json`,n.click(),URL.revokeObjectURL(n.href)}})}),(0,eX.jsxs)("div",{className:"min-w-0 space-y-8",children:[(0,eX.jsx)(tn,{timeline:l.length?l:[{id:"scrapper",title:"scrapper",summary:"Fetch article content",detail:"Input validated. Fetch attempt recorded. Fallbacks prepared when blocked.",toolCalls:[],status:"pending"},{id:"initiator",title:"initiator",summary:"Prepare extraction prompt",detail:"Metadata and article content assembled into the extraction request.",toolCalls:[],status:"pending"},{id:"kpExtractor",title:"kpExtractor",summary:"Draft key points",detail:"First extraction pass built the bullet list.",toolCalls:[],status:"pending"},{id:"reviewer",title:"reviewer",summary:"Review and feedback",detail:"Reviewer checks relevance and optionally calls fact-checking.",toolCalls:x.factCheckEnabled?["fact_check: claim 1","fact_check: claim 2","fact_check: claim 3"]:[],status:"pending"}]}),(0,eX.jsx)(tr,{settings:x,sourceMode:e,onAbout:()=>m(!0)})]})]})]}),f?(0,eX.jsx)(e5,{onClose:()=>m(!1)}):null,g?(0,eX.jsx)(tt,{settings:x,onChange:O,onClose:()=>b(!1)}):null,(0,eX.jsx)(ts,{toasts:w})]})}e.s(["default",()=>dM],31713)}]);